# 学校成绩管理系统 - 桌面应用完整指南

## 📦 应用打包成功

✅ 应用已成功打包为独立的桌面应用
- **位置**: `dist/学校成绩管理系统.app`
- **大小**: 约65MB
- **平台**: macOS (支持 Apple Silicon 和 Intel)

---

## 📊 一、数据库问题解答

### 1. 数据库是否跟随应用？
**当前状态（Windows 版）**：数据库**会**跟随应用文件夹
- 数据库文件：`grade_manager.db`（与 .exe 同目录）
- 复制整个应用文件夹即可带走数据
- 旧版本在 AppData 的数据库首次启动会自动复制到应用目录

### 2. 如何让老师使用现有数据？

**方案A：替换数据库文件（推荐）**

1. 找到你的数据库文件：`grade_manager.db`（与 .exe 同目录）
2. 将数据库文件发给老师
3. 老师解压后，用该文件替换应用目录中的 `grade_manager.db`
4. 重启应用即可

**数据库位置（Windows）**：
```
应用目录\grade_manager.db
```

**macOS 数据库位置**：
```
~/Library/Application Support/学校成绩管理系统/grade_manager.db
```

**方案B：预装数据库（需要重新打包）**

1. 将当前数据库放到应用目录并命名为 `grade_manager.db`
2. 重新打包后，所有老师都会有相同的初始数据

## 👥 二、老师如何安装使用

### macOS 用户安装步骤

**步骤1：获取应用**
- 从你这里获得 `学校成绩管理系统.app` 文件
- 或者获得压缩包后解压

**步骤2：安装应用**
```
1. 将 学校成绩管理系统.app 拖到"应用程序"文件夹
2. 双击打开应用
```

**步骤3：首次运行（重要）**

首次打开时，macOS 可能会提示"无法验证开发者"：

```
解决方法：
1. 打开"系统设置" > "隐私与安全性"
2. 找到"学校成绩管理系统"的提示
3. 点击"仍要打开"
4. 再次双击应用即可正常使用
```

**步骤4：开始使用**
- 应用会自动在浏览器中打开
- 默认账号：`ddjia2022` / `ddjia2022`

### Windows 用户

目前只打包了 macOS 版本。如需 Windows 版本：
- 需要在 Windows 系统上重新打包
- 打包命令相同，但需要 Windows 环境

---

## 🎨 三、如何修改应用图标

### 准备图标文件

**macOS 需要 .icns 格式图标**

1. **准备原始图片**
   - 推荐尺寸：1024x1024 像素
   - 格式：PNG（透明背景更佳）

2. **转换为 .icns 格式**

**方法A：使用在线工具（最简单）**
- 访问：https://cloudconvert.com/png-to-icns
- 上传你的图片，转换为 .icns 格式
- 下载生成的 `icon.icns` 文件

**方法B：使用 macOS 命令行**
```bash
# 创建图标集目录
mkdir MyIcon.iconset

# 生成不同尺寸（需要原始图片为 icon.png）
sips -z 16 16     icon.png --out MyIcon.iconset/icon_16x16.png
sips -z 32 32     icon.png --out MyIcon.iconset/icon_16x16@2x.png
sips -z 32 32     icon.png --out MyIcon.iconset/icon_32x32.png
sips -z 64 64     icon.png --out MyIcon.iconset/icon_32x32@2x.png
sips -z 128 128   icon.png --out MyIcon.iconset/icon_128x128.png
sips -z 256 256   icon.png --out MyIcon.iconset/icon_128x128@2x.png
sips -z 256 256   icon.png --out MyIcon.iconset/icon_256x256.png
sips -z 512 512   icon.png --out MyIcon.iconset/icon_256x256@2x.png
sips -z 512 512   icon.png --out MyIcon.iconset/icon_512x512.png
sips -z 1024 1024 icon.png --out MyIcon.iconset/icon_512x512@2x.png

# 转换为 .icns
iconutil -c icns MyIcon.iconset
```

### 应用图标到打包配置

1. **将图标文件放到项目根目录**
```bash
# 将你的 icon.icns 放到这里
/Users/chaoteng/Desktop/7c/edu/icon.icns
```

2. **修改打包配置文件**

打开 `build_desktop.spec`，找到第72行：
```python
icon=None,
```

修改为：
```python
icon='icon.icns',
```

3. **重新打包**
```bash
source .venv/bin/activate
rm -rf dist build
pyinstaller build_desktop.spec
```

打包完成后，新的应用就会显示你的自定义图标了！

---

## 🔓 四、桌面版免登录设置

### 为什么需要免登录？

桌面应用是单机版本，每位老师独立使用，不需要登录验证。

### 实现方法

需要修改后端代码，让桌面版自动登录。

**步骤1：修改启动器，添加自动登录标识**

打开 `app/desktop_launcher.py`，在第30行的 `uvicorn.run` 之前添加：

```python
# 设置桌面模式环境变量
os.environ['DESKTOP_MODE'] = 'true'
```

完整代码：
```python
def start_server():
    """后台启动FastAPI服务器"""
    try:
        # 设置工作目录
        base_path = get_resource_path()
        os.chdir(base_path)

        # 添加到Python路径
        if base_path not in sys.path:
            sys.path.insert(0, base_path)

        # 设置桌面模式环境变量
        os.environ['DESKTOP_MODE'] = 'true'

        from app.main import app
        uvicorn.run(
            app,
            host="127.0.0.1",
            port=18765,
            log_level="warning"
        )
```

**步骤2：修改主页面，检测桌面模式**

找到登录页面的路由（通常在 `app/main.py` 或 `app/routes/` 目录下）。

添加桌面模式检测：

```python
import os

@app.get("/")
async def read_root():
    # 检测是否为桌面模式
    if os.getenv('DESKTOP_MODE') == 'true':
        # 桌面模式：自动登录，跳转到主页
        response = RedirectResponse(url="/static/points.html")
        # 设置默认登录token（如果需要）
        response.set_cookie(key="access_token", value="desktop_auto_login")
        return response
    else:
        # Web模式：显示登录页面
        return FileResponse("app/static/login.html")
```

**步骤3：（可选）修改API认证中间件**

如果你的API有认证中间件，需要让桌面模式跳过认证：

```python
# 在认证中间件中添加
if os.getenv('DESKTOP_MODE') == 'true':
    # 桌面模式，跳过认证
    return await call_next(request)
```

**步骤4：重新打包**

```bash
source .venv/bin/activate
rm -rf dist build
pyinstaller build_desktop.spec
```

### 简化方案（推荐）

如果不想修改太多代码，可以使用更简单的方法：

**修改启动器，直接打开主页**

在 `app/desktop_launcher.py` 的第64行，将URL改为直接打开主页：

```python
# 原来的代码
webview.create_window(
    "学校成绩管理系统",
    "http://127.0.0.1:18765",  # 这会打开登录页
    ...
)

# 修改为
webview.create_window(
    "学校成绩管理系统",
    "http://127.0.0.1:18765/static/points.html",  # 直接打开主页
    ...
)
```

这样应用启动后会直接显示主页，跳过登录页面。

---

## 📋 五、快速操作清单

### 分发给老师的文件

**必需文件：**
1. `学校成绩管理系统.app` - 应用程序

**可选文件：**
2. `grade_manager.db` - 数据库文件（Windows：与 .exe 同目录，需要共享数据时提供）
3. 使用说明文档

### 打包新版本的完整流程

```bash
# 1. 进入项目目录
cd /Users/chaoteng/Desktop/7c/edu

# 2. 激活虚拟环境
source .venv/bin/activate

# 3. 清理旧文件
rm -rf dist build

# 4. 执行打包
pyinstaller build_desktop.spec

# 5. 测试应用
open dist/学校成绩管理系统.app

# 6. 压缩分发（可选）
cd dist
zip -r 学校成绩管理系统.zip 学校成绩管理系统.app
```

### 常见问题解决

**Q1: 应用打不开，提示"已损坏"**
```bash
# 解决方法：移除隔离属性
xattr -cr /Applications/学校成绩管理系统.app
```

**Q2: 端口18765被占用**
```bash
# 查找占用进程
lsof -i:18765

# 结束进程
kill -9 [进程ID]
```

**Q3: 如何查看应用日志**
```bash
# 从命令行运行查看详细输出
./dist/学校成绩管理系统.app/Contents/MacOS/学校成绩管理系统
```

**Q4: 数据库在哪里**
`ash
# Windows：应用目录同级 grade_manager.db
# macOS：~/Library/Application Support/学校成绩管理系统/grade_manager.db
`\r\n\r\n---

## 🎯 六、总结

### 已完成的工作

✅ **CDN资源离线化**
- Font Awesome 字体库
- xlsx.full.min.js (Excel处理)
- chart.min.js (图表库)
- 所有外部资源已本地化

✅ **桌面应用打包**
- 成功打包为 macOS .app 应用
- 大小约65MB
- 完全离线运行

✅ **功能验证**
- 应用可以正常启动
- 服务器正常运行
- 所有功能可用

### 下一步建议

**1. 修改应用图标**
- 准备 1024x1024 的PNG图片
- 转换为 .icns 格式
- 修改 build_desktop.spec
- 重新打包

**2. 实现免登录**
- 修改 desktop_launcher.py
- 直接打开主页面
- 或添加自动登录逻辑
- 重新打包

**3. 准备分发**
- 压缩应用为 .zip
- 准备使用说明
- 可选：准备数据库文件

### 技术支持

如需帮助，可以：
1. 查看本文档的常见问题部分
2. 从命令行运行应用查看详细日志
3. 检查系统日志：控制台.app

---

## 📞 联系方式

**项目位置**: `/Users/chaoteng/Desktop/7c/edu`

**关键文件**:
- 应用程序: `dist/学校成绩管理系统.app`
- 启动器: `app/desktop_launcher.py`
- 打包配置: `build_desktop.spec`
- 依赖文件: `requirements_desktop.txt`

**打包命令**:
```bash
source .venv/bin/activate && pyinstaller build_desktop.spec
```

---

*文档创建时间: 2026-01-02*
*应用版本: 1.0*
*平台: macOS (Apple Silicon & Intel)*


