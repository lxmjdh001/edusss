# 用户认证系统使用说明

## 系统概述

本系统新增了完整的用户认证和激活码管理功能，支持用户注册、登录和基于激活码的账号过期管理。

---

## 核心功能

### 1. 激活码管理系统
- **访问地址**: `http://localhost:8010/static/admin-codes.html`
- **管理员密码**: `ddjia2022` (固定密码)

#### 功能说明
- 查看激活码列表（显示激活码、有效天数、使用状态等）
- 创建新激活码（支持3天、7天、30天、90天、180天、365天）
- 删除未使用的激活码
- 查看统计信息（总数、已使用、未使用）

#### 使用步骤
1. 访问激活码管理页面
2. 输入管理员密码 `ddjia2022`
3. 点击"+ 新建激活码"按钮
4. 选择有效天数（3天或365天）
5. 点击"创建"，系统会自动生成一个唯一的激活码
6. 将激活码分享给用户用于注册

---

### 2. 用户注册
- **访问地址**: `http://localhost:8010/static/register.html`

#### 功能说明
- 注册新账号需要提供：
  - 用户名（3-20个字符）
  - 密码（至少6个字符）
  - 确认密码
  - 激活码

#### 特性
- 实时检查用户名是否可用
- 密码强度提示
- 激活码验证
- 自动计算账号过期时间（根据激活码的有效天数）

#### 使用步骤
1. 访问注册页面
2. 填写用户名（系统会实时检查是否可用）
3. 设置密码（系统会显示密码强度）
4. 确认密码
5. 输入从管理员处获取的激活码
6. 点击"注册"
7. 注册成功后自动跳转到登录页面

---

### 3. 用户登录
- **访问地址**: `http://localhost:8010/static/login.html`

#### 功能说明
- 使用用户名和密码登录
- 验证账号是否过期
- 登录成功后保存用户信息到浏览器

#### 使用步骤
1. 访问登录页面
2. 输入用户名和密码
3. 点击"登录"
4. 登录成功后跳转到成绩管理系统主页面

---

## 数据库设计

### 表结构

#### 1. users（用户表）
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(64) NOT NULL UNIQUE,          -- 用户名
    password_hash VARCHAR(128) NOT NULL,           -- 密码哈希
    expires_at DATETIME,                           -- 账号过期时间
    is_active BOOLEAN NOT NULL DEFAULT 1,          -- 是否激活
    last_login_at DATETIME,                        -- 最后登录时间
    activation_code_id INTEGER,                    -- 关联的激活码ID
    created_at DATETIME NOT NULL,                  -- 创建时间
    updated_at DATETIME NOT NULL                   -- 更新时间
);
```

#### 2. activation_codes（激活码表）
```sql
CREATE TABLE activation_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    code VARCHAR(32) NOT NULL UNIQUE,              -- 激活码
    valid_days INTEGER NOT NULL,                   -- 有效天数
    is_used BOOLEAN NOT NULL DEFAULT 0,            -- 是否已使用
    used_at DATETIME,                              -- 使用时间
    generated_at DATETIME NOT NULL,                -- 生成时间
    created_at DATETIME NOT NULL,                  -- 创建时间
    updated_at DATETIME NOT NULL                   -- 更新时间
);
```

---

## API 接口文档

### 认证相关接口

#### 1. 用户注册
- **URL**: `POST /api/auth/register`
- **请求体**:
```json
{
  "username": "testuser",
  "password": "123456",
  "activation_code": "SNW7GQVPHI"
}
```
- **响应**:
```json
{
  "id": 1,
  "username": "testuser",
  "expires_at": "2026-12-02T06:19:19",
  "is_active": true,
  "last_login_at": null,
  "created_at": "2025-12-02T06:19:19"
}
```

#### 2. 用户登录
- **URL**: `POST /api/auth/login`
- **请求体**:
```json
{
  "username": "testuser",
  "password": "123456"
}
```
- **响应**:
```json
{
  "user": {
    "id": 1,
    "username": "testuser",
    "expires_at": "2026-12-02T06:19:19",
    "is_active": true,
    "last_login_at": "2025-12-02T06:20:00",
    "created_at": "2025-12-02T06:19:19"
  },
  "token": "random_token_string",
  "message": "登录成功"
}
```

#### 3. 检查用户名是否可用
- **URL**: `GET /api/auth/check/{username}`
- **响应**:
```json
{
  "available": true,
  "message": "用户名可用"
}
```

---

### 激活码管理接口

#### 1. 验证管理员密码
- **URL**: `POST /api/activation-codes/verify-admin`
- **请求体**:
```json
{
  "password": "ddjia2022"
}
```

#### 2. 获取激活码列表
- **URL**: `GET /api/activation-codes?password=ddjia2022`
- **响应**: 激活码数组

#### 3. 创建激活码
- **URL**: `POST /api/activation-codes?password=ddjia2022`
- **请求体**:
```json
{
  "valid_days": 365
}
```

#### 4. 删除激活码
- **URL**: `DELETE /api/activation-codes/{code_id}?password=ddjia2022`

#### 5. 获取统计信息
- **URL**: `GET /api/activation-codes/stats/summary?password=ddjia2022`
- **响应**:
```json
{
  "total": 10,
  "used": 3,
  "unused": 7
}
```

---

## 业务流程

### 完整注册流程
1. 管理员登录激活码管理系统
2. 创建新激活码（选择有效期）
3. 将激活码提供给用户
4. 用户访问注册页面
5. 用户填写信息并输入激活码
6. 系统验证激活码并创建账号
7. 账号过期时间 = 当前时间 + 激活码有效天数
8. 激活码标记为已使用

### 登录验证流程
1. 用户输入用户名和密码
2. 验证用户名和密码是否正确
3. 检查账号是否被禁用（is_active）
4. 检查账号是否过期（expires_at）
5. 更新最后登录时间
6. 返回用户信息和token

---

## 测试激活码

系统已创建两个测试激活码：

1. **365天激活码**: `SNW7GQVPHI`
2. **3天激活码**: `U1KYSRW7EM`

您可以使用这些激活码进行测试。

---

## 安全说明

### 密码加密
- 使用 SHA256 哈希算法加密密码
- 密码不会以明文形式存储在数据库中

### 管理员密码
- 固定密码：`ddjia2022`
- 建议在生产环境中修改此密码

### Token管理
- 当前实现为简化版本
- 生产环境建议使用 JWT（JSON Web Token）

---

## 后续优化建议

1. **JWT认证**: 将简单的token替换为JWT，支持token过期和刷新
2. **密码加密升级**: 使用bcrypt或argon2替代SHA256
3. **邮箱验证**: 添加邮箱验证功能
4. **找回密码**: 实现密码重置功能
5. **角色权限**: 添加用户角色和权限管理
6. **登录日志**: 记录用户登录历史
7. **多因素认证**: 支持2FA
8. **密码策略**: 强制密码复杂度和定期更换

---

## 文件清单

### 后端文件
- `app/models.py` - 新增User和ActivationCode模型
- `app/schemas.py` - 新增认证相关的Pydantic模型
- `app/routes/auth.py` - 用户认证API路由
- `app/routes/activation_codes.py` - 激活码管理API路由
- `app/utils.py` - 新增token生成函数
- `migrate_add_auth_system.py` - 数据库迁移脚本

### 前端文件
- `app/static/login.html` - 用户登录页面
- `app/static/register.html` - 用户注册页面
- `app/static/admin-codes.html` - 激活码管理页面

---

## 常见问题

### Q: 忘记管理员密码怎么办？
A: 管理员密码固定为 `ddjia2022`，写在代码中：`app/routes/activation_codes.py`

### Q: 如何修改管理员密码？
A: 编辑 `app/routes/activation_codes.py` 文件，修改 `ADMIN_PASSWORD` 变量

### Q: 激活码可以重复使用吗？
A: 不可以。每个激活码只能使用一次，使用后会自动标记为已使用

### Q: 如何延长用户账号有效期？
A: 需要直接修改数据库中users表的expires_at字段，或者让用户重新注册

### Q: 账号过期后会怎样？
A: 账号过期后无法登录，系统会提示"账号已过期，请联系管理员续费"

---

## 数据库迁移

如果数据库表不存在，运行迁移脚本：

```bash
python migrate_add_auth_system.py
```

迁移脚本会创建以下内容：
- users表及其索引
- activation_codes表及其索引
- 必要的外键关系

---

## 页面访问链接

- 激活码管理: http://localhost:8010/static/admin-codes.html
- 用户注册: http://localhost:8010/static/register.html
- 用户登录: http://localhost:8010/static/login.html
- 成绩系统: http://localhost:8010/static/grades.html
- 积分系统: http://localhost:8010/static/points.html
