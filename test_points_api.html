<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç§¯åˆ†ç³»ç»ŸAPIæµ‹è¯•</title>
  <style>
    body {
      font-family: "PingFang SC", sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      color: #333;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #2563eb;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #1d4ed8;
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #2563eb;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
    }
    .error {
      border-left-color: #ef4444;
      background: #fef2f2;
      color: #991b1b;
    }
    .success {
      border-left-color: #10b981;
      background: #f0fdf4;
      color: #065f46;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª ç§¯åˆ†ç³»ç»ŸAPIæµ‹è¯•</h1>

  <div class="section">
    <h2>1. æµ‹è¯•ç­çº§åˆ—è¡¨ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰</h2>
    <button onclick="testGetClasses()">è·å–ç­çº§åˆ—è¡¨</button>
    <div id="classes-result" class="result" style="display:none;"></div>
  </div>

  <div class="section">
    <h2>2. æµ‹è¯•å­¦ç”ŸåŒæ­¥</h2>
    <p>å…ˆè·å–ç­çº§åˆ—è¡¨ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªç­çº§åŒæ­¥å­¦ç”Ÿ</p>
    <button onclick="testSyncStudents()">åŒæ­¥å­¦ç”Ÿï¼ˆéœ€è¦å…ˆæœ‰ç­çº§ï¼‰</button>
    <div id="sync-result" class="result" style="display:none;"></div>
  </div>

  <div class="section">
    <h2>3. æµ‹è¯•è·å–å­¦ç”Ÿåˆ—è¡¨</h2>
    <button onclick="testGetStudents()">è·å–å­¦ç”Ÿåˆ—è¡¨</button>
    <div id="students-result" class="result" style="display:none;"></div>
  </div>

  <div class="section">
    <h2>4. æµ‹è¯•æ›´æ–°å­¦ç”Ÿç§¯åˆ†</h2>
    <button onclick="testUpdatePoints()">æ›´æ–°ç§¯åˆ†ï¼ˆéœ€è¦å…ˆæœ‰å­¦ç”Ÿï¼‰</button>
    <div id="points-result" class="result" style="display:none;"></div>
  </div>

  <div class="section">
    <h2>5. æµ‹è¯•æ’è¡Œæ¦œ</h2>
    <button onclick="testRankings()">è·å–æ’è¡Œæ¦œ</button>
    <div id="rankings-result" class="result" style="display:none;"></div>
  </div>

  <script>
    const API_BASE = '/api/points';
    let testClassId = null;
    let testStudentId = null;

    function showResult(elementId, data, isError = false) {
      const element = document.getElementById(elementId);
      element.style.display = 'block';
      element.className = 'result ' + (isError ? 'error' : 'success');
      element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }

    async function testGetClasses() {
      try {
        const response = await fetch(`${API_BASE}/classes`);
        const data = await response.json();

        if (data.length > 0) {
          testClassId = data[0].id;
          showResult('classes-result', {
            message: 'âœ… æˆåŠŸè·å–ç­çº§åˆ—è¡¨',
            count: data.length,
            classes: data,
            note: `å·²ä¿å­˜ç¬¬ä¸€ä¸ªç­çº§ID: ${testClassId} ç”¨äºåç»­æµ‹è¯•`
          });
        } else {
          showResult('classes-result', {
            message: 'âš ï¸ æ²¡æœ‰æ‰¾åˆ°ç­çº§',
            note: 'è¯·å…ˆåœ¨æˆç»©ç®¡ç†ç³»ç»Ÿä¸­æ·»åŠ å­¦ç”Ÿæ•°æ®'
          });
        }
      } catch (error) {
        showResult('classes-result', `âŒ é”™è¯¯: ${error.message}`, true);
      }
    }

    async function testSyncStudents() {
      if (!testClassId) {
        showResult('sync-result', 'âŒ è¯·å…ˆè¿è¡Œ"è·å–ç­çº§åˆ—è¡¨"æµ‹è¯•', true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/classes/${testClassId}/sync-from-grades`, {
          method: 'POST'
        });
        const data = await response.json();
        showResult('sync-result', {
          message: 'âœ… åŒæ­¥æˆåŠŸ',
          result: data
        });

        // åŒæ­¥åè·å–å­¦ç”Ÿåˆ—è¡¨
        setTimeout(() => testGetStudents(), 500);
      } catch (error) {
        showResult('sync-result', `âŒ é”™è¯¯: ${error.message}`, true);
      }
    }

    async function testGetStudents() {
      if (!testClassId) {
        showResult('students-result', 'âŒ è¯·å…ˆè¿è¡Œ"è·å–ç­çº§åˆ—è¡¨"æµ‹è¯•', true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/classes/${testClassId}/students`);
        const data = await response.json();

        if (data.length > 0) {
          testStudentId = data[0].id;
          showResult('students-result', {
            message: 'âœ… æˆåŠŸè·å–å­¦ç”Ÿåˆ—è¡¨',
            count: data.length,
            students: data.slice(0, 5),
            note: data.length > 5 ? `åªæ˜¾ç¤ºå‰5ä¸ªå­¦ç”Ÿï¼Œå…±${data.length}ä¸ª` : '',
            savedStudentId: testStudentId
          });
        } else {
          showResult('students-result', {
            message: 'âš ï¸ è¯¥ç­çº§æ²¡æœ‰å­¦ç”Ÿ',
            note: 'è¯·å…ˆè¿è¡Œ"åŒæ­¥å­¦ç”Ÿ"æµ‹è¯•'
          });
        }
      } catch (error) {
        showResult('students-result', `âŒ é”™è¯¯: ${error.message}`, true);
      }
    }

    async function testUpdatePoints() {
      if (!testStudentId) {
        showResult('points-result', 'âŒ è¯·å…ˆè¿è¡Œ"è·å–å­¦ç”Ÿåˆ—è¡¨"æµ‹è¯•', true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/students/${testStudentId}/points`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            points: 10,
            reason: 'APIæµ‹è¯•åŠ åˆ†',
            operator: 'æµ‹è¯•å‘˜'
          })
        });
        const data = await response.json();
        showResult('points-result', {
          message: 'âœ… æˆåŠŸæ›´æ–°ç§¯åˆ†',
          result: data
        });
      } catch (error) {
        showResult('points-result', `âŒ é”™è¯¯: ${error.message}`, true);
      }
    }

    async function testRankings() {
      if (!testClassId) {
        showResult('rankings-result', 'âŒ è¯·å…ˆè¿è¡Œ"è·å–ç­çº§åˆ—è¡¨"æµ‹è¯•', true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/classes/${testClassId}/rankings/students?limit=10`);
        const data = await response.json();
        showResult('rankings-result', {
          message: 'âœ… æˆåŠŸè·å–æ’è¡Œæ¦œ',
          rankings: data
        });
      } catch (error) {
        showResult('rankings-result', `âŒ é”™è¯¯: ${error.message}`, true);
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
    window.addEventListener('load', () => {
      console.log('ç§¯åˆ†ç³»ç»ŸAPIæµ‹è¯•é¡µé¢å·²åŠ è½½');
      console.log('APIåŸºç¡€è·¯å¾„:', API_BASE);
    });
  </script>
</body>
</html>
