<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆç»©ç®¡ç†æ§åˆ¶å°</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f4f6fb;
        --card-bg: #ffffff;
        --primary: #2563eb;
        --text: #1f2937;
        --subtext: #6b7280;
        --border: #e5e7eb;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "PingFang SC", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      header.top-nav {
        position: sticky;
        top: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 40px;
        background: var(--card-bg);
        box-shadow: 0 2px 30px rgba(15, 23, 42, 0.08);
        z-index: 100;
      }
      .brand {
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      nav ul {
        list-style: none;
        display: flex;
        gap: 8px;
        margin: 0;
        padding: 0;
      }
      nav button {
        border: none;
        background: transparent;
        padding: 10px 18px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        color: var(--subtext);
        transition: background 0.2s ease, color 0.2s ease;
      }
      nav button.active {
        background: rgba(37, 99, 235, 0.12);
        color: var(--primary);
      }
      .app-shell {
        max-width: 1400px;
        margin: 0 auto;
        padding: 32px 12px 80px;
      }
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
      }
      .page-header h1 {
        margin: 0;
        font-size: 28px;
      }
      .page-header p {
        margin: 4px 0 0;
        color: var(--subtext);
      }
      .actions {
        display: flex;
        gap: 12px;
      }
      button,
      input,
      select,
      textarea {
        font: inherit;
      }
      .btn {
        border: none;
        border-radius: 10px;
        padding: 10px 18px;
        cursor: pointer;
        color: #fff;
        background: var(--primary);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.2);
      }
      .btn.secondary {
        background: #e5e7eb;
        color: #111827;
      }
      .compact-btn {
        padding: 8px 14px;
      }
      .btn.danger {
        background: var(--danger);
      }
      main[data-section] {
        display: none;
      }
      main[data-section].active {
        display: block;
      }
      .stats-grid {
        margin-top: 24px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }
      .stat-card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 15px 40px rgba(15, 23, 42, 0.05);
      }
      .stat-card h3 {
        margin: 0;
        font-size: 14px;
        color: var(--subtext);
      }
      .stat-card .value {
        font-size: 32px;
        margin-top: 12px;
        font-weight: 700;
      }
      .chip {
        display: inline-flex;
        margin-top: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        background: #ecfccb;
        color: #365314;
      }
      .filters {
        margin-top: 28px;
        background: var(--card-bg);
        border-radius: 16px;
        padding: 16px;
        border: 1px solid var(--border);
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .subject-tabs {
        margin-top: 20px;
        background: var(--card-bg);
        border-radius: 16px;
        border: 1px solid var(--border);
        padding: 18px 16px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .subject-tab {
        border: none;
        border-radius: 999px;
        padding: 10px 18px;
        background: #edf2ff;
        color: #475569;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .subject-tab.active {
        background: var(--primary);
        color: #fff;
      }
      .filters input,
      .filters select {
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        min-width: 180px;
      }
      .table-wrapper {
        margin-top: 18px;
        background: var(--card-bg);
        border-radius: 22px;
        border: 1px solid var(--border);
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: #f8fafc;
      }
      th,
      td {
        padding: 14px 16px;
        border-bottom: 1px solid #f1f5f9;
        text-align: left;
        font-size: 14px;
        vertical-align: top;
      }
      tbody tr:hover {
        background: #f9fbff;
      }
      .highlight-cell {
        background: rgba(37, 99, 235, 0.08);
        color: var(--primary);
        font-weight: 600;
      }
      .empty-tip {
        text-align: center;
        padding: 60px 20px;
        color: var(--subtext);
      }
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .modal-backdrop.active {
        display: flex;
      }
      .modal {
        background: var(--card-bg);
        width: min(640px, 92vw);
        max-height: 90vh;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 30px 80px rgba(15, 23, 42, 0.25);
        position: relative;
        overflow-y: auto;
      }
      .modal.modal-wide {
        width: min(900px, 92vw);
      }
      .modal h2 {
        margin-top: 0;
        font-size: 20px;
      }
      .modal form {
        display: grid;
        gap: 12px;
      }
      .field-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .field-group label {
        flex: 1;
      }
      label span {
        display: block;
        font-size: 12px;
        margin-bottom: 2px;
        color: var(--subtext);
      }
      label input,
      label textarea,
      label select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      label textarea {
        min-height: 64px;
        resize: vertical;
      }
      .scores-list {
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 12px;
        background: #f8fafc;
      }
      .score-row {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }
      .score-row input {
        flex: 1;
      }
      .score-row button {
        border: none;
        background: transparent;
        color: var(--danger);
        cursor: pointer;
      }
      .range-config-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
      }
      .range-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }
      .range-row .range-label {
        font-weight: 600;
        min-width: 64px;
      }
      .range-row input {
        width: 90px;
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 6px 8px;
      }
      .config-tip {
        margin: 4px 0 0;
        color: var(--subtext);
        font-size: 13px;
      }
      .config-note {
        margin: 8px 0 0;
        font-size: 12px;
        color: var(--subtext);
      }
      .modal-footer {
        margin-top: 12px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }
      .grade-manager {
        display: grid;
        gap: 20px;
        margin-top: 20px;
      }
      .grade-card {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border);
        padding: 24px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
      }
      .grade-card h2 {
        margin-top: 0;
      }
      .collapsible-section {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border);
        padding: 0;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
        overflow: hidden;
      }
      .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
      }
      .collapsible-header:hover {
        background: #f8fafc;
      }
      .collapsible-header h2 {
        margin: 0;
        font-size: 18px;
      }
      .collapsible-toggle {
        font-size: 20px;
        color: var(--primary);
        transition: transform 0.3s ease;
      }
      .collapsible-toggle.expanded {
        transform: rotate(180deg);
      }
      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      .collapsible-content.expanded {
        max-height: 1000px;
      }
      .collapsible-body {
        padding: 0 24px 24px 24px;
      }
      .inline-form {
        display: grid;
        gap: 16px;
      }
      .inline-form label {
        display: flex;
        flex-direction: column;
        font-size: 14px;
        color: var(--subtext);
      }
      .inline-form input,
      .inline-form select {
        margin-top: 4px;
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 8px 10px;
      }
      .inline-form-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .inline-form-row label {
        flex: 1;
      }
      .import-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .hint-text {
        font-size: 13px;
        color: var(--subtext);
        margin-top: 8px;
      }
      .notification {
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: #111827;
        color: #fff;
        padding: 12px 18px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .notification.show {
        opacity: 1;
        transform: translateY(0);
      }
      .detail-tab {
        border: none;
        background: transparent;
        padding: 10px 20px;
        font-weight: 600;
        cursor: pointer;
        color: var(--subtext);
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
      }
      .detail-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .detail-tab-content {
        padding: 20px 0;
      }
      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }
      .info-item {
        padding: 12px;
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid var(--border);
      }
      .info-item label {
        display: block;
        font-size: 12px;
        color: var(--subtext);
        margin-bottom: 4px;
      }
      .info-item .value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
      }
      .overview-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }
      .overview-stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px;
        border-radius: 12px;
        text-align: center;
      }
      .overview-stat-card:nth-child(2) {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      .overview-stat-card:nth-child(3) {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      .overview-stat-card:nth-child(4) {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      }
      .overview-stat-card label {
        display: block;
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 4px;
      }
      .overview-stat-card .value {
        font-size: 24px;
        font-weight: 700;
      }
      #radarChart {
        max-width: 500px;
        margin: 0 auto;
      }
      .top-student-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        padding: 16px 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: box-shadow 0.2s ease;
      }
      .top-student-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
      .top-student-card .rank-badge {
        flex-shrink: 0;
        background: #f3f4f6;
        color: #111827;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
      }
      .top-student-card:nth-child(1) .rank-badge {
        background: #fef3c7;
        color: #92400e;
      }
      .top-student-card:nth-child(2) .rank-badge {
        background: #e0e7ff;
        color: #3730a3;
      }
      .top-student-card:nth-child(3) .rank-badge {
        background: #dbeafe;
        color: #1e40af;
      }
      .top-student-card .student-info-group {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 24px;
      }
      .top-student-card .student-name {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        min-width: 80px;
      }
      .top-student-card .student-detail {
        font-size: 14px;
        color: #6b7280;
      }
      .top-student-card .student-detail span {
        margin-right: 16px;
      }
      .top-student-card .score-display {
        flex-shrink: 0;
        text-align: right;
      }
      .top-student-card .avg-score {
        font-size: 24px;
        font-weight: 700;
        color: #111827;
      }
      .top-student-card .score-label {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 2px;
      }
      @media (max-width: 720px) {
        header.top-nav {
          flex-direction: column;
          align-items: flex-start;
          gap: 16px;
        }
        .filters {
          flex-direction: column;
        }
        .actions {
          width: 100%;
        }
        .btn {
          flex: 1;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <header class="top-nav">
      <div class="brand">ğŸ“Š æˆç»©ç®¡ç†</div>
      <nav>
        <ul>
          <li><button class="active" data-target="dashboard">ä»ªè¡¨ç›˜</button></li>
          <li><button data-target="grade">æˆç»©ç®¡ç†</button></li>
          <li><button data-target="data">æ•°æ®ç®¡ç†</button></li>
        </ul>
      </nav>
    </header>

    <div class="app-shell">
      <main data-section="dashboard" class="active">
        <div class="page-header">
          <div>
            <h1>æ•°æ®çœ‹æ¿</h1>
            <p>æˆç»©ç»Ÿè®¡æ¦‚è§ˆ</p>
          </div>
          <div class="actions">
            <button class="btn secondary" id="refreshBtn">åˆ·æ–°æ•°æ®</button>
          </div>
        </div>

        <section class="subject-tabs" id="subjectTabs"></section>

        <section class="stats-grid" id="statCards"></section>

        <section class="grade-card" style="margin-top: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2>è€ƒè¯•æˆç»©èµ°åŠ¿</h2>
            <div class="subject-tabs" style="margin: 0;">
              <button class="subject-tab active" data-trend-count="3">è¿‘3åœº</button>
              <button class="subject-tab" data-trend-count="5">è¿‘5åœº</button>
              <button class="subject-tab" data-trend-count="10">è¿‘10åœº</button>
            </div>
          </div>
          <div style="padding: 20px;">
            <canvas id="dashboardTrendChart" width="800" height="300"></canvas>
          </div>
          <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
            <h3 style="margin: 0 0 16px 0; font-size: 16px;">æ’åå‰5å­¦ç”Ÿ</h3>
            <div id="topStudentsGrid" style="display: flex; flex-direction: column; gap: 12px;"></div>
          </div>
        </section>

        <section class="grade-card" style="margin-top: 24px;">
          <h2>è€ƒè¯•å¯¹æ¯”åˆ†æ</h2>
          <p class="hint-text">é€‰æ‹©ä¸¤åœºè€ƒè¯•è¿›è¡Œå¯¹æ¯”åˆ†æï¼ŒæŸ¥çœ‹å¹³å‡åˆ†ã€åŠæ ¼ç‡ç­‰æŒ‡æ ‡çš„å˜åŒ–</p>
          <div class="inline-form-row" style="margin-top: 16px;">
            <label>
              ç¬¬ä¸€åœºè€ƒè¯•
              <select id="compareExam1Select">
                <option value="">è¯·é€‰æ‹©è€ƒè¯•</option>
              </select>
            </label>
            <label>
              ç¬¬äºŒåœºè€ƒè¯•
              <select id="compareExam2Select">
                <option value="">è¯·é€‰æ‹©è€ƒè¯•</option>
              </select>
            </label>
            <button class="btn" id="compareExamsBtn" style="align-self: flex-end;">å¼€å§‹å¯¹æ¯”</button>
          </div>
          <div id="examComparisonResult" style="margin-top: 24px; display: none;">
            <div class="stats-grid" id="comparisonStats"></div>
            <div style="padding: 20px; margin-top: 20px;">
              <canvas id="comparisonChart" width="800" height="400"></canvas>
            </div>
          </div>
        </section>
      </main>

      <main data-section="grade">
        <div class="page-header">
          <div>
            <h1>æˆç»©ç®¡ç†</h1>
            <p>æŸ¥çœ‹å’Œç®¡ç†å­¦ç”Ÿæˆç»©</p>
          </div>
          <div class="actions">
            <button class="btn" id="addStudentBtn">+ æ·»åŠ å­¦ç”Ÿ</button>
          </div>
        </div>

        <section class="filters">
          <input type="search" id="searchInput" placeholder="æŒ‰å§“å/å­¦å·æœç´¢" />
          <select id="classFilter"><option value="">å…¨éƒ¨ç­çº§</option></select>
          <select id="examFilter"><option value="">å…¨éƒ¨è€ƒè¯•</option></select>
          <button class="btn secondary compact-btn" id="columnSettingsBtn">âš™ï¸ åˆ—è®¾ç½®</button>
        </section>

        <section class="table-wrapper">
          <table class="ranking-table">
            <thead>
              <tr id="tableHeader">
                <th data-column="name">å§“å</th>
                <th data-column="student_no">å­¦å·</th>
                <th data-column="class_rank">ç­çº§æ’å</th>
                <th data-column="grade_rank">å¹´çº§æ’å</th>
                <th data-column="total_score">æ€»åˆ†</th>
                <th data-column="rating">è¯„åˆ†</th>
                <th data-column="è¯­æ–‡">è¯­æ–‡</th>
                <th data-column="æ•°å­¦">æ•°å­¦</th>
                <th data-column="è‹±è¯­">è‹±è¯­</th>
                <th data-column="ç‰©ç†">ç‰©ç†</th>
                <th data-column="åŒ–å­¦">åŒ–å­¦</th>
                <th data-column="ç”Ÿç‰©">ç”Ÿç‰©</th>
                <th data-column="å†å²">å†å²</th>
                <th data-column="æ”¿æ²»">æ”¿æ²»</th>
                <th data-column="åœ°ç†">åœ°ç†</th>
                <th data-column="actions">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="studentBody">
              <tr><td colspan="16" class="empty-tip">æ•°æ®åŠ è½½ä¸­...</td></tr>
            </tbody>
          </table>
        </section>
      </main>

      <main data-section="data">
        <div class="page-header">
          <div>
            <h1>æ•°æ®ç®¡ç†</h1>
            <p>æ‰¹é‡å¯¼å…¥å¯¼å‡ºæˆç»©ã€è®¾ç½®ç§‘ç›®åŒºé—´ã€‚</p>
          </div>
        </div>
        <div class="grade-manager">
          <section class="grade-card">
            <h2>ç­çº§ç®¡ç†åˆ—è¡¨</h2>
            <p class="hint-text">æŸ¥çœ‹æ‰€æœ‰ç­çº§çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬äººæ•°ã€æ€§åˆ«æ¯”ä¾‹ã€å¹³å‡åˆ†åŠå„é¡¹ç‡ã€‚</p>
            <div class="table-wrapper" style="margin-top:16px;">
              <table>
                <thead>
                  <tr>
                    <th>ç­çº§åç§°</th>
                    <th>å¹´çº§</th>
                    <th>äººæ•°</th>
                    <th>è€ƒè¯•åœºæ•°</th>
                    <th>ç”·ç”Ÿ</th>
                    <th>å¥³ç”Ÿ</th>
                    <th>æ€§åˆ«æ¯”ä¾‹(ç”·:å¥³)</th>
                    <th>ç­çº§å¹³å‡åˆ†</th>
                    <th>åŠæ ¼ç‡</th>
                    <th>è‰¯å¥½ç‡</th>
                    <th>ä¼˜ç§€ç‡</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="classStatsBody">
                  <tr><td colspan="12" class="empty-tip">æ•°æ®åŠ è½½ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
          </section>
          <section class="collapsible-section">
            <div class="collapsible-header" data-target="importSection">
              <h2>æ‰¹é‡å¯¼å…¥</h2>
              <span class="collapsible-toggle">â–¼</span>
            </div>
            <div class="collapsible-content" id="importSection">
              <div class="collapsible-body">
                <p class="hint-text">å…ˆä¸‹è½½æ¨¡æ¿å¹¶å½•å…¥æˆç»©ï¼Œå†ä¸Šä¼  Excelã€‚æ”¯æŒä¸€æ¬¡å¯¼å…¥ä¸€ä¸ªç­çº§çš„æŸæ¬¡è€ƒè¯•ã€‚</p>
                <div class="import-actions">
                  <button class="btn secondary" id="downloadTemplate">ä¸‹è½½å¯¼å…¥æ¨¡æ¿</button>
                </div>
                <form class="inline-form" id="importForm">
                  <div class="inline-form-row">
                    <label>ç­çº§ <input type="text" id="importClass" placeholder="ä¾‹ï¼šé«˜ä¸€(1)ç­" /></label>
                    <label>å¹´çº§ <input type="text" id="importGrade" placeholder="ä¾‹ï¼šé«˜ä¸€" /></label>
                  </div>
                  <div class="inline-form-row">
                    <label>è€ƒè¯•åç§° <input type="text" id="importExam" placeholder="ä¾‹ï¼šæœŸä¸­è€ƒè¯•" /></label>
                    <label>Excel æ–‡ä»¶
                      <input type="file" id="importFile" accept=".xlsx,.xls" required />
                    </label>
                  </div>
                  <div class="import-actions">
                    <button class="btn" type="submit">ä¸Šä¼ å¹¶å¯¼å…¥</button>
                  </div>
                </form>
              </div>
            </div>
          </section>
          <section class="collapsible-section">
            <div class="collapsible-header" data-target="exportSection">
              <h2>æˆç»©å¯¼å‡º</h2>
              <span class="collapsible-toggle">â–¼</span>
            </div>
            <div class="collapsible-content" id="exportSection">
              <div class="collapsible-body">
                <p class="hint-text">é€‰æ‹©ç­çº§æˆ–è€ƒè¯•å¯¼å‡ºæˆç»©ï¼Œè‹¥éƒ½ä¸ºç©ºåˆ™å¯¼å‡ºæ‰€æœ‰æ•°æ®ã€‚</p>
                <div class="inline-form-row">
                  <label>ç­çº§
                    <select id="exportClassSelect">
                      <option value="">å…¨éƒ¨ç­çº§</option>
                    </select>
                  </label>
                  <label>è€ƒè¯•
                    <select id="exportExamSelect">
                      <option value="">å…¨éƒ¨è€ƒè¯•</option>
                    </select>
                  </label>
                </div>
                <div class="import-actions">
                  <button class="btn secondary" id="exportBtn">å¯¼å‡º Excel</button>
                </div>
              </div>
            </div>
          </section>
          <section class="collapsible-section">
            <div class="collapsible-header" data-target="rangeSection">
              <h2>æˆç»©åŒºé—´è®¾ç½®</h2>
              <span class="collapsible-toggle">â–¼</span>
            </div>
            <div class="collapsible-content" id="rangeSection">
              <div class="collapsible-body">
                <p class="hint-text">ä¸ºæ¯ä¸ªç§‘ç›®å®šä¹‰ä¸åŠæ ¼/åŠæ ¼/è‰¯å¥½/ä¼˜ç§€çš„åˆ†æ•°èŒƒå›´ï¼Œä»ªè¡¨ç›˜ä¸æˆç»©ç®¡ç†å…±ç”¨ã€‚</p>
                <div class="inline-form-row">
                  <label>
                    ç§‘ç›®
                    <select id="rangeSubjectSelect"></select>
                  </label>
                </div>
                <form id="rangeForm">
                  <div class="range-config-list" id="rangeRows"></div>
                  <div class="import-actions">
                    <button class="btn" type="submit">ä¿å­˜é…ç½®</button>
                  </div>
                </form>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
      <div class="modal modal-wide">
        <h2 id="modalTitle">æ·»åŠ å­¦ç”Ÿ</h2>
        <form id="studentForm">
          <div class="field-group">
            <label>
              <span>å§“å *</span>
              <input type="text" name="name" required />
            </label>
            <label>
              <span>å­¦å· *</span>
              <input type="text" name="student_no" required />
            </label>
            <label>
              <span>æ€§åˆ«</span>
              <select name="gender">
                <option value="">è¯·é€‰æ‹©</option>
                <option value="ç”·">ç”·</option>
                <option value="å¥³">å¥³</option>
              </select>
            </label>
          </div>
          <div class="field-group">
            <label>
              <span>ç­çº§</span>
              <input type="text" name="class_name" placeholder="ä¾‹ï¼šé«˜ä¸€(3)ç­" />
            </label>
            <label>
              <span>å¹´çº§</span>
              <input type="text" name="grade_name" placeholder="ä¾‹ï¼šé«˜ä¸€" />
            </label>
            <label>
              <span>è€ƒè¯•åç§°</span>
              <input type="text" name="exam_name" placeholder="ä¾‹ï¼šæœŸä¸­è€ƒè¯•" />
            </label>
          </div>
          <div class="field-group">
            <label>
              <span>ç­çº§æ’å</span>
              <input type="number" name="class_rank" min="1" placeholder="ä¾‹ï¼š5" />
            </label>
            <label>
              <span>å¹´çº§æ’å</span>
              <input type="number" name="grade_rank" min="1" placeholder="ä¾‹ï¼š20" />
            </label>
          </div>
          <label>
            <span>å¤‡æ³¨</span>
            <textarea name="notes" rows="2" placeholder="å¯å†™è¾…å¯¼å»ºè®®ã€å¼‚å¸¸æƒ…å†µç­‰"></textarea>
          </label>
          <div>
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight:600;">å„ç§‘æˆç»©</span>
              <button class="btn secondary compact-btn" type="button" id="addScoreRow">+ æ·»åŠ ç§‘ç›®</button>
            </div>
            <div class="scores-list" id="scoreList"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn secondary" id="cancelModal">å–æ¶ˆ</button>
            <button type="submit" class="btn">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal-backdrop" id="columnSettingsModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>åˆ—è®¾ç½®</h2>
        <p class="hint-text">é€‰æ‹©è¦åœ¨è¡¨æ ¼ä¸­æ˜¾ç¤ºçš„åˆ—</p>
        <div id="columnCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin: 16px 0; max-height: 60vh; overflow-y: auto;"></div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelColumnSettings">å–æ¶ˆ</button>
          <button type="button" class="btn" id="saveColumnSettings">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="studentDetailModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 800px;">
        <h2 id="detailStudentName">å­¦ç”Ÿä¿¡æ¯</h2>
        <form id="studentDetailForm">
          <div id="detailContent" style="max-height: 60vh; overflow-y: auto;">
            <div class="info-grid" id="studentInfoGrid"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn secondary" id="closeDetailModal">å…³é—­</button>
            <button type="button" class="btn" id="editDetailBtn">ç¼–è¾‘</button>
            <button type="submit" class="btn" id="saveDetailBtn" style="display: none;">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal-backdrop" id="classEditModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>ç¼–è¾‘ç­çº§</h2>
        <form id="classEditForm">
          <div class="field-group">
            <label>
              <span>ç­çº§åç§° *</span>
              <input type="text" name="class_name" id="editClassName" required />
            </label>
            <label>
              <span>å¹´çº§</span>
              <input type="text" name="grade_name" id="editGradeName" placeholder="ä¾‹ï¼šé«˜ä¸€" />
            </label>
          </div>
          <p class="hint-text">ä¿®æ”¹ç­çº§åç§°æˆ–å¹´çº§å°†æ›´æ–°è¯¥ç­çº§æ‰€æœ‰å­¦ç”Ÿçš„è®°å½•ã€‚</p>
          <div class="modal-footer">
            <button type="button" class="btn secondary" id="cancelClassEdit">å–æ¶ˆ</button>
            <button type="submit" class="btn">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal-backdrop" id="shareModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>ç”Ÿæˆåˆ†äº«é“¾æ¥</h2>
        <p class="hint-text">é€‰æ‹©è€ƒè¯•åœºæ¬¡å’ŒæŸ¥è¯¢é“¾æ¥çš„æœ‰æ•ˆæœŸï¼Œè¿‡æœŸåå®¶é•¿å°†æ— æ³•ä½¿ç”¨è¯¥é“¾æ¥æŸ¥è¯¢æˆç»©ã€‚</p>
        <div style="margin-top: 24px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">é€‰æ‹©è€ƒè¯•åœºæ¬¡ *</label>
          <select id="shareExamSelect" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px;">
            <option value="">å…¨éƒ¨è€ƒè¯•</option>
          </select>

          <label style="display: block; margin-bottom: 12px; font-weight: 600;">é€‰æ‹©æœ‰æ•ˆæœŸ</label>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <button type="button" class="btn secondary" data-days="3" style="padding: 16px;">3å¤©</button>
            <button type="button" class="btn secondary" data-days="7" style="padding: 16px;">7å¤©</button>
            <button type="button" class="btn secondary" data-days="15" style="padding: 16px;">15å¤©</button>
            <button type="button" class="btn secondary" data-days="30" style="padding: 16px;">30å¤©</button>
          </div>
          <div style="margin-top: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--subtext);">è‡ªå®šä¹‰å¤©æ•°</label>
            <input type="number" id="customDays" min="1" max="365" placeholder="è¾“å…¥1-365å¤©" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelShare">å–æ¶ˆ</button>
          <button type="button" class="btn" id="confirmShare">ç”Ÿæˆé“¾æ¥</button>
        </div>
      </div>
    </div>

    <div class="notification" id="notify"></div>

    <script>
      const API_BASE = "/api/students";
      const studentBody = document.getElementById("studentBody");
      const statCards = document.getElementById("statCards");
      const subjectTabsEl = document.getElementById("subjectTabs");
      const modalBackdrop = document.getElementById("modalBackdrop");
      const studentForm = document.getElementById("studentForm");
      const modalTitle = document.getElementById("modalTitle");
      const addStudentBtn = document.getElementById("addStudentBtn");
      const addStudentBtn2 = document.getElementById("addStudentBtn2");
      const cancelModal = document.getElementById("cancelModal");
      const addScoreRowBtn = document.getElementById("addScoreRow");
      const scoreList = document.getElementById("scoreList");
      const notify = document.getElementById("notify");
      const classFilter = document.getElementById("classFilter");
      const examFilter = document.getElementById("examFilter");
      const searchInput = document.getElementById("searchInput");
      const refreshBtn = document.getElementById("refreshBtn");
      const downloadTemplateBtn = document.getElementById("downloadTemplate");
      const importForm = document.getElementById("importForm");
      const importFileInput = document.getElementById("importFile");
      const importClassInput = document.getElementById("importClass");
      const importGradeInput = document.getElementById("importGrade");
      const importExamInput = document.getElementById("importExam");
      const exportClassSelect = document.getElementById("exportClassSelect");
      const exportExamSelect = document.getElementById("exportExamSelect");
      const exportBtn = document.getElementById("exportBtn");
      const rangeSubjectSelect = document.getElementById("rangeSubjectSelect");
      const rangeForm = document.getElementById("rangeForm");
      const rangeRows = document.getElementById("rangeRows");
      const columnSettingsBtn = document.getElementById("columnSettingsBtn");
      const columnSettingsModal = document.getElementById("columnSettingsModal");
      const columnCheckboxes = document.getElementById("columnCheckboxes");
      const cancelColumnSettings = document.getElementById("cancelColumnSettings");
      const saveColumnSettings = document.getElementById("saveColumnSettings");
      const studentDetailModal = document.getElementById("studentDetailModal");
      const detailStudentName = document.getElementById("detailStudentName");
      const studentInfoGrid = document.getElementById("studentInfoGrid");
      const closeDetailModal = document.getElementById("closeDetailModal");
      const editDetailBtn = document.getElementById("editDetailBtn");
      const saveDetailBtn = document.getElementById("saveDetailBtn");
      const studentDetailForm = document.getElementById("studentDetailForm");
      const classStatsBody = document.getElementById("classStatsBody");
      const classEditModal = document.getElementById("classEditModal");
      const classEditForm = document.getElementById("classEditForm");
      const editClassName = document.getElementById("editClassName");
      const editGradeName = document.getElementById("editGradeName");
      const cancelClassEdit = document.getElementById("cancelClassEdit");
      const compareExam1Select = document.getElementById("compareExam1Select");
      const compareExam2Select = document.getElementById("compareExam2Select");
      const compareExamsBtn = document.getElementById("compareExamsBtn");
      const examComparisonResult = document.getElementById("examComparisonResult");
      const comparisonStats = document.getElementById("comparisonStats");
      const comparisonChart = document.getElementById("comparisonChart");
      const shareModal = document.getElementById("shareModal");
      const cancelShare = document.getElementById("cancelShare");
      const confirmShare = document.getElementById("confirmShare");
      const customDays = document.getElementById("customDays");
      const shareExamSelect = document.getElementById("shareExamSelect");

      let students = [];
      let editingClassName = null;
      let summary = null;
      let editingId = null;
      let currentDetailStudent = null;
      let isEditingDetail = false;
      let classStats = [];
      let trendExamCount = 3;
      let shareClassName = null;
      let selectedDays = 30;

      const scoreSubjects = ["è¯­æ–‡", "æ•°å­¦", "è‹±è¯­", "ç‰©ç†", "åŒ–å­¦", "ç”Ÿç‰©", "å†å²", "æ”¿æ²»", "åœ°ç†"];
      const allColumns = [
        { key: "name", label: "å§“å", fixed: true },
        { key: "student_no", label: "å­¦å·", fixed: true },
        { key: "class_rank", label: "ç­çº§æ’å", fixed: false },
        { key: "grade_rank", label: "å¹´çº§æ’å", fixed: false },
        { key: "total_score", label: "æ€»åˆ†", fixed: false },
        { key: "rating", label: "è¯„åˆ†", fixed: false },
        ...scoreSubjects.map(s => ({ key: s, label: s, fixed: false })),
        { key: "actions", label: "æ“ä½œ", fixed: true }
      ];
      let visibleColumns = allColumns.map(c => c.key);
      const subjectTabsList = ["æ€»åˆ†", ...scoreSubjects];
      const rangeSubjects = ["æ€»åˆ†", ...scoreSubjects];
      const subjectsPreset = [...scoreSubjects];
      const DEFAULT_RANGE_TEMPLATE = [
        { key: "fail", name: "ä¸åŠæ ¼", min: 0, max: 60 },
        { key: "pass", name: "åŠæ ¼", min: 60, max: 80 },
        { key: "good", name: "è‰¯å¥½", min: 80, max: 90 },
        { key: "excellent", name: "ä¼˜ç§€", min: 90, max: 100 },
      ];
      let gradeRanges = {};
      let availableClasses = [];
      let availableExams = [];
      let selectedSubject = "æ€»åˆ†";
      let currentRangeSubject = "æ€»åˆ†";

      function createDefaultRanges() {
        return DEFAULT_RANGE_TEMPLATE.map((range) => ({ ...range }));
      }
      function getSubjectRanges(subject) {
        if (gradeRanges && gradeRanges[subject]) {
          return gradeRanges[subject];
        }
        return createDefaultRanges();
      }
      async function loadGradeConfig() {
        try {
          const res = await fetch(`${API_BASE}/ranges`);
          if (!res.ok) throw new Error("æ— æ³•è·å–åŒºé—´é…ç½®");
          gradeRanges = await res.json();
        } catch (error) {
          gradeRanges = {};
          showToast(error.message, true);
        }
        renderRangeSubjectOptions();
        renderRangeRows();
      }
      function renderRangeSubjectOptions() {
        if (!rangeSubjectSelect) return;
        rangeSubjectSelect.innerHTML = rangeSubjects
          .map((subject) => `<option value="${subject}">${subject}</option>`)
          .join("");
        rangeSubjectSelect.value = currentRangeSubject;
      }
      function renderRangeRows() {
        if (!rangeRows) return;
        const ranges = getSubjectRanges(currentRangeSubject);
        rangeRows.innerHTML = ranges
          .map(
            (range) => `
            <div class="range-row" data-key="${range.key}">
              <div class="range-label">${range.name}</div>
              <input type="number" data-field="min" step="0.1" value="${range.min}" placeholder="æœ€ä½åˆ†" required />
              <span>è‡³</span>
              <input type="number" data-field="max" step="0.1" value="${range.max ?? ""}" placeholder="æœ€é«˜åˆ†ï¼ˆå¯ç©ºï¼‰" />
            </div>
          `,
          )
          .join("");
      }

      renderSubjectTabs();

      document.querySelectorAll("nav button").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll("nav button").forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const target = btn.dataset.target;
          document.querySelectorAll("main[data-section]").forEach((section) => {
            section.classList.toggle("active", section.dataset.section === target);
          });
        });
      });

      function showToast(message, isError = false) {
        notify.textContent = message;
        notify.style.background = isError ? "#b91c1c" : "#111827";
        notify.classList.add("show");
        setTimeout(() => notify.classList.remove("show"), 2600);
      }

      function openModal(student) {
        editingId = student ? student.id : null;
        modalTitle.textContent = student ? "ç¼–è¾‘å­¦ç”Ÿ" : "æ·»åŠ å­¦ç”Ÿ";
        studentForm.reset();
        scoreList.innerHTML = "";
        const scores = student?.scores?.length ? student.scores : subjectsPreset.map((s) => ({ subject: s, score: "" }));
        scores.forEach((row) => addScoreRow(row.subject, row.score));
        ["name", "student_no", "class_name", "grade_name", "exam_name", "notes", "class_rank", "grade_rank"].forEach((field) => {
          studentForm.elements[field].value = student?.[field] ?? "";
        });
        modalBackdrop.classList.add("active");
      }
      function closeModal() {
        modalBackdrop.classList.remove("active");
      }

      function addScoreRow(subject = "", score = "") {
        const wrapper = document.createElement("div");
        wrapper.className = "score-row";
        wrapper.innerHTML = `
          <input type="text" placeholder="ç§‘ç›®" value="${subject}" />
          <input type="number" placeholder="åˆ†æ•°" value="${score}" min="0" max="150" step="0.5" />
          <button type="button" title="åˆ é™¤è¿™è¡Œ">Ã—</button>
        `;
        wrapper.querySelector("button").addEventListener("click", () => wrapper.remove());
        scoreList.appendChild(wrapper);
      }

      function getScoresFromForm() {
        const rows = [...scoreList.querySelectorAll(".score-row")];
        const scores = [];
        rows.forEach((row) => {
          const [subjectInput, scoreInput] = row.querySelectorAll("input");
          const subject = subjectInput.value.trim();
          const scoreValue = scoreInput.value.trim();
          if (!subject && !scoreValue) return;
          const score = Number(scoreValue);
          if (!subject || Number.isNaN(score)) return;
          scores.push({ subject, score });
        });
        return scores;
      }

      async function saveStudent(event) {
        event.preventDefault();
        const form = new FormData(studentForm);
        const payload = Object.fromEntries(form.entries());
        payload.scores = getScoresFromForm();
        if (payload.scores.length === 0) {
          showToast("è¯·è‡³å°‘å½•å…¥ä¸€ä¸ªç§‘ç›®æˆç»©", true);
          return;
        }

        // è½¬æ¢æ•°å­—å­—æ®µï¼Œç©ºå€¼è½¬ä¸º null
        if (payload.class_rank) {
          payload.class_rank = parseInt(payload.class_rank);
        } else {
          delete payload.class_rank;
        }

        if (payload.grade_rank) {
          payload.grade_rank = parseInt(payload.grade_rank);
        } else {
          delete payload.grade_rank;
        }

        // æ¸…ç†ç©ºå­—ç¬¦ä¸²å­—æ®µ
        Object.keys(payload).forEach(key => {
          if (payload[key] === '') {
            delete payload[key];
          }
        });

        const method = editingId ? "PUT" : "POST";
        const url = editingId ? `${API_BASE}/${editingId}` : API_BASE;
        try {
          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "ä¿å­˜å¤±è´¥");
          }
          showToast("ä¿å­˜æˆåŠŸ");
          closeModal();
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function deleteStudent(id) {
        if (!confirm("ç¡®è®¤åˆ é™¤è¯¥å­¦ç”Ÿè®°å½•ï¼Ÿ")) return;
        try {
          const res = await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
          if (!res.ok) throw new Error("åˆ é™¤å¤±è´¥");
          showToast("å·²åˆ é™¤");
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      function renderStats() {
        if (!summary) {
          statCards.innerHTML = "";
          return;
        }

        // è®¡ç®—ç­çº§æ•°
        const classSet = new Set();
        students.forEach(student => {
          if (student.class_name) classSet.add(student.class_name);
        });
        const classCount = classSet.size;

        // è®¡ç®—è€ƒè¯•åœºæ¬¡
        const examSet = new Set();
        students.forEach(student => {
          if (student.exam_name) examSet.add(student.exam_name);
        });
        const examCount = examSet.size;

        const cards = [
          { label: "å­¦ç”Ÿæ€»æ•°", value: summary.total_students },
          { label: "ç­çº§æ•°", value: classCount },
          { label: "è€ƒè¯•åœºæ¬¡", value: examCount },
          { label: "å¹³å‡æ€»åˆ†", value: summary.average_total },
          { label: "æœ€é«˜æ€»åˆ†", value: summary.highest_total ?? "-", extra: summary.highest_student ? `(${summary.highest_student})` : "" },
          { label: "åŠæ ¼ç‡", value: `${summary.pass_rate}%` },
          { label: "è‰¯å¥½ç‡", value: `${summary.good_rate}%` },
          { label: "ä¼˜ç§€ç‡", value: `${summary.excellent_rate}%` },
        ];
        statCards.innerHTML = cards
          .map(
            (card) => `
            <div class="stat-card">
              <h3>${card.label}</h3>
              <div class="value">${card.value}</div>
              ${card.extra ? `<div class="chip">${card.extra}</div>` : ""}
            </div>
          `,
          )
          .join("");
      }

      function renderSubjectTabs() {
        if (!subjectTabsEl) return;
        subjectTabsEl.innerHTML = subjectTabsList
          .map(
            (subject) => `
            <button class="subject-tab ${selectedSubject === subject ? "active" : ""}" data-subject="${subject}">
              ${subject}
            </button>
          `,
          )
          .join("");
      }

      function renderFilters() {
        const classes = new Set();
        const exams = new Set();
        students.forEach((student) => {
          if (student.class_name) classes.add(student.class_name);
          if (student.exam_name) exams.add(student.exam_name);
        });
        availableClasses = [...classes];
        availableExams = [...exams];
        populateSelect(classFilter, availableClasses, "å…¨éƒ¨ç­çº§", true);
        populateSelect(examFilter, availableExams, "å…¨éƒ¨è€ƒè¯•", true);
        populateSelect(exportClassSelect, availableClasses, "å…¨éƒ¨ç­çº§", true);
        populateSelect(exportExamSelect, availableExams, "å…¨éƒ¨è€ƒè¯•", true);
        populateSelect(compareExam1Select, availableExams, "è¯·é€‰æ‹©è€ƒè¯•", true);
        populateSelect(compareExam2Select, availableExams, "è¯·é€‰æ‹©è€ƒè¯•", true);
        renderSubjectTabs();
      }

      function populateSelect(selectEl, values, placeholder, includeEmpty) {
        if (!selectEl) return;
        const options = includeEmpty ? `<option value="">${placeholder}</option>` : "";
        selectEl.innerHTML = options + values.map((value) => `<option value="${value}">${value}</option>`).join("");
      }

      function loadColumnSettings() {
        const saved = localStorage.getItem("visibleColumns");
        if (saved) {
          try {
            visibleColumns = JSON.parse(saved);
          } catch (e) {
            visibleColumns = allColumns.map(c => c.key);
          }
        }
      }

      function saveColumnSettingsToStorage() {
        localStorage.setItem("visibleColumns", JSON.stringify(visibleColumns));
      }

      function openColumnSettings() {
        columnCheckboxes.innerHTML = allColumns.map(col => `
          <label style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 8px; background: #f8fafc; cursor: ${col.fixed ? 'not-allowed' : 'pointer'}; white-space: nowrap;">
            <input type="checkbox" value="${col.key}" ${visibleColumns.includes(col.key) ? 'checked' : ''} ${col.fixed ? 'disabled' : ''} style="cursor: ${col.fixed ? 'not-allowed' : 'pointer'};">
            <span style="color: ${col.fixed ? '#9ca3af' : 'inherit'}; font-size: 14px;">${col.label}${col.fixed ? ' (å¿…éœ€)' : ''}</span>
          </label>
        `).join('');
        columnSettingsModal.classList.add("active");
      }

      function closeColumnSettings() {
        columnSettingsModal.classList.remove("active");
      }

      function applyColumnSettings() {
        const checkboxes = columnCheckboxes.querySelectorAll('input[type="checkbox"]');
        visibleColumns = Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);
        saveColumnSettingsToStorage();
        updateTableColumns();
        closeColumnSettings();
        renderTable();
      }

      function updateTableColumns() {
        const headers = document.querySelectorAll('#tableHeader th');
        headers.forEach(th => {
          const column = th.getAttribute('data-column');
          th.style.display = visibleColumns.includes(column) ? '' : 'none';
        });
      }

      function openStudentDetail(studentId) {
        const student = students.find(s => s.id === studentId);
        if (!student) return;

        currentDetailStudent = student;
        isEditingDetail = false;
        detailStudentName.textContent = `${student.name} - å­¦ç”Ÿä¿¡æ¯`;

        renderStudentInfo(student, false);

        editDetailBtn.style.display = '';
        saveDetailBtn.style.display = 'none';
        studentDetailModal.classList.add("active");
      }

      function closeStudentDetail() {
        studentDetailModal.classList.remove("active");
        currentDetailStudent = null;
        isEditingDetail = false;
      }

      function renderStudentInfo(student, isEditing) {
        const fields = [
          { key: 'name', label: 'å§“å', type: 'text', required: true },
          { key: 'student_no', label: 'å­¦å·', type: 'text', required: true },
          { key: 'gender', label: 'æ€§åˆ«', type: 'text' },
          { key: 'birthday', label: 'ç”Ÿæ—¥', type: 'date' },
          { key: 'class_name', label: 'ç­çº§', type: 'text' },
          { key: 'grade_name', label: 'å¹´çº§', type: 'text' },
          { key: 'exam_name', label: 'è€ƒè¯•åç§°', type: 'text' },
          { key: 'class_rank', label: 'ç­çº§æ’å', type: 'number' },
          { key: 'grade_rank', label: 'å¹´çº§æ’å', type: 'number' },
          { key: 'parent_name', label: 'å®¶é•¿å§“å', type: 'text' },
          { key: 'parent_phone', label: 'å®¶é•¿ç”µè¯', type: 'tel' },
          { key: 'notes', label: 'å¤‡æ³¨', type: 'textarea', fullWidth: true }
        ];

        if (isEditing) {
          studentInfoGrid.innerHTML = fields.map(field => {
            const value = student[field.key] || '';
            if (field.type === 'textarea') {
              return `
                <div class="info-item" style="${field.fullWidth ? 'grid-column: 1 / -1;' : ''}">
                  <label>${field.label}${field.required ? ' *' : ''}</label>
                  <textarea name="${field.key}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); min-height: 80px;" ${field.required ? 'required' : ''}>${value}</textarea>
                </div>
              `;
            }
            return `
              <div class="info-item" style="${field.fullWidth ? 'grid-column: 1 / -1;' : ''}">
                <label>${field.label}${field.required ? ' *' : ''}</label>
                <input type="${field.type}" name="${field.key}" value="${value}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border);" ${field.required ? 'required' : ''} />
              </div>
            `;
          }).join('');
        } else {
          studentInfoGrid.innerHTML = fields.map(field => {
            const value = student[field.key] || '-';
            return `
              <div class="info-item" style="${field.fullWidth ? 'grid-column: 1 / -1;' : ''}">
                <label>${field.label}</label>
                <div class="value">${value}</div>
              </div>
            `;
          }).join('');
        }
      }

      function enableDetailEdit() {
        if (!currentDetailStudent) return;
        isEditingDetail = true;
        renderStudentInfo(currentDetailStudent, true);
        editDetailBtn.style.display = 'none';
        saveDetailBtn.style.display = '';
      }

      async function saveDetailEdit(event) {
        event.preventDefault();
        if (!currentDetailStudent) return;

        const formData = new FormData(studentDetailForm);
        const payload = Object.fromEntries(formData.entries());

        // è½¬æ¢æ•°å­—å­—æ®µ
        if (payload.class_rank) {
          payload.class_rank = parseInt(payload.class_rank);
        } else {
          delete payload.class_rank;
        }

        if (payload.grade_rank) {
          payload.grade_rank = parseInt(payload.grade_rank);
        } else {
          delete payload.grade_rank;
        }

        // æ¸…ç†ç©ºå­—ç¬¦ä¸²å­—æ®µ
        Object.keys(payload).forEach(key => {
          if (payload[key] === '') {
            delete payload[key];
          }
        });

        // ä¿ç•™åŸæœ‰çš„æˆç»©æ•°æ®
        payload.scores = currentDetailStudent.scores;

        try {
          const res = await fetch(`${API_BASE}/${currentDetailStudent.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'ä¿å­˜å¤±è´¥');
          }

          showToast('ä¿å­˜æˆåŠŸ');
          await loadStudents();
          await loadClassStats();

          // æ›´æ–°å½“å‰å­¦ç”Ÿæ•°æ®å¹¶åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼
          const updatedStudent = students.find(s => s.id === currentDetailStudent.id);
          if (updatedStudent) {
            currentDetailStudent = updatedStudent;
            detailStudentName.textContent = `${updatedStudent.name} - å­¦ç”Ÿä¿¡æ¯`;
            renderStudentInfo(updatedStudent, false);
            isEditingDetail = false;
            editDetailBtn.style.display = '';
            saveDetailBtn.style.display = 'none';
          }
        } catch (error) {
          showToast(error.message, true);
        }
      }

      function applyFilters(student) {
        const keyword = searchInput.value.trim().toLowerCase();
        if (keyword) {
          const hit = student.name.toLowerCase().includes(keyword) || student.student_no.toLowerCase().includes(keyword);
          if (!hit) return false;
        }
        if (classFilter.value && student.class_name !== classFilter.value) return false;
        if (examFilter.value && student.exam_name !== examFilter.value) return false;
        if (selectedSubject !== "æ€»åˆ†") {
          const hasScore = student.scores.some((item) => item.subject === selectedSubject);
          if (!hasScore) return false;
        }
        return true;
      }

      function renderTable() {
        updateTableColumns();
        if (!students.length) {
          studentBody.innerHTML = `<tr><td colspan="${visibleColumns.length}" class="empty-tip">æš‚æœªå½•å…¥ä»»ä½•å­¦ç”Ÿæ•°æ®ï¼Œç‚¹å‡»"æ·»åŠ å­¦ç”Ÿ"å¼€å§‹å§ã€‚</td></tr>`;
          return;
        }
        const filtered = students.filter(applyFilters);
        const rows = filtered
          .sort((a, b) => {
            const scoreA = getSubjectScore(a, selectedSubject);
            const scoreB = getSubjectScore(b, selectedSubject);
            return scoreB - scoreA;
          })
          .map((student, index) => {
            const scoreMap = Object.fromEntries(student.scores.map((item) => [item.subject, item.score]));
            const rating = getPerformanceLabel(getSubjectScore(student, "æ€»åˆ†"), "æ€»åˆ†");

            const cellData = {
              name: student.name,
              student_no: student.student_no,
              class_rank: student.class_rank ?? "-",
              grade_rank: student.grade_rank ?? "-",
              total_score: Number(student.total_score || 0).toFixed(1),
              rating: rating,
              ...Object.fromEntries(scoreSubjects.map(key => [
                key,
                scoreMap[key] ?? "-"
              ])),
              actions: `
                <button class="btn secondary compact-btn" type="button" data-view="${student.id}">æŸ¥çœ‹</button>
                <button class="btn secondary compact-btn" type="button" data-edit="${student.id}" style="margin-left:4px;">ç¼–è¾‘</button>
                <button class="btn danger compact-btn" type="button" data-delete="${student.id}" style="margin-left:4px;">åˆ é™¤</button>
              `
            };

            const cells = visibleColumns.map(col => {
              const value = cellData[col];
              const cls = selectedSubject === col ? "highlight-cell" : "";
              return `<td class="${cls}" data-column="${col}" style="${visibleColumns.includes(col) ? '' : 'display:none;'}">${value}</td>`;
            }).join("");

            return `<tr>${cells}</tr>`;
          })
          .join("");
        studentBody.innerHTML = rows || `<tr><td colspan="${visibleColumns.length}" class="empty-tip">æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„æ•°æ®ã€‚</td></tr>`;
      }

      function getPerformanceLabel(value, subject) {
        const ranges = getSubjectRanges(subject);
        if (!ranges) return "-";
        if (inRange(ranges.find((r) => r.key === "excellent"), value)) return "ä¼˜ç§€";
        if (inRange(ranges.find((r) => r.key === "good"), value)) return "è‰¯å¥½";
        if (inRange(ranges.find((r) => r.key === "pass"), value)) return "åŠæ ¼";
        return "ä¸åŠæ ¼";
      }


      function enrichStudent(student) {
        const scores = Array.isArray(student.scores) ? student.scores : [];
        const totalFromScores = scores.reduce((sum, item) => sum + Number(item.score || 0), 0);
        const totalScore = typeof student.total_score === "number" ? student.total_score : totalFromScores;
        const averageScore =
          typeof student.average_score === "number"
            ? student.average_score
            : scores.length
              ? totalScore / scores.length
              : 0;
        return {
          ...student,
          scores,
          total_score: Number(totalScore.toFixed(2)),
          average_score: Number(averageScore.toFixed(2)),
        };
      }

      function getSubjectScore(student, subject) {
        if (subject === "æ€»åˆ†") return Number(student.total_score || 0);
        const score = student.scores.find((item) => item.subject === subject);
        return score ? Number(score.score || 0) : 0;
      }

      async function loadStudents() {
        try {
          const res = await fetch(API_BASE);
          students = (await res.json()).map(enrichStudent);
          renderFilters();
          renderTable();
          updateSummary();
          await loadClassStats();
        } catch (error) {
          studentBody.innerHTML = `<tr><td colspan="14" class="empty-tip">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
        }
      }

      async function loadClassStats() {
        try {
          const res = await fetch(`${API_BASE}/class-stats`);
          if (!res.ok) throw new Error("åŠ è½½ç­çº§ç»Ÿè®¡å¤±è´¥");
          classStats = await res.json();
          renderClassStats();
        } catch (error) {
          if (classStatsBody) {
            classStatsBody.innerHTML = `<tr><td colspan="11" class="empty-tip">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
          }
        }
      }

      function renderClassStats() {
        if (!classStatsBody) return;
        if (!classStats || classStats.length === 0) {
          classStatsBody.innerHTML = '<tr><td colspan="12" class="empty-tip">æš‚æ— ç­çº§æ•°æ®</td></tr>';
          return;
        }

        const rows = classStats.map(cls => {
          const genderRatio = `${cls.male_ratio}% : ${cls.female_ratio}%`;
          return `
            <tr>
              <td>${cls.class_name}</td>
              <td>${cls.grade_name || '-'}</td>
              <td>${cls.total_students}</td>
              <td>${cls.exam_count}</td>
              <td>${cls.male_count}</td>
              <td>${cls.female_count}</td>
              <td>${genderRatio}</td>
              <td>${cls.average_score.toFixed(2)}</td>
              <td>${cls.pass_rate}%</td>
              <td>${cls.good_rate}%</td>
              <td>${cls.excellent_rate}%</td>
              <td>
                <button class="btn compact-btn" type="button" data-share-class="${cls.class_name}">åˆ†äº«æŸ¥è¯¢</button>
                <button class="btn secondary compact-btn" type="button" data-edit-class="${cls.class_name}" style="margin-left:4px;">ç¼–è¾‘</button>
                <button class="btn danger compact-btn" type="button" data-delete-class="${cls.class_name}" style="margin-left:4px;">åˆ é™¤</button>
              </td>
            </tr>
          `;
        }).join('');

        classStatsBody.innerHTML = rows;
      }

      function openClassEditModal(className) {
        const classData = classStats.find(c => c.class_name === className);
        if (!classData) return;

        editingClassName = className;
        editClassName.value = className;
        editGradeName.value = classData.grade_name || '';
        classEditModal.classList.add('active');
      }

      function closeClassEditModal() {
        classEditModal.classList.remove('active');
        editingClassName = null;
      }

      async function saveClassEdit(event) {
        event.preventDefault();
        if (!editingClassName) return;

        const newClassName = editClassName.value.trim();
        const newGradeName = editGradeName.value.trim();

        if (!newClassName) {
          showToast('ç­çº§åç§°ä¸èƒ½ä¸ºç©º', true);
          return;
        }

        try {
          const params = new URLSearchParams();
          params.append('new_class_name', newClassName);
          if (newGradeName) {
            params.append('new_grade_name', newGradeName);
          }

          const res = await fetch(`${API_BASE}/class/${encodeURIComponent(editingClassName)}/rename?${params.toString()}`, {
            method: 'PUT'
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'æ›´æ–°å¤±è´¥');
          }

          const result = await res.json();
          showToast(`å·²æ›´æ–° ${result.updated_count} æ¡è®°å½•`);
          closeClassEditModal();
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function deleteClass(className) {
        if (!confirm(`ç¡®è®¤åˆ é™¤ç­çº§"${className}"åŠå…¶æ‰€æœ‰å­¦ç”Ÿè®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

        try {
          const res = await fetch(`${API_BASE}/class/${encodeURIComponent(className)}`, {
            method: 'DELETE'
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'åˆ é™¤å¤±è´¥');
          }

          const result = await res.json();
          showToast(`å·²åˆ é™¤ç­çº§åŠ ${result.deleted_count} æ¡å­¦ç”Ÿè®°å½•`);
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      function inRange(range, value) {
        if (!range) return false;
        const minOk = value >= Number(range.min ?? Number.NEGATIVE_INFINITY);
        const maxOk = range.max == null ? true : value <= Number(range.max);
        return minOk && maxOk;
      }

      function computeSummaryFromStudents(list, subject = "æ€»åˆ†") {
        if (!list.length) {
          return {
            total_students: 0,
            average_total: 0,
            highest_total: null,
            highest_student: null,
            pass_rate: 0,
            good_rate: 0,
            excellent_rate: 0,
          };
        }
        const ranges = getSubjectRanges(subject);
        const passRange = ranges.find((item) => item.key === "pass");
        const goodRange = ranges.find((item) => item.key === "good");
        const excellentRange = ranges.find((item) => item.key === "excellent");
        let totalScores = 0;
        let highestTotal = -Infinity;
        let highestName = null;
        let passCount = 0;
        let goodCount = 0;
        let excellentCount = 0;
        list.forEach((student) => {
          // å¯¹äºæ€»åˆ†ï¼Œä½¿ç”¨æ€»åˆ†ï¼›å¯¹äºå•ç§‘ï¼Œä½¿ç”¨å•ç§‘åˆ†æ•°
          const value = subject === "æ€»åˆ†" ? Number(student.total_score || 0) : getSubjectScore(student, subject);
          totalScores += value;
          if (value > highestTotal) {
            highestTotal = value;
            highestName = student.name;
          }

          // åˆ¤æ–­ç­‰çº§æ—¶ï¼šæ€»åˆ†ä½¿ç”¨å¹³å‡åˆ†ï¼Œå•ç§‘ä½¿ç”¨å•ç§‘åˆ†æ•°
          const scoreForRate = subject === "æ€»åˆ†" ? Number(student.average_score || 0) : value;

          // æŒ‰ä¼˜å…ˆçº§æ£€æŸ¥ï¼šä¼˜ç§€ > è‰¯å¥½ > åŠæ ¼
          // ä¼˜ç§€çš„å­¦ç”Ÿä¹Ÿç®—è‰¯å¥½å’ŒåŠæ ¼ï¼Œè‰¯å¥½çš„å­¦ç”Ÿä¹Ÿç®—åŠæ ¼
          if (inRange(excellentRange, scoreForRate)) {
            excellentCount++;
            goodCount++; // ä¼˜ç§€çš„å­¦ç”Ÿä¹Ÿç®—è‰¯å¥½
            passCount++; // ä¼˜ç§€çš„å­¦ç”Ÿä¹Ÿç®—åŠæ ¼
          } else if (inRange(goodRange, scoreForRate)) {
            goodCount++;
            passCount++; // è‰¯å¥½çš„å­¦ç”Ÿä¹Ÿç®—åŠæ ¼
          } else if (inRange(passRange, scoreForRate)) {
            passCount++;
          }
        });
        const totalStudents = list.length;
        return {
          total_students: totalStudents,
          average_total: Number((totalScores / totalStudents).toFixed(2)),
            highest_total: highestTotal === -Infinity ? null : Number(highestTotal.toFixed(2)),
            highest_student: highestName,
            pass_rate: Number(((passCount / totalStudents) * 100).toFixed(2)),
            good_rate: Number(((goodCount / totalStudents) * 100).toFixed(2)),
            excellent_rate: Number(((excellentCount / totalStudents) * 100).toFixed(2)),
        };
      }

      function updateSummary() {
        // åº”ç”¨ç­›é€‰æ¡ä»¶ï¼Œç¡®ä¿ç»Ÿè®¡æ•°æ®ä¸è¡¨æ ¼æ•°æ®ä¸€è‡´
        const filtered = students.filter(applyFilters);
        summary = computeSummaryFromStudents(filtered, selectedSubject);
        renderStats();
        renderDashboardTrendChart();
        renderTopStudents();
      }

      function renderDashboardTrendChart() {
        const canvas = document.getElementById('dashboardTrendChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const padding = 60;
        const chartWidth = width - padding * 2;
        const chartHeight = height - padding * 2;

        ctx.clearRect(0, 0, width, height);

        if (students.length === 0) {
          ctx.fillStyle = '#6b7280';
          ctx.font = '14px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('æš‚æ— å­¦ç”Ÿæ•°æ®', width / 2, height / 2);
          return;
        }

        // å®šä¹‰è¦æ˜¾ç¤ºçš„ç§‘ç›®
        const subjects = ["è¯­æ–‡", "æ•°å­¦", "è‹±è¯­", "ç‰©ç†", "åŒ–å­¦", "ç”Ÿç‰©", "å†å²", "æ”¿æ²»", "åœ°ç†"];

        // è®¡ç®—æ¯ä¸ªç§‘ç›®çš„ç»Ÿè®¡æ•°æ®
        const subjectStats = subjects.map(subject => {
          const stats = computeSummaryFromStudents(students, subject);
          return {
            name: subject,
            avgScore: stats.average_total,
            excellentRate: stats.excellent_rate,
            goodRate: stats.good_rate
          };
        });

        // è®¡ç®—åˆ†æ•°èŒƒå›´ï¼ˆå·¦Yè½´ï¼‰
        const scores = subjectStats.map(s => s.avgScore);
        const maxScore = Math.max(...scores);
        const minScore = Math.min(...scores);
        const yMin = Math.max(0, minScore - 10);
        const yMax = maxScore + 10;
        const yRange = yMax - yMin;

        // å³Yè½´å›ºå®šä¸º0-100%
        const rateMax = 100;

        // ç»˜åˆ¶ç½‘æ ¼çº¿å’ŒYè½´æ ‡ç­¾
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding + (chartHeight / 5) * i;
          ctx.beginPath();
          ctx.moveTo(padding, y);
          ctx.lineTo(width - padding, y);
          ctx.stroke();

          // å·¦Yè½´æ ‡ç­¾ï¼ˆåˆ†æ•°ï¼‰
          const score = yMax - (yRange / 5) * i;
          ctx.fillStyle = '#3b82f6';
          ctx.font = '12px sans-serif';
          ctx.textAlign = 'right';
          ctx.fillText(score.toFixed(0), padding - 10, y + 4);

          // å³Yè½´æ ‡ç­¾ï¼ˆç™¾åˆ†æ¯”ï¼‰
          const rate = rateMax - (rateMax / 5) * i;
          ctx.fillStyle = '#10b981';
          ctx.textAlign = 'left';
          ctx.fillText(rate.toFixed(0) + '%', width - padding + 10, y + 4);
        }

        const pointSpacing = subjectStats.length > 1 ? chartWidth / (subjectStats.length - 1) : chartWidth / 2;

        // ç»˜åˆ¶å¹³å‡åˆ†æŠ˜çº¿ï¼ˆè“è‰²ï¼‰
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 3;
        ctx.beginPath();
        subjectStats.forEach((stat, i) => {
          const x = padding + (subjectStats.length > 1 ? pointSpacing * i : chartWidth / 2);
          const y = padding + chartHeight - ((stat.avgScore - yMin) / yRange) * chartHeight;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // ç»˜åˆ¶ä¼˜ç§€ç‡æŠ˜çº¿ï¼ˆç»¿è‰²ï¼‰
        ctx.strokeStyle = '#10b981';
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        subjectStats.forEach((stat, i) => {
          const x = padding + (subjectStats.length > 1 ? pointSpacing * i : chartWidth / 2);
          const y = padding + chartHeight - (stat.excellentRate / rateMax) * chartHeight;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // ç»˜åˆ¶è‰¯å¥½ç‡æŠ˜çº¿ï¼ˆæ©™è‰²ï¼‰
        ctx.strokeStyle = '#f59e0b';
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        subjectStats.forEach((stat, i) => {
          const x = padding + (subjectStats.length > 1 ? pointSpacing * i : chartWidth / 2);
          const y = padding + chartHeight - (stat.goodRate / rateMax) * chartHeight;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // ç»˜åˆ¶å¹³å‡åˆ†æ•°æ®ç‚¹
        ctx.fillStyle = '#3b82f6';
        subjectStats.forEach((stat, i) => {
          const x = padding + (subjectStats.length > 1 ? pointSpacing * i : chartWidth / 2);
          const y = padding + chartHeight - ((stat.avgScore - yMin) / yRange) * chartHeight;
          ctx.beginPath();
          ctx.arc(x, y, 5, 0, Math.PI * 2);
          ctx.fill();

          // æ˜¾ç¤ºåˆ†æ•°
          ctx.fillStyle = '#1e40af';
          ctx.font = 'bold 11px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(stat.avgScore.toFixed(1), x, y - 12);
        });

        // ç»˜åˆ¶ä¼˜ç§€ç‡æ•°æ®ç‚¹
        ctx.fillStyle = '#10b981';
        subjectStats.forEach((stat, i) => {
          const x = padding + (subjectStats.length > 1 ? pointSpacing * i : chartWidth / 2);
          const y = padding + chartHeight - (stat.excellentRate / rateMax) * chartHeight;
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();

          // æ˜¾ç¤ºä¼˜ç§€ç‡
          ctx.fillStyle = '#059669';
          ctx.font = 'bold 10px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(stat.excellentRate.toFixed(1) + '%', x + 25, y);
        });

        // ç»˜åˆ¶è‰¯å¥½ç‡æ•°æ®ç‚¹
        ctx.fillStyle = '#f59e0b';
        subjectStats.forEach((stat, i) => {
          const x = padding + (subjectStats.length > 1 ? pointSpacing * i : chartWidth / 2);
          const y = padding + chartHeight - (stat.goodRate / rateMax) * chartHeight;
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();

          // æ˜¾ç¤ºè‰¯å¥½ç‡
          ctx.fillStyle = '#d97706';
          ctx.font = 'bold 10px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(stat.goodRate.toFixed(1) + '%', x - 25, y);
        });

        // ç»˜åˆ¶Xè½´æ ‡ç­¾ï¼ˆç§‘ç›®åç§°ï¼‰
        ctx.fillStyle = '#374151';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        subjectStats.forEach((stat, i) => {
          const x = padding + (subjectStats.length > 1 ? pointSpacing * i : chartWidth / 2);
          ctx.fillText(stat.name, x, height - padding + 20);
        });

        // ç»˜åˆ¶å›¾ä¾‹
        const legendY = 25;
        const legendX = padding;

        // å¹³å‡åˆ†å›¾ä¾‹
        ctx.strokeStyle = '#3b82f6';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(legendX, legendY);
        ctx.lineTo(legendX + 30, legendY);
        ctx.stroke();
        ctx.fillStyle = '#3b82f6';
        ctx.beginPath();
        ctx.arc(legendX + 15, legendY, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#374151';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText('å¹³å‡åˆ†', legendX + 35, legendY + 4);

        // ä¼˜ç§€ç‡å›¾ä¾‹
        const legend2X = legendX + 100;
        ctx.strokeStyle = '#10b981';
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        ctx.moveTo(legend2X, legendY);
        ctx.lineTo(legend2X + 30, legendY);
        ctx.stroke();
        ctx.fillStyle = '#10b981';
        ctx.beginPath();
        ctx.arc(legend2X + 15, legendY, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#374151';
        ctx.font = '12px sans-serif';
        ctx.fillText('ä¼˜ç§€ç‡', legend2X + 35, legendY + 4);

        // è‰¯å¥½ç‡å›¾ä¾‹
        const legend3X = legend2X + 100;
        ctx.strokeStyle = '#f59e0b';
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        ctx.moveTo(legend3X, legendY);
        ctx.lineTo(legend3X + 30, legendY);
        ctx.stroke();
        ctx.fillStyle = '#f59e0b';
        ctx.beginPath();
        ctx.arc(legend3X + 15, legendY, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#374151';
        ctx.font = '12px sans-serif';
        ctx.fillText('è‰¯å¥½ç‡', legend3X + 35, legendY + 4);
      }

      function renderTopStudents() {
        const topStudentsGrid = document.getElementById('topStudentsGrid');
        if (!topStudentsGrid) return;

        // è·å–æ‰€æœ‰è€ƒè¯•åç§°
        const examNames = new Set();
        students.forEach(student => {
          if (student.exam_name) examNames.add(student.exam_name);
        });

        // å–æœ€è¿‘Nåœºè€ƒè¯•
        const recentExams = Array.from(examNames).slice(-trendExamCount);

        if (recentExams.length === 0) {
          topStudentsGrid.innerHTML = '<p style="color: #6b7280; text-align: center; grid-column: 1 / -1;">æš‚æ— è€ƒè¯•æ•°æ®</p>';
          return;
        }

        // è®¡ç®—æ¯ä¸ªå­¦ç”Ÿåœ¨è¿™äº›è€ƒè¯•ä¸­çš„å¹³å‡åˆ†
        const studentScores = new Map();

        students.forEach(student => {
          if (!student.exam_name || !recentExams.includes(student.exam_name)) return;
          if (!student.total_score) return;

          const key = student.student_no;
          if (!studentScores.has(key)) {
            studentScores.set(key, {
              name: student.name,
              student_no: student.student_no,
              class_name: student.class_name,
              scores: [],
              ranks: []
            });
          }

          const data = studentScores.get(key);
          data.scores.push(Number(student.total_score));
          if (student.grade_rank) {
            data.ranks.push(student.grade_rank);
          }
        });

        // è®¡ç®—å¹³å‡åˆ†å¹¶æŒ‰å¹³å‡åˆ†æ’åº
        const topStudents = Array.from(studentScores.values())
          .map(student => ({
            ...student,
            examCount: student.scores.length,
            avgScore: student.scores.reduce((sum, score) => sum + score, 0) / student.scores.length,
            avgRank: student.ranks.length > 0
              ? student.ranks.reduce((sum, rank) => sum + rank, 0) / student.ranks.length
              : null
          }))
          .filter(student => student.examCount >= Math.min(1, recentExams.length)) // è‡³å°‘å‚åŠ 1åœºè€ƒè¯•
          .sort((a, b) => b.avgScore - a.avgScore) // æŒ‰å¹³å‡åˆ†é™åºæ’åº
          .slice(0, 5);

        if (topStudents.length === 0) {
          topStudentsGrid.innerHTML = '<p style="color: #6b7280; text-align: center; grid-column: 1 / -1;">æš‚æ— å­¦ç”Ÿæ•°æ®</p>';
          return;
        }

        // æ¸²æŸ“å­¦ç”Ÿå¡ç‰‡
        topStudentsGrid.innerHTML = topStudents.map((student, index) => `
          <div class="top-student-card">
            <div class="rank-badge">${index + 1}</div>
            <div class="student-info-group">
              <div class="student-name">${student.name}</div>
              <div class="student-detail">
                <span>å­¦å·: ${student.student_no}</span>
                <span>${student.class_name || '-'}</span>
                <span>å‚åŠ : ${student.examCount} åœºè€ƒè¯•</span>
                ${student.avgRank !== null ? `<span>å¹³å‡æ’å: ${student.avgRank.toFixed(1)}</span>` : ''}
              </div>
            </div>
            <div class="score-display">
              <div class="avg-score">${student.avgScore.toFixed(1)}</div>
              <div class="score-label">å¹³å‡æ€»åˆ†</div>
            </div>
          </div>
        `).join('');
      }

      function compareExams() {
        const exam1Name = compareExam1Select.value;
        const exam2Name = compareExam2Select.value;

        if (!exam1Name || !exam2Name) {
          showToast('è¯·é€‰æ‹©ä¸¤åœºè€ƒè¯•è¿›è¡Œå¯¹æ¯”', true);
          return;
        }

        if (exam1Name === exam2Name) {
          showToast('è¯·é€‰æ‹©ä¸åŒçš„è€ƒè¯•è¿›è¡Œå¯¹æ¯”', true);
          return;
        }

        // è·å–ä¸¤åœºè€ƒè¯•çš„å­¦ç”Ÿæ•°æ®
        const exam1Students = students.filter(s => s.exam_name === exam1Name);
        const exam2Students = students.filter(s => s.exam_name === exam2Name);

        if (exam1Students.length === 0 || exam2Students.length === 0) {
          showToast('æ‰€é€‰è€ƒè¯•æ²¡æœ‰æ•°æ®', true);
          return;
        }

        // è®¡ç®—ä¸¤åœºè€ƒè¯•çš„ç»Ÿè®¡æ•°æ®
        const exam1Stats = computeSummaryFromStudents(exam1Students, "æ€»åˆ†");
        const exam2Stats = computeSummaryFromStudents(exam2Students, "æ€»åˆ†");

        // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
        renderComparisonStats(exam1Name, exam2Name, exam1Stats, exam2Stats);
        renderComparisonChart(exam1Name, exam2Name, exam1Stats, exam2Stats);

        examComparisonResult.style.display = 'block';
      }

      function renderComparisonStats(exam1Name, exam2Name, exam1Stats, exam2Stats) {
        const metrics = [
          { label: 'å­¦ç”Ÿäººæ•°', key: 'total_students', unit: 'äºº' },
          { label: 'å¹³å‡æ€»åˆ†', key: 'average_total', unit: 'åˆ†' },
          { label: 'åŠæ ¼ç‡', key: 'pass_rate', unit: '%' },
          { label: 'è‰¯å¥½ç‡', key: 'good_rate', unit: '%' },
          { label: 'ä¼˜ç§€ç‡', key: 'excellent_rate', unit: '%' }
        ];

        const cards = metrics.map(metric => {
          const value1 = exam1Stats[metric.key];
          const value2 = exam2Stats[metric.key];
          const diff = value2 - value1;
          const diffText = diff > 0 ? `+${diff.toFixed(2)}` : diff.toFixed(2);
          const diffColor = diff > 0 ? '#10b981' : (diff < 0 ? '#ef4444' : '#6b7280');
          const arrow = diff > 0 ? 'â†‘' : (diff < 0 ? 'â†“' : 'â†’');

          return `
            <div class="stat-card">
              <h3>${metric.label}</h3>
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                <div>
                  <div style="font-size: 14px; color: var(--subtext);">${exam1Name}</div>
                  <div style="font-size: 20px; font-weight: 600; margin-top: 4px;">${value1.toFixed(2)}${metric.unit}</div>
                </div>
                <div style="font-size: 24px; color: ${diffColor};">${arrow}</div>
                <div>
                  <div style="font-size: 14px; color: var(--subtext);">${exam2Name}</div>
                  <div style="font-size: 20px; font-weight: 600; margin-top: 4px;">${value2.toFixed(2)}${metric.unit}</div>
                </div>
              </div>
              <div style="margin-top: 8px; padding: 6px 10px; border-radius: 6px; background: ${diff === 0 ? '#f3f4f6' : (diff > 0 ? '#d1fae5' : '#fee2e2')}; text-align: center;">
                <span style="color: ${diffColor}; font-weight: 600;">${diffText}${metric.unit}</span>
              </div>
            </div>
          `;
        }).join('');

        comparisonStats.innerHTML = cards;
      }

      function renderComparisonChart(exam1Name, exam2Name, exam1Stats, exam2Stats) {
        const canvas = comparisonChart;
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const padding = 80;
        const chartWidth = width - padding * 2;
        const chartHeight = height - padding * 2;

        ctx.clearRect(0, 0, width, height);

        // æ•°æ®æŒ‡æ ‡
        const metrics = [
          { label: 'å¹³å‡åˆ†', key: 'average_total' },
          { label: 'åŠæ ¼ç‡', key: 'pass_rate' },
          { label: 'è‰¯å¥½ç‡', key: 'good_rate' },
          { label: 'ä¼˜ç§€ç‡', key: 'excellent_rate' }
        ];

        const barWidth = chartWidth / (metrics.length * 2 + metrics.length + 1);
        const groupSpacing = barWidth;

        // æ‰¾å‡ºæœ€å¤§å€¼ç”¨äºç¼©æ”¾
        const allValues = metrics.flatMap(m => [exam1Stats[m.key], exam2Stats[m.key]]);
        const maxValue = Math.max(...allValues);
        const yMax = Math.ceil(maxValue / 10) * 10 + 10;

        // ç»˜åˆ¶Yè½´ç½‘æ ¼çº¿å’Œæ ‡ç­¾
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
          const y = padding + (chartHeight / 5) * i;
          ctx.beginPath();
          ctx.moveTo(padding, y);
          ctx.lineTo(width - padding, y);
          ctx.stroke();

          const value = yMax - (yMax / 5) * i;
          ctx.fillStyle = '#6b7280';
          ctx.font = '12px sans-serif';
          ctx.textAlign = 'right';
          ctx.fillText(value.toFixed(0), padding - 10, y + 4);
        }

        // ç»˜åˆ¶æŸ±çŠ¶å›¾
        metrics.forEach((metric, i) => {
          const groupX = padding + (i * (barWidth * 2 + groupSpacing)) + groupSpacing;

          // ç¬¬ä¸€åœºè€ƒè¯•çš„æŸ±å­
          const value1 = exam1Stats[metric.key];
          const height1 = (value1 / yMax) * chartHeight;
          const y1 = padding + chartHeight - height1;

          ctx.fillStyle = '#3b82f6';
          ctx.fillRect(groupX, y1, barWidth, height1);

          // æ˜¾ç¤ºæ•°å€¼
          ctx.fillStyle = '#1e40af';
          ctx.font = 'bold 11px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(value1.toFixed(1), groupX + barWidth / 2, y1 - 5);

          // ç¬¬äºŒåœºè€ƒè¯•çš„æŸ±å­
          const value2 = exam2Stats[metric.key];
          const height2 = (value2 / yMax) * chartHeight;
          const y2 = padding + chartHeight - height2;

          ctx.fillStyle = '#10b981';
          ctx.fillRect(groupX + barWidth, y2, barWidth, height2);

          // æ˜¾ç¤ºæ•°å€¼
          ctx.fillStyle = '#059669';
          ctx.font = 'bold 11px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(value2.toFixed(1), groupX + barWidth + barWidth / 2, y2 - 5);

          // Xè½´æ ‡ç­¾
          ctx.fillStyle = '#374151';
          ctx.font = '13px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(metric.label, groupX + barWidth, height - padding + 25);
        });

        // ç»˜åˆ¶å›¾ä¾‹
        const legendY = 30;
        ctx.fillStyle = '#3b82f6';
        ctx.fillRect(padding, legendY, 20, 12);
        ctx.fillStyle = '#374151';
        ctx.font = '13px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(exam1Name, padding + 25, legendY + 10);

        ctx.fillStyle = '#10b981';
        ctx.fillRect(padding + 150, legendY, 20, 12);
        ctx.fillStyle = '#374151';
        ctx.fillText(exam2Name, padding + 175, legendY + 10);

        // ç»˜åˆ¶æ ‡é¢˜
        ctx.fillStyle = '#111827';
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('è€ƒè¯•å¯¹æ¯”åˆ†æ', width / 2, legendY + 10);
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      async function downloadTemplate(event) {
        event?.preventDefault();
        try {
          const res = await fetch(`${API_BASE}/template`);
          if (!res.ok) throw new Error("æ¨¡æ¿ä¸‹è½½å¤±è´¥");
          const blob = await res.blob();
          downloadBlob(blob, "æˆç»©å¯¼å…¥æ¨¡æ¿.xlsx");
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleImport(event) {
        event.preventDefault();
        if (!importFileInput?.files.length) {
          showToast("è¯·å…ˆé€‰æ‹© Excel æ–‡ä»¶", true);
          return;
        }
        const formData = new FormData();
        formData.append("file", importFileInput.files[0]);
        if (importClassInput?.value) formData.append("class_name", importClassInput.value);
        if (importGradeInput?.value) formData.append("grade_name", importGradeInput.value);
        if (importExamInput?.value) formData.append("exam_name", importExamInput.value);
        try {
          const res = await fetch(`${API_BASE}/import`, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "å¯¼å…¥å¤±è´¥");
          }
          const summary = await res.json();
          showToast(`å¯¼å…¥å®Œæˆï¼šæ–°å¢ ${summary.imported} æ¡ï¼Œæ›´æ–° ${summary.updated} æ¡`);
          importForm?.reset();
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function exportScores(event) {
        event.preventDefault();
        const params = new URLSearchParams();
        if (exportClassSelect?.value) params.append("class_name", exportClassSelect.value);
        if (exportExamSelect?.value) params.append("exam_name", exportExamSelect.value);
        const query = params.toString();
        try {
          const res = await fetch(`${API_BASE}/export${query ? `?${query}` : ""}`);
          if (!res.ok) throw new Error("å¯¼å‡ºå¤±è´¥");
          const blob = await res.blob();
          downloadBlob(blob, "æˆç»©å¯¼å‡º.xlsx");
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleRangeSave(event) {
        event.preventDefault();
        if (!rangeRows) return;
        const current = gradeRanges[currentRangeSubject] || createDefaultRanges();
        let hasError = false;
        const updated = current.map((range) => {
          const row = rangeRows.querySelector(`.range-row[data-key="${range.key}"]`);
          if (!row) return range;
          const minInput = row.querySelector('[data-field="min"]');
          const maxInput = row.querySelector('[data-field="max"]');
          const minVal = parseFloat(minInput.value);
          const maxRaw = maxInput.value.trim();
          const maxVal = maxRaw === "" ? null : parseFloat(maxRaw);
          if (Number.isNaN(minVal)) {
            showToast(`è¯·å¡«å†™${range.name}çš„æœ€å°å€¼`, true);
            hasError = true;
            return range;
          }
          if (maxRaw !== "" && Number.isNaN(maxVal)) {
            showToast(`è¯·å¡«å†™${range.name}çš„æœ€å¤§å€¼`, true);
            hasError = true;
            return range;
          }
          if (maxVal !== null && maxVal <= minVal) {
            showToast(`${range.name}çš„æœ€å¤§å€¼éœ€å¤§äºæœ€å°å€¼`, true);
            hasError = true;
            return range;
          }
          return { ...range, min: minVal, max: maxVal };
        });
        if (hasError) return;
        try {
          const res = await fetch(`${API_BASE}/ranges/${encodeURIComponent(currentRangeSubject)}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updated),
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "ä¿å­˜å¤±è´¥");
          }
          const saved = await res.json();
          gradeRanges[currentRangeSubject] = saved;
          renderRangeRows();
          updateSummary();
          showToast("åŒºé—´é…ç½®å·²ä¿å­˜");
        } catch (error) {
          showToast(error.message, true);
        }
      }

      refreshBtn.addEventListener("click", () => {
        loadStudents();
      });
      subjectTabsEl?.addEventListener("click", async (event) => {
        const target = event.target.closest("button[data-subject]");
        if (!target) return;
        const subject = target.dataset.subject;
        if (subject && subject !== selectedSubject) {
          selectedSubject = subject;
          renderSubjectTabs();
          renderTable();
          updateSummary();
        }
      });

      // èµ°åŠ¿å›¾é€‰é¡¹å¡åˆ‡æ¢
      document.addEventListener("click", (event) => {
        const target = event.target.closest("button[data-trend-count]");
        if (!target) return;

        const count = parseInt(target.dataset.trendCount);
        if (count && count !== trendExamCount) {
          trendExamCount = count;

          // æ›´æ–°é€‰é¡¹å¡æ ·å¼
          document.querySelectorAll("button[data-trend-count]").forEach(btn => {
            btn.classList.remove("active");
          });
          target.classList.add("active");

          // é‡æ–°ç»˜åˆ¶å›¾è¡¨å’Œæ’å
          renderDashboardTrendChart();
          renderTopStudents();
        }
      });
      downloadTemplateBtn?.addEventListener("click", downloadTemplate);
      addStudentBtn?.addEventListener("click", () => openModal());
      cancelModal.addEventListener("click", closeModal);
      modalBackdrop.addEventListener("click", (event) => {
        if (event.target === modalBackdrop) closeModal();
      });
      addScoreRowBtn.addEventListener("click", () => addScoreRow());
      studentForm.addEventListener("submit", saveStudent);
      rangeSubjectSelect?.addEventListener("change", () => {
        currentRangeSubject = rangeSubjectSelect.value;
        renderRangeRows();
      });
      importForm?.addEventListener("submit", handleImport);
      exportBtn?.addEventListener("click", exportScores);
      rangeForm?.addEventListener("submit", handleRangeSave);
      searchInput.addEventListener("input", renderTable);
      classFilter.addEventListener("change", renderTable);
      examFilter.addEventListener("change", renderTable);

      columnSettingsBtn?.addEventListener("click", openColumnSettings);
      cancelColumnSettings?.addEventListener("click", closeColumnSettings);
      saveColumnSettings?.addEventListener("click", applyColumnSettings);
      columnSettingsModal?.addEventListener("click", (event) => {
        if (event.target === columnSettingsModal) closeColumnSettings();
      });

      closeDetailModal?.addEventListener("click", closeStudentDetail);
      editDetailBtn?.addEventListener("click", enableDetailEdit);
      studentDetailForm?.addEventListener("submit", saveDetailEdit);
      studentDetailModal?.addEventListener("click", (event) => {
        if (event.target === studentDetailModal) closeStudentDetail();
      });

      cancelClassEdit?.addEventListener("click", closeClassEditModal);
      classEditForm?.addEventListener("submit", saveClassEdit);
      classEditModal?.addEventListener("click", (event) => {
        if (event.target === classEditModal) closeClassEditModal();
      });

      classStatsBody?.addEventListener("click", (event) => {
        const shareClassName = event.target.getAttribute("data-share-class");
        const editClassName = event.target.getAttribute("data-edit-class");
        const deleteClassName = event.target.getAttribute("data-delete-class");

        if (shareClassName) {
          shareClassQuery(shareClassName);
        }
        if (editClassName) {
          openClassEditModal(editClassName);
        }
        if (deleteClassName) {
          deleteClass(deleteClassName);
        }
      });

      function shareClassQuery(className) {
        shareClassName = className;
        selectedDays = 30;
        customDays.value = '';

        // è·å–è¯¥ç­çº§çš„æ‰€æœ‰è€ƒè¯•
        const classExams = new Set();
        students.forEach(student => {
          if (student.class_name === className && student.exam_name) {
            classExams.add(student.exam_name);
          }
        });

        // å¡«å……è€ƒè¯•é€‰æ‹©ä¸‹æ‹‰æ¡†
        shareExamSelect.innerHTML = '<option value="">å…¨éƒ¨è€ƒè¯•</option>';
        Array.from(classExams).forEach(examName => {
          const option = document.createElement('option');
          option.value = examName;
          option.textContent = examName;
          shareExamSelect.appendChild(option);
        });

        shareModal.classList.add('active');
      }

      function closeShareModal() {
        shareModal.classList.remove('active');
        shareClassName = null;
        selectedDays = 30;
        customDays.value = '';
        shareExamSelect.value = '';
      }

      async function generateShareLink() {
        if (!shareClassName) return;

        const days = customDays.value ? parseInt(customDays.value) : selectedDays;
        const examName = shareExamSelect.value;

        if (days < 1 || days > 365) {
          showToast('æœ‰æ•ˆæœŸå¿…é¡»åœ¨1-365å¤©ä¹‹é—´', true);
          return;
        }

        try {
          const params = new URLSearchParams();
          params.append('valid_days', days);
          if (examName) {
            params.append('exam_name', examName);
          }

          const res = await fetch(`${API_BASE}/class/${encodeURIComponent(shareClassName)}/share?${params.toString()}`, {
            method: 'POST'
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥');
          }

          const result = await res.json();
          const queryUrl = `${window.location.origin}/static/query.html?code=${result.code}`;

          let toastMessage = `åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\nç­çº§ï¼š${shareClassName}`;
          if (examName) {
            toastMessage += `\nè€ƒè¯•ï¼š${examName}`;
          } else {
            toastMessage += `\nè€ƒè¯•ï¼šå…¨éƒ¨è€ƒè¯•`;
          }
          toastMessage += `\næœ‰æ•ˆæœŸï¼š${days}å¤©\nè¿‡æœŸæ—¶é—´ï¼š${new Date(result.expires_at).toLocaleString()}`;

          // å¤åˆ¶åˆ°å‰ªè´´æ¿
          if (navigator.clipboard) {
            await navigator.clipboard.writeText(queryUrl);
            showToast(toastMessage);
          } else {
            // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºé“¾æ¥è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
            prompt('è¯·å¤åˆ¶ä»¥ä¸‹é“¾æ¥åˆ†äº«ç»™å®¶é•¿ï¼š', queryUrl);
          }

          closeShareModal();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      compareExamsBtn?.addEventListener("click", compareExams);

      // åˆ†äº«å¼¹çª—äº‹ä»¶ç›‘å¬
      cancelShare?.addEventListener("click", closeShareModal);
      confirmShare?.addEventListener("click", generateShareLink);
      shareModal?.addEventListener("click", (event) => {
        if (event.target === shareModal) closeShareModal();
      });

      // å¿«æ·å¤©æ•°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      shareModal?.querySelectorAll('button[data-days]').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedDays = parseInt(btn.getAttribute('data-days'));
          customDays.value = '';
          // é«˜äº®é€‰ä¸­çš„æŒ‰é’®
          shareModal.querySelectorAll('button[data-days]').forEach(b => {
            b.style.background = '#e5e7eb';
            b.style.color = '#111827';
          });
          btn.style.background = 'var(--primary)';
          btn.style.color = 'white';
        });
      });

      studentBody.addEventListener("click", (event) => {
        const viewId = event.target.getAttribute("data-view");
        const editId = event.target.getAttribute("data-edit");
        const deleteId = event.target.getAttribute("data-delete");

        if (viewId) {
          openStudentDetail(Number(viewId));
        }
        if (editId) {
          const student = students.find((item) => item.id === Number(editId));
          if (student) openModal(student);
        }
        if (deleteId) {
          deleteStudent(Number(deleteId));
        }
      });

      function initCollapsibleSections() {
        document.querySelectorAll('.collapsible-header').forEach(header => {
          header.addEventListener('click', () => {
            const targetId = header.getAttribute('data-target');
            const content = document.getElementById(targetId);
            const toggle = header.querySelector('.collapsible-toggle');

            if (content && toggle) {
              const isExpanded = content.classList.contains('expanded');

              if (isExpanded) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
              } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
              }
            }
          });
        });
      }

      async function bootstrap() {
        loadColumnSettings();
        renderRangeSubjectOptions();
        await loadGradeConfig();
        await loadStudents();
        addScoreRow();
        initCollapsibleSections();
      }
      bootstrap();
    </script>
  </body>
</html>
