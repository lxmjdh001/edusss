<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆç»©ç®¡ç†æ§åˆ¶å°</title>
    <script src="/static/chart.min.js"></script>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f4f6fb;
        --card-bg: #ffffff;
        --primary: #2563eb;
        --text: #1f2937;
        --subtext: #6b7280;
        --border: #e5e7eb;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "PingFang SC", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      header.top-nav {
        position: sticky;
        top: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 40px;
        background: var(--card-bg);
        box-shadow: 0 2px 30px rgba(15, 23, 42, 0.08);
        z-index: 100;
      }
      .brand {
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      nav ul {
        list-style: none;
        display: flex;
        gap: 8px;
        margin: 0;
        padding: 0;
      }
      nav button {
        border: none;
        background: transparent;
        padding: 10px 18px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        color: var(--subtext);
        transition: background 0.2s ease, color 0.2s ease;
      }
      nav button.active {
        background: rgba(37, 99, 235, 0.12);
        color: var(--primary);
      }
      nav .has-submenu {
        position: relative;
      }
      nav .has-submenu > button {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      nav .submenu {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(15, 23, 42, 0.15);
        min-width: 180px;
        padding: 8px;
        list-style: none;
        z-index: 1000;
      }
      nav .has-submenu:hover .submenu {
        display: block;
      }
      nav .submenu li {
        margin: 0;
      }
      nav .submenu a {
        display: block;
        padding: 10px 14px;
        color: var(--text);
        text-decoration: none;
        border-radius: 8px;
        transition: background 0.2s ease;
        font-weight: 500;
      }
      nav .submenu a:hover {
        background: rgba(37, 99, 235, 0.08);
        color: var(--primary);
      }
      .app-shell {
        max-width: 1400px;
        margin: 0 auto;
        padding: 32px 12px 80px;
      }
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
      }
      .page-header h1 {
        margin: 0;
        font-size: 28px;
      }
      .page-header p {
        margin: 4px 0 0;
        color: var(--subtext);
      }
      .actions {
        display: flex;
        gap: 12px;
      }
      button,
      input,
      select,
      textarea {
        font: inherit;
      }
      .btn {
        border: none;
        border-radius: 10px;
        padding: 10px 18px;
        cursor: pointer;
        color: #fff;
        background: var(--primary);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.2);
      }
      .btn.secondary {
        background: #e5e7eb;
        color: #111827;
      }
      .compact-btn {
        padding: 8px 14px;
      }
      .btn.danger {
        background: var(--danger);
      }
      main[data-section] {
        display: none;
      }
      main[data-section].active {
        display: block;
      }
      .stats-grid {
        margin-top: 24px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }
      .stat-card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 15px 40px rgba(15, 23, 42, 0.05);
      }
      .stat-card h3 {
        margin: 0;
        font-size: 14px;
        color: var(--subtext);
      }
      .stat-card .value {
        font-size: 32px;
        margin-top: 12px;
        font-weight: 700;
      }
      .chip {
        display: inline-flex;
        margin-top: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        background: #ecfccb;
        color: #365314;
      }
      .filters {
        margin-top: 28px;
        background: var(--card-bg);
        border-radius: 16px;
        padding: 16px;
        border: 1px solid var(--border);
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .subject-tabs {
        margin-top: 20px;
        background: var(--card-bg);
        border-radius: 16px;
        border: 1px solid var(--border);
        padding: 18px 16px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .subject-tab {
        border: none;
        border-radius: 999px;
        padding: 10px 18px;
        background: #edf2ff;
        color: #475569;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .subject-tab.active {
        background: var(--primary);
        color: #fff;
      }
      .filters input,
      .filters select {
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        min-width: 180px;
      }
      .table-wrapper {
        margin-top: 18px;
        background: var(--card-bg);
        border-radius: 22px;
        border: 1px solid var(--border);
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: #f8fafc;
      }
      th,
      td {
        padding: 14px 16px;
        border-bottom: 1px solid #f1f5f9;
        text-align: left;
        font-size: 14px;
        vertical-align: top;
      }
      tbody tr:hover {
        background: #f9fbff;
      }
      .highlight-cell {
        background: rgba(37, 99, 235, 0.08);
        color: var(--primary);
        font-weight: 600;
      }
      .empty-tip {
        text-align: center;
        padding: 60px 20px;
        color: var(--subtext);
      }
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .modal-backdrop.active {
        display: flex;
      }
      .modal {
        background: var(--card-bg);
        width: min(640px, 92vw);
        max-height: 90vh;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 30px 80px rgba(15, 23, 42, 0.25);
        position: relative;
        overflow-y: auto;
      }
      .modal.modal-wide {
        width: min(900px, 92vw);
      }
      .modal h2 {
        margin-top: 0;
        font-size: 20px;
      }
      .modal form {
        display: grid;
        gap: 12px;
      }
      .field-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .field-group label {
        flex: 1;
      }
      label span {
        display: block;
        font-size: 12px;
        margin-bottom: 2px;
        color: var(--subtext);
      }
      label input,
      label textarea,
      label select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      label textarea {
        min-height: 64px;
        resize: vertical;
      }
      .scores-list {
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 12px;
        background: #f8fafc;
      }
      .score-row {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }
      .score-row input {
        flex: 1;
      }
      .score-row button {
        border: none;
        background: transparent;
        color: var(--danger);
        cursor: pointer;
      }
      .range-config-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
      }
      .range-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }
      .range-row .range-label {
        font-weight: 600;
        min-width: 64px;
      }
      .range-row input {
        width: 90px;
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 6px 8px;
      }
      .config-tip {
        margin: 4px 0 0;
        color: var(--subtext);
        font-size: 13px;
      }
      .config-note {
        margin: 8px 0 0;
        font-size: 12px;
        color: var(--subtext);
      }
      .modal-footer {
        margin-top: 12px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }
      .grade-manager {
        display: grid;
        gap: 20px;
        margin-top: 20px;
      }
      .grade-card {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border);
        padding: 24px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
      }
      .grade-card h2 {
        margin-top: 0;
      }
      .collapsible-section {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border);
        padding: 0;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
        overflow: hidden;
      }
      .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
      }
      .collapsible-header:hover {
        background: #f8fafc;
      }
      .collapsible-header h2 {
        margin: 0;
        font-size: 18px;
      }
      .collapsible-toggle {
        font-size: 20px;
        color: var(--primary);
        transition: transform 0.3s ease;
      }
      .collapsible-toggle.expanded {
        transform: rotate(180deg);
      }
      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      .collapsible-content.expanded {
        max-height: 1000px;
      }
      .collapsible-body {
        padding: 0 24px 24px 24px;
      }
      .inline-form {
        display: grid;
        gap: 16px;
      }
      .inline-form label {
        display: flex;
        flex-direction: column;
        font-size: 14px;
        color: var(--subtext);
      }
      .inline-form input,
      .inline-form select {
        margin-top: 4px;
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 8px 10px;
      }
      .inline-form-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .inline-form-row label {
        flex: 1;
      }
      .import-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .hint-text {
        font-size: 13px;
        color: var(--subtext);
        margin-top: 8px;
      }
      .notification {
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: #111827;
        color: #fff;
        padding: 12px 18px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .notification.show {
        opacity: 1;
        transform: translateY(0);
      }
      .detail-tab {
        border: none;
        background: transparent;
        padding: 10px 20px;
        font-weight: 600;
        cursor: pointer;
        color: var(--subtext);
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
      }
      .detail-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .detail-tab-content {
        padding: 20px 0;
      }
      .info-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-top: 16px;
      }
      @media (max-width: 900px) {
        .info-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 600px) {
        .info-grid {
          grid-template-columns: 1fr;
        }
      }
      .info-item {
        padding: 12px;
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid var(--border);
      }
      .info-item label {
        display: block;
        font-size: 12px;
        color: var(--subtext);
        margin-bottom: 4px;
      }
      .info-item .value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
      }
      .overview-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }
      .overview-stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px;
        border-radius: 12px;
        text-align: center;
      }
      .overview-stat-card:nth-child(2) {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      .overview-stat-card:nth-child(3) {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      .overview-stat-card:nth-child(4) {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      }
      .overview-stat-card label {
        display: block;
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 4px;
      }
      .overview-stat-card .value {
        font-size: 24px;
        font-weight: 700;
      }
      #radarChart {
        max-width: 500px;
        margin: 0 auto;
      }
      .top-student-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        padding: 16px 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: box-shadow 0.2s ease;
      }
      .top-student-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
      .top-student-card .rank-badge {
        flex-shrink: 0;
        background: #f3f4f6;
        color: #111827;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
      }
      .top-student-card:nth-child(1) .rank-badge {
        background: #fef3c7;
        color: #92400e;
      }
      .top-student-card:nth-child(2) .rank-badge {
        background: #e0e7ff;
        color: #3730a3;
      }
      .top-student-card:nth-child(3) .rank-badge {
        background: #dbeafe;
        color: #1e40af;
      }
      .top-student-card .student-info-group {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 24px;
      }
      .top-student-card .student-name {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        min-width: 80px;
      }
      .top-student-card .student-detail {
        font-size: 14px;
        color: #6b7280;
      }
      .top-student-card .student-detail span {
        margin-right: 16px;
      }
      .top-student-card .score-display {
        flex-shrink: 0;
        text-align: right;
      }
      .top-student-card .avg-score {
        font-size: 24px;
        font-weight: 700;
        color: #111827;
      }
      .top-student-card .score-label {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 2px;
      }
      .tabs {
        display: flex;
        gap: 8px;
        border-bottom: 2px solid var(--border);
      }
      .tab-button {
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--subtext);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: -2px;
        font-size: 14px;
      }
      .tab-button:hover {
        color: var(--text);
        background: rgba(0, 0, 0, 0.02);
      }
      .tab-button.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      @media (max-width: 720px) {
        header.top-nav {
          flex-direction: column;
          align-items: flex-start;
          gap: 16px;
        }
        .filters {
          flex-direction: column;
        }
        .actions {
          width: 100%;
        }
        .btn {
          flex: 1;
          justify-content: center;
        }
        .tab-button {
          padding: 10px 16px;
          font-size: 13px;
        }
      }
    </style>
    <script src="/static/auth-guard.js"></script>
  </head>
  <body>
    <header class="top-nav">
      <div class="brand">ğŸ“Š æˆç»©ç®¡ç†</div>
      <nav>
        <ul>
          <li><button class="active" data-target="dashboard">ä»ªè¡¨ç›˜</button></li>
          <li><button data-target="grade">æˆç»©ç®¡ç†</button></li>
          <li><button data-target="data">æ•°æ®ç®¡ç†</button></li>
          <li><a href="points.html" style="text-decoration: none;"><button>ğŸ® ç§¯åˆ†ç³»ç»Ÿ</button></a></li>
          <li id="systemMenuBtn" class="has-submenu" style="display: none;">
            <button>âš™ï¸ ç³»ç»Ÿç®¡ç†</button>
            <ul class="submenu">
              <li><a href="/static/admin-codes.html">ğŸ”‘ æ¿€æ´»ç ç®¡ç†</a></li>
              <li><a href="/static/users.html">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </header>

    <div class="app-shell">
      <main data-section="dashboard" class="active">
        <div class="page-header">
          <div>
            <h1>æ•°æ®çœ‹æ¿</h1>
            <p>æˆç»©ç»Ÿè®¡æ¦‚è§ˆ</p>
          </div>
          <div class="actions" style="gap: 12px; flex-wrap: wrap;">
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
              <button class="btn secondary" id="filterClassBtn" style="display: flex; align-items: center; gap: 6px;">
                <span>ğŸ“š</span>
                <span id="filterClassText">é€‰æ‹©ç­çº§</span>
                <span style="font-size: 12px; opacity: 0.7;" id="classCount"></span>
              </button>
              <button class="btn secondary" id="filterExamBtn" style="display: flex; align-items: center; gap: 6px;">
                <span>ğŸ“</span>
                <span id="filterExamText">é€‰æ‹©è€ƒè¯•</span>
                <span style="font-size: 12px; opacity: 0.7;" id="examCount"></span>
              </button>
              <button class="btn secondary" id="refreshBtn" style="display: flex; align-items: center; gap: 6px;">
                <span>ğŸ”„</span>
                <span>åˆ·æ–°æ•°æ®</span>
              </button>
            </div>
          </div>
        </div>

        <section class="subject-tabs" id="subjectTabs"></section>

        <!-- æ•°æ®ä»ªè¡¨ç›˜ -->
        <section class="grade-card" style="margin-top: 20px;">
          <h2 style="margin-bottom: 20px;">æ•°æ®ç»Ÿè®¡æ¦‚è§ˆ</h2>
          <div id="gradeDashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;"></div>
        </section>

        <!-- æ–°å¢ç»Ÿè®¡å›¾è¡¨ -->
        <section style="margin-top: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">
          <!-- åˆ†æ•°åˆ†å¸ƒ -->
          <div class="grade-card">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
              <span style="font-size: 20px;">ğŸ“Š</span>
              <h2 style="margin: 0;">åˆ†æ•°åˆ†å¸ƒ</h2>
            </div>
            <p style="color: #718096; font-size: 14px; margin-bottom: 20px;">æ€»åˆ†åˆ†æ®µç»Ÿè®¡</p>
            <div style="height: 300px; position: relative;">
              <canvas id="scoreDistributionChart"></canvas>
            </div>
          </div>

          <!-- ç§‘ç›®é›·è¾¾å›¾ -->
          <div class="grade-card">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 20px;">ğŸ‘¤</span>
                <h2 style="margin: 0;">ç§‘ç›®é›·è¾¾å›¾</h2>
              </div>
              <button class="btn secondary" id="radarSettingsBtn" style="padding: 6px 12px; font-size: 14px;">âš™ï¸ è®¾ç½®ç§‘ç›®</button>
            </div>
            <p style="color: #718096; font-size: 14px; margin-bottom: 20px;">å„ç§‘å¹³å‡åˆ†å¯¹æ¯”åˆ†æ</p>
            <div style="height: 300px; position: relative;">
              <canvas id="subjectRadarChart"></canvas>
            </div>
          </div>

          <!-- ç­‰çº§åˆ†å¸ƒ -->
          <div class="grade-card">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
              <span style="font-size: 20px;">ğŸ“ˆ</span>
              <h2 style="margin: 0;">ç­‰çº§åˆ†å¸ƒ</h2>
            </div>
            <p style="color: #718096; font-size: 14px; margin-bottom: 20px;">ä¼˜ç§€/è‰¯å¥½/åŠæ ¼/ä¸åŠæ ¼å æ¯”</p>
            <div style="height: 300px; position: relative;">
              <canvas id="gradeLevelChart"></canvas>
            </div>
          </div>
        </section>

        <section class="grade-card" style="margin-top: 24px;">
          <div style="margin-bottom: 16px;">
            <h2 style="margin-bottom: 12px;">è€ƒè¯•æˆç»©èµ°åŠ¿</h2>
            <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 14px; color: #718096;">æŒ‰åœºæ¬¡:</span>
                <div class="subject-tabs" style="margin: 0;">
                  <button class="subject-tab active" data-trend-count="3">è¿‘3åœº</button>
                  <button class="subject-tab" data-trend-count="5">è¿‘5åœº</button>
                  <button class="subject-tab" data-trend-count="10">è¿‘10åœº</button>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 14px; color: #718096;">æŒ‰æ—¶é—´:</span>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="date" id="trendStartDate" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white;">
                  <span style="color: #718096;">è‡³</span>
                  <input type="date" id="trendEndDate" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white;">
                  <button id="applyTrendDateRange" class="subject-tab" style="padding: 6px 16px;">åº”ç”¨</button>
                </div>
              </div>
            </div>
          </div>
          <div style="padding: 20px; height: 350px; position: relative;">
            <canvas id="dashboardTrendChart"></canvas>
          </div>
          <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
              <div>
                <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #059669;">ğŸ† æ’åå‰5å­¦ç”Ÿ</h3>
                <div id="topStudentsGrid" style="display: flex; flex-direction: column; gap: 12px;"></div>
              </div>
              <div>
                <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #dc2626;">ğŸ“‰ æ’åå5å­¦ç”Ÿ</h3>
                <div id="bottomStudentsGrid" style="display: flex; flex-direction: column; gap: 12px;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- å­¦ç”Ÿä¸ªäººæˆç»©èµ°åŠ¿ -->
        <section class="grade-card" style="margin-top: 24px;">
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h2 style="margin: 0;">å­¦ç”Ÿæˆç»©å¯¹æ¯”èµ°åŠ¿</h2>
              <div style="display: flex; gap: 12px;">
                <button class="btn secondary compact-btn" id="selectStudentsBtn">ğŸ“‹ é€‰æ‹©å­¦ç”Ÿ</button>
                <button class="btn secondary compact-btn" id="selectSubjectsBtn">âš™ï¸ é€‰æ‹©ç§‘ç›®</button>
              </div>
            </div>
            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
              <span style="font-size: 14px; color: #718096;">å·²é€‰æ‹©å­¦ç”Ÿ (<span id="selectedStudentCount">0</span>/5)</span>
              <span style="font-size: 14px; color: #718096;">|</span>
              <span style="font-size: 14px; color: #718096;">æ˜¾ç¤ºç§‘ç›® (<span id="selectedSubjectCount">1</span>)</span>
            </div>
            <div id="selectedStudentsList" style="min-height: 44px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #f9fafb; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
              <span style="color: #9ca3af; font-size: 14px;">ç‚¹å‡»"é€‰æ‹©å­¦ç”Ÿ"æŒ‰é’®æ·»åŠ å­¦ç”Ÿ</span>
            </div>
          </div>
          <div id="studentTrendChartContainer" style="display: none;">
            <div style="padding: 20px; height: 350px; position: relative;">
              <canvas id="studentTrendChart"></canvas>
            </div>
            <div style="margin-top: 24px; padding: 20px; background: #f7fafc; border-radius: 12px;">
              <h3 style="margin: 0 0 16px 0; font-size: 16px;">æˆç»©ç»Ÿè®¡</h3>
              <div id="studentTrendStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;"></div>
            </div>
          </div>
          <div id="studentTrendPlaceholder" style="padding: 60px 20px; text-align: center; color: #a0aec0;">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px;">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <p style="font-size: 16px; margin: 0;">è¯·é€‰æ‹©å­¦ç”ŸæŸ¥çœ‹æˆç»©å¯¹æ¯”èµ°åŠ¿ï¼ˆæœ€å¤š5äººï¼‰</p>
          </div>
        </section>

        <!-- è¿›æ­¥ä¸é€€æ­¥å­¦ç”Ÿåˆ†æ -->
        <section style="margin-top: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="margin: 0; font-size: 20px;">ğŸ“Š è¿›æ­¥ä¸é€€æ­¥å­¦ç”Ÿåˆ†æ</h2>
            <button class="btn secondary compact-btn" id="progressSettingsBtn" style="padding: 6px 12px; font-size: 14px;">âš™ï¸ è®¾ç½®</button>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px;">
          <!-- è¿›æ­¥æœ€å¤§å‰åå -->
          <div class="grade-card">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
              <span style="font-size: 20px;">ğŸ“ˆ</span>
              <h2 style="margin: 0;" id="progressTitle">è¿›æ­¥æœ€å¤§å‰10å</h2>
            </div>
            <p style="color: #718096; font-size: 14px; margin-bottom: 20px;" id="progressSubtitle">åŸºäºæœ€è¿‘3åœºè€ƒè¯•ç»¼åˆå¯¹æ¯”</p>
            <div style="height: 400px; position: relative;">
              <canvas id="progressChart"></canvas>
            </div>
            <div id="progressStudentsList" style="margin-top: 16px; padding: 12px; background: #f0fdf4; border-radius: 8px; max-height: 200px; overflow-y: auto;">
              <p style="margin: 0; color: #6b7280; text-align: center;">æš‚æ— æ•°æ®</p>
            </div>
          </div>

          <!-- é€€æ­¥æœ€å¤§å‰åå -->
          <div class="grade-card">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
              <span style="font-size: 20px;">ğŸ“‰</span>
              <h2 style="margin: 0;" id="regressionTitle">é€€æ­¥æœ€å¤§å‰10å</h2>
            </div>
            <p style="color: #718096; font-size: 14px; margin-bottom: 20px;" id="regressionSubtitle">åŸºäºæœ€è¿‘3åœºè€ƒè¯•ç»¼åˆå¯¹æ¯”</p>
            <div style="height: 400px; position: relative;">
              <canvas id="regressionChart"></canvas>
            </div>
            <div id="regressionStudentsList" style="margin-top: 16px; padding: 12px; background: #fef2f2; border-radius: 8px; max-height: 200px; overflow-y: auto;">
              <p style="margin: 0; color: #6b7280; text-align: center;">æš‚æ— æ•°æ®</p>
            </div>
          </div>
          </div>
        </section>

        <!-- ç­çº§å¯¹æ¯”åˆ†æ -->
        <section class="grade-card" style="margin-top: 24px;" id="classComparisonSection">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <h2 style="margin: 0; font-size: 20px;">ğŸ“Š ç­çº§å¯¹æ¯”åˆ†æ</h2>
              <p style="color: #718096; font-size: 14px; margin: 4px 0 0 0;">é€‰æ‹©ç­çº§è¿›è¡Œå¤šç»´åº¦å¯¹æ¯”åˆ†æ</p>
            </div>
            <button class="btn primary" id="selectClassesBtn" style="padding: 8px 16px;">
              <span>ğŸ“‹</span>
              <span>é€‰æ‹©ç­çº§</span>
            </button>
          </div>

          <!-- å·²é€‰æ‹©ç­çº§æ ‡ç­¾ -->
          <div id="selectedClassesTags" style="min-height: 40px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: #f9fafb; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 20px;">
            <span style="color: #6b7280; font-size: 14px;">è¯·é€‰æ‹©ç­çº§è¿›è¡Œå¯¹æ¯”ï¼ˆè‡³å°‘é€‰æ‹©2ä¸ªç­çº§ï¼‰</span>
          </div>

          <!-- å¯¹æ¯”å†…å®¹å®¹å™¨ -->
          <div id="classComparisonContent" style="display: none;">

            <!-- 1. ç­çº§å¹³å‡åˆ†å¯¹æ¯” -->
            <div style="margin-bottom: 32px;">
              <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #111827;">
                <span style="margin-right: 8px;">ğŸ“ˆ</span>æ€»åˆ†å¹³å‡åˆ†å¯¹æ¯”
              </h3>
              <div style="height: 350px; position: relative; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                <canvas id="classAvgComparisonChart"></canvas>
              </div>
            </div>

            <!-- 2. å„ç­è¯¦ç»†æ•°æ®å¯¹æ¯”è¡¨æ ¼ -->
            <div style="margin-bottom: 32px;">
              <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #111827;">
                <span style="margin-right: 8px;">ğŸ“‹</span>å„ç­è¯¦ç»†æ•°æ®
              </h3>
              <div style="overflow-x: auto; background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f9fafb;">
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">æ’å</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">ç­çº§</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">äººæ•°</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">å¹³å‡åˆ†</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">æœ€é«˜åˆ†</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">åŠæ ¼ç‡</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">è‰¯å¥½ç‡</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">ä¼˜ç§€ç‡</th>
                    </tr>
                  </thead>
                  <tbody id="classDetailTableBody">
                    <tr>
                      <td colspan="8" style="padding: 20px; text-align: center; color: #6b7280;">æš‚æ— æ•°æ®</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 3. å„ç§‘å¹³å‡åˆ†å¯¹æ¯” -->
            <div style="margin-bottom: 32px;">
              <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #111827;">
                <span style="margin-right: 8px;">ğŸ“Š</span>å„ç§‘å¹³å‡åˆ†å¯¹æ¯”
              </h3>
              <div style="height: 400px; position: relative; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                <canvas id="subjectComparisonChart"></canvas>
              </div>
            </div>

            <!-- 4. ä¸‰ç‡ç»Ÿè®¡å¯¹æ¯” -->
            <div>
              <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #111827;">
                <span style="margin-right: 8px;">ğŸ“ˆ</span>åŠæ ¼ç‡Â·è‰¯å¥½ç‡Â·ä¼˜ç§€ç‡å¯¹æ¯”
              </h3>
              <div style="height: 350px; position: relative; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                <canvas id="ratesComparisonChart"></canvas>
              </div>
            </div>

          </div>
        </section>
      </main>

      <main data-section="grade">
        <div class="page-header">
          <div>
            <h1>æˆç»©ç®¡ç†</h1>
            <p>æŸ¥çœ‹å’Œç®¡ç†å­¦ç”Ÿæˆç»©</p>
          </div>
          <div class="actions">
            <button class="btn" id="addStudentBtn">+ æ·»åŠ å­¦ç”Ÿ</button>
          </div>
        </div>

        <section class="filters">
          <input type="search" id="searchInput" placeholder="æŒ‰å§“å/å­¦å·æœç´¢" />
          <select id="classFilter"><option value="">å…¨éƒ¨ç­çº§</option></select>
          <select id="examFilter"><option value="">å…¨éƒ¨è€ƒè¯•</option></select>
          <button class="btn secondary compact-btn" id="columnSettingsBtn">âš™ï¸ åˆ—è®¾ç½®</button>
        </section>

        <section class="table-wrapper">
          <table class="ranking-table">
            <thead>
              <tr id="tableHeader">
                <th data-column="name">å§“å</th>
                <th data-column="student_no">å­¦å·</th>
                <th data-column="class_rank">ç­çº§æ’å</th>
                <th data-column="grade_rank">å¹´çº§æ’å</th>
                <th data-column="total_score">æ€»åˆ†</th>
                <th data-column="rating">è¯„åˆ†</th>
                <th data-column="è¯­æ–‡">è¯­æ–‡</th>
                <th data-column="æ•°å­¦">æ•°å­¦</th>
                <th data-column="è‹±è¯­">è‹±è¯­</th>
                <th data-column="ç‰©ç†">ç‰©ç†</th>
                <th data-column="åŒ–å­¦">åŒ–å­¦</th>
                <th data-column="ç”Ÿç‰©">ç”Ÿç‰©</th>
                <th data-column="å†å²">å†å²</th>
                <th data-column="æ”¿æ²»">æ”¿æ²»</th>
                <th data-column="åœ°ç†">åœ°ç†</th>
                <th data-column="actions">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="studentBody">
              <tr><td colspan="16" class="empty-tip">æ•°æ®åŠ è½½ä¸­...</td></tr>
            </tbody>
          </table>
        </section>
      </main>

      <main data-section="data">
        <div class="page-header">
          <div>
            <h1>æ•°æ®ç®¡ç†</h1>
            <p>æ‰¹é‡å¯¼å…¥å¯¼å‡ºæˆç»©ã€è®¾ç½®ç§‘ç›®åŒºé—´ã€‚</p>
          </div>
        </div>
        <div class="grade-manager">
          <section class="grade-card">
            <h2>ç­çº§ç®¡ç†åˆ—è¡¨</h2>
            <p class="hint-text">æŸ¥çœ‹æ‰€æœ‰ç­çº§çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬äººæ•°ã€æ€§åˆ«æ¯”ä¾‹ã€å¹³å‡åˆ†åŠå„é¡¹ç‡ã€‚</p>
            <div class="table-wrapper" style="margin-top:16px;">
              <table>
                <thead>
                  <tr>
                    <th>ç­çº§åç§°</th>
                    <th>å¹´çº§</th>
                    <th>äººæ•°</th>
                    <th>è€ƒè¯•åœºæ•°</th>
                    <th>ç”·ç”Ÿ</th>
                    <th>å¥³ç”Ÿ</th>
                    <th>æ€§åˆ«æ¯”ä¾‹(ç”·:å¥³)</th>
                    <th>ç­çº§å¹³å‡åˆ†</th>
                    <th>åŠæ ¼ç‡</th>
                    <th>è‰¯å¥½ç‡</th>
                    <th>ä¼˜ç§€ç‡</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="classStatsBody">
                  <tr><td colspan="12" class="empty-tip">æ•°æ®åŠ è½½ä¸­...</td></tr>
                </tbody>
              </table>
            </div>
          </section>
          <section class="collapsible-section">
            <div class="collapsible-header" data-target="importSection">
              <h2>æ‰¹é‡å¯¼å…¥æˆç»©</h2>
              <span class="collapsible-toggle">â–¼</span>
            </div>
            <div class="collapsible-content" id="importSection">
              <div class="collapsible-body">
                <p class="hint-text">å…ˆä¸‹è½½æ¨¡æ¿å¹¶å½•å…¥æˆç»©ï¼Œå†ä¸Šä¼  Excelã€‚æ”¯æŒä¸€æ¬¡å¯¼å…¥ä¸€ä¸ªç­çº§çš„æŸæ¬¡è€ƒè¯•ã€‚</p>
                <div class="import-actions">
                  <button class="btn secondary" id="downloadTemplate">ä¸‹è½½å¯¼å…¥æ¨¡æ¿</button>
                </div>
                <form class="inline-form" id="importForm">
                  <div class="inline-form-row">
                    <label style="flex: 1;">å¹´çº§
                      <input type="text" id="importGrade" list="gradeList" placeholder="è¯·é€‰æ‹©æˆ–è¾“å…¥æ–°å¹´çº§" />
                      <datalist id="gradeList"></datalist>
                    </label>
                    <label style="flex: 1;">ç­çº§
                      <input type="text" id="importClass" list="classList" placeholder="è¯·é€‰æ‹©æˆ–è¾“å…¥æ–°ç­çº§" />
                      <datalist id="classList"></datalist>
                    </label>
                    <label style="flex: 1;">è€ƒè¯•åç§°
                      <input type="text" id="importExam" placeholder="ä¾‹ï¼šæœŸä¸­è€ƒè¯•" required />
                    </label>
                    <label style="flex: 1;">Excel æ–‡ä»¶
                      <input type="file" id="importFile" accept=".xlsx,.xls" required />
                    </label>
                  </div>
                  <div class="import-actions">
                    <button class="btn" type="submit">ä¸Šä¼ å¹¶å¯¼å…¥</button>
                  </div>
                </form>
              </div>
            </div>
          </section>
          <section class="collapsible-section">
            <div class="collapsible-header" data-target="rankImportSection">
              <h2>å¯¼å…¥å¹´çº§æ’å</h2>
              <span class="collapsible-toggle">â–¼</span>
            </div>
            <div class="collapsible-content" id="rankImportSection">
              <div class="collapsible-body">
                <p class="hint-text">å¯¼å…¥å…¨å¹´çº§å­¦ç”Ÿçš„å¹´çº§æ’åå’Œç­çº§æ’åæ•°æ®ã€‚å¦‚æœæŸæ¬¡è€ƒè¯•æ‰€æœ‰ç§‘ç›®æˆç»©éƒ½å·²å½•å…¥ï¼Œç³»ç»Ÿå¯è‡ªåŠ¨è®¡ç®—å¹´çº§æ’åå’Œç­çº§æ’åï¼Œæ— éœ€æ‰‹åŠ¨å¯¼å…¥ã€‚</p>
                <div class="import-actions">
                  <button class="btn secondary" id="downloadRankTemplate">ä¸‹è½½æ’åæ¨¡æ¿</button>
                  <button class="btn" id="autoCalculateRanksBtn">è‡ªåŠ¨è®¡ç®—æ’å</button>
                </div>
                <form class="inline-form" id="rankImportForm">
                  <label>
                    <span>é€‰æ‹©æ’åæ–‡ä»¶ (Excel)</span>
                    <input type="file" id="rankImportFile" accept=".xlsx,.xls" required />
                  </label>
                  <div class="import-actions">
                    <button class="btn" type="submit">ä¸Šä¼ å¹¶å¯¼å…¥æ’å</button>
                  </div>
                </form>
              </div>
            </div>
          </section>
          <section class="collapsible-section">
            <div class="collapsible-header" data-target="exportSection">
              <h2>æˆç»©å¯¼å‡º</h2>
              <span class="collapsible-toggle">â–¼</span>
            </div>
            <div class="collapsible-content" id="exportSection">
              <div class="collapsible-body">
                <p class="hint-text">é€‰æ‹©ç­çº§æˆ–è€ƒè¯•å¯¼å‡ºæˆç»©ï¼Œè‹¥éƒ½ä¸ºç©ºåˆ™å¯¼å‡ºæ‰€æœ‰æ•°æ®ã€‚</p>
                <div class="inline-form-row">
                  <label>ç­çº§
                    <select id="exportClassSelect">
                      <option value="">å…¨éƒ¨ç­çº§</option>
                    </select>
                  </label>
                  <label>è€ƒè¯•
                    <select id="exportExamSelect">
                      <option value="">å…¨éƒ¨è€ƒè¯•</option>
                    </select>
                  </label>
                </div>
                <div class="import-actions">
                  <button class="btn secondary" id="exportBtn">å¯¼å‡º Excel</button>
                </div>
              </div>
            </div>
          </section>
          <section class="collapsible-section">
            <div class="collapsible-header" data-target="backupSection">
              <h2>æ•°æ®å¤‡ä»½ä¸æ¢å¤</h2>
              <span class="collapsible-toggle">â–¼</span>
            </div>
            <div class="collapsible-content" id="backupSection">
              <div class="collapsible-body">
                <p class="hint-text">å¤‡ä»½æ‰€æœ‰æˆç»©æ•°æ®åˆ°æ–‡ä»¶ï¼Œæˆ–ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®ã€‚</p>
                <div class="import-actions" style="gap: 12px;">
                  <button class="btn secondary" id="backupDataBtn">å¯¼å‡ºæ•°æ®å¤‡ä»½</button>
                </div>
                <form class="inline-form" id="restoreForm" style="margin-top: 20px;">
                  <label>
                    <span>é€‰æ‹©å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®</span>
                    <input type="file" id="restoreFile" accept=".json" />
                  </label>
                  <div class="import-actions">
                    <button class="btn" type="submit">æ¢å¤æ•°æ®</button>
                  </div>
                </form>
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                  <p class="hint-text" style="color: var(--danger); font-weight: 500;">å±é™©æ“ä½œï¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®</p>
                  <div class="import-actions" style="margin-top: 12px;">
                    <button class="btn" id="clearDataBtn" style="background: var(--danger); border-color: var(--danger);">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <section class="collapsible-section">
            <div class="collapsible-header" data-target="rangeSection">
              <h2>æˆç»©åŒºé—´è®¾ç½®</h2>
              <span class="collapsible-toggle">â–¼</span>
            </div>
            <div class="collapsible-content" id="rangeSection">
              <div class="collapsible-body">
                <p class="hint-text">ä¸ºæ¯ä¸ªç§‘ç›®å®šä¹‰ä¸åŠæ ¼/åŠæ ¼/è‰¯å¥½/ä¼˜ç§€çš„åˆ†æ•°èŒƒå›´ï¼Œä»ªè¡¨ç›˜ä¸æˆç»©ç®¡ç†å…±ç”¨ã€‚</p>
                <div class="inline-form-row">
                  <label>
                    ç§‘ç›®
                    <select id="rangeSubjectSelect"></select>
                  </label>
                </div>
                <form id="rangeForm">
                  <div class="range-config-list" id="rangeRows"></div>
                  <div class="import-actions">
                    <button class="btn" type="submit">ä¿å­˜é…ç½®</button>
                  </div>
                </form>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
      <div class="modal modal-wide">
        <h2 id="modalTitle">æ·»åŠ å­¦ç”Ÿ</h2>
        <form id="studentForm">
          <div class="field-group">
            <label>
              <span>å§“å *</span>
              <input type="text" name="name" required />
            </label>
            <label>
              <span>å­¦å· *</span>
              <input type="text" name="student_no" required />
            </label>
            <label>
              <span>æ€§åˆ«</span>
              <select name="gender">
                <option value="">è¯·é€‰æ‹©</option>
                <option value="ç”·">ç”·</option>
                <option value="å¥³">å¥³</option>
              </select>
            </label>
          </div>
          <div class="field-group">
            <label>
              <span>ç­çº§</span>
              <input type="text" name="class_name" placeholder="ä¾‹ï¼šé«˜ä¸€(3)ç­" />
            </label>
            <label>
              <span>å¹´çº§</span>
              <input type="text" name="grade_name" placeholder="ä¾‹ï¼šé«˜ä¸€" />
            </label>
            <label>
              <span>è€ƒè¯•åç§°</span>
              <input type="text" name="exam_name" placeholder="ä¾‹ï¼šæœŸä¸­è€ƒè¯•" />
            </label>
          </div>
          <div class="field-group">
            <label>
              <span>ç­çº§æ’å</span>
              <input type="number" name="class_rank" min="1" placeholder="ä¾‹ï¼š5" />
            </label>
            <label>
              <span>å¹´çº§æ’å</span>
              <input type="number" name="grade_rank" min="1" placeholder="ä¾‹ï¼š20" />
            </label>
          </div>
          <label>
            <span>å¤‡æ³¨</span>
            <textarea name="notes" rows="2" placeholder="å¯å†™è¾…å¯¼å»ºè®®ã€å¼‚å¸¸æƒ…å†µç­‰"></textarea>
          </label>
          <div>
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight:600;">å„ç§‘æˆç»©</span>
              <button class="btn secondary compact-btn" type="button" id="addScoreRow">+ æ·»åŠ ç§‘ç›®</button>
            </div>
            <div class="scores-list" id="scoreList"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn secondary" id="cancelModal">å–æ¶ˆ</button>
            <button type="submit" class="btn">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal-backdrop" id="columnSettingsModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>åˆ—è®¾ç½®</h2>
        <p class="hint-text">é€‰æ‹©è¦åœ¨è¡¨æ ¼ä¸­æ˜¾ç¤ºçš„åˆ—</p>
        <div id="columnCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin: 16px 0; max-height: 60vh; overflow-y: auto;"></div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelColumnSettings">å–æ¶ˆ</button>
          <button type="button" class="btn" id="saveColumnSettings">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="studentDetailModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 900px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 id="detailStudentName" style="margin: 0;">å­¦ç”Ÿæˆç»©æŠ¥å‘Š</h2>
          <div style="display: flex; gap: 8px; font-size: 13px; color: #6b7280;">
            <span id="detailStudentNo"></span>
            <span id="detailClassName"></span>
            <span id="detailExamInfo"></span>
          </div>
        </div>

        <!-- é€‰é¡¹å¡å¯¼èˆª -->
        <div class="tabs" style="margin-bottom: 20px;">
          <button class="tab-button active" data-detail-tab="overview">æˆç»©æ¦‚è§ˆ</button>
          <button class="tab-button" data-detail-tab="trend">è¶‹åŠ¿åˆ†æ</button>
          <button class="tab-button" data-detail-tab="analysis">è¯¦ç»†åˆ†æ</button>
          <button class="tab-button" data-detail-tab="info">å­¦ç”Ÿä¿¡æ¯</button>
        </div>

        <!-- æˆç»©æ¦‚è§ˆæ ‡ç­¾é¡µ -->
        <div class="tab-content active" id="overviewTab" style="max-height: 60vh; overflow-y: auto;">
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">æ€»åˆ†</div>
              <div style="font-size: 32px; font-weight: 700; color: #111827;" id="overviewTotalScore">0</div>
            </div>
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">ç­çº§æ’å</div>
              <div style="font-size: 32px; font-weight: 700; color: #111827;" id="overviewClassRank">-</div>
            </div>
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">å¹³å‡åˆ†</div>
              <div style="font-size: 32px; font-weight: 700; color: #111827;" id="overviewAvgScore">0</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
            <div style="background: #ecfdf5; padding: 16px; border-radius: 10px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #059669;" id="overviewLevel">è‰¯å¥½</div>
              <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">ç­‰çº§è¯„å®š</div>
            </div>
            <div style="background: #fef3c7; padding: 16px; border-radius: 10px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #d97706;" id="overviewBestSubject">åŒ–å­¦</div>
              <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">æœ€å¼ºç§‘ç›®</div>
            </div>
            <div style="background: #fee2e2; padding: 16px; border-radius: 10px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #dc2626;" id="overviewWeakSubject">ç‰©ç†</div>
              <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">å¾…æé«˜ç§‘ç›®</div>
            </div>
          </div>

          <h3 style="margin: 24px 0 16px; font-size: 16px;">å„ç§‘æˆç»©å¯¹æ¯”</h3>
          <div style="height: 300px; position: relative; margin-bottom: 20px;">
            <canvas id="overviewRadarChart"></canvas>
          </div>

          <!-- å•ç§‘ç»Ÿè®¡è¡¨æ ¼ -->
          <h3 style="margin: 24px 0 16px; font-size: 16px;">ğŸ“Š å•ç§‘ç»Ÿè®¡</h3>
          <div style="overflow-x: auto; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr>
                  <th style="background: #f3f4f6; padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb; font-size: 13px;">ç§‘ç›®</th>
                  <th style="background: #f3f4f6; padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb; font-size: 13px;">å¹³å‡åˆ†</th>
                  <th style="background: #f3f4f6; padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb; font-size: 13px;">æœ€é«˜åˆ†</th>
                  <th style="background: #f3f4f6; padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb; font-size: 13px;">åŠæ ¼äººæ•°</th>
                  <th style="background: #f3f4f6; padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb; font-size: 13px;">è‰¯å¥½äººæ•°</th>
                  <th style="background: #f3f4f6; padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb; font-size: 13px;">ä¼˜ç§€äººæ•°</th>
                </tr>
              </thead>
              <tbody id="overviewSubjectStatsBody">
                <tr>
                  <td colspan="6" style="padding: 20px; text-align: center; color: #6b7280;">åŠ è½½ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- è¶‹åŠ¿åˆ†ææ ‡ç­¾é¡µ -->
        <div class="tab-content" id="trendTab" style="max-height: 60vh; overflow-y: auto;">
          <div style="height: 300px; position: relative; margin-bottom: 20px;">
            <canvas id="trendScoreChart"></canvas>
          </div>
          <div style="height: 300px; position: relative;">
            <canvas id="trendSubjectChart"></canvas>
          </div>
        </div>

        <!-- è¯¦ç»†åˆ†ææ ‡ç­¾é¡µ -->
        <div class="tab-content" id="analysisTab" style="max-height: 60vh; overflow-y: auto;">
          <h3 style="margin: 0 0 16px; font-size: 16px;">è¯¦ç»†åˆ†ææŠ¥å‘Š</h3>
          <div id="subjectAnalysisList" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
            <!-- åŠ¨æ€ç”Ÿæˆå„ç§‘ç›®è¯¦ç»†åˆ†æ -->
          </div>

          <h3 style="margin: 24px 0 16px; font-size: 16px;">çŸ¥è¯†ç‚¹ä¸å¼±é¡¹åˆ†æ</h3>
          <div id="weaknessAnalysis" style="background: #f9fafb; padding: 20px; border-radius: 12px;">
            <!-- åŠ¨æ€ç”Ÿæˆå¼±é¡¹åˆ†æ -->
          </div>
        </div>

        <!-- å­¦ç”Ÿä¿¡æ¯æ ‡ç­¾é¡µ -->
        <div class="tab-content" id="infoTab" style="max-height: 60vh; overflow-y: auto;">
          <form id="studentDetailForm">
            <div class="info-grid" id="studentInfoGrid"></div>
          </form>
        </div>

        <div class="modal-footer" style="margin-top: 20px;">
          <button type="button" class="btn secondary" id="closeDetailModal">å…³é—­</button>
          <button type="button" class="btn secondary" id="editDetailBtn">ç¼–è¾‘</button>
          <button type="button" class="btn" id="saveDetailBtn" style="display: none;">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="classEditModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>ç¼–è¾‘ç­çº§</h2>
        <form id="classEditForm">
          <div class="field-group">
            <label>
              <span>ç­çº§åç§° *</span>
              <input type="text" name="class_name" id="editClassName" required />
            </label>
            <label>
              <span>å¹´çº§</span>
              <input type="text" name="grade_name" id="editGradeName" placeholder="ä¾‹ï¼šé«˜ä¸€" />
            </label>
          </div>
          <p class="hint-text">ä¿®æ”¹ç­çº§åç§°æˆ–å¹´çº§å°†æ›´æ–°è¯¥ç­çº§æ‰€æœ‰å­¦ç”Ÿçš„è®°å½•ã€‚</p>
          <div class="modal-footer">
            <button type="button" class="btn secondary" id="cancelClassEdit">å–æ¶ˆ</button>
            <button type="submit" class="btn">ä¿å­˜</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal-backdrop" id="radarSettingsModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>ç§‘ç›®é›·è¾¾å›¾è®¾ç½®</h2>
        <p class="hint-text">é€‰æ‹©è¦åœ¨é›·è¾¾å›¾ä¸­æ˜¾ç¤ºçš„ç§‘ç›®ï¼ˆè‡³å°‘é€‰æ‹©3ä¸ªç§‘ç›®ï¼‰</p>
        <div style="margin-top: 24px;">
          <div id="radarSubjectCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;"></div>
        </div>
        <div class="modal-footer" style="margin-top: 24px;">
          <button type="button" class="btn secondary" id="cancelRadarSettings">å–æ¶ˆ</button>
          <button type="button" class="btn" id="saveRadarSettings">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="progressSettingsModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>ğŸ“Š è¿›æ­¥é€€æ­¥åˆ†æè®¾ç½®</h2>
        <p class="hint-text">é€‰æ‹©å¯¹æ¯”æ–¹å¼å’Œæ˜¾ç¤ºäººæ•°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—å­¦ç”Ÿçš„è¿›æ­¥æˆ–é€€æ­¥æƒ…å†µ</p>

        <div style="margin-top: 24px;">
          <label style="display: block; margin-bottom: 12px; font-weight: 600;">å¯¹æ¯”æ–¹å¼</label>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="compareMode" value="2" style="width: 18px; height: 18px; cursor: pointer;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">æœ€è¿‘2åœºå¯¹æ¯”</div>
                <div style="font-size: 13px; color: #718096; margin-top: 4px;">å¯¹æ¯”æœ€æ–°1åœº vs å‰1åœºï¼ˆçµæ•ï¼Œé€‚åˆçŸ­æœŸæ¿€åŠ±ï¼‰</div>
              </div>
            </label>
            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid #3b82f6; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: rgba(59, 130, 246, 0.05);">
              <input type="radio" name="compareMode" value="3" checked style="width: 18px; height: 18px; cursor: pointer;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">æœ€è¿‘3åœºç»¼åˆå¯¹æ¯” â­ æ¨è</div>
                <div style="font-size: 13px; color: #718096; margin-top: 4px;">å¯¹æ¯”æœ€æ–°1åœº vs å‰2åœºå¹³å‡ï¼ˆç¨³å®šï¼Œè¿‡æ»¤å¶ç„¶æ³¢åŠ¨ï¼‰</div>
              </div>
            </label>
            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="compareMode" value="5" style="width: 18px; height: 18px; cursor: pointer;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">æœ€è¿‘5åœºè¶‹åŠ¿å¯¹æ¯”</div>
                <div style="font-size: 13px; color: #718096; margin-top: 4px;">å¯¹æ¯”æœ€è¿‘2åœºå¹³å‡ vs å‰3åœºå¹³å‡ï¼ˆé•¿æœŸè¶‹åŠ¿ï¼‰</div>
              </div>
            </label>
            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="compareMode" value="custom" style="width: 18px; height: 18px; cursor: pointer;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">è‡ªå®šä¹‰åœºæ¬¡</div>
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                  <span style="font-size: 13px; color: #718096;">å¯¹æ¯”æœ€è¿‘</span>
                  <input type="number" id="customExamCount" min="2" max="50" value="10"
                    style="width: 70px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; text-align: center;"
                    onclick="event.stopPropagation(); document.querySelector('input[value=custom]').checked = true; document.querySelector('input[value=custom]').dispatchEvent(new Event('change'));">
                  <span style="font-size: 13px; color: #718096;">åœºè€ƒè¯•ï¼ˆçµæ´»è®¾ç½®ï¼‰</span>
                </div>
                <div style="font-size: 12px; color: #f59e0b; margin-top: 6px;">ğŸ’¡ è®¡ç®—æ–¹å¼ï¼šæœ€æ–°1åœº vs å‰N-1åœºå¹³å‡</div>
              </div>
            </label>
          </div>
        </div>

        <div style="margin-top: 24px;">
          <label style="display: block; margin-bottom: 12px; font-weight: 600;">æ˜¾ç¤ºäººæ•°</label>
          <select id="progressTopCount" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
            <option value="5">å‰5å</option>
            <option value="10" selected>å‰10å</option>
            <option value="15">å‰15å</option>
            <option value="20">å‰20å</option>
          </select>
        </div>

        <div class="modal-footer" style="margin-top: 24px;">
          <button type="button" class="btn secondary" id="cancelProgressSettings">å–æ¶ˆ</button>
          <button type="button" class="btn" id="saveProgressSettings">ä¿å­˜</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="shareModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>ç”Ÿæˆåˆ†äº«é“¾æ¥</h2>
        <p class="hint-text">é€‰æ‹©è€ƒè¯•åœºæ¬¡å’ŒæŸ¥è¯¢é“¾æ¥çš„æœ‰æ•ˆæœŸï¼Œè¿‡æœŸåå®¶é•¿å°†æ— æ³•ä½¿ç”¨è¯¥é“¾æ¥æŸ¥è¯¢æˆç»©ã€‚</p>
        <div style="margin-top: 24px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">é€‰æ‹©è€ƒè¯•åœºæ¬¡ *</label>
          <select id="shareExamSelect" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px;">
            <option value="">å…¨éƒ¨è€ƒè¯•</option>
          </select>

          <label style="display: block; margin-bottom: 12px; font-weight: 600;">é€‰æ‹©æœ‰æ•ˆæœŸ</label>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <button type="button" class="btn secondary" data-days="3" style="padding: 16px;">3å¤©</button>
            <button type="button" class="btn secondary" data-days="7" style="padding: 16px;">7å¤©</button>
            <button type="button" class="btn secondary" data-days="15" style="padding: 16px;">15å¤©</button>
            <button type="button" class="btn secondary" data-days="30" style="padding: 16px;">30å¤©</button>
          </div>
          <div style="margin-top: 16px;">
            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--subtext);">è‡ªå®šä¹‰å¤©æ•°</label>
            <input type="number" id="customDays" min="1" max="365" placeholder="è¾“å…¥1-365å¤©" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border);" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelShare">å–æ¶ˆ</button>
          <button type="button" class="btn" id="confirmShare">ç”Ÿæˆé“¾æ¥</button>
        </div>
      </div>
    </div>

    <!-- å­¦ç”Ÿé€‰æ‹©å¼¹çª— -->
    <div class="modal-backdrop" id="studentSelectModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 600px;">
        <h2>é€‰æ‹©å­¦ç”Ÿï¼ˆæœ€å¤š5äººï¼‰</h2>
        <p class="hint-text">é€‰æ‹©è¦å¯¹æ¯”çš„å­¦ç”Ÿï¼Œä¸åŒå­¦ç”Ÿå°†ç”¨ä¸åŒé¢œè‰²çš„æ›²çº¿æ˜¾ç¤º</p>
        <div style="margin: 20px 0;">
          <input type="search" id="studentSearchInput" placeholder="æœç´¢å­¦ç”Ÿå§“åæˆ–å­¦å·..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 16px;" />
          <div id="studentCheckboxList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
            <!-- åŠ¨æ€å¡«å……å­¦ç”Ÿå¤é€‰æ¡† -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelStudentSelect">å–æ¶ˆ</button>
          <button type="button" class="btn" id="confirmStudentSelect">ç¡®å®š</button>
        </div>
      </div>
    </div>

    <!-- ç§‘ç›®é€‰æ‹©å¼¹çª— -->
    <div class="modal-backdrop" id="subjectSelectModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 500px;">
        <h2>é€‰æ‹©æ˜¾ç¤ºç§‘ç›®</h2>
        <p class="hint-text">é€‰æ‹©è¦åœ¨èµ°åŠ¿å›¾ä¸­æ˜¾ç¤ºçš„ç§‘ç›®</p>
        <div id="subjectCheckboxList" style="margin: 20px 0; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
          <!-- åŠ¨æ€å¡«å……ç§‘ç›®å¤é€‰æ¡† -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelSubjectSelect">å–æ¶ˆ</button>
          <button type="button" class="btn" id="confirmSubjectSelect">ç¡®å®š</button>
        </div>
      </div>
    </div>

    <!-- ç­çº§ç­›é€‰å¼¹çª— -->
    <div class="modal-backdrop" id="classFilterModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 600px;">
        <h2>ğŸ“š ç­›é€‰ç­çº§</h2>
        <p class="hint-text">å¯ä»¥é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªç­çº§è¿›è¡Œæ•°æ®ç»Ÿè®¡</p>
        <div style="margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: 600; font-size: 14px;">å·²é€‰æ‹© <span id="selectedClassCount">0</span> ä¸ªç­çº§</span>
            <div style="display: flex; gap: 8px;">
              <button type="button" class="btn secondary" id="selectAllClasses" style="padding: 6px 12px; font-size: 13px;">å…¨é€‰</button>
              <button type="button" class="btn secondary" id="clearAllClasses" style="padding: 6px 12px; font-size: 13px;">æ¸…ç©º</button>
            </div>
          </div>
          <div id="classCheckboxList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <!-- åŠ¨æ€å¡«å……ç­çº§å¤é€‰æ¡† -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelClassFilter">å–æ¶ˆ</button>
          <button type="button" class="btn" id="confirmClassFilter">åº”ç”¨ç­›é€‰</button>
        </div>
      </div>
    </div>

    <!-- è€ƒè¯•ç­›é€‰å¼¹çª— -->
    <div class="modal-backdrop" id="examFilterModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 600px;">
        <h2>ğŸ“ ç­›é€‰è€ƒè¯•</h2>
        <p class="hint-text">å¯ä»¥é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªè€ƒè¯•è¿›è¡Œæ•°æ®ç»Ÿè®¡</p>
        <div style="margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: 600; font-size: 14px;">å·²é€‰æ‹© <span id="selectedExamCount">0</span> ä¸ªè€ƒè¯•</span>
            <div style="display: flex; gap: 8px;">
              <button type="button" class="btn secondary" id="selectAllExams" style="padding: 6px 12px; font-size: 13px;">å…¨é€‰</button>
              <button type="button" class="btn secondary" id="clearAllExams" style="padding: 6px 12px; font-size: 13px;">æ¸…ç©º</button>
            </div>
          </div>
          <div id="examCheckboxList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <!-- åŠ¨æ€å¡«å……è€ƒè¯•å¤é€‰æ¡† -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelExamFilter">å–æ¶ˆ</button>
          <button type="button" class="btn" id="confirmExamFilter">åº”ç”¨ç­›é€‰</button>
        </div>
      </div>
    </div>

    <!-- ç­çº§é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal-backdrop" id="classSelectionModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 700px;">
        <h2>ğŸ“‹ é€‰æ‹©å¯¹æ¯”ç­çº§</h2>
        <p class="hint-text">è¯·é€‰æ‹©è‡³å°‘2ä¸ªç­çº§è¿›è¡Œå¯¹æ¯”åˆ†æï¼ˆæœ€å¤šé€‰æ‹©6ä¸ªï¼‰</p>

        <!-- è€ƒè¯•ç­›é€‰ -->
        <div style="margin: 16px 0;">
          <label style="font-weight: 600; font-size: 14px; color: #111827; margin-bottom: 8px; display: block;">ç­›é€‰è€ƒè¯•</label>
          <select id="classComparisonExamFilter" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
            <option value="">å…¨éƒ¨è€ƒè¯•</option>
          </select>
        </div>

        <div style="margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: 600; font-size: 14px;">å·²é€‰æ‹© <span id="selectedClassCount">0</span> ä¸ªç­çº§</span>
            <div style="display: flex; gap: 8px;">
              <button type="button" class="btn secondary" id="selectAllClasses" style="padding: 6px 12px; font-size: 13px;">å…¨é€‰</button>
              <button type="button" class="btn secondary" id="clearAllClasses" style="padding: 6px 12px; font-size: 13px;">æ¸…ç©º</button>
            </div>
          </div>
          <div id="classCheckboxList" style="max-height: 350px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <!-- åŠ¨æ€å¡«å……ç­çº§å¤é€‰æ¡† -->
            <p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 20px;">åŠ è½½ç­çº§åˆ—è¡¨ä¸­...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelClassSelection">å–æ¶ˆ</button>
          <button type="button" class="btn" id="confirmClassSelection">å¼€å§‹å¯¹æ¯”</button>
        </div>
      </div>
    </div>

    <div class="notification" id="notify"></div>

    <script>
      // åˆå§‹åŒ–è®¤è¯å®ˆå«
      authGuard.init({
        required: true,
        onAuth: (user) => {
          // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼ˆVIP3ï¼‰ï¼Œæ˜¾ç¤ºç³»ç»Ÿç®¡ç†èœå•
          if (user.vip_level >= 3) {
            document.getElementById('systemMenuBtn').style.display = 'block';
          }
        }
      });

      const API_BASE = "/api/students";
      const studentBody = document.getElementById("studentBody");
      const subjectTabsEl = document.getElementById("subjectTabs");
      const modalBackdrop = document.getElementById("modalBackdrop");
      const studentForm = document.getElementById("studentForm");
      const modalTitle = document.getElementById("modalTitle");
      const addStudentBtn = document.getElementById("addStudentBtn");
      const addStudentBtn2 = document.getElementById("addStudentBtn2");
      const cancelModal = document.getElementById("cancelModal");
      const addScoreRowBtn = document.getElementById("addScoreRow");
      const scoreList = document.getElementById("scoreList");
      const notify = document.getElementById("notify");
      const classFilter = document.getElementById("classFilter");
      const examFilter = document.getElementById("examFilter");
      const searchInput = document.getElementById("searchInput");
      const refreshBtn = document.getElementById("refreshBtn");
      const downloadTemplateBtn = document.getElementById("downloadTemplate");
      const importForm = document.getElementById("importForm");
      const importFileInput = document.getElementById("importFile");
      const importClassInput = document.getElementById("importClass");
      const importGradeInput = document.getElementById("importGrade");
      const importExamInput = document.getElementById("importExam");
      const exportClassSelect = document.getElementById("exportClassSelect");
      const exportExamSelect = document.getElementById("exportExamSelect");
      const exportBtn = document.getElementById("exportBtn");
      const rangeSubjectSelect = document.getElementById("rangeSubjectSelect");
      const rangeForm = document.getElementById("rangeForm");
      const rangeRows = document.getElementById("rangeRows");
      const autoCalculateRanksBtn = document.getElementById("autoCalculateRanksBtn");
      const backupDataBtn = document.getElementById("backupDataBtn");
      const restoreForm = document.getElementById("restoreForm");
      const restoreFile = document.getElementById("restoreFile");
      const clearDataBtn = document.getElementById("clearDataBtn");
      const columnSettingsBtn = document.getElementById("columnSettingsBtn");
      const columnSettingsModal = document.getElementById("columnSettingsModal");
      const columnCheckboxes = document.getElementById("columnCheckboxes");
      const cancelColumnSettings = document.getElementById("cancelColumnSettings");
      const saveColumnSettings = document.getElementById("saveColumnSettings");
      const studentDetailModal = document.getElementById("studentDetailModal");
      const detailStudentName = document.getElementById("detailStudentName");
      const studentInfoGrid = document.getElementById("studentInfoGrid");
      const closeDetailModal = document.getElementById("closeDetailModal");
      const editDetailBtn = document.getElementById("editDetailBtn");
      const saveDetailBtn = document.getElementById("saveDetailBtn");
      const studentDetailForm = document.getElementById("studentDetailForm");
      const classStatsBody = document.getElementById("classStatsBody");
      const classEditModal = document.getElementById("classEditModal");
      const classEditForm = document.getElementById("classEditForm");
      const editClassName = document.getElementById("editClassName");
      const editGradeName = document.getElementById("editGradeName");
      const cancelClassEdit = document.getElementById("cancelClassEdit");

      // ç­›é€‰å™¨ç›¸å…³å…ƒç´ 
      const filterClassBtn = document.getElementById("filterClassBtn");
      const filterExamBtn = document.getElementById("filterExamBtn");
      const filterClassText = document.getElementById("filterClassText");
      const filterExamText = document.getElementById("filterExamText");
      const classCount = document.getElementById("classCount");
      const examCount = document.getElementById("examCount");
      const classFilterModal = document.getElementById("classFilterModal");
      const examFilterModal = document.getElementById("examFilterModal");
      const classCheckboxList = document.getElementById("classCheckboxList");
      const examCheckboxList = document.getElementById("examCheckboxList");
      const selectedClassCount = document.getElementById("selectedClassCount");
      const selectedExamCount = document.getElementById("selectedExamCount");
      const selectAllClasses = document.getElementById("selectAllClasses");
      const clearAllClasses = document.getElementById("clearAllClasses");
      const selectAllExams = document.getElementById("selectAllExams");
      const clearAllExams = document.getElementById("clearAllExams");
      const cancelClassFilter = document.getElementById("cancelClassFilter");
      const confirmClassFilter = document.getElementById("confirmClassFilter");
      const cancelExamFilter = document.getElementById("cancelExamFilter");
      const confirmExamFilter = document.getElementById("confirmExamFilter");

      // ç­›é€‰å™¨çŠ¶æ€
      let selectedClasses = [];
      let selectedExams = [];
      let allClassList = [];
      let allExamList = [];
      const selectStudentsBtn = document.getElementById("selectStudentsBtn");
      const selectSubjectsBtn = document.getElementById("selectSubjectsBtn");
      const studentSelectModal = document.getElementById("studentSelectModal");
      const subjectSelectModal = document.getElementById("subjectSelectModal");
      const studentCheckboxList = document.getElementById("studentCheckboxList");
      const subjectCheckboxList = document.getElementById("subjectCheckboxList");
      const studentSearchInput = document.getElementById("studentSearchInput");
      const cancelStudentSelect = document.getElementById("cancelStudentSelect");
      const confirmStudentSelect = document.getElementById("confirmStudentSelect");
      const cancelSubjectSelect = document.getElementById("cancelSubjectSelect");
      const confirmSubjectSelect = document.getElementById("confirmSubjectSelect");
      const selectedStudentsList = document.getElementById("selectedStudentsList");
      const selectedStudentCount = document.getElementById("selectedStudentCount");
      const selectedSubjectCount = document.getElementById("selectedSubjectCount");
      const studentTrendChartContainer = document.getElementById("studentTrendChartContainer");
      const studentTrendPlaceholder = document.getElementById("studentTrendPlaceholder");
      const studentTrendStats = document.getElementById("studentTrendStats");
      const shareModal = document.getElementById("shareModal");
      const cancelShare = document.getElementById("cancelShare");
      const confirmShare = document.getElementById("confirmShare");
      const customDays = document.getElementById("customDays");
      const shareExamSelect = document.getElementById("shareExamSelect");

      let students = [];
      let editingClassName = null;
      let summary = null;
      let editingId = null;
      let currentDetailStudent = null;
      let isEditingDetail = false;
      let classStats = [];
      let trendExamCount = 3; // æŒ‰åœºæ¬¡ï¼šé»˜è®¤æ˜¾ç¤ºè¿‘3åœº
      let trendDateRange = null; // æŒ‰æ—¶é—´ï¼š{startDate, endDate} æˆ– null
      let shareClassName = null;
      let selectedDays = 30;
      let selectedStudentNos = []; // å­¦ç”Ÿèµ°åŠ¿å¯¹æ¯”ï¼šé€‰ä¸­çš„å­¦ç”Ÿå­¦å·åˆ—è¡¨ï¼ˆæœ€å¤š5ä¸ªï¼‰
      let selectedTrendSubjects = ["æ€»åˆ†"]; // å­¦ç”Ÿèµ°åŠ¿å¯¹æ¯”ï¼šé€‰ä¸­çš„ç§‘ç›®åˆ—è¡¨
      let studentTrendChart = null; // å­¦ç”Ÿèµ°åŠ¿å¯¹æ¯”å›¾è¡¨å®ä¾‹
      let allAvailableTrendSubjects = ["æ€»åˆ†", "è¯­æ–‡", "æ•°å­¦", "è‹±è¯­", "ç‰©ç†", "åŒ–å­¦", "ç”Ÿç‰©", "å†å²", "æ”¿æ²»", "åœ°ç†"]; // æ‰€æœ‰å¯ç”¨ç§‘ç›®

      // 5ä¸ªå­¦ç”Ÿå¯¹åº”çš„é¢œè‰²
      const studentColors = [
        { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },   // ç´«è‰²
        { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },   // è“è‰²
        { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },   // ç»¿è‰²
        { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },   // æ©™è‰²
        { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' }    // ç²‰è‰²
      ];

      const scoreSubjects = ["è¯­æ–‡", "æ•°å­¦", "è‹±è¯­", "ç‰©ç†", "åŒ–å­¦", "ç”Ÿç‰©", "å†å²", "æ”¿æ²»", "åœ°ç†"];
      const allColumns = [
        { key: "name", label: "å§“å", fixed: true },
        { key: "student_no", label: "å­¦å·", fixed: true },
        { key: "class_rank", label: "ç­çº§æ’å", fixed: false },
        { key: "grade_rank", label: "å¹´çº§æ’å", fixed: false },
        { key: "total_score", label: "æ€»åˆ†", fixed: false },
        { key: "rating", label: "è¯„åˆ†", fixed: false },
        ...scoreSubjects.map(s => ({ key: s, label: s, fixed: false })),
        { key: "actions", label: "æ“ä½œ", fixed: true }
      ];
      let visibleColumns = allColumns.map(c => c.key);
      const subjectTabsList = ["æ€»åˆ†", ...scoreSubjects];
      const rangeSubjects = ["æ€»åˆ†", ...scoreSubjects];
      const subjectsPreset = [...scoreSubjects];
      const DEFAULT_RANGE_TEMPLATE = [
        { key: "fail", name: "ä¸åŠæ ¼", min: 0, max: 60 },
        { key: "pass", name: "åŠæ ¼", min: 60, max: 80 },
        { key: "good", name: "è‰¯å¥½", min: 80, max: 90 },
        { key: "excellent", name: "ä¼˜ç§€", min: 90, max: 100 },
      ];
      let gradeRanges = {};
      let availableClasses = [];
      let availableExams = [];
      let selectedSubject = "æ€»åˆ†";
      let currentRangeSubject = "æ€»åˆ†";

      function createDefaultRanges() {
        return DEFAULT_RANGE_TEMPLATE.map((range) => ({ ...range }));
      }
      function getSubjectRanges(subject) {
        if (gradeRanges && gradeRanges[subject]) {
          return gradeRanges[subject];
        }
        return createDefaultRanges();
      }
      async function loadGradeConfig() {
        try {
          const res = await fetch(`${API_BASE}/ranges`);
          if (!res.ok) throw new Error("æ— æ³•è·å–åŒºé—´é…ç½®");
          gradeRanges = await res.json();
        } catch (error) {
          gradeRanges = {};
          showToast(error.message, true);
        }
        renderRangeSubjectOptions();
        renderRangeRows();
      }
      function renderRangeSubjectOptions() {
        if (!rangeSubjectSelect) return;
        rangeSubjectSelect.innerHTML = rangeSubjects
          .map((subject) => `<option value="${subject}">${subject}</option>`)
          .join("");
        rangeSubjectSelect.value = currentRangeSubject;
      }
      function renderRangeRows() {
        if (!rangeRows) return;
        const ranges = getSubjectRanges(currentRangeSubject);
        rangeRows.innerHTML = ranges
          .map(
            (range) => `
            <div class="range-row" data-key="${range.key}">
              <div class="range-label">${range.name}</div>
              <input type="number" data-field="min" step="0.1" value="${range.min}" placeholder="æœ€ä½åˆ†" required />
              <span>è‡³</span>
              <input type="number" data-field="max" step="0.1" value="${range.max ?? ""}" placeholder="æœ€é«˜åˆ†ï¼ˆå¯ç©ºï¼‰" />
            </div>
          `,
          )
          .join("");
      }

      renderSubjectTabs();

      document.querySelectorAll("nav button").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll("nav button").forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const target = btn.dataset.target;
          document.querySelectorAll("main[data-section]").forEach((section) => {
            section.classList.toggle("active", section.dataset.section === target);
          });
        });
      });

      function showToast(message, isError = false) {
        notify.textContent = message;
        notify.style.background = isError ? "#b91c1c" : "#111827";
        notify.classList.add("show");
        setTimeout(() => notify.classList.remove("show"), 2600);
      }

      function openModal(student) {
        editingId = student ? student.id : null;
        modalTitle.textContent = student ? "ç¼–è¾‘å­¦ç”Ÿ" : "æ·»åŠ å­¦ç”Ÿ";
        studentForm.reset();
        scoreList.innerHTML = "";
        const scores = student?.scores?.length ? student.scores : subjectsPreset.map((s) => ({ subject: s, score: "" }));
        scores.forEach((row) => addScoreRow(row.subject, row.score));
        ["name", "student_no", "class_name", "grade_name", "exam_name", "notes", "class_rank", "grade_rank"].forEach((field) => {
          studentForm.elements[field].value = student?.[field] ?? "";
        });
        modalBackdrop.classList.add("active");
      }
      function closeModal() {
        modalBackdrop.classList.remove("active");
      }

      function addScoreRow(subject = "", score = "") {
        const wrapper = document.createElement("div");
        wrapper.className = "score-row";
        wrapper.innerHTML = `
          <input type="text" placeholder="ç§‘ç›®" value="${subject}" />
          <input type="number" placeholder="åˆ†æ•°" value="${score}" min="0" max="150" step="0.5" />
          <button type="button" title="åˆ é™¤è¿™è¡Œ">Ã—</button>
        `;
        wrapper.querySelector("button").addEventListener("click", () => wrapper.remove());
        scoreList.appendChild(wrapper);
      }

      function getScoresFromForm() {
        const rows = [...scoreList.querySelectorAll(".score-row")];
        const scores = [];
        rows.forEach((row) => {
          const [subjectInput, scoreInput] = row.querySelectorAll("input");
          const subject = subjectInput.value.trim();
          const scoreValue = scoreInput.value.trim();
          if (!subject && !scoreValue) return;
          const score = Number(scoreValue);
          if (!subject || Number.isNaN(score)) return;
          scores.push({ subject, score });
        });
        return scores;
      }

      async function saveStudent(event) {
        event.preventDefault();
        const form = new FormData(studentForm);
        const payload = Object.fromEntries(form.entries());
        payload.scores = getScoresFromForm();
        if (payload.scores.length === 0) {
          showToast("è¯·è‡³å°‘å½•å…¥ä¸€ä¸ªç§‘ç›®æˆç»©", true);
          return;
        }

        // è½¬æ¢æ•°å­—å­—æ®µï¼Œç©ºå€¼è½¬ä¸º null
        if (payload.class_rank) {
          payload.class_rank = parseInt(payload.class_rank);
        } else {
          delete payload.class_rank;
        }

        if (payload.grade_rank) {
          payload.grade_rank = parseInt(payload.grade_rank);
        } else {
          delete payload.grade_rank;
        }

        // æ¸…ç†ç©ºå­—ç¬¦ä¸²å­—æ®µ
        Object.keys(payload).forEach(key => {
          if (payload[key] === '') {
            delete payload[key];
          }
        });

        const method = editingId ? "PUT" : "POST";
        const url = editingId ? `${API_BASE}/${editingId}` : API_BASE;
        try {
          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "ä¿å­˜å¤±è´¥");
          }
          showToast("ä¿å­˜æˆåŠŸ");
          closeModal();
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function deleteStudent(id) {
        if (!confirm("ç¡®è®¤åˆ é™¤è¯¥å­¦ç”Ÿè®°å½•ï¼Ÿ")) return;
        try {
          const res = await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
          if (!res.ok) throw new Error("åˆ é™¤å¤±è´¥");
          showToast("å·²åˆ é™¤");
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }


      function renderSubjectTabs() {
        if (!subjectTabsEl) return;
        subjectTabsEl.innerHTML = subjectTabsList
          .map(
            (subject) => `
            <button class="subject-tab ${selectedSubject === subject ? "active" : ""}" data-subject="${subject}">
              ${subject}
            </button>
          `,
          )
          .join("");
      }

      function renderFilters() {
        const classes = new Set();
        const grades = new Set();
        const exams = new Set();
        students.forEach((student) => {
          if (student.class_name) classes.add(student.class_name);
          if (student.grade_name) grades.add(student.grade_name);
          if (student.exam_name) exams.add(student.exam_name);
        });
        availableClasses = [...classes];
        availableExams = [...exams];
        const availableGrades = [...grades];

        populateSelect(classFilter, availableClasses, "å…¨éƒ¨ç­çº§", true);
        populateSelect(examFilter, availableExams, "å…¨éƒ¨è€ƒè¯•", true);
        populateSelect(exportClassSelect, availableClasses, "å…¨éƒ¨ç­çº§", true);
        populateSelect(exportExamSelect, availableExams, "å…¨éƒ¨è€ƒè¯•", true);
        populateDatalist('gradeList', availableGrades);
        populateDatalist('classList', availableClasses);
        renderSubjectTabs();
      }

      function populateSelect(selectEl, values, placeholder, includeEmpty) {
        if (!selectEl) return;
        const options = includeEmpty ? `<option value="">${placeholder}</option>` : "";
        selectEl.innerHTML = options + values.map((value) => `<option value="${value}">${value}</option>`).join("");
      }

      function populateDatalist(datalistId, values) {
        const datalist = document.getElementById(datalistId);
        if (!datalist) return;
        datalist.innerHTML = values.map((value) => `<option value="${value}">`).join("");
      }

      function loadColumnSettings() {
        const saved = localStorage.getItem("visibleColumns");
        if (saved) {
          try {
            visibleColumns = JSON.parse(saved);
          } catch (e) {
            visibleColumns = allColumns.map(c => c.key);
          }
        }
      }

      function saveColumnSettingsToStorage() {
        localStorage.setItem("visibleColumns", JSON.stringify(visibleColumns));
      }

      function openColumnSettings() {
        columnCheckboxes.innerHTML = allColumns.map(col => `
          <label style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 8px; background: #f8fafc; cursor: ${col.fixed ? 'not-allowed' : 'pointer'}; white-space: nowrap;">
            <input type="checkbox" value="${col.key}" ${visibleColumns.includes(col.key) ? 'checked' : ''} ${col.fixed ? 'disabled' : ''} style="cursor: ${col.fixed ? 'not-allowed' : 'pointer'};">
            <span style="color: ${col.fixed ? '#9ca3af' : 'inherit'}; font-size: 14px;">${col.label}${col.fixed ? ' (å¿…éœ€)' : ''}</span>
          </label>
        `).join('');
        columnSettingsModal.classList.add("active");
      }

      function closeColumnSettings() {
        columnSettingsModal.classList.remove("active");
      }

      function applyColumnSettings() {
        const checkboxes = columnCheckboxes.querySelectorAll('input[type="checkbox"]');
        visibleColumns = Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);
        saveColumnSettingsToStorage();
        updateTableColumns();
        closeColumnSettings();
        renderTable();
      }

      function updateTableColumns() {
        const headers = document.querySelectorAll('#tableHeader th');
        headers.forEach(th => {
          const column = th.getAttribute('data-column');
          th.style.display = visibleColumns.includes(column) ? '' : 'none';
        });
      }

      // è¯¦æƒ…å¼¹çª—çš„å›¾è¡¨å¯¹è±¡
      let detailRadarChart = null;
      let detailTrendScoreChart = null;
      let detailTrendSubjectChart = null;

      async function openStudentDetail(studentId) {
        const student = students.find(s => s.id === studentId);
        if (!student) return;

        currentDetailStudent = student;
        isEditingDetail = false;

        // æ›´æ–°æ ‡é¢˜ä¿¡æ¯
        detailStudentName.textContent = student.name;
        document.getElementById('detailStudentNo').textContent = `å­¦å·: ${student.student_no}`;
        document.getElementById('detailClassName').textContent = student.class_name ? `ç­çº§: ${student.class_name}` : '';
        document.getElementById('detailExamInfo').textContent = student.exam_name ? `è€ƒè¯•: ${student.exam_name}` : '';

        // é‡ç½®åˆ°æˆç»©æ¦‚è§ˆæ ‡ç­¾é¡µ
        document.querySelectorAll('[data-detail-tab]').forEach(btn => btn.classList.remove('active'));
        document.querySelector('[data-detail-tab="overview"]').classList.add('active');
        document.querySelectorAll('#studentDetailModal .tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById('overviewTab').classList.add('active');

        // æ¸²æŸ“æˆç»©æ¦‚è§ˆ
        renderOverviewTab(student);

        // æ¸²æŸ“å­¦ç”Ÿä¿¡æ¯ï¼ˆç¬¬å››ä¸ªæ ‡ç­¾é¡µï¼‰
        renderStudentInfo(student, false);

        editDetailBtn.style.display = '';
        saveDetailBtn.style.display = 'none';
        studentDetailModal.classList.add("active");
      }

      // æ¸²æŸ“æˆç»©æ¦‚è§ˆæ ‡ç­¾é¡µ
      function renderOverviewTab(student) {
        const totalScore = student.total_score || 0;
        const avgScore = student.average_score || 0;
        const classRank = student.class_rank || '-';

        document.getElementById('overviewTotalScore').textContent = totalScore.toFixed(1);
        document.getElementById('overviewAvgScore').textContent = avgScore.toFixed(1);
        document.getElementById('overviewClassRank').textContent = classRank;

        // è®¡ç®—ç­‰çº§
        let level = 'å¾…æé«˜';
        let levelColor = '#dc2626';
        let levelBg = '#fee2e2';
        if (avgScore >= 90) {
          level = 'ä¼˜ç§€';
          levelColor = '#059669';
          levelBg = '#ecfdf5';
        } else if (avgScore >= 80) {
          level = 'è‰¯å¥½';
          levelColor = '#d97706';
          levelBg = '#fef3c7';
        } else if (avgScore >= 60) {
          level = 'åŠæ ¼';
          levelColor = '#2563eb';
          levelBg = '#dbeafe';
        }

        const levelEl = document.getElementById('overviewLevel');
        levelEl.textContent = level;
        levelEl.style.color = levelColor;
        levelEl.parentElement.style.background = levelBg;

        // æ‰¾å‡ºæœ€å¼ºå’Œæœ€å¼±ç§‘ç›®
        const scores = student.scores || [];
        if (scores.length > 0) {
          const sortedScores = [...scores].sort((a, b) => b.score - a.score);
          document.getElementById('overviewBestSubject').textContent = sortedScores[0].subject;
          document.getElementById('overviewWeakSubject').textContent = sortedScores[sortedScores.length - 1].subject;
        }

        // æ¸²æŸ“é›·è¾¾å›¾
        renderDetailRadarChart(student);

        // åŠ è½½å•ç§‘ç»Ÿè®¡æ•°æ®
        loadDetailSubjectStats(student.exam_name, student.class_name);
      }

      // æ¸²æŸ“é›·è¾¾å›¾
      async function renderDetailRadarChart(student) {
        const ctx = document.getElementById('overviewRadarChart');
        if (!ctx) return;

        const scores = student.scores || [];
        const subjects = scores.map(s => s.subject);
        const values = scores.map(s => s.score);

        // è·å–ç­çº§å¹³å‡åˆ†ï¼ˆä»APIè·å–çœŸå®æ•°æ®ï¼‰
        let classAvg = values.map(v => v * 0.95); // é»˜è®¤å€¼
        try {
          const response = await fetch(`${API_BASE}/class-subject-stats?class_name=${encodeURIComponent(student.class_name)}&exam_name=${encodeURIComponent(student.exam_name)}`);
          if (response.ok) {
            const classStats = await response.json();
            const statsMap = {};
            classStats.subject_stats.forEach(stat => {
              statsMap[stat.subject] = stat.average;
            });
            classAvg = subjects.map(subject => statsMap[subject] || 0);
          }
        } catch (error) {
          console.error('è·å–ç­çº§ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        }

        if (detailRadarChart) {
          detailRadarChart.destroy();
        }

        detailRadarChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: subjects,
            datasets: [
              {
                label: 'æœ¬äººæˆç»©',
                data: values,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.2)',
                pointBackgroundColor: '#2563eb',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#2563eb'
              },
              {
                label: 'ç­çº§å¹³å‡',
                data: classAvg,
                borderColor: '#dc2626',
                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                pointBackgroundColor: '#dc2626',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#dc2626'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 20
                }
              }
            },
            plugins: {
              legend: {
                position: 'top'
              }
            }
          }
        });
      }

      // åŠ è½½å•ç§‘ç»Ÿè®¡æ•°æ®ï¼ˆæ˜¾ç¤ºè¯¥è€ƒè¯•/ç­çº§çš„æ‰€æœ‰å­¦ç”Ÿç»Ÿè®¡ï¼‰
      async function loadDetailSubjectStats(examName, className) {
        const tbody = document.getElementById('overviewSubjectStatsBody');

        if (!examName) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #6b7280;">æš‚æ— è€ƒè¯•ä¿¡æ¯</td></tr>';
          return;
        }

        // æ˜¾ç¤ºåŠ è½½ä¸­
        tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #6b7280;">åŠ è½½ä¸­...</td></tr>';

        try {
          // æ„å»ºæŸ¥è¯¢å‚æ•° - è·å–è¯¥è€ƒè¯•çš„æ‰€æœ‰å­¦ç”Ÿæˆç»©
          const params = new URLSearchParams();
          params.append('exam_name', examName);
          if (className) {
            params.append('class_name', className);
          }

          console.log('æ­£åœ¨åŠ è½½å•ç§‘ç»Ÿè®¡:', examName, className);

          // è·å–è¯¥è€ƒè¯•çš„æ‰€æœ‰å­¦ç”Ÿæˆç»©
          const res = await fetch(`${API_BASE}/?${params.toString()}`);
          if (!res.ok) {
            throw new Error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥');
          }

          const allStudents = await res.json();
          console.log('è·å–åˆ°å­¦ç”Ÿæ•°æ®:', allStudents.length, 'äºº');

          if (allStudents.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #6b7280;">æš‚æ— ç»Ÿè®¡æ•°æ®</td></tr>';
            return;
          }

          // æŒ‰ç§‘ç›®ç»Ÿè®¡
          const subjectStats = {};

          allStudents.forEach(student => {
            if (!student.scores || !Array.isArray(student.scores)) return;

            student.scores.forEach(score => {
              const subject = score.subject;
              const scoreValue = parseFloat(score.score);

              if (isNaN(scoreValue)) return;

              if (!subjectStats[subject]) {
                subjectStats[subject] = {
                  subject: subject,
                  scores: [],
                  passCount: 0,
                  goodCount: 0,
                  excellentCount: 0
                };
              }

              subjectStats[subject].scores.push(scoreValue);

              // è®¡ç®—åŠæ ¼ã€è‰¯å¥½ã€ä¼˜ç§€äººæ•° (å‡è®¾60åŠæ ¼ï¼Œ75è‰¯å¥½ï¼Œ90ä¼˜ç§€)
              if (scoreValue >= 60) subjectStats[subject].passCount++;
              if (scoreValue >= 75) subjectStats[subject].goodCount++;
              if (scoreValue >= 90) subjectStats[subject].excellentCount++;
            });
          });

          console.log('ç»Ÿè®¡ç»“æœ:', subjectStats);

          // ç”Ÿæˆè¡¨æ ¼è¡Œ
          const statsArray = Object.values(subjectStats);
          if (statsArray.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #6b7280;">æš‚æ— ç§‘ç›®æ•°æ®</td></tr>';
            return;
          }

          tbody.innerHTML = statsArray.map(stat => {
            const avgScore = (stat.scores.reduce((a, b) => a + b, 0) / stat.scores.length).toFixed(1);
            const maxScore = Math.max(...stat.scores).toFixed(1);

            return `
              <tr style="border-bottom: 1px solid #f3f4f6;">
                <td style="padding: 12px 16px; color: #111827; font-weight: 600;"><strong>${stat.subject}</strong></td>
                <td style="padding: 12px 16px; color: #111827;"><span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-weight: 600;">${avgScore}</span></td>
                <td style="padding: 12px 16px; color: #111827;">${maxScore}</td>
                <td style="padding: 12px 16px; color: #111827;">${stat.passCount}</td>
                <td style="padding: 12px 16px; color: #111827;">${stat.goodCount}</td>
                <td style="padding: 12px 16px; color: #111827;">${stat.excellentCount}</td>
              </tr>
            `;
          }).join('');

        } catch (error) {
          console.error('åŠ è½½å•ç§‘ç»Ÿè®¡å¤±è´¥:', error);
          tbody.innerHTML = `<tr><td colspan="6" style="padding: 20px; text-align: center; color: #dc2626;">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
        }
      }

      // æ¸²æŸ“è¶‹åŠ¿åˆ†ææ ‡ç­¾é¡µ
      async function renderTrendTab(student) {
        try {
          const res = await fetch(`${API_BASE}/student-trend/${student.student_no}`);
          if (!res.ok) throw new Error('æ— æ³•åŠ è½½è¶‹åŠ¿æ•°æ®');

          const trendData = await res.json();
          const exams = trendData.exams || [];

          if (exams.length === 0) {
            document.getElementById('trendTab').innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 60px;">æš‚æ— å†å²æˆç»©æ•°æ®</p>';
            return;
          }

          const examNames = exams.map(e => e.exam_name);
          const totalScores = exams.map(e => e.total_score);
          const avgScores = exams.map(e => e.average_score);

          // æ€»åˆ†ä¸å¹³å‡åˆ†èµ°åŠ¿å›¾
          const trendScoreCtx = document.getElementById('trendScoreChart');
          if (detailTrendScoreChart) {
            detailTrendScoreChart.destroy();
          }

          detailTrendScoreChart = new Chart(trendScoreCtx, {
            type: 'line',
            data: {
              labels: examNames,
              datasets: [
                {
                  label: 'æ€»åˆ†',
                  data: totalScores,
                  borderColor: '#2563eb',
                  backgroundColor: 'rgba(37, 99, 235, 0.1)',
                  tension: 0.3,
                  fill: true
                },
                {
                  label: 'å¹³å‡åˆ†',
                  data: avgScores,
                  borderColor: '#059669',
                  backgroundColor: 'rgba(5, 150, 105, 0.1)',
                  tension: 0.3,
                  fill: true
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top'
                },
                title: {
                  display: true,
                  text: 'æ€»åˆ†ä¸å¹³å‡åˆ†èµ°åŠ¿'
                }
              },
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });

          // å„ç§‘ç›®æˆç»©èµ°åŠ¿å›¾
          const allSubjects = new Set();
          exams.forEach(exam => {
            Object.keys(exam.subject_scores).forEach(subject => allSubjects.add(subject));
          });

          const subjectArray = Array.from(allSubjects);
          const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0'
          ];

          const subjectDatasets = subjectArray.map((subject, index) => {
            return {
              label: subject,
              data: exams.map(exam => exam.subject_scores[subject] || null),
              borderColor: colors[index % colors.length],
              backgroundColor: colors[index % colors.length] + '33',
              tension: 0.3,
              fill: false
            };
          });

          const trendSubjectCtx = document.getElementById('trendSubjectChart');
          if (detailTrendSubjectChart) {
            detailTrendSubjectChart.destroy();
          }

          detailTrendSubjectChart = new Chart(trendSubjectCtx, {
            type: 'line',
            data: {
              labels: examNames,
              datasets: subjectDatasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top'
                },
                title: {
                  display: true,
                  text: 'å„ç§‘ç›®æˆç»©èµ°åŠ¿'
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100
                }
              }
            }
          });

        } catch (error) {
          console.error('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥:', error);
          document.getElementById('trendTab').innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 60px;">æš‚æ— å†å²æˆç»©æ•°æ®</p>';
        }
      }

      // æ¸²æŸ“è¯¦ç»†åˆ†ææ ‡ç­¾é¡µ
      async function renderAnalysisTab(student) {
        const scores = student.scores || [];
        const avgScore = student.average_score || 0;

        // è·å–ç­çº§ç§‘ç›®ç»Ÿè®¡æ•°æ®ï¼ˆç­çº§å¹³å‡åˆ†ã€æ’åç­‰ï¼‰
        let classStats = null;
        let classStudents = [];
        try {
          // è·å–ç­çº§ç»Ÿè®¡æ•°æ®
          const statsResponse = await fetch(`${API_BASE}/class-subject-stats?class_name=${encodeURIComponent(student.class_name)}&exam_name=${encodeURIComponent(student.exam_name)}`);
          if (statsResponse.ok) {
            classStats = await statsResponse.json();
          }

          // è·å–åŒç­åŒå­¦æ•°æ®ç”¨äºè®¡ç®—æ’å
          const studentsResponse = await fetch(`${API_BASE}/?class_name=${encodeURIComponent(student.class_name)}&exam_name=${encodeURIComponent(student.exam_name)}`);
          if (studentsResponse.ok) {
            classStudents = await studentsResponse.json();
          }
        } catch (error) {
          console.error('è·å–ç­çº§æ•°æ®å¤±è´¥:', error);
        }

        // åˆ›å»ºç­çº§å¹³å‡åˆ†æ˜ å°„
        const classAvgMap = {};
        if (classStats) {
          classStats.subject_stats.forEach(stat => {
            classAvgMap[stat.subject] = stat.average;
          });
        }

        // ç”Ÿæˆå„ç§‘ç›®è¯¦ç»†åˆ†æ
        const subjectAnalysisList = document.getElementById('subjectAnalysisList');
        subjectAnalysisList.innerHTML = scores.map(scoreItem => {
          const score = scoreItem.score;
          const subject = scoreItem.subject;

          // è®¡ç®—å¾—åˆ†ç‡
          const rate = score;

          // è®¡ç®—ç­çº§æ’åï¼ˆåŸºäºçœŸå®æ•°æ®ï¼‰
          let rank = 1;
          if (classStudents.length > 0) {
            classStudents.forEach(s => {
              const subjectScore = (s.scores || []).find(sc => sc.subject === subject);
              if (subjectScore && subjectScore.score > score) {
                rank++;
              }
            });
          } else {
            rank = '-';
          }

          // ä¸ç­çº§å¹³å‡åˆ†å·®è·ï¼ˆä½¿ç”¨çœŸå®ç­çº§å¹³å‡ï¼‰
          const classAvg = classAvgMap[subject] || avgScore;
          const diff = (score - classAvg).toFixed(1);
          const diffText = diff > 0 ? `+${diff}` : diff;
          const diffColor = diff >= 0 ? '#059669' : '#dc2626';

          return `
            <div style="background: #f9fafb; padding: 16px; border-radius: 10px; border-left: 4px solid ${score >= 90 ? '#059669' : score >= 60 ? '#d97706' : '#dc2626'};">
              <h4 style="margin: 0 0 12px; font-size: 15px; font-weight: 600;">${subject}è¯¦ç»†åˆ†æ</h4>
              <div style="font-size: 13px; color: #6b7280; line-height: 1.8;">
                <div>å¾—åˆ†ç‡: <strong style="color: #111827;">${rate.toFixed(1)}%</strong></div>
                <div>ç­çº§æ’å: <strong style="color: #111827;">${rank}</strong></div>
                <div>ä¸ç­çº§å¹³å‡å·®è·: <strong style="color: ${diffColor};">${diffText}åˆ†</strong></div>
                <div style="margin-top: 8px; color: ${score >= 80 ? '#059669' : score >= 60 ? '#d97706' : '#dc2626'};">
                  ${score >= 90 ? 'âœ“ ä¼˜ç§€ï¼Œç»§ç»­ä¿æŒ' : score >= 80 ? 'â—‹ è‰¯å¥½ï¼Œéœ€è¦ç»§ç»­åŠªåŠ›' : score >= 60 ? 'â–³ åŠæ ¼ï¼Œå±äºåŠæ ¼çº¿' : 'âœ— ä½äºåŠæ ¼çº¿ï¼Œéœ€é‡ç‚¹å…³æ³¨'}
                </div>
              </div>
            </div>
          `;
        }).join('');

        // ç”Ÿæˆå¼±é¡¹åˆ†æï¼ˆä½¿ç”¨ç­çº§å¹³å‡åˆ†ï¼‰
        const weaknessAnalysis = document.getElementById('weaknessAnalysis');
        const weakSubjects = scores.map(s => {
          const classAvg = classAvgMap[s.subject] || avgScore;
          return {
            ...s,
            belowAvg: s.score < classAvg,
            diff: classAvg - s.score
          };
        }).filter(s => s.belowAvg).sort((a, b) => b.diff - a.diff);

        if (weakSubjects.length > 0) {
          weaknessAnalysis.innerHTML = `
            <ul style="margin: 0; padding-left: 20px; color: #374151; line-height: 2;">
              ${weakSubjects.map(s => `
                <li><strong>${s.subject}</strong>ç§‘ç›®ä½äºç­çº§å¹³å‡æ°´å¹³${s.diff.toFixed(1)}åˆ†ï¼Œéœ€è¦åŠ å¼ºå­¦ä¹ ã€‚</li>
              `).join('')}
              ${weakSubjects.length > 2 ? `<li>å»ºè®®é‡ç‚¹å…³æ³¨<strong>${weakSubjects[0].subject}</strong>å’Œ<strong>${weakSubjects[1].subject}</strong>ï¼Œè¿™ä¸¤ç§‘ä¸ç­çº§å¹³å‡å·®è·è¾ƒå¤§ã€‚</li>` : ''}
              <li>å»ºè®®åŠ å¼ºå¼±é¡¹è®­ç»ƒï¼Œå¤šåšç»ƒä¹ ã€‚</li>
            </ul>
          `;
        } else {
          weaknessAnalysis.innerHTML = '<p style="margin: 0; color: #059669;">æ‰€æœ‰ç§‘ç›®å‡è¾¾åˆ°æˆ–è¶…è¿‡ç­çº§å¹³å‡åˆ†ï¼Œç»§ç»­ä¿æŒï¼</p>';
        }
      }

      // è¯¦æƒ…å¼¹çª—é€‰é¡¹å¡åˆ‡æ¢ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
      studentDetailModal?.addEventListener('click', async (e) => {
        const button = e.target.closest('[data-detail-tab]');
        if (!button) return;

        const targetTab = button.getAttribute('data-detail-tab');

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('#studentDetailModal [data-detail-tab]').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        document.querySelectorAll('#studentDetailModal .tab-content').forEach(content => content.classList.remove('active'));
        const targetContent = document.getElementById(targetTab + 'Tab');
        if (targetContent) {
          targetContent.classList.add('active');
        }

        // æ‡’åŠ è½½æ•°æ®
        if (targetTab === 'trend' && currentDetailStudent) {
          await renderTrendTab(currentDetailStudent);
        } else if (targetTab === 'analysis' && currentDetailStudent) {
          renderAnalysisTab(currentDetailStudent);
        }
      });

      function closeStudentDetail() {
        studentDetailModal.classList.remove("active");
        currentDetailStudent = null;
        isEditingDetail = false;
      }

      function renderStudentInfo(student, isEditing) {
        const fields = [
          { key: 'name', label: 'å§“å', type: 'text', required: true },
          { key: 'student_no', label: 'å­¦å·', type: 'text', required: true },
          { key: 'gender', label: 'æ€§åˆ«', type: 'text' },
          { key: 'class_name', label: 'ç­çº§', type: 'text' },
          { key: 'grade_name', label: 'å¹´çº§', type: 'text' },
          { key: 'exam_name', label: 'è€ƒè¯•åç§°', type: 'text' },
          { key: 'class_rank', label: 'ç­çº§æ’å', type: 'number' },
          { key: 'grade_rank', label: 'å¹´çº§æ’å', type: 'number' },
          { key: 'notes', label: 'å¤‡æ³¨', type: 'textarea', fullWidth: true }
        ];

        if (isEditing) {
          studentInfoGrid.innerHTML = fields.map(field => {
            const value = student[field.key] || '';
            if (field.type === 'textarea') {
              return `
                <div class="info-item" style="${field.fullWidth ? 'grid-column: 1 / -1;' : ''}">
                  <label>${field.label}${field.required ? ' *' : ''}</label>
                  <textarea name="${field.key}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); min-height: 80px;" ${field.required ? 'required' : ''}>${value}</textarea>
                </div>
              `;
            }
            return `
              <div class="info-item" style="${field.fullWidth ? 'grid-column: 1 / -1;' : ''}">
                <label>${field.label}${field.required ? ' *' : ''}</label>
                <input type="${field.type}" name="${field.key}" value="${value}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border);" ${field.required ? 'required' : ''} />
              </div>
            `;
          }).join('');
        } else {
          studentInfoGrid.innerHTML = fields.map(field => {
            const value = student[field.key] || '-';
            return `
              <div class="info-item" style="${field.fullWidth ? 'grid-column: 1 / -1;' : ''}">
                <label>${field.label}</label>
                <div class="value">${value}</div>
              </div>
            `;
          }).join('');
        }
      }

      function enableDetailEdit() {
        if (!currentDetailStudent) return;
        isEditingDetail = true;
        renderStudentInfo(currentDetailStudent, true);
        editDetailBtn.style.display = 'none';
        saveDetailBtn.style.display = '';
      }

      async function saveDetailEdit(event) {
        event.preventDefault();
        if (!currentDetailStudent) return;

        const formData = new FormData(studentDetailForm);
        const payload = Object.fromEntries(formData.entries());

        // è½¬æ¢æ•°å­—å­—æ®µ
        if (payload.class_rank) {
          payload.class_rank = parseInt(payload.class_rank);
        } else {
          delete payload.class_rank;
        }

        if (payload.grade_rank) {
          payload.grade_rank = parseInt(payload.grade_rank);
        } else {
          delete payload.grade_rank;
        }

        // æ¸…ç†ç©ºå­—ç¬¦ä¸²å­—æ®µ
        Object.keys(payload).forEach(key => {
          if (payload[key] === '') {
            delete payload[key];
          }
        });

        // ä¿ç•™åŸæœ‰çš„æˆç»©æ•°æ®
        payload.scores = currentDetailStudent.scores;

        try {
          const res = await fetch(`${API_BASE}/${currentDetailStudent.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'ä¿å­˜å¤±è´¥');
          }

          showToast('ä¿å­˜æˆåŠŸ');
          await loadStudents();
          await loadClassStats();

          // æ›´æ–°å½“å‰å­¦ç”Ÿæ•°æ®å¹¶åˆ‡æ¢å›æŸ¥çœ‹æ¨¡å¼
          const updatedStudent = students.find(s => s.id === currentDetailStudent.id);
          if (updatedStudent) {
            currentDetailStudent = updatedStudent;
            detailStudentName.textContent = `${updatedStudent.name} - å­¦ç”Ÿä¿¡æ¯`;
            renderStudentInfo(updatedStudent, false);
            isEditingDetail = false;
            editDetailBtn.style.display = '';
            saveDetailBtn.style.display = 'none';
          }
        } catch (error) {
          showToast(error.message, true);
        }
      }

      function applyFilters(student) {
        const keyword = searchInput.value.trim().toLowerCase();
        if (keyword) {
          const hit = student.name.toLowerCase().includes(keyword) || student.student_no.toLowerCase().includes(keyword);
          if (!hit) return false;
        }
        if (classFilter.value && student.class_name !== classFilter.value) return false;
        if (examFilter.value && student.exam_name !== examFilter.value) return false;
        if (selectedSubject !== "æ€»åˆ†") {
          const hasScore = student.scores.some((item) => item.subject === selectedSubject);
          if (!hasScore) return false;
        }
        return true;
      }

      function renderTable() {
        updateTableColumns();
        if (!students.length) {
          studentBody.innerHTML = `<tr><td colspan="${visibleColumns.length}" class="empty-tip">æš‚æœªå½•å…¥ä»»ä½•å­¦ç”Ÿæ•°æ®ï¼Œç‚¹å‡»"æ·»åŠ å­¦ç”Ÿ"å¼€å§‹å§ã€‚</td></tr>`;
          return;
        }
        const filtered = students.filter(applyFilters);
        const rows = filtered
          .sort((a, b) => {
            const scoreA = getSubjectScore(a, selectedSubject);
            const scoreB = getSubjectScore(b, selectedSubject);
            return scoreB - scoreA;
          })
          .map((student, index) => {
            const scoreMap = Object.fromEntries(student.scores.map((item) => [item.subject, item.score]));
            const rating = getPerformanceLabel(getSubjectScore(student, "æ€»åˆ†"), "æ€»åˆ†");

            const cellData = {
              name: student.name,
              student_no: student.student_no,
              class_rank: student.class_rank ?? "-",
              grade_rank: student.grade_rank ?? "-",
              total_score: Number(student.total_score || 0).toFixed(1),
              rating: rating,
              ...Object.fromEntries(scoreSubjects.map(key => [
                key,
                scoreMap[key] ?? "-"
              ])),
              actions: `
                <button class="btn secondary compact-btn" type="button" data-view="${student.id}">æŸ¥çœ‹</button>
                <button class="btn secondary compact-btn" type="button" data-edit="${student.id}" style="margin-left:4px;">ç¼–è¾‘</button>
                <button class="btn danger compact-btn" type="button" data-delete="${student.id}" style="margin-left:4px;">åˆ é™¤</button>
              `
            };

            const cells = visibleColumns.map(col => {
              const value = cellData[col];
              const cls = selectedSubject === col ? "highlight-cell" : "";
              return `<td class="${cls}" data-column="${col}" style="${visibleColumns.includes(col) ? '' : 'display:none;'}">${value}</td>`;
            }).join("");

            return `<tr>${cells}</tr>`;
          })
          .join("");
        studentBody.innerHTML = rows || `<tr><td colspan="${visibleColumns.length}" class="empty-tip">æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„æ•°æ®ã€‚</td></tr>`;
      }

      function getPerformanceLabel(value, subject) {
        const ranges = getSubjectRanges(subject);
        if (!ranges) return "-";
        if (inRange(ranges.find((r) => r.key === "excellent"), value)) return "ä¼˜ç§€";
        if (inRange(ranges.find((r) => r.key === "good"), value)) return "è‰¯å¥½";
        if (inRange(ranges.find((r) => r.key === "pass"), value)) return "åŠæ ¼";
        return "ä¸åŠæ ¼";
      }


      function enrichStudent(student) {
        const scores = Array.isArray(student.scores) ? student.scores : [];
        const totalFromScores = scores.reduce((sum, item) => sum + Number(item.score || 0), 0);
        const totalScore = typeof student.total_score === "number" ? student.total_score : totalFromScores;
        const averageScore =
          typeof student.average_score === "number"
            ? student.average_score
            : scores.length
              ? totalScore / scores.length
              : 0;
        return {
          ...student,
          scores,
          total_score: Number(totalScore.toFixed(2)),
          average_score: Number(averageScore.toFixed(2)),
        };
      }

      function getSubjectScore(student, subject) {
        if (subject === "æ€»åˆ†") return Number(student.total_score || 0);
        const score = student.scores.find((item) => item.subject === subject);
        return score ? Number(score.score || 0) : 0;
      }

      async function loadStudents() {
        try {
          const res = await fetch(API_BASE);
          let allStudents = (await res.json()).map(enrichStudent);

          // åº”ç”¨ç­çº§ç­›é€‰
          if (selectedClasses.length > 0) {
            allStudents = allStudents.filter(s => selectedClasses.includes(s.class_name));
          }

          // åº”ç”¨è€ƒè¯•ç­›é€‰
          if (selectedExams.length > 0) {
            allStudents = allStudents.filter(s => selectedExams.includes(s.exam_name));
          }

          students = allStudents;
          renderFilters();
          renderTable();
          updateSummary();
          await loadClassStats();
          renderProgressRegressionCharts();
        } catch (error) {
          studentBody.innerHTML = `<tr><td colspan="14" class="empty-tip">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
        }
      }

      async function loadClassStats() {
        try {
          const res = await fetch(`${API_BASE}/class-stats`);
          if (!res.ok) throw new Error("åŠ è½½ç­çº§ç»Ÿè®¡å¤±è´¥");
          classStats = await res.json();
          renderClassStats();
        } catch (error) {
          if (classStatsBody) {
            classStatsBody.innerHTML = `<tr><td colspan="11" class="empty-tip">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
          }
        }
      }

      function renderClassStats() {
        if (!classStatsBody) return;
        if (!classStats || classStats.length === 0) {
          classStatsBody.innerHTML = '<tr><td colspan="12" class="empty-tip">æš‚æ— ç­çº§æ•°æ®</td></tr>';
          return;
        }

        const rows = classStats.map(cls => {
          const genderRatio = `${cls.male_ratio}% : ${cls.female_ratio}%`;
          return `
            <tr>
              <td>${cls.class_name}</td>
              <td>${cls.grade_name || '-'}</td>
              <td>${cls.total_students}</td>
              <td>${cls.exam_count}</td>
              <td>${cls.male_count}</td>
              <td>${cls.female_count}</td>
              <td>${genderRatio}</td>
              <td>${cls.average_score.toFixed(2)}</td>
              <td>${cls.pass_rate}%</td>
              <td>${cls.good_rate}%</td>
              <td>${cls.excellent_rate}%</td>
              <td>
                <button class="btn compact-btn" type="button" data-share-class="${cls.class_name}">åˆ†äº«æŸ¥è¯¢</button>
                <button class="btn secondary compact-btn" type="button" data-edit-class="${cls.class_name}" style="margin-left:4px;">ç¼–è¾‘</button>
                <button class="btn danger compact-btn" type="button" data-delete-class="${cls.class_name}" style="margin-left:4px;">åˆ é™¤</button>
              </td>
            </tr>
          `;
        }).join('');

        classStatsBody.innerHTML = rows;
      }

      function openClassEditModal(className) {
        const classData = classStats.find(c => c.class_name === className);
        if (!classData) return;

        editingClassName = className;
        editClassName.value = className;
        editGradeName.value = classData.grade_name || '';
        classEditModal.classList.add('active');
      }

      function closeClassEditModal() {
        classEditModal.classList.remove('active');
        editingClassName = null;
      }

      async function saveClassEdit(event) {
        event.preventDefault();
        if (!editingClassName) return;

        const newClassName = editClassName.value.trim();
        const newGradeName = editGradeName.value.trim();

        if (!newClassName) {
          showToast('ç­çº§åç§°ä¸èƒ½ä¸ºç©º', true);
          return;
        }

        try {
          const params = new URLSearchParams();
          params.append('new_class_name', newClassName);
          if (newGradeName) {
            params.append('new_grade_name', newGradeName);
          }

          const res = await fetch(`${API_BASE}/class/${encodeURIComponent(editingClassName)}/rename?${params.toString()}`, {
            method: 'PUT'
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'æ›´æ–°å¤±è´¥');
          }

          const result = await res.json();
          showToast(`å·²æ›´æ–° ${result.updated_count} æ¡è®°å½•`);
          closeClassEditModal();
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function deleteClass(className) {
        if (!confirm(`ç¡®è®¤åˆ é™¤ç­çº§"${className}"åŠå…¶æ‰€æœ‰å­¦ç”Ÿè®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

        try {
          const res = await fetch(`${API_BASE}/class/${encodeURIComponent(className)}`, {
            method: 'DELETE'
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'åˆ é™¤å¤±è´¥');
          }

          const result = await res.json();
          showToast(`å·²åˆ é™¤ç­çº§åŠ ${result.deleted_count} æ¡å­¦ç”Ÿè®°å½•`);
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      function inRange(range, value) {
        if (!range) return false;
        const minOk = value >= Number(range.min ?? Number.NEGATIVE_INFINITY);
        const maxOk = range.max == null ? true : value <= Number(range.max);
        return minOk && maxOk;
      }

      function computeSummaryFromStudents(list, subject = "æ€»åˆ†") {
        if (!list.length) {
          return {
            total_students: 0,
            average_total: 0,
            highest_total: null,
            highest_student: null,
            pass_rate: 0,
            good_rate: 0,
            excellent_rate: 0,
          };
        }
        const ranges = getSubjectRanges(subject);
        const passRange = ranges.find((item) => item.key === "pass");
        const goodRange = ranges.find((item) => item.key === "good");
        const excellentRange = ranges.find((item) => item.key === "excellent");
        let totalScores = 0;
        let highestTotal = -Infinity;
        let highestName = null;
        let passCount = 0;
        let goodCount = 0;
        let excellentCount = 0;
        list.forEach((student) => {
          // å¯¹äºæ€»åˆ†ï¼Œä½¿ç”¨æ€»åˆ†ï¼›å¯¹äºå•ç§‘ï¼Œä½¿ç”¨å•ç§‘åˆ†æ•°
          const value = subject === "æ€»åˆ†" ? Number(student.total_score || 0) : getSubjectScore(student, subject);
          totalScores += value;
          if (value > highestTotal) {
            highestTotal = value;
            highestName = student.name;
          }

          // åˆ¤æ–­ç­‰çº§æ—¶ï¼šæ€»åˆ†ä½¿ç”¨å¹³å‡åˆ†ï¼Œå•ç§‘ä½¿ç”¨å•ç§‘åˆ†æ•°
          const scoreForRate = subject === "æ€»åˆ†" ? Number(student.average_score || 0) : value;

          // æŒ‰ä¼˜å…ˆçº§æ£€æŸ¥ï¼šä¼˜ç§€ > è‰¯å¥½ > åŠæ ¼
          // ä¼˜ç§€çš„å­¦ç”Ÿä¹Ÿç®—è‰¯å¥½å’ŒåŠæ ¼ï¼Œè‰¯å¥½çš„å­¦ç”Ÿä¹Ÿç®—åŠæ ¼
          if (inRange(excellentRange, scoreForRate)) {
            excellentCount++;
            goodCount++; // ä¼˜ç§€çš„å­¦ç”Ÿä¹Ÿç®—è‰¯å¥½
            passCount++; // ä¼˜ç§€çš„å­¦ç”Ÿä¹Ÿç®—åŠæ ¼
          } else if (inRange(goodRange, scoreForRate)) {
            goodCount++;
            passCount++; // è‰¯å¥½çš„å­¦ç”Ÿä¹Ÿç®—åŠæ ¼
          } else if (inRange(passRange, scoreForRate)) {
            passCount++;
          }
        });
        const totalStudents = list.length;
        return {
          total_students: totalStudents,
          average_total: Number((totalScores / totalStudents).toFixed(2)),
            highest_total: highestTotal === -Infinity ? null : Number(highestTotal.toFixed(2)),
            highest_student: highestName,
            pass_rate: Number(((passCount / totalStudents) * 100).toFixed(2)),
            good_rate: Number(((goodCount / totalStudents) * 100).toFixed(2)),
            excellent_rate: Number(((excellentCount / totalStudents) * 100).toFixed(2)),
        };
      }

      function updateSummary() {
        // åº”ç”¨ç­›é€‰æ¡ä»¶ï¼Œç¡®ä¿ç»Ÿè®¡æ•°æ®ä¸è¡¨æ ¼æ•°æ®ä¸€è‡´
        const filtered = students.filter(applyFilters);
        summary = computeSummaryFromStudents(filtered, selectedSubject);
        renderGradeDashboard();
        renderStatisticsCharts();
        renderProgressRegressionCharts();
        renderDashboardTrendChart();
        renderTopStudents();
        updateSelectedSubjectCount(); // åˆå§‹åŒ–ç§‘ç›®æ•°é‡æ˜¾ç¤º
      }

      // è€ƒè¯•æˆç»©èµ°åŠ¿å›¾ï¼ˆä½¿ç”¨Chart.jsï¼‰
      let trendChart = null;

      function renderDashboardTrendChart() {
        const canvas = document.getElementById('dashboardTrendChart');
        if (!canvas) return;

        // é”€æ¯æ—§å›¾è¡¨
        if (trendChart) {
          trendChart.destroy();
        }

        if (students.length === 0) {
          return;
        }

        // æŒ‰è€ƒè¯•åç§°åˆ†ç»„
        const examGroups = {};
        students.forEach(student => {
          const examName = student.exam_name || 'æœªçŸ¥è€ƒè¯•';
          if (!examGroups[examName]) {
            examGroups[examName] = {
              name: examName,
              date: student.exam_date ? new Date(student.exam_date) : null,
              students: []
            };
          }
          examGroups[examName].students.push(student);
        });

        // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ—¥æœŸæ’åº
        let exams = Object.values(examGroups).sort((a, b) => {
          if (!a.date || !b.date) return 0;
          return a.date - b.date;
        });

        // æ ¹æ®ç­›é€‰æ¨¡å¼è¿‡æ»¤è€ƒè¯•
        if (trendDateRange !== null) {
          // æŒ‰æ—¶é—´æ¨¡å¼ï¼šç­›é€‰æŒ‡å®šæ—¥æœŸèŒƒå›´å†…çš„è€ƒè¯•
          const startDate = new Date(trendDateRange.startDate);
          const endDate = new Date(trendDateRange.endDate);
          endDate.setHours(23, 59, 59, 999); // åŒ…å«ç»“æŸæ—¥æœŸçš„å…¨å¤©
          exams = exams.filter(exam => exam.date && exam.date >= startDate && exam.date <= endDate);
        } else if (trendExamCount !== null) {
          // æŒ‰åœºæ¬¡æ¨¡å¼ï¼šå–æœ€è¿‘Nåœºè€ƒè¯•
          exams = exams.slice(-trendExamCount);
        }

        // å¦‚æœæ²¡æœ‰è€ƒè¯•æ•°æ®ï¼Œæ˜¾ç¤ºç©ºå›¾è¡¨
        if (exams.length === 0) {
          return;
        }

        // è®¡ç®—æ¯åœºè€ƒè¯•çš„ç»Ÿè®¡æ•°æ®
        const examStats = exams.map(exam => {
          const stats = computeSummaryFromStudents(exam.students, "æ€»åˆ†");
          return {
            name: exam.name,
            date: exam.date,
            avgScore: stats.average_total,
            excellentRate: stats.excellent_rate,
            goodRate: stats.good_rate,
            passRate: stats.pass_rate
          };
        });

        // å‡†å¤‡å›¾è¡¨æ•°æ®
        const labels = examStats.map(e => {
          // å¦‚æœæœ‰æ—¥æœŸï¼Œæ˜¾ç¤ºæ—¥æœŸï¼›å¦åˆ™æ˜¾ç¤ºè€ƒè¯•åç§°
          if (e.date) {
            const month = (e.date.getMonth() + 1).toString().padStart(2, '0');
            const day = e.date.getDate().toString().padStart(2, '0');
            return `${month}-${day}`;
          }
          return e.name.length > 10 ? e.name.substring(0, 10) + '...' : e.name;
        });
        const avgScores = examStats.map(e => e.avgScore);
        const excellentRates = examStats.map(e => e.excellentRate);
        const goodRates = examStats.map(e => e.goodRate);

        const ctx = canvas.getContext('2d');
        trendChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'å¹³å‡åˆ†',
                data: avgScores,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.3,
                yAxisID: 'y'
              },
              {
                label: 'ä¼˜ç§€ç‡',
                data: excellentRates,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 2.5,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#10b981',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.3,
                yAxisID: 'y1'
              },
              {
                label: 'è‰¯å¥½ç‡',
                data: goodRates,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                borderWidth: 2.5,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#f59e0b',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.3,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false
            },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: { size: 13 },
                  padding: 15,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: { size: 14 },
                bodyFont: { size: 13 },
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      if (context.datasetIndex === 0) {
                        label += context.parsed.y.toFixed(1) + 'åˆ†';
                      } else {
                        label += context.parsed.y.toFixed(1) + '%';
                      }
                    }
                    return label;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: { size: 12 },
                  color: '#374151'
                }
              },
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'å¹³å‡åˆ†',
                  color: '#3b82f6',
                  font: { size: 12, weight: 'bold' }
                },
                ticks: {
                  font: { size: 12 },
                  color: '#3b82f6'
                },
                grid: {
                  color: '#e5e7eb'
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'ç™¾åˆ†æ¯”(%)',
                  color: '#10b981',
                  font: { size: 12, weight: 'bold' }
                },
                min: 0,
                max: 100,
                ticks: {
                  font: { size: 12 },
                  color: '#10b981',
                  callback: function(value) {
                    return value + '%';
                  }
                },
                grid: {
                  drawOnChartArea: false
                }
              }
            }
          }
        });
      }

      function renderTopStudents() {
        const topStudentsGrid = document.getElementById('topStudentsGrid');
        const bottomStudentsGrid = document.getElementById('bottomStudentsGrid');
        if (!topStudentsGrid) return;

        // è·å–æ‰€æœ‰è€ƒè¯•åç§°
        const examNames = new Set();
        students.forEach(student => {
          if (student.exam_name) examNames.add(student.exam_name);
        });

        // å–æœ€è¿‘Nåœºè€ƒè¯•
        const recentExams = Array.from(examNames).slice(-trendExamCount);

        if (recentExams.length === 0) {
          topStudentsGrid.innerHTML = '<p style="color: #6b7280; text-align: center;">æš‚æ— è€ƒè¯•æ•°æ®</p>';
          if (bottomStudentsGrid) {
            bottomStudentsGrid.innerHTML = '<p style="color: #6b7280; text-align: center;">æš‚æ— è€ƒè¯•æ•°æ®</p>';
          }
          return;
        }

        // è®¡ç®—æ¯ä¸ªå­¦ç”Ÿåœ¨è¿™äº›è€ƒè¯•ä¸­çš„å¹³å‡åˆ†
        const studentScores = new Map();

        students.forEach(student => {
          if (!student.exam_name || !recentExams.includes(student.exam_name)) return;
          if (!student.total_score) return;

          const key = student.student_no;
          if (!studentScores.has(key)) {
            studentScores.set(key, {
              name: student.name,
              student_no: student.student_no,
              class_name: student.class_name,
              scores: [],
              ranks: []
            });
          }

          const data = studentScores.get(key);
          data.scores.push(Number(student.total_score));
          if (student.grade_rank) {
            data.ranks.push(student.grade_rank);
          }
        });

        // è®¡ç®—å¹³å‡åˆ†å¹¶æŒ‰å¹³å‡åˆ†æ’åº
        const allStudents = Array.from(studentScores.values())
          .map(student => ({
            ...student,
            examCount: student.scores.length,
            avgScore: student.scores.reduce((sum, score) => sum + score, 0) / student.scores.length,
            avgRank: student.ranks.length > 0
              ? student.ranks.reduce((sum, rank) => sum + rank, 0) / student.ranks.length
              : null
          }))
          .filter(student => student.examCount >= Math.min(1, recentExams.length)) // è‡³å°‘å‚åŠ 1åœºè€ƒè¯•
          .sort((a, b) => b.avgScore - a.avgScore); // æŒ‰å¹³å‡åˆ†é™åºæ’åº

        if (allStudents.length === 0) {
          topStudentsGrid.innerHTML = '<p style="color: #6b7280; text-align: center;">æš‚æ— å­¦ç”Ÿæ•°æ®</p>';
          if (bottomStudentsGrid) {
            bottomStudentsGrid.innerHTML = '<p style="color: #6b7280; text-align: center;">æš‚æ— å­¦ç”Ÿæ•°æ®</p>';
          }
          return;
        }

        // å‰5åå­¦ç”Ÿ
        const topStudents = allStudents.slice(0, 5);

        // å5åå­¦ç”Ÿ
        const bottomStudents = allStudents.slice(-5).reverse();

        // æ¸²æŸ“å‰5åå­¦ç”Ÿå¡ç‰‡
        topStudentsGrid.innerHTML = topStudents.map((student, index) => `
          <div class="top-student-card">
            <div class="rank-badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">${index + 1}</div>
            <div class="student-info-group">
              <div class="student-name">${student.name}</div>
              <div class="student-detail">
                <span>å­¦å·: ${student.student_no}</span>
                <span>${student.class_name || '-'}</span>
                <span>å‚åŠ : ${student.examCount} åœºè€ƒè¯•</span>
                ${student.avgRank !== null ? `<span>å¹³å‡æ’å: ${student.avgRank.toFixed(1)}</span>` : ''}
              </div>
            </div>
            <div class="score-display">
              <div class="avg-score" style="color: #059669;">${student.avgScore.toFixed(1)}</div>
              <div class="score-label">å¹³å‡æ€»åˆ†</div>
            </div>
          </div>
        `).join('');

        // æ¸²æŸ“å5åå­¦ç”Ÿå¡ç‰‡
        if (bottomStudentsGrid) {
          bottomStudentsGrid.innerHTML = bottomStudents.map((student, index) => {
            const actualRank = allStudents.length - bottomStudents.length + index + 1;
            return `
              <div class="top-student-card">
                <div class="rank-badge" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">${actualRank}</div>
                <div class="student-info-group">
                  <div class="student-name">${student.name}</div>
                  <div class="student-detail">
                    <span>å­¦å·: ${student.student_no}</span>
                    <span>${student.class_name || '-'}</span>
                    <span>å‚åŠ : ${student.examCount} åœºè€ƒè¯•</span>
                    ${student.avgRank !== null ? `<span>å¹³å‡æ’å: ${student.avgRank.toFixed(1)}</span>` : ''}
                  </div>
                </div>
                <div class="score-display">
                  <div class="avg-score" style="color: #dc2626;">${student.avgScore.toFixed(1)}</div>
                  <div class="score-label">å¹³å‡æ€»åˆ†</div>
                </div>
              </div>
            `;
          }).join('');
        }
      }

      // å¡«å……å­¦ç”Ÿå¤é€‰æ¡†åˆ—è¡¨
      function populateStudentCheckboxList(searchTerm = '') {
        if (!studentCheckboxList) return;

        // è·å–æ‰€æœ‰å”¯ä¸€çš„å­¦ç”Ÿï¼ˆæŒ‰å­¦å·å»é‡ï¼‰
        const uniqueStudents = new Map();
        students.forEach(student => {
          if (!uniqueStudents.has(student.student_no)) {
            uniqueStudents.set(student.student_no, {
              name: student.name,
              student_no: student.student_no,
              class_name: student.class_name
            });
          }
        });

        // æŒ‰å§“åæ’åºå¹¶ç­›é€‰
        let sortedStudents = Array.from(uniqueStudents.values()).sort((a, b) =>
          a.name.localeCompare(b.name, 'zh-CN')
        );

        if (searchTerm) {
          sortedStudents = sortedStudents.filter(s =>
            s.name.includes(searchTerm) || s.student_no.includes(searchTerm)
          );
        }

        studentCheckboxList.innerHTML = sortedStudents.map(s => {
          const isChecked = selectedStudentNos.includes(s.student_no);
          const colorIndex = selectedStudentNos.indexOf(s.student_no);
          const colorIndicator = colorIndex >= 0 ?
            `<span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${studentColors[colorIndex].border}; margin-left: 8px;"></span>` : '';

          return `
            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; ${isChecked ? 'background: #f0f9ff; border-color: #3b82f6;' : ''}">
              <input type="checkbox" value="${s.student_no}" ${isChecked ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
              <span style="flex: 1;">${s.name} (${s.student_no})</span>
              <span style="font-size: 12px; color: #6b7280;">${s.class_name || 'æ— ç­çº§'}</span>
              ${colorIndicator}
            </label>
          `;
        }).join('') || '<p style="text-align: center; color: #9ca3af; padding: 20px;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å­¦ç”Ÿ</p>';
      }

      // å¡«å……ç§‘ç›®å¤é€‰æ¡†åˆ—è¡¨
      function populateSubjectCheckboxList() {
        if (!subjectCheckboxList) return;

        subjectCheckboxList.innerHTML = allAvailableTrendSubjects.map(subject => {
          const isChecked = selectedTrendSubjects.includes(subject);
          return `
            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; ${isChecked ? 'background: #f0fdf4; border-color: #10b981;' : ''}">
              <input type="checkbox" value="${subject}" ${isChecked ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
              <span>${subject}</span>
            </label>
          `;
        }).join('');
      }

      // æ›´æ–°å·²é€‰æ‹©å­¦ç”Ÿåˆ—è¡¨æ˜¾ç¤º
      function updateSelectedStudentsList() {
        if (!selectedStudentsList || !selectedStudentCount) return;

        selectedStudentCount.textContent = selectedStudentNos.length;

        if (selectedStudentNos.length === 0) {
          selectedStudentsList.innerHTML = '<span style="color: #9ca3af; font-size: 14px;">ç‚¹å‡»"é€‰æ‹©å­¦ç”Ÿ"æŒ‰é’®æ·»åŠ å­¦ç”Ÿ</span>';
        } else {
          const uniqueStudents = new Map();
          students.forEach(student => {
            if (!uniqueStudents.has(student.student_no)) {
              uniqueStudents.set(student.student_no, student.name);
            }
          });

          selectedStudentsList.innerHTML = selectedStudentNos.map((studentNo, index) => {
            const name = uniqueStudents.get(studentNo) || 'æœªçŸ¥';
            const color = studentColors[index].border;
            return `
              <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: ${studentColors[index].bg}; border: 1px solid ${color}; border-radius: 6px; font-size: 14px; color: ${color}; font-weight: 500;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: ${color};"></span>
                ${name}
                <button onclick="removeSelectedStudent('${studentNo}')" style="background: none; border: none; color: ${color}; cursor: pointer; padding: 0; margin-left: 4px; font-size: 16px; line-height: 1;">&times;</button>
              </span>
            `;
          }).join('');
        }
      }

      // ç§»é™¤é€‰ä¸­çš„å­¦ç”Ÿ
      window.removeSelectedStudent = function(studentNo) {
        selectedStudentNos = selectedStudentNos.filter(no => no !== studentNo);
        updateSelectedStudentsList();
        renderStudentTrendChart();
      };

      // æ›´æ–°é€‰ä¸­ç§‘ç›®æ•°é‡æ˜¾ç¤º
      function updateSelectedSubjectCount() {
        if (selectedSubjectCount) {
          selectedSubjectCount.textContent = selectedTrendSubjects.length;
        }
      }

      // æ¸²æŸ“å­¦ç”Ÿæˆç»©å¯¹æ¯”èµ°åŠ¿å›¾
      function renderStudentTrendChart() {
        if (selectedStudentNos.length === 0 || selectedTrendSubjects.length === 0) {
          studentTrendChartContainer.style.display = 'none';
          studentTrendPlaceholder.style.display = 'block';
          return;
        }

        studentTrendChartContainer.style.display = 'block';
        studentTrendPlaceholder.style.display = 'none';

        // é”€æ¯æ—§å›¾è¡¨
        if (studentTrendChart) {
          studentTrendChart.destroy();
        }

        // è·å–æ‰€æœ‰è€ƒè¯•ï¼ŒæŒ‰æ—¥æœŸæ’åº
        const examGroups = {};
        students.forEach(student => {
          const examName = student.exam_name || 'æœªçŸ¥è€ƒè¯•';
          if (!examGroups[examName]) {
            examGroups[examName] = {
              name: examName,
              date: student.exam_date ? new Date(student.exam_date) : null
            };
          }
        });

        const exams = Object.values(examGroups).sort((a, b) => {
          if (a.date && b.date) return a.date - b.date;
          return 0;
        });

        // Xè½´æ ‡ç­¾
        const labels = exams.map(e => {
          if (e.date) {
            const month = (e.date.getMonth() + 1).toString().padStart(2, '0');
            const day = e.date.getDate().toString().padStart(2, '0');
            return `${month}-${day}`;
          }
          return e.name.length > 8 ? e.name.substring(0, 8) + '...' : e.name;
        });

        // ä¸ºæ¯ä¸ªå­¦ç”Ÿçš„æ¯ä¸ªç§‘ç›®åˆ›å»ºä¸€æ¡æ›²çº¿
        const datasets = [];
        selectedStudentNos.forEach((studentNo, studentIndex) => {
          const studentName = students.find(s => s.student_no === studentNo)?.name || 'æœªçŸ¥';
          const color = studentColors[studentIndex];

          selectedTrendSubjects.forEach((subject) => {
            // è·å–è¯¥å­¦ç”Ÿåœ¨å„åœºè€ƒè¯•ä¸­è¯¥ç§‘ç›®çš„æˆç»©
            const scores = exams.map(exam => {
              const record = students.find(s =>
                s.student_no === studentNo && s.exam_name === exam.name
              );
              if (!record) return null;

              if (subject === "æ€»åˆ†") {
                return record.total_score || null;
              } else {
                const scoreItem = record.scores?.find(s => s.subject === subject);
                return scoreItem ? Number(scoreItem.score) : null;
              }
            });

            datasets.push({
              label: `${studentName} - ${subject}`,
              data: scores,
              borderColor: color.border,
              backgroundColor: color.bg,
              borderWidth: 2.5,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: color.border,
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              tension: 0.3,
              spanGaps: true // å…è®¸è·³è¿‡nullå€¼è¿æ¥çº¿
            });
          });
        });

        const canvas = document.getElementById('studentTrendChart');
        const ctx = canvas.getContext('2d');

        studentTrendChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: { size: 12 },
                  padding: 12,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: { size: 14 },
                bodyFont: { size: 13 }
              }
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: { size: 11 },
                  color: '#374151',
                  maxRotation: 45,
                  minRotation: 0
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: '#e5e7eb'
                },
                ticks: {
                  font: { size: 11 },
                  color: '#374151'
                },
                title: {
                  display: true,
                  text: 'åˆ†æ•°',
                  font: { size: 12, weight: 'bold' }
                }
              }
            }
          }
        });

        // éšè—ç»Ÿè®¡ä¿¡æ¯ï¼ˆå› ä¸ºæ˜¯å¤šå­¦ç”Ÿå¯¹æ¯”ï¼Œç»Ÿè®¡ä¸å¤ªåˆé€‚ï¼‰
        if (studentTrendStats) {
          studentTrendStats.parentElement.style.display = 'none';
        }
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      async function downloadTemplate(event) {
        event?.preventDefault();
        try {
          const res = await fetch(`${API_BASE}/template`);
          if (!res.ok) throw new Error("æ¨¡æ¿ä¸‹è½½å¤±è´¥");
          const blob = await res.blob();
          downloadBlob(blob, "æˆç»©å¯¼å…¥æ¨¡æ¿.xlsx");
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function downloadRankTemplate(event) {
        event?.preventDefault();
        try {
          const res = await fetch(`${API_BASE}/rank-template`);
          if (!res.ok) throw new Error("æ’åæ¨¡æ¿ä¸‹è½½å¤±è´¥");
          const blob = await res.blob();
          downloadBlob(blob, "æ’åå¯¼å…¥æ¨¡æ¿.xlsx");
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleImport(event) {
        event.preventDefault();
        if (!importFileInput?.files.length) {
          showToast("è¯·å…ˆé€‰æ‹© Excel æ–‡ä»¶", true);
          return;
        }
        const formData = new FormData();
        formData.append("file", importFileInput.files[0]);
        if (importClassInput?.value) formData.append("class_name", importClassInput.value);
        if (importGradeInput?.value) formData.append("grade_name", importGradeInput.value);
        if (importExamInput?.value) formData.append("exam_name", importExamInput.value);
        try {
          const res = await fetch(`${API_BASE}/import`, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "å¯¼å…¥å¤±è´¥");
          }
          const summary = await res.json();
          showToast(`å¯¼å…¥å®Œæˆï¼šæ–°å¢ ${summary.imported} æ¡ï¼Œæ›´æ–° ${summary.updated} æ¡`);
          importForm?.reset();
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleRankImport(event) {
        event.preventDefault();
        const rankFileInput = document.getElementById('rankImportFile');
        if (!rankFileInput?.files.length) {
          showToast("è¯·å…ˆé€‰æ‹© Excel æ–‡ä»¶", true);
          return;
        }
        const formData = new FormData();
        formData.append("file", rankFileInput.files[0]);
        try {
          const res = await fetch(`${API_BASE}/import-ranks`, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "å¯¼å…¥æ’åå¤±è´¥");
          }
          const summary = await res.json();
          let message = `å¯¼å…¥å®Œæˆï¼šæ›´æ–° ${summary.updated} æ¡è®°å½•`;
          if (summary.not_found > 0) {
            message += `ï¼Œæœªæ‰¾åˆ° ${summary.not_found} æ¡è®°å½•`;
          }
          if (summary.errors && summary.errors.length > 0) {
            message += `\nå‰${summary.errors.length}ä¸ªé”™è¯¯ï¼š\n${summary.errors.join('\n')}`;
          }
          showToast(message);
          document.getElementById('rankImportForm')?.reset();
          await loadStudents();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function exportScores(event) {
        event.preventDefault();
        const params = new URLSearchParams();
        if (exportClassSelect?.value) params.append("class_name", exportClassSelect.value);
        if (exportExamSelect?.value) params.append("exam_name", exportExamSelect.value);
        const query = params.toString();
        try {
          const res = await fetch(`${API_BASE}/export${query ? `?${query}` : ""}`);
          if (!res.ok) throw new Error("å¯¼å‡ºå¤±è´¥");
          const blob = await res.blob();
          downloadBlob(blob, "æˆç»©å¯¼å‡º.xlsx");
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleAutoCalculateRanks() {
        if (!confirm('ç¡®è®¤è¦è‡ªåŠ¨è®¡ç®—æ‰€æœ‰è€ƒè¯•çš„å¹´çº§æ’åå’Œç­çº§æ’åå—ï¼Ÿ\n\næ­¤æ“ä½œå°†æ ¹æ®æ€»åˆ†é‡æ–°è®¡ç®—æ’åï¼Œå·²æœ‰çš„æ’åæ•°æ®å°†è¢«è¦†ç›–ã€‚')) {
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/calculate-ranks`, {
            method: "POST"
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "è®¡ç®—æ’åå¤±è´¥");
          }
          const summary = await res.json();
          showToast(`æ’åè®¡ç®—å®Œæˆï¼šæ›´æ–°äº† ${summary.updated || 0} æ¡è®°å½•`);
          await loadStudents();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleBackupData() {
        try {
          const res = await fetch(`${API_BASE}/backup`);
          if (!res.ok) throw new Error("å¤‡ä»½å¤±è´¥");
          const data = await res.json();
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
          downloadBlob(blob, `æˆç»©æ•°æ®å¤‡ä»½_${timestamp}.json`);
          showToast('æ•°æ®å¤‡ä»½æˆåŠŸ');
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleRestoreData(event) {
        event.preventDefault();
        if (!restoreFile?.files.length) {
          showToast("è¯·å…ˆé€‰æ‹©å¤‡ä»½æ–‡ä»¶", true);
          return;
        }

        if (!confirm('ç¡®è®¤è¦æ¢å¤æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œå°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œå»ºè®®å…ˆè¿›è¡Œå¤‡ä»½ï¼')) {
          return;
        }

        try {
          const file = restoreFile.files[0];
          const text = await file.text();
          const data = JSON.parse(text);

          const res = await fetch(`${API_BASE}/restore`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "æ¢å¤æ•°æ®å¤±è´¥");
          }

          const summary = await res.json();
          showToast(`æ•°æ®æ¢å¤å®Œæˆï¼šæ¢å¤äº† ${summary.restored || 0} æ¡è®°å½•`);
          restoreForm?.reset();
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleClearData() {
        if (!confirm('âš ï¸ å±é™©æ“ä½œè­¦å‘Š âš ï¸\n\nç¡®è®¤è¦æ¸…ç©ºæ‰€æœ‰æˆç»©æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå»ºè®®å…ˆè¿›è¡Œæ•°æ®å¤‡ä»½ï¼')) {
          return;
        }

        if (!confirm('âš ï¸ æœ€åç¡®è®¤ âš ï¸\n\nçœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/clear-all`, {
            method: "DELETE"
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "æ¸…ç©ºæ•°æ®å¤±è´¥");
          }

          const summary = await res.json();
          showToast(`å·²æ¸…ç©º ${summary.deleted || 0} æ¡è®°å½•`);
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleRangeSave(event) {
        event.preventDefault();
        if (!rangeRows) return;
        const current = gradeRanges[currentRangeSubject] || createDefaultRanges();
        let hasError = false;
        const updated = current.map((range) => {
          const row = rangeRows.querySelector(`.range-row[data-key="${range.key}"]`);
          if (!row) return range;
          const minInput = row.querySelector('[data-field="min"]');
          const maxInput = row.querySelector('[data-field="max"]');
          const minVal = parseFloat(minInput.value);
          const maxRaw = maxInput.value.trim();
          const maxVal = maxRaw === "" ? null : parseFloat(maxRaw);
          if (Number.isNaN(minVal)) {
            showToast(`è¯·å¡«å†™${range.name}çš„æœ€å°å€¼`, true);
            hasError = true;
            return range;
          }
          if (maxRaw !== "" && Number.isNaN(maxVal)) {
            showToast(`è¯·å¡«å†™${range.name}çš„æœ€å¤§å€¼`, true);
            hasError = true;
            return range;
          }
          if (maxVal !== null && maxVal <= minVal) {
            showToast(`${range.name}çš„æœ€å¤§å€¼éœ€å¤§äºæœ€å°å€¼`, true);
            hasError = true;
            return range;
          }
          return { ...range, min: minVal, max: maxVal };
        });
        if (hasError) return;
        try {
          const res = await fetch(`${API_BASE}/ranges/${encodeURIComponent(currentRangeSubject)}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updated),
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "ä¿å­˜å¤±è´¥");
          }
          const saved = await res.json();
          gradeRanges[currentRangeSubject] = saved;
          renderRangeRows();
          updateSummary();
          showToast("åŒºé—´é…ç½®å·²ä¿å­˜");
        } catch (error) {
          showToast(error.message, true);
        }
      }

      // ========== ç­›é€‰å™¨åŠŸèƒ½ ==========

      // åŠ è½½ç­çº§å’Œè€ƒè¯•åˆ—è¡¨
      async function loadFilterOptions() {
        try {
          const res = await fetch(`${API_BASE}/`);
          if (!res.ok) throw new Error("åŠ è½½æ•°æ®å¤±è´¥");
          const students = await res.json();

          // æå–å”¯ä¸€çš„ç­çº§å’Œè€ƒè¯•
          const classSet = new Set();
          const examSet = new Set();

          students.forEach(student => {
            if (student.class_name) classSet.add(student.class_name);
            if (student.exam_name) examSet.add(student.exam_name);
          });

          allClassList = Array.from(classSet).sort();
          allExamList = Array.from(examSet).sort();

          // æ¸²æŸ“ç­çº§å¤é€‰æ¡†
          renderClassCheckboxes();
          // æ¸²æŸ“è€ƒè¯•å¤é€‰æ¡†
          renderExamCheckboxes();
        } catch (error) {
          console.error("åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥:", error);
        }
      }

      // æ¸²æŸ“ç­çº§å¤é€‰æ¡†åˆ—è¡¨
      function renderClassCheckboxes() {
        classCheckboxList.innerHTML = allClassList.map(className => `
          <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s;"
                 onmouseover="this.style.background='#f3f4f6'"
                 onmouseout="this.style.background='transparent'">
            <input type="checkbox" value="${className}" ${selectedClasses.includes(className) ? 'checked' : ''}
                   style="width: 16px; height: 16px; cursor: pointer;">
            <span style="font-size: 14px;">${className}</span>
          </label>
        `).join('');

        updateSelectedClassCount();
      }

      // æ¸²æŸ“è€ƒè¯•å¤é€‰æ¡†åˆ—è¡¨
      function renderExamCheckboxes() {
        examCheckboxList.innerHTML = allExamList.map(examName => `
          <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s;"
                 onmouseover="this.style.background='#f3f4f6'"
                 onmouseout="this.style.background='transparent'">
            <input type="checkbox" value="${examName}" ${selectedExams.includes(examName) ? 'checked' : ''}
                   style="width: 16px; height: 16px; cursor: pointer;">
            <span style="font-size: 14px;">${examName}</span>
          </label>
        `).join('');

        updateSelectedExamCount();
      }

      // æ›´æ–°å·²é€‰æ‹©ç­çº§æ•°é‡
      function updateSelectedClassCount() {
        const checkboxes = classCheckboxList.querySelectorAll('input[type="checkbox"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        selectedClassCount.textContent = checked.length;
      }

      // æ›´æ–°å·²é€‰æ‹©è€ƒè¯•æ•°é‡
      function updateSelectedExamCount() {
        const checkboxes = examCheckboxList.querySelectorAll('input[type="checkbox"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        selectedExamCount.textContent = checked.length;
      }

      // æ›´æ–°ç­›é€‰å™¨æŒ‰é’®æ–‡æœ¬
      function updateFilterButtonText() {
        if (selectedClasses.length === 0) {
          filterClassText.textContent = "å…¨éƒ¨ç­çº§";
          classCount.textContent = "";
        } else if (selectedClasses.length === 1) {
          filterClassText.textContent = selectedClasses[0];
          classCount.textContent = "";
        } else {
          filterClassText.textContent = "å¤šä¸ªç­çº§";
          classCount.textContent = `(${selectedClasses.length})`;
        }

        if (selectedExams.length === 0) {
          filterExamText.textContent = "å…¨éƒ¨è€ƒè¯•";
          examCount.textContent = "";
        } else if (selectedExams.length === 1) {
          filterExamText.textContent = selectedExams[0];
          examCount.textContent = "";
        } else {
          filterExamText.textContent = "å¤šä¸ªè€ƒè¯•";
          examCount.textContent = `(${selectedExams.length})`;
        }
      }

      // æ‰“å¼€ç­çº§ç­›é€‰å¼¹çª—
      filterClassBtn?.addEventListener("click", () => {
        renderClassCheckboxes();
        classFilterModal.classList.add("active");
      });

      // æ‰“å¼€è€ƒè¯•ç­›é€‰å¼¹çª—
      filterExamBtn?.addEventListener("click", () => {
        renderExamCheckboxes();
        examFilterModal.classList.add("active");
      });

      // ç­çº§å¤é€‰æ¡†changeäº‹ä»¶
      classCheckboxList?.addEventListener("change", updateSelectedClassCount);

      // è€ƒè¯•å¤é€‰æ¡†changeäº‹ä»¶
      examCheckboxList?.addEventListener("change", updateSelectedExamCount);

      // å…¨é€‰ç­çº§
      selectAllClasses?.addEventListener("click", () => {
        classCheckboxList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        updateSelectedClassCount();
      });

      // æ¸…ç©ºç­çº§é€‰æ‹©
      clearAllClasses?.addEventListener("click", () => {
        classCheckboxList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateSelectedClassCount();
      });

      // å…¨é€‰è€ƒè¯•
      selectAllExams?.addEventListener("click", () => {
        examCheckboxList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        updateSelectedExamCount();
      });

      // æ¸…ç©ºè€ƒè¯•é€‰æ‹©
      clearAllExams?.addEventListener("click", () => {
        examCheckboxList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateSelectedExamCount();
      });

      // å–æ¶ˆç­çº§ç­›é€‰
      cancelClassFilter?.addEventListener("click", () => {
        classFilterModal.classList.remove("active");
      });

      // ç¡®è®¤ç­çº§ç­›é€‰
      confirmClassFilter?.addEventListener("click", () => {
        const checkboxes = classCheckboxList.querySelectorAll('input[type="checkbox"]:checked');
        selectedClasses = Array.from(checkboxes).map(cb => cb.value);
        updateFilterButtonText();
        classFilterModal.classList.remove("active");

        // åˆ·æ–°ä»ªè¡¨ç›˜æ•°æ®
        loadStudents();
        showToast(`å·²åº”ç”¨ç­çº§ç­›é€‰ (${selectedClasses.length || 'å…¨éƒ¨'})`);
      });

      // å–æ¶ˆè€ƒè¯•ç­›é€‰
      cancelExamFilter?.addEventListener("click", () => {
        examFilterModal.classList.remove("active");
      });

      // ç¡®è®¤è€ƒè¯•ç­›é€‰
      confirmExamFilter?.addEventListener("click", () => {
        const checkboxes = examCheckboxList.querySelectorAll('input[type="checkbox"]:checked');
        selectedExams = Array.from(checkboxes).map(cb => cb.value);
        updateFilterButtonText();
        examFilterModal.classList.remove("active");

        // åˆ·æ–°ä»ªè¡¨ç›˜æ•°æ®
        loadStudents();
        showToast(`å·²åº”ç”¨è€ƒè¯•ç­›é€‰ (${selectedExams.length || 'å…¨éƒ¨'})`);
      });

      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      classFilterModal?.addEventListener("click", (e) => {
        if (e.target === classFilterModal) {
          classFilterModal.classList.remove("active");
        }
      });

      examFilterModal?.addEventListener("click", (e) => {
        if (e.target === examFilterModal) {
          examFilterModal.classList.remove("active");
        }
      });

      // ========== ç»“æŸç­›é€‰å™¨åŠŸèƒ½ ==========

      refreshBtn.addEventListener("click", () => {
        loadStudents();
      });
      subjectTabsEl?.addEventListener("click", async (event) => {
        const target = event.target.closest("button[data-subject]");
        if (!target) return;
        const subject = target.dataset.subject;
        if (subject && subject !== selectedSubject) {
          selectedSubject = subject;
          renderSubjectTabs();
          renderTable();
          updateSummary();
        }
      });

      // èµ°åŠ¿å›¾é€‰é¡¹å¡åˆ‡æ¢ - æŒ‰åœºæ¬¡
      document.addEventListener("click", (event) => {
        const countTarget = event.target.closest("button[data-trend-count]");
        if (countTarget) {
          const count = parseInt(countTarget.dataset.trendCount);
          if (count && count !== trendExamCount) {
            trendExamCount = count;
            trendDateRange = null; // ç¦ç”¨æŒ‰æ—¶é—´æ¨¡å¼

            // æ›´æ–°æŒ‰åœºæ¬¡é€‰é¡¹å¡æ ·å¼
            document.querySelectorAll("button[data-trend-count]").forEach(btn => {
              btn.classList.remove("active");
            });
            countTarget.classList.add("active");

            // é‡æ–°ç»˜åˆ¶å›¾è¡¨å’Œæ’å
            renderDashboardTrendChart();
            renderTopStudents();
          }
          return;
        }
      });

      // åº”ç”¨è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´
      document.getElementById("applyTrendDateRange")?.addEventListener("click", () => {
        const startDate = document.getElementById("trendStartDate").value;
        const endDate = document.getElementById("trendEndDate").value;

        if (!startDate || !endDate) {
          alert("è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ");
          return;
        }

        if (new Date(startDate) > new Date(endDate)) {
          alert("å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ");
          return;
        }

        trendDateRange = { startDate, endDate };
        trendExamCount = null; // ç¦ç”¨æŒ‰åœºæ¬¡æ¨¡å¼

        // æ¸…é™¤æŒ‰åœºæ¬¡é€‰é¡¹å¡æ ·å¼
        document.querySelectorAll("button[data-trend-count]").forEach(btn => {
          btn.classList.remove("active");
        });

        // é‡æ–°ç»˜åˆ¶å›¾è¡¨å’Œæ’å
        renderDashboardTrendChart();
        renderTopStudents();
      });
      downloadTemplateBtn?.addEventListener("click", downloadTemplate);
      document.getElementById('downloadRankTemplate')?.addEventListener("click", downloadRankTemplate);
      document.getElementById('rankImportForm')?.addEventListener("submit", handleRankImport);
      autoCalculateRanksBtn?.addEventListener("click", handleAutoCalculateRanks);
      backupDataBtn?.addEventListener("click", handleBackupData);
      restoreForm?.addEventListener("submit", handleRestoreData);
      clearDataBtn?.addEventListener("click", handleClearData);
      addStudentBtn?.addEventListener("click", () => openModal());
      cancelModal.addEventListener("click", closeModal);
      modalBackdrop.addEventListener("click", (event) => {
        if (event.target === modalBackdrop) closeModal();
      });
      addScoreRowBtn.addEventListener("click", () => addScoreRow());
      studentForm.addEventListener("submit", saveStudent);
      rangeSubjectSelect?.addEventListener("change", () => {
        currentRangeSubject = rangeSubjectSelect.value;
        renderRangeRows();
      });
      importForm?.addEventListener("submit", handleImport);
      exportBtn?.addEventListener("click", exportScores);
      rangeForm?.addEventListener("submit", handleRangeSave);
      searchInput.addEventListener("input", renderTable);
      classFilter.addEventListener("change", renderTable);
      examFilter.addEventListener("change", renderTable);

      columnSettingsBtn?.addEventListener("click", openColumnSettings);
      cancelColumnSettings?.addEventListener("click", closeColumnSettings);
      saveColumnSettings?.addEventListener("click", applyColumnSettings);
      columnSettingsModal?.addEventListener("click", (event) => {
        if (event.target === columnSettingsModal) closeColumnSettings();
      });

      closeDetailModal?.addEventListener("click", closeStudentDetail);
      editDetailBtn?.addEventListener("click", enableDetailEdit);
      studentDetailForm?.addEventListener("submit", saveDetailEdit);
      studentDetailModal?.addEventListener("click", (event) => {
        if (event.target === studentDetailModal) closeStudentDetail();
      });

      cancelClassEdit?.addEventListener("click", closeClassEditModal);
      classEditForm?.addEventListener("submit", saveClassEdit);
      classEditModal?.addEventListener("click", (event) => {
        if (event.target === classEditModal) closeClassEditModal();
      });

      classStatsBody?.addEventListener("click", (event) => {
        const shareClassName = event.target.getAttribute("data-share-class");
        const editClassName = event.target.getAttribute("data-edit-class");
        const deleteClassName = event.target.getAttribute("data-delete-class");

        if (shareClassName) {
          shareClassQuery(shareClassName);
        }
        if (editClassName) {
          openClassEditModal(editClassName);
        }
        if (deleteClassName) {
          deleteClass(deleteClassName);
        }
      });

      function shareClassQuery(className) {
        shareClassName = className;
        selectedDays = 30;
        customDays.value = '';

        // è·å–è¯¥ç­çº§çš„æ‰€æœ‰è€ƒè¯•
        const classExams = new Set();
        students.forEach(student => {
          if (student.class_name === className && student.exam_name) {
            classExams.add(student.exam_name);
          }
        });

        // å¡«å……è€ƒè¯•é€‰æ‹©ä¸‹æ‹‰æ¡†
        shareExamSelect.innerHTML = '<option value="">å…¨éƒ¨è€ƒè¯•</option>';
        Array.from(classExams).forEach(examName => {
          const option = document.createElement('option');
          option.value = examName;
          option.textContent = examName;
          shareExamSelect.appendChild(option);
        });

        shareModal.classList.add('active');
      }

      function closeShareModal() {
        shareModal.classList.remove('active');
        shareClassName = null;
        selectedDays = 30;
        customDays.value = '';
        shareExamSelect.value = '';
      }

      async function generateShareLink() {
        if (!shareClassName) return;

        const days = customDays.value ? parseInt(customDays.value) : selectedDays;
        const examName = shareExamSelect.value;

        if (days < 1 || days > 365) {
          showToast('æœ‰æ•ˆæœŸå¿…é¡»åœ¨1-365å¤©ä¹‹é—´', true);
          return;
        }

        try {
          const params = new URLSearchParams();
          params.append('valid_days', days);
          if (examName) {
            params.append('exam_name', examName);
          }

          const res = await fetch(`${API_BASE}/class/${encodeURIComponent(shareClassName)}/share?${params.toString()}`, {
            method: 'POST'
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥');
          }

          const result = await res.json();
          const queryUrl = `${window.location.origin}/static/query.html?code=${result.code}`;

          let toastMessage = `åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\nç­çº§ï¼š${shareClassName}`;
          if (examName) {
            toastMessage += `\nè€ƒè¯•ï¼š${examName}`;
          } else {
            toastMessage += `\nè€ƒè¯•ï¼šå…¨éƒ¨è€ƒè¯•`;
          }
          toastMessage += `\næœ‰æ•ˆæœŸï¼š${days}å¤©\nè¿‡æœŸæ—¶é—´ï¼š${new Date(result.expires_at).toLocaleString()}`;

          // å¤åˆ¶åˆ°å‰ªè´´æ¿
          if (navigator.clipboard) {
            await navigator.clipboard.writeText(queryUrl);
            showToast(toastMessage);
          } else {
            // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºé“¾æ¥è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
            prompt('è¯·å¤åˆ¶ä»¥ä¸‹é“¾æ¥åˆ†äº«ç»™å®¶é•¿ï¼š', queryUrl);
          }

          closeShareModal();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      // å­¦ç”Ÿæˆç»©å¯¹æ¯”èµ°åŠ¿å›¾äº‹ä»¶ç›‘å¬

      // æ‰“å¼€å­¦ç”Ÿé€‰æ‹©å¼¹çª—
      selectStudentsBtn?.addEventListener("click", () => {
        populateStudentCheckboxList();
        studentSelectModal?.classList.add("active");
      });

      // æ‰“å¼€ç§‘ç›®é€‰æ‹©å¼¹çª—
      selectSubjectsBtn?.addEventListener("click", () => {
        populateSubjectCheckboxList();
        subjectSelectModal?.classList.add("active");
      });

      // å­¦ç”Ÿæœç´¢
      studentSearchInput?.addEventListener("input", (e) => {
        populateStudentCheckboxList(e.target.value);
      });

      // å–æ¶ˆå­¦ç”Ÿé€‰æ‹©
      cancelStudentSelect?.addEventListener("click", () => {
        studentSelectModal?.classList.remove("active");
      });

      // ç¡®è®¤å­¦ç”Ÿé€‰æ‹©
      confirmStudentSelect?.addEventListener("click", () => {
        const checkboxes = studentCheckboxList.querySelectorAll('input[type="checkbox"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);

        if (selected.length > 5) {
          alert('æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªå­¦ç”Ÿ');
          return;
        }

        selectedStudentNos = selected;
        updateSelectedStudentsList();
        studentSelectModal?.classList.remove("active");
        renderStudentTrendChart();
      });

      // å–æ¶ˆç§‘ç›®é€‰æ‹©
      cancelSubjectSelect?.addEventListener("click", () => {
        subjectSelectModal?.classList.remove("active");
      });

      // ç¡®è®¤ç§‘ç›®é€‰æ‹©
      confirmSubjectSelect?.addEventListener("click", () => {
        const checkboxes = subjectCheckboxList.querySelectorAll('input[type="checkbox"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);

        if (selected.length === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç§‘ç›®');
          return;
        }

        selectedTrendSubjects = selected;
        updateSelectedSubjectCount();
        subjectSelectModal?.classList.remove("active");
        renderStudentTrendChart();
      });

      // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
      studentSelectModal?.addEventListener("click", (event) => {
        if (event.target === studentSelectModal) {
          studentSelectModal.classList.remove("active");
        }
      });

      subjectSelectModal?.addEventListener("click", (event) => {
        if (event.target === subjectSelectModal) {
          subjectSelectModal.classList.remove("active");
        }
      });

      // åˆ†äº«å¼¹çª—äº‹ä»¶ç›‘å¬
      cancelShare?.addEventListener("click", closeShareModal);
      confirmShare?.addEventListener("click", generateShareLink);
      shareModal?.addEventListener("click", (event) => {
        if (event.target === shareModal) closeShareModal();
      });

      // å¿«æ·å¤©æ•°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      shareModal?.querySelectorAll('button[data-days]').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedDays = parseInt(btn.getAttribute('data-days'));
          customDays.value = '';
          // é«˜äº®é€‰ä¸­çš„æŒ‰é’®
          shareModal.querySelectorAll('button[data-days]').forEach(b => {
            b.style.background = '#e5e7eb';
            b.style.color = '#111827';
          });
          btn.style.background = 'var(--primary)';
          btn.style.color = 'white';
        });
      });

      studentBody.addEventListener("click", (event) => {
        const viewId = event.target.getAttribute("data-view");
        const editId = event.target.getAttribute("data-edit");
        const deleteId = event.target.getAttribute("data-delete");

        if (viewId) {
          openStudentDetail(Number(viewId));
        }
        if (editId) {
          const student = students.find((item) => item.id === Number(editId));
          if (student) openModal(student);
        }
        if (deleteId) {
          deleteStudent(Number(deleteId));
        }
      });

      function initCollapsibleSections() {
        document.querySelectorAll('.collapsible-header').forEach(header => {
          header.addEventListener('click', () => {
            const targetId = header.getAttribute('data-target');
            const content = document.getElementById(targetId);
            const toggle = header.querySelector('.collapsible-toggle');

            if (content && toggle) {
              const isExpanded = content.classList.contains('expanded');

              if (isExpanded) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
              } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
              }
            }
          });
        });
      }

      // æ¸²æŸ“æˆç»©ä»ªè¡¨ç›˜ï¼ˆä½¿ç”¨Chart.jsï¼‰
      let dashboardCharts = [];

      function renderGradeDashboard() {
        const container = document.getElementById('gradeDashboard');
        if (!container) return;

        // é”€æ¯æ—§å›¾è¡¨
        dashboardCharts.forEach(chart => chart.destroy());
        dashboardCharts = [];

        // ä½¿ç”¨ç°æœ‰çš„computeSummaryFromStudentså‡½æ•°è®¡ç®—ç»Ÿè®¡æ•°æ®
        const summaryData = computeSummaryFromStudents(students, "æ€»åˆ†");

        // è®¡ç®—ç­çº§æ•°å’Œè€ƒè¯•åœºæ¬¡
        const classCount = new Set(students.map(s => s.class_name).filter(Boolean)).size;
        const examCount = new Set(students.map(s => s.exam_name).filter(Boolean)).size;

        // æå–ç»Ÿè®¡æ•°æ®
        const totalStudents = summaryData.total_students;
        const avgScore = summaryData.average_total;
        const maxScore = summaryData.highest_total || 0;
        const topStudentName = summaryData.highest_student || '';
        const passRate = Math.round(summaryData.pass_rate);
        const goodRate = Math.round(summaryData.good_rate);
        const excellentRate = Math.round(summaryData.excellent_rate);

        // è®¡ç®—æ€»åˆ†æ»¡åˆ†ï¼ˆå‡è®¾æ¯ç§‘150åˆ†ï¼Œå…±5ç§‘=750åˆ†ï¼‰
        const maxPossibleTotal = 750;

        // å®šä¹‰ç»Ÿè®¡å¡ç‰‡æ•°æ®
        const dashboardStats = [
          { label: 'å­¦ç”Ÿæ€»æ•°', value: totalStudents, percentage: Math.min(100, (totalStudents / 50) * 100), color: '#9f7aea', trend: null },
          { label: 'ç­çº§æ•°', value: classCount, percentage: Math.min(100, (classCount / 10) * 100), color: '#4299e1', trend: null },
          { label: 'è€ƒè¯•åœºæ¬¡', value: examCount, percentage: Math.min(100, (examCount / 20) * 100), color: '#38b2ac', trend: null },
          { label: 'å¹³å‡æ€»åˆ†', value: avgScore, percentage: Math.min(100, (avgScore / maxPossibleTotal) * 100), color: '#ed8936', trend: null },
          { label: 'æœ€é«˜æ€»åˆ†', value: maxScore, percentage: Math.min(100, (maxScore / maxPossibleTotal) * 100), color: '#48bb78', trend: topStudentName },
          { label: 'åŠæ ¼ç‡', value: passRate + '%', percentage: passRate, color: '#ecc94b', trend: null },
          { label: 'è‰¯å¥½ç‡', value: goodRate + '%', percentage: goodRate, color: '#ed64a6', trend: null },
          { label: 'ä¼˜ç§€ç‡', value: excellentRate + '%', percentage: excellentRate, color: '#f56565', trend: null }
        ];

        // æ¸…ç©ºå®¹å™¨
        container.innerHTML = '';

        // åˆ›å»ºå¡ç‰‡
        dashboardStats.forEach((stat, index) => {
          const card = document.createElement('div');
          card.style.cssText = `
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
          `;
          card.onmouseenter = () => {
            card.style.transform = 'translateY(-5px)';
            card.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.15)';
          };
          card.onmouseleave = () => {
            card.style.transform = '';
            card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
          };

          // å·¦ä¾§å†…å®¹
          const content = document.createElement('div');
          content.style.cssText = 'flex: 1;';
          content.innerHTML = `
            <div style="font-size: 14px; color: #718096; margin-bottom: 8px; font-weight: 500;">${stat.label}</div>
            <div style="font-size: 32px; font-weight: bold; color: #2d3748; line-height: 1;">${stat.value}</div>
            ${stat.trend ? `<div style="font-size: 12px; margin-top: 8px; color: #48bb78;">â†‘ ${stat.trend}</div>` : ''}
          `;

          // å³ä¾§åœ†ç¯å›¾
          const chartContainer = document.createElement('div');
          chartContainer.style.cssText = 'width: 80px; height: 80px; position: relative;';

          const canvas = document.createElement('canvas');
          canvas.id = `dashboardChart${index}`;
          chartContainer.appendChild(canvas);

          card.appendChild(content);
          card.appendChild(chartContainer);
          container.appendChild(card);

          // åˆ›å»ºChart.jsåœ†ç¯å›¾
          const ctx = canvas.getContext('2d');
          const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              datasets: [{
                data: [stat.percentage, 100 - stat.percentage],
                backgroundColor: [stat.color, '#edf2f7'],
                borderWidth: 0
              }]
            },
            options: {
              cutout: '70%',
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
              }
            }
          });
          dashboardCharts.push(chart);

          // æ·»åŠ è£…é¥°åœ†åœˆ
          const decoration = document.createElement('div');
          decoration.style.cssText = `
            position: absolute;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: ${stat.color};
            opacity: 0.05;
            right: -50px;
            top: -50px;
            pointer-events: none;
          `;
          card.appendChild(decoration);
        });
      }

      // æ–°å¢ç»Ÿè®¡å›¾è¡¨
      let scoreDistChart = null;
      let radarChart = null;
      let levelChart = null;

      function renderStatisticsCharts() {
        renderScoreDistribution();
        renderSubjectRadar();
        renderGradeLevel();
      }

      // 1. åˆ†æ•°åˆ†å¸ƒæŸ±çŠ¶å›¾
      function renderScoreDistribution() {
        const canvas = document.getElementById('scoreDistributionChart');
        if (!canvas) return;

        // é”€æ¯æ—§å›¾è¡¨
        if (scoreDistChart) {
          scoreDistChart.destroy();
        }

        // è·å–æ‰€æœ‰å­¦ç”Ÿçš„æ€»åˆ†
        const scores = students
          .filter(s => s.total_score != null && s.total_score > 0)
          .map(s => Number(s.total_score));

        if (scores.length === 0) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.font = '14px PingFang SC';
          ctx.fillStyle = '#6b7280';
          ctx.textAlign = 'center';
          ctx.fillText('æš‚æ— åˆ†æ•°æ•°æ®', canvas.width / 2, canvas.height / 2);
          return;
        }

        // è®¡ç®—åˆ†æ•°èŒƒå›´
        const minScore = Math.floor(Math.min(...scores) / 50) * 50; // å‘ä¸‹å–æ•´åˆ°50çš„å€æ•°
        const maxScore = Math.ceil(Math.max(...scores) / 50) * 50; // å‘ä¸Šå–æ•´åˆ°50çš„å€æ•°
        const interval = 50; // æ¯ä¸ªåŒºé—´50åˆ†

        // åŠ¨æ€ç”Ÿæˆåˆ†æ•°æ®µ
        const ranges = [];
        for (let i = minScore; i < maxScore; i += interval) {
          ranges.push({
            label: `${i}-${i + interval - 1}`,
            min: i,
            max: i + interval - 1
          });
        }

        const distribution = ranges.map(range => {
          return students.filter(s => {
            const total = s.total_score || 0;
            return total >= range.min && total <= range.max;
          }).length;
        });

        const ctx = canvas.getContext('2d');
        scoreDistChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ranges.map(r => r.label),
            datasets: [{
              label: 'äººæ•°',
              data: distribution,
              backgroundColor: '#3b82f6',
              borderRadius: 8,
              barThickness: 40
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: { size: 14 },
                bodyFont: { size: 13 }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  font: { size: 12 }
                },
                grid: {
                  color: '#e5e7eb'
                }
              },
              x: {
                ticks: {
                  font: { size: 12 }
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }

      // 2. ç§‘ç›®é›·è¾¾å›¾
      let selectedRadarSubjects = []; // ç”¨æˆ·é€‰æ‹©çš„ç§‘ç›®
      let allAvailableSubjects = []; // æ‰€æœ‰å¯ç”¨ç§‘ç›®

      // ä»æ•°æ®åº“æå–æ‰€æœ‰ç§‘ç›®
      function extractAvailableSubjects() {
        const subjectsSet = new Set();
        students.forEach(student => {
          if (student.scores && Array.isArray(student.scores)) {
            student.scores.forEach(score => {
              if (score.subject) {
                subjectsSet.add(score.subject);
              }
            });
          }
        });
        allAvailableSubjects = Array.from(subjectsSet).sort();

        // åˆå§‹åŒ–é€‰æ‹©çš„ç§‘ç›®ï¼ˆé»˜è®¤å…¨é€‰æ‰€æœ‰ç§‘ç›®ï¼‰
        if (selectedRadarSubjects.length === 0) {
          selectedRadarSubjects = [...allAvailableSubjects];
        }

        return allAvailableSubjects;
      }

      function renderSubjectRadar() {
        const canvas = document.getElementById('subjectRadarChart');
        if (!canvas) return;

        // é”€æ¯æ—§å›¾è¡¨
        if (radarChart) {
          radarChart.destroy();
        }

        // æå–å¯ç”¨ç§‘ç›®
        extractAvailableSubjects();

        // ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„ç§‘ç›®ï¼ˆé»˜è®¤å…¨éƒ¨ï¼‰
        const subjects = selectedRadarSubjects.length > 0 ? selectedRadarSubjects : allAvailableSubjects;
        const subjectAvgs = subjects.map(subject => {
          let total = 0;
          let count = 0;
          students.forEach(student => {
            const score = student.scores?.find(s => s.subject === subject);
            if (score) {
              total += Number(score.score || 0);
              count++;
            }
          });
          return count > 0 ? (total / count).toFixed(1) : 0;
        });

        const ctx = canvas.getContext('2d');
        radarChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: subjects,
            datasets: [{
              label: 'å¹³å‡åˆ†',
              data: subjectAvgs,
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              borderColor: '#3b82f6',
              borderWidth: 2,
              pointBackgroundColor: '#3b82f6',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: { size: 12 },
                  padding: 15
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + context.parsed.r + 'åˆ†';
                  }
                }
              }
            },
            scales: {
              r: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 20,
                  font: { size: 11 }
                },
                grid: {
                  color: '#e5e7eb'
                },
                angleLines: {
                  color: '#e5e7eb'
                },
                pointLabels: {
                  font: { size: 13, weight: 'bold' },
                  color: '#2d3748'
                }
              }
            }
          }
        });
      }

      // 3. ç­‰çº§åˆ†å¸ƒé¥¼å›¾
      function renderGradeLevel() {
        const canvas = document.getElementById('gradeLevelChart');
        if (!canvas) return;

        // é”€æ¯æ—§å›¾è¡¨
        if (levelChart) {
          levelChart.destroy();
        }

        // è®¡ç®—ç­‰çº§åˆ†å¸ƒ
        const summaryData = computeSummaryFromStudents(students, "æ€»åˆ†");
        const total = summaryData.total_students;

        // è®¡ç®—å„ç­‰çº§äººæ•°
        const excellentCount = Math.round(total * summaryData.excellent_rate / 100);
        const goodCount = Math.round(total * summaryData.good_rate / 100) - excellentCount;
        const passCount = Math.round(total * summaryData.pass_rate / 100) - goodCount - excellentCount;
        const failCount = total - excellentCount - goodCount - passCount;

        const ctx = canvas.getContext('2d');
        levelChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['ä¸åŠæ ¼', 'åŠæ ¼', 'è‰¯å¥½', 'ä¼˜ç§€'],
            datasets: [{
              data: [failCount, passCount, goodCount, excellentCount],
              backgroundColor: ['#3b82f6', '#f59e0b', '#10b981', '#ef4444'],
              borderWidth: 0,
              spacing: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: {
                display: true,
                position: 'right',
                labels: {
                  font: { size: 13 },
                  padding: 15,
                  generateLabels: function(chart) {
                    const data = chart.data;
                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                    return data.labels.map((label, i) => {
                      const value = data.datasets[0].data[i];
                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return {
                        text: `${label}: ${value}äºº (${percentage}%)`,
                        fillStyle: data.datasets[0].backgroundColor[i],
                        hidden: false,
                        index: i
                      };
                    });
                  }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value}äºº (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }

      // ç§‘ç›®é›·è¾¾å›¾è®¾ç½®å¼¹çª—
      const radarSettingsModal = document.getElementById('radarSettingsModal');
      const radarSettingsBtn = document.getElementById('radarSettingsBtn');
      const cancelRadarSettings = document.getElementById('cancelRadarSettings');
      const saveRadarSettings = document.getElementById('saveRadarSettings');
      const radarSubjectCheckboxes = document.getElementById('radarSubjectCheckboxes');

      // æ‰“å¼€è®¾ç½®å¼¹çª—
      radarSettingsBtn?.addEventListener('click', () => {
        // æå–å¯ç”¨ç§‘ç›®
        extractAvailableSubjects();

        // æ¸²æŸ“å¤é€‰æ¡†
        radarSubjectCheckboxes.innerHTML = allAvailableSubjects.map(subject => `
          <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
            <input type="checkbox" value="${subject}" ${selectedRadarSubjects.includes(subject) ? 'checked' : ''}
              style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-size: 14px;">${subject}</span>
          </label>
        `).join('');

        radarSettingsModal?.classList.add('active');
      });

      // å…³é—­å¼¹çª—
      cancelRadarSettings?.addEventListener('click', () => {
        radarSettingsModal?.classList.remove('active');
      });

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      radarSettingsModal?.addEventListener('click', (e) => {
        if (e.target === radarSettingsModal) {
          radarSettingsModal.classList.remove('active');
        }
      });

      // ä¿å­˜è®¾ç½®
      saveRadarSettings?.addEventListener('click', () => {
        const checkboxes = radarSubjectCheckboxes.querySelectorAll('input[type="checkbox"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);

        if (selected.length < 3) {
          alert('è¯·è‡³å°‘é€‰æ‹©3ä¸ªç§‘ç›®');
          return;
        }

        selectedRadarSubjects = selected;
        radarSettingsModal?.classList.remove('active');

        // é‡æ–°æ¸²æŸ“é›·è¾¾å›¾
        renderSubjectRadar();
      });

      // è¿›æ­¥ä¸é€€æ­¥å­¦ç”Ÿåˆ†æ
      let progressChart = null;
      let regressionChart = null;

      // é»˜è®¤è®¾ç½®ï¼šå¯¹æ¯”åœºæ¬¡3ï¼Œæ˜¾ç¤ºäººæ•°10ï¼Œè‡ªå®šä¹‰åœºæ¬¡10
      let progressSettings = {
        compareMode: 3,
        topCount: 10,
        customCount: 10
      };

      // ä»localStorageåŠ è½½è®¾ç½®
      function loadProgressSettings() {
        const saved = localStorage.getItem('progressSettings');
        if (saved) {
          try {
            progressSettings = JSON.parse(saved);
          } catch (e) {
            console.error('Failed to load progress settings', e);
          }
        }
      }

      // ä¿å­˜è®¾ç½®åˆ°localStorage
      function saveProgressSettings() {
        localStorage.setItem('progressSettings', JSON.stringify(progressSettings));
      }

      // æ›´æ–°æ ‡é¢˜æ˜¾ç¤º
      function updateProgressTitles() {
        const count = progressSettings.topCount;
        const mode = progressSettings.compareMode;

        document.getElementById('progressTitle').textContent = `è¿›æ­¥æœ€å¤§å‰${count}å`;
        document.getElementById('regressionTitle').textContent = `é€€æ­¥æœ€å¤§å‰${count}å`;

        let subtitle = '';
        if (mode === 2) {
          subtitle = 'åŸºäºæœ€è¿‘2åœºè€ƒè¯•å¯¹æ¯”';
        } else if (mode === 3) {
          subtitle = 'åŸºäºæœ€è¿‘3åœºè€ƒè¯•ç»¼åˆå¯¹æ¯”';
        } else if (mode === 5) {
          subtitle = 'åŸºäºæœ€è¿‘5åœºè€ƒè¯•è¶‹åŠ¿å¯¹æ¯”';
        } else if (mode === 'custom') {
          const customCount = progressSettings.customCount || 10;
          subtitle = `åŸºäºæœ€è¿‘${customCount}åœºè€ƒè¯•ç»¼åˆå¯¹æ¯”`;
        }

        document.getElementById('progressSubtitle').textContent = subtitle;
        document.getElementById('regressionSubtitle').textContent = subtitle;
      }

      function renderProgressRegressionCharts() {
        // è·å–æ‰€æœ‰å­¦ç”Ÿçš„æˆç»©æ•°æ®
        if (!students || students.length === 0) {
          document.getElementById('progressStudentsList').innerHTML = '<p style="margin: 0; color: #6b7280; text-align: center;">æš‚æ— æ•°æ®</p>';
          document.getElementById('regressionStudentsList').innerHTML = '<p style="margin: 0; color: #6b7280; text-align: center;">æš‚æ— æ•°æ®</p>';
          return;
        }

        // æ›´æ–°æ ‡é¢˜
        updateProgressTitles();

        const mode = progressSettings.compareMode;
        const topCount = progressSettings.topCount;

        // è·å–æ¯ä¸ªå­¦ç”Ÿçš„æ‰€æœ‰è€ƒè¯•è®°å½•ï¼ŒæŒ‰æ—¥æœŸæ’åº
        const studentProgressData = [];

        students.forEach(student => {
          if (!student.exam_id) return;

          // æ‰¾åˆ°è¯¥å­¦ç”Ÿçš„æ‰€æœ‰è€ƒè¯•è®°å½•
          const studentExams = students.filter(s => s.name === student.name && s.total_score != null);

          // ç¡®å®šéœ€è¦çš„æœ€å°‘è€ƒè¯•åœºæ¬¡
          let requiredExams;
          if (mode === 'custom') {
            requiredExams = progressSettings.customCount || 10;
          } else {
            requiredExams = mode;
          }

          if (studentExams.length >= requiredExams) {
            // æŒ‰æ—¥æœŸæ’åº
            studentExams.sort((a, b) => {
              const dateA = new Date(a.exam_date || 0);
              const dateB = new Date(b.exam_date || 0);
              return dateA - dateB;
            });

            let latestScore, previousScore, change;

            if (mode === 2) {
              // æœ€è¿‘2åœºå¯¹æ¯”ï¼šæœ€æ–°1åœº vs å‰1åœº
              const latest = studentExams[studentExams.length - 1];
              const previous = studentExams[studentExams.length - 2];
              latestScore = latest.total_score;
              previousScore = previous.total_score;
              change = latestScore - previousScore;
            } else if (mode === 3) {
              // æœ€è¿‘3åœºç»¼åˆå¯¹æ¯”ï¼šæœ€æ–°1åœº vs å‰2åœºå¹³å‡
              const latest = studentExams[studentExams.length - 1];
              const prev1 = studentExams[studentExams.length - 2];
              const prev2 = studentExams[studentExams.length - 3];
              latestScore = latest.total_score;
              previousScore = (prev1.total_score + prev2.total_score) / 2;
              change = latestScore - previousScore;
            } else if (mode === 5) {
              // æœ€è¿‘5åœºè¶‹åŠ¿å¯¹æ¯”ï¼šæœ€è¿‘2åœºå¹³å‡ vs å‰3åœºå¹³å‡
              const recent2Avg = (studentExams[studentExams.length - 1].total_score + studentExams[studentExams.length - 2].total_score) / 2;
              const prev3Avg = (studentExams[studentExams.length - 3].total_score + studentExams[studentExams.length - 4].total_score + studentExams[studentExams.length - 5].total_score) / 3;
              latestScore = recent2Avg;
              previousScore = prev3Avg;
              change = latestScore - previousScore;
            } else if (mode === 'custom') {
              // è‡ªå®šä¹‰åœºæ¬¡å¯¹æ¯”ï¼šæœ€æ–°1åœº vs å‰N-1åœºå¹³å‡
              const customCount = progressSettings.customCount || 10;
              const latest = studentExams[studentExams.length - 1];
              latestScore = latest.total_score;

              // è®¡ç®—å‰N-1åœºçš„å¹³å‡åˆ†
              let sum = 0;
              for (let i = studentExams.length - 2; i >= studentExams.length - customCount; i--) {
                sum += studentExams[i].total_score;
              }
              previousScore = sum / (customCount - 1);
              change = latestScore - previousScore;
            }

            studentProgressData.push({
              name: student.name,
              previous: previousScore.toFixed(1),
              latest: latestScore.toFixed(1),
              change: change.toFixed(1),
              changePercent: ((change / previousScore) * 100).toFixed(1)
            });
          }
        });

        // å»é‡ï¼ˆåŒä¸€ä¸ªå­¦ç”Ÿåªä¿ç•™ä¸€æ¡è®°å½•ï¼‰
        const uniqueStudents = [];
        const seenNames = new Set();
        studentProgressData.forEach(item => {
          if (!seenNames.has(item.name)) {
            seenNames.add(item.name);
            uniqueStudents.push(item);
          }
        });

        // è¿›æ­¥æœ€å¤§çš„å‰Nåï¼ˆæ­£æ•°ï¼Œä»å¤§åˆ°å°ï¼‰
        const topProgress = uniqueStudents
          .filter(s => parseFloat(s.change) > 0)
          .sort((a, b) => parseFloat(b.change) - parseFloat(a.change))
          .slice(0, topCount);

        // é€€æ­¥æœ€å¤§çš„å‰Nåï¼ˆè´Ÿæ•°ï¼Œä»å°åˆ°å¤§ï¼‰
        const topRegression = uniqueStudents
          .filter(s => parseFloat(s.change) < 0)
          .sort((a, b) => parseFloat(a.change) - parseFloat(b.change))
          .slice(0, topCount);

        // æ¸²æŸ“è¿›æ­¥æ¦œ
        renderProgressChart(topProgress);
        renderProgressList(topProgress);

        // æ¸²æŸ“é€€æ­¥æ¦œ
        renderRegressionChart(topRegression);
        renderRegressionList(topRegression);
      }

      function renderProgressChart(data) {
        const canvas = document.getElementById('progressChart');
        if (!canvas) return;

        if (progressChart) {
          progressChart.destroy();
        }

        if (data.length === 0) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.font = '14px sans-serif';
          ctx.fillStyle = '#9ca3af';
          ctx.textAlign = 'center';
          ctx.fillText('æš‚æ— è¿›æ­¥æ•°æ®', canvas.width / 2, canvas.height / 2);
          return;
        }

        const ctx = canvas.getContext('2d');
        progressChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.map(s => s.name),
            datasets: [{
              label: 'è¿›æ­¥åˆ†æ•°',
              data: data.map(s => s.change),
              backgroundColor: '#10b981',
              borderRadius: 8,
              barThickness: 30
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                  label: function(context) {
                    const student = data[context.dataIndex];
                    return [
                      `è¿›æ­¥: +${student.change}åˆ†`,
                      `å‰æ¬¡: ${student.previous}åˆ†`,
                      `æœ¬æ¬¡: ${student.latest}åˆ†`,
                      `æå‡: ${student.changePercent}%`
                    ];
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: { font: { size: 11 } },
                grid: { color: '#e5e7eb' }
              },
              y: {
                ticks: { font: { size: 12 } },
                grid: { display: false }
              }
            }
          }
        });
      }

      function renderRegressionChart(data) {
        const canvas = document.getElementById('regressionChart');
        if (!canvas) return;

        if (regressionChart) {
          regressionChart.destroy();
        }

        if (data.length === 0) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.font = '14px sans-serif';
          ctx.fillStyle = '#9ca3af';
          ctx.textAlign = 'center';
          ctx.fillText('æš‚æ— é€€æ­¥æ•°æ®', canvas.width / 2, canvas.height / 2);
          return;
        }

        const ctx = canvas.getContext('2d');
        regressionChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.map(s => s.name),
            datasets: [{
              label: 'é€€æ­¥åˆ†æ•°',
              data: data.map(s => Math.abs(s.change)),
              backgroundColor: '#ef4444',
              borderRadius: 8,
              barThickness: 30
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                  label: function(context) {
                    const student = data[context.dataIndex];
                    return [
                      `é€€æ­¥: ${student.change}åˆ†`,
                      `å‰æ¬¡: ${student.previous}åˆ†`,
                      `æœ¬æ¬¡: ${student.latest}åˆ†`,
                      `ä¸‹é™: ${student.changePercent}%`
                    ];
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: { font: { size: 11 } },
                grid: { color: '#e5e7eb' }
              },
              y: {
                ticks: { font: { size: 12 } },
                grid: { display: false }
              }
            }
          }
        });
      }

      function renderProgressList(data) {
        const container = document.getElementById('progressStudentsList');
        if (!container) return;

        if (data.length === 0) {
          container.innerHTML = '<p style="margin: 0; color: #6b7280; text-align: center;">æš‚æ— æ•°æ®</p>';
          return;
        }

        container.innerHTML = data.map((student, index) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-weight: 600; color: #10b981; font-size: 16px;">${index + 1}</span>
              <span style="font-weight: 500;">${student.name}</span>
            </div>
            <div style="text-align: right;">
              <span style="color: #10b981; font-weight: 600; font-size: 15px;">+${student.change}åˆ†</span>
              <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">(${student.previous}â†’${student.latest})</span>
            </div>
          </div>
        `).join('');
      }

      function renderRegressionList(data) {
        const container = document.getElementById('regressionStudentsList');
        if (!container) return;

        if (data.length === 0) {
          container.innerHTML = '<p style="margin: 0; color: #6b7280; text-align: center;">æš‚æ— æ•°æ®</p>';
          return;
        }

        container.innerHTML = data.map((student, index) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-weight: 600; color: #ef4444; font-size: 16px;">${index + 1}</span>
              <span style="font-weight: 500;">${student.name}</span>
            </div>
            <div style="text-align: right;">
              <span style="color: #ef4444; font-weight: 600; font-size: 15px;">${student.change}åˆ†</span>
              <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">(${student.previous}â†’${student.latest})</span>
            </div>
          </div>
        `).join('');
      }

      // è¿›æ­¥é€€æ­¥è®¾ç½®æ¨¡æ€æ¡†
      const progressSettingsModal = document.getElementById('progressSettingsModal');
      const progressSettingsBtn = document.getElementById('progressSettingsBtn');
      const cancelProgressSettings = document.getElementById('cancelProgressSettings');
      const saveProgressSettingsBtn = document.getElementById('saveProgressSettings');
      const progressTopCountSelect = document.getElementById('progressTopCount');
      const customExamCountInput = document.getElementById('customExamCount');

      // æ‰“å¼€è®¾ç½®å¼¹çª—
      progressSettingsBtn?.addEventListener('click', () => {
        // æ¢å¤å½“å‰è®¾ç½®åˆ°UI
        document.querySelectorAll('input[name="compareMode"]').forEach(radio => {
          const isCustom = radio.value === 'custom' && progressSettings.compareMode === 'custom';
          const isNumeric = parseInt(radio.value) === progressSettings.compareMode;
          radio.checked = isCustom || isNumeric;

          // æ›´æ–°æ ·å¼
          const label = radio.closest('label');
          if (radio.checked) {
            label.style.borderColor = '#3b82f6';
            label.style.background = 'rgba(59, 130, 246, 0.05)';
          } else {
            label.style.borderColor = 'var(--border)';
            label.style.background = 'transparent';
          }
        });
        progressTopCountSelect.value = progressSettings.topCount;
        customExamCountInput.value = progressSettings.customCount || 10;
        progressSettingsModal?.classList.add('active');
      });

      // å•é€‰æŒ‰é’®æ ·å¼æ›´æ–°
      document.querySelectorAll('input[name="compareMode"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.querySelectorAll('input[name="compareMode"]').forEach(r => {
            const label = r.closest('label');
            if (r.checked) {
              label.style.borderColor = '#3b82f6';
              label.style.background = 'rgba(59, 130, 246, 0.05)';
            } else {
              label.style.borderColor = 'var(--border)';
              label.style.background = 'transparent';
            }
          });
        });
      });

      // å…³é—­å¼¹çª—
      cancelProgressSettings?.addEventListener('click', () => {
        progressSettingsModal?.classList.remove('active');
      });

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      progressSettingsModal?.addEventListener('click', (e) => {
        if (e.target === progressSettingsModal) {
          progressSettingsModal.classList.remove('active');
        }
      });

      // ä¿å­˜è®¾ç½®
      saveProgressSettingsBtn?.addEventListener('click', () => {
        const selectedMode = document.querySelector('input[name="compareMode"]:checked');
        if (selectedMode) {
          if (selectedMode.value === 'custom') {
            // è‡ªå®šä¹‰åœºæ¬¡
            const customCount = parseInt(customExamCountInput.value);

            // éªŒè¯è¾“å…¥
            if (isNaN(customCount) || customCount < 2 || customCount > 50) {
              alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åœºæ¬¡æ•°ï¼ˆ2-50ä¹‹é—´ï¼‰');
              return;
            }

            progressSettings.compareMode = 'custom';
            progressSettings.customCount = customCount;
          } else {
            // é¢„è®¾åœºæ¬¡
            progressSettings.compareMode = parseInt(selectedMode.value);
          }
        }
        progressSettings.topCount = parseInt(progressTopCountSelect.value);

        // ä¿å­˜åˆ°localStorage
        saveProgressSettings();

        // å…³é—­å¼¹çª—
        progressSettingsModal?.classList.remove('active');

        // é‡æ–°æ¸²æŸ“å›¾è¡¨
        renderProgressRegressionCharts();
      });

      // ============ ç­çº§å¯¹æ¯”åŠŸèƒ½ ============
      let selectedComparisonClasses = [];
      let classComparisonCharts = {
        avgChart: null,
        subjectChart: null,
        ratesChart: null
      };

      // æ‰“å¼€ç­çº§é€‰æ‹©æ¨¡æ€æ¡†
      document.getElementById('selectClassesBtn')?.addEventListener('click', () => {
        openClassSelectionModal();
      });

      // æ‰“å¼€ç­çº§é€‰æ‹©æ¨¡æ€æ¡†
      async function openClassSelectionModal() {
        const modal = document.getElementById('classSelectionModal');
        const examFilter = document.getElementById('classComparisonExamFilter');
        const classList = document.getElementById('classCheckboxList');

        // åŠ è½½è€ƒè¯•åˆ—è¡¨åˆ°ç­›é€‰å™¨
        const exams = [...new Set(students.map(s => s.exam_name).filter(Boolean))];
        examFilter.innerHTML = '<option value="">å…¨éƒ¨è€ƒè¯•</option>' +
          exams.map(exam => `<option value="${exam}">${exam}</option>`).join('');

        // åŠ è½½ç­çº§åˆ—è¡¨
        await loadClassListForComparison();

        modal.classList.add('active');
      }

      // åŠ è½½ç­çº§åˆ—è¡¨
      async function loadClassListForComparison() {
        const classList = document.getElementById('classCheckboxList');
        const examFilter = document.getElementById('classComparisonExamFilter');
        const selectedExam = examFilter.value;

        try {
          // ä»å½“å‰å­¦ç”Ÿæ•°æ®ä¸­æå–ç­çº§
          let filteredStudents = students;
          if (selectedExam) {
            filteredStudents = students.filter(s => s.exam_name === selectedExam);
          }

          const classes = [...new Set(filteredStudents.map(s => s.class_name).filter(Boolean))];

          if (classes.length === 0) {
            classList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 20px;">æš‚æ— ç­çº§æ•°æ®</p>';
            return;
          }

          // æ¸²æŸ“ç­çº§å¤é€‰æ¡†
          classList.innerHTML = classes.map((className, index) => {
            const isChecked = selectedComparisonClasses.includes(className);
            const studentCount = filteredStudents.filter(s => s.class_name === className).length;

            return `
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid ${isChecked ? '#2563eb' : '#e5e7eb'}; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: ${isChecked ? '#eff6ff' : 'white'};">
                <input type="checkbox" value="${className}" ${isChecked ? 'checked' : ''}
                  onchange="toggleClassSelection('${className}')"
                  style="width: 18px; height: 18px; cursor: pointer;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 14px; color: #111827;">${className}</div>
                  <div style="font-size: 12px; color: #6b7280;">${studentCount} åå­¦ç”Ÿ</div>
                </div>
              </label>
            `;
          }).join('');

          updateSelectedClassCount();
        } catch (error) {
          console.error('åŠ è½½ç­çº§åˆ—è¡¨å¤±è´¥:', error);
          classList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #dc2626; padding: 20px;">åŠ è½½å¤±è´¥</p>';
        }
      }

      // åˆ‡æ¢ç­çº§é€‰æ‹©
      function toggleClassSelection(className) {
        const index = selectedComparisonClasses.indexOf(className);
        if (index > -1) {
          selectedComparisonClasses.splice(index, 1);
        } else {
          if (selectedComparisonClasses.length >= 6) {
            alert('æœ€å¤šåªèƒ½é€‰æ‹©6ä¸ªç­çº§');
            event.target.checked = false;
            return;
          }
          selectedComparisonClasses.push(className);
        }
        updateSelectedClassCount();
        loadClassListForComparison(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ ·å¼
      }

      // æ›´æ–°å·²é€‰æ‹©ç­çº§æ•°é‡
      function updateSelectedClassCount() {
        const countEl = document.getElementById('selectedClassCount');
        if (countEl) {
          countEl.textContent = selectedComparisonClasses.length;
        }
      }

      // å…¨é€‰ç­çº§
      document.getElementById('selectAllClasses')?.addEventListener('click', () => {
        const checkboxes = document.querySelectorAll('#classCheckboxList input[type="checkbox"]');
        const classes = Array.from(checkboxes).map(cb => cb.value).slice(0, 6);
        selectedComparisonClasses = classes;
        loadClassListForComparison();
      });

      // æ¸…ç©ºé€‰æ‹©
      document.getElementById('clearAllClasses')?.addEventListener('click', () => {
        selectedComparisonClasses = [];
        loadClassListForComparison();
      });

      // è€ƒè¯•ç­›é€‰å˜åŒ–
      document.getElementById('classComparisonExamFilter')?.addEventListener('change', () => {
        selectedComparisonClasses = []; // é‡ç½®é€‰æ‹©
        loadClassListForComparison();
      });

      // å–æ¶ˆé€‰æ‹©
      document.getElementById('cancelClassSelection')?.addEventListener('click', () => {
        document.getElementById('classSelectionModal').classList.remove('active');
      });

      // ç¡®è®¤é€‰æ‹©å¹¶å¼€å§‹å¯¹æ¯”
      document.getElementById('confirmClassSelection')?.addEventListener('click', () => {
        if (selectedComparisonClasses.length < 2) {
          alert('è¯·è‡³å°‘é€‰æ‹©2ä¸ªç­çº§è¿›è¡Œå¯¹æ¯”');
          return;
        }

        document.getElementById('classSelectionModal').classList.remove('active');
        renderClassComparison();
      });

      // æ¸²æŸ“ç­çº§å¯¹æ¯”
      async function renderClassComparison() {
        const examFilter = document.getElementById('classComparisonExamFilter').value;

        // æ˜¾ç¤ºå¯¹æ¯”å†…å®¹åŒºåŸŸ
        document.getElementById('classComparisonContent').style.display = 'block';

        // æ›´æ–°å·²é€‰æ‹©ç­çº§æ ‡ç­¾
        updateSelectedClassesTags();

        // æ”¶é›†å„ç­æ•°æ®
        const classesData = await Promise.all(
          selectedComparisonClasses.map(className => getClassData(className, examFilter))
        );

        // æ¸²æŸ“å„ä¸ªå›¾è¡¨
        renderClassAvgComparison(classesData);
        renderClassDetailTable(classesData);
        renderSubjectComparison(classesData);
        renderRatesComparison(classesData);

        // æ»šåŠ¨åˆ°å¯¹æ¯”åŒºåŸŸ
        document.getElementById('classComparisonSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // æ›´æ–°å·²é€‰æ‹©ç­çº§æ ‡ç­¾
      function updateSelectedClassesTags() {
        const container = document.getElementById('selectedClassesTags');
        if (selectedComparisonClasses.length === 0) {
          container.innerHTML = '<span style="color: #6b7280; font-size: 14px;">è¯·é€‰æ‹©ç­çº§è¿›è¡Œå¯¹æ¯”ï¼ˆè‡³å°‘é€‰æ‹©2ä¸ªç­çº§ï¼‰</span>';
          return;
        }

        container.innerHTML = selectedComparisonClasses.map((className, index) => {
          const colors = ['#2563eb', '#059669', '#d97706', '#dc2626', '#7c3aed', '#0891b2'];
          const color = colors[index % colors.length];
          return `
            <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: ${color}; color: white; border-radius: 6px; font-size: 14px; font-weight: 500;">
              ${className}
              <button onclick="removeComparisonClass('${className}')" style="background: none; border: none; color: white; cursor: pointer; padding: 0; margin: 0; font-size: 16px; line-height: 1;">Ã—</button>
            </span>
          `;
        }).join('');
      }

      // ç§»é™¤å¯¹æ¯”ç­çº§
      function removeComparisonClass(className) {
        selectedComparisonClasses = selectedComparisonClasses.filter(c => c !== className);
        if (selectedComparisonClasses.length < 2) {
          document.getElementById('classComparisonContent').style.display = 'none';
        }
        updateSelectedClassesTags();
        if (selectedComparisonClasses.length >= 2) {
          renderClassComparison();
        }
      }

      // è·å–ç­çº§æ•°æ®
      async function getClassData(className, examName) {
        let classStudents = students.filter(s => s.class_name === className);
        if (examName) {
          classStudents = classStudents.filter(s => s.exam_name === examName);
        }

        if (classStudents.length === 0) {
          return {
            className,
            studentCount: 0,
            avgScore: 0,
            maxScore: 0,
            passRate: 0,
            goodRate: 0,
            excellentRate: 0,
            subjectAvgs: {}
          };
        }

        const totalScores = classStudents.map(s => s.total_score || 0);
        const avgScores = classStudents.map(s => s.average_score || 0);

        const avgScore = avgScores.reduce((a, b) => a + b, 0) / avgScores.length;
        const maxScore = Math.max(...totalScores);

        // è®¡ç®—ä¸‰ç‡
        const passCount = avgScores.filter(s => s >= 60).length;
        const goodCount = avgScores.filter(s => s >= 75).length;
        const excellentCount = avgScores.filter(s => s >= 90).length;

        // è®¡ç®—å„ç§‘å¹³å‡åˆ†
        const subjectAvgs = {};
        classStudents.forEach(student => {
          if (student.scores && Array.isArray(student.scores)) {
            student.scores.forEach(score => {
              if (!subjectAvgs[score.subject]) {
                subjectAvgs[score.subject] = [];
              }
              subjectAvgs[score.subject].push(parseFloat(score.score));
            });
          }
        });

        // è®¡ç®—å¹³å‡å€¼
        Object.keys(subjectAvgs).forEach(subject => {
          const scores = subjectAvgs[subject];
          subjectAvgs[subject] = scores.reduce((a, b) => a + b, 0) / scores.length;
        });

        return {
          className,
          studentCount: classStudents.length,
          avgScore: avgScore.toFixed(1),
          maxScore: maxScore.toFixed(1),
          passRate: ((passCount / classStudents.length) * 100).toFixed(1),
          goodRate: ((goodCount / classStudents.length) * 100).toFixed(1),
          excellentRate: ((excellentCount / classStudents.length) * 100).toFixed(1),
          subjectAvgs
        };
      }

      // 1. æ¸²æŸ“ç­çº§å¹³å‡åˆ†å¯¹æ¯”æŸ±çŠ¶å›¾
      function renderClassAvgComparison(classesData) {
        const ctx = document.getElementById('classAvgComparisonChart');
        if (!ctx) return;

        if (classComparisonCharts.avgChart) {
          classComparisonCharts.avgChart.destroy();
        }

        const colors = ['#2563eb', '#059669', '#d97706', '#dc2626', '#7c3aed', '#0891b2'];

        classComparisonCharts.avgChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: classesData.map(d => d.className),
            datasets: [{
              label: 'å¹³å‡åˆ†',
              data: classesData.map(d => parseFloat(d.avgScore)),
              backgroundColor: classesData.map((_, i) => colors[i % colors.length]),
              borderColor: classesData.map((_, i) => colors[i % colors.length]),
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: (context) => `å¹³å‡åˆ†: ${context.parsed.y.toFixed(1)}åˆ†`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 10
                },
                title: {
                  display: true,
                  text: 'å¹³å‡åˆ†'
                }
              }
            }
          }
        });
      }

      // 2. æ¸²æŸ“å„ç­è¯¦ç»†æ•°æ®è¡¨æ ¼
      function renderClassDetailTable(classesData) {
        const tbody = document.getElementById('classDetailTableBody');
        if (!tbody) return;

        // æŒ‰å¹³å‡åˆ†æ’åº
        const sortedData = [...classesData].sort((a, b) => parseFloat(b.avgScore) - parseFloat(a.avgScore));

        tbody.innerHTML = sortedData.map((data, index) => {
          const rankColors = ['#f59e0b', '#94a3b8', '#cd7f32'];
          const rankColor = index < 3 ? rankColors[index] : '#6b7280';

          return `
            <tr style="border-bottom: 1px solid #f3f4f6;">
              <td style="padding: 12px 16px;">
                <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: ${rankColor}; color: white; font-weight: 700; font-size: 14px;">
                  ${index + 1}
                </span>
              </td>
              <td style="padding: 12px 16px; font-weight: 600; color: #111827;">${data.className}</td>
              <td style="padding: 12px 16px; color: #111827;">${data.studentCount}</td>
              <td style="padding: 12px 16px;"><span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 4px; font-weight: 600;">${data.avgScore}</span></td>
              <td style="padding: 12px 16px; color: #111827;">${data.maxScore}</td>
              <td style="padding: 12px 16px; color: #111827;">${data.passRate}%</td>
              <td style="padding: 12px 16px; color: #111827;">${data.goodRate}%</td>
              <td style="padding: 12px 16px; color: #111827;">${data.excellentRate}%</td>
            </tr>
          `;
        }).join('');
      }

      // 3. æ¸²æŸ“å„ç§‘å¹³å‡åˆ†å¯¹æ¯”
      function renderSubjectComparison(classesData) {
        const ctx = document.getElementById('subjectComparisonChart');
        if (!ctx) return;

        if (classComparisonCharts.subjectChart) {
          classComparisonCharts.subjectChart.destroy();
        }

        // æå–æ‰€æœ‰ç§‘ç›®
        const allSubjects = new Set();
        classesData.forEach(data => {
          Object.keys(data.subjectAvgs).forEach(subject => allSubjects.add(subject));
        });
        const subjects = Array.from(allSubjects);

        if (subjects.length === 0) {
          return;
        }

        const colors = ['#2563eb', '#059669', '#d97706', '#dc2626', '#7c3aed', '#0891b2'];

        const datasets = classesData.map((data, index) => ({
          label: data.className,
          data: subjects.map(subject => data.subjectAvgs[subject] || 0),
          backgroundColor: colors[index % colors.length],
          borderColor: colors[index % colors.length],
          borderWidth: 2,
          borderRadius: 6
        }));

        classComparisonCharts.subjectChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: subjects,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(1)}åˆ†`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 10
                },
                title: {
                  display: true,
                  text: 'å¹³å‡åˆ†'
                }
              }
            }
          }
        });
      }

      // 4. æ¸²æŸ“ä¸‰ç‡å¯¹æ¯”
      function renderRatesComparison(classesData) {
        const ctx = document.getElementById('ratesComparisonChart');
        if (!ctx) return;

        if (classComparisonCharts.ratesChart) {
          classComparisonCharts.ratesChart.destroy();
        }

        const colors = ['#2563eb', '#059669', '#d97706', '#dc2626', '#7c3aed', '#0891b2'];

        classComparisonCharts.ratesChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: classesData.map(d => d.className),
            datasets: [
              {
                label: 'åŠæ ¼ç‡',
                data: classesData.map(d => parseFloat(d.passRate)),
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              },
              {
                label: 'è‰¯å¥½ç‡',
                data: classesData.map(d => parseFloat(d.goodRate)),
                borderColor: '#d97706',
                backgroundColor: 'rgba(217, 119, 6, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              },
              {
                label: 'ä¼˜ç§€ç‡',
                data: classesData.map(d => parseFloat(d.excellentRate)),
                borderColor: '#059669',
                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 10,
                  callback: (value) => value + '%'
                },
                title: {
                  display: true,
                  text: 'ç™¾åˆ†æ¯”'
                }
              }
            }
          }
        });
      }

      // ============ ç­çº§å¯¹æ¯”åŠŸèƒ½ç»“æŸ ============

      async function bootstrap() {
        loadColumnSettings();
        loadProgressSettings();
        renderRangeSubjectOptions();
        await loadGradeConfig();
        await loadFilterOptions(); // åŠ è½½ç­›é€‰é€‰é¡¹
        await loadStudents();
        addScoreRow();
        initCollapsibleSections();
        renderGradeDashboard();
        renderStatisticsCharts();
        renderProgressRegressionCharts();
      }
      bootstrap();
    </script>
  </body>
</html>
