<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡æ‰“å¡</title>
    <link rel="stylesheet" href="/static/fonts/fontawesome/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Comic Sans MS', 'Marker Felt', 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background: linear-gradient(135deg, #ffd6e0, #b8e1ff);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: all 0.5s ease;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
            animation: fadeInDown 1s ease;
            flex-wrap: wrap;
        }

        .title {
            font-size: 26px;
            color: #ff6b9e;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            cursor: text;
            position: relative;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            margin-right: 20px;
        }

        .title-icon {
            margin-right: 10px;
            color: #ff6b9e;
            animation: spin 2s infinite linear;
        }

        .title-edit {
            position: absolute;
            left: 40px;
            top: 0;
            font-size: 24px;
            color: #ff6b9e;
            border: 2px solid #ff6b9e;
            background: rgba(255, 255, 255, 0.9);
            font-family: inherit;
            padding: 0 10px;
            width: calc(100% - 40px);
            height: 100%;
            display: none;
            border-radius: 50px;
        }

        .controls-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            flex: 1;
            justify-content: flex-end;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #ffffff, #f0f0f0);
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .control-group label {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
        }

        .start-timer-btn,
        .save-btn,
        .home-btn {
            background: linear-gradient(45deg, #ff9eb5, #ff6b9e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            animation: pulse 1.5s infinite;
            min-width: 140px;
            justify-content: center;
            white-space: nowrap;
        }

        .home-btn {
            background: linear-gradient(45deg, #4a90e2, #73a6ff);
        }

        .home-btn:hover {
            background: linear-gradient(45deg, #73a6ff, #4a90e2);
        }

        .start-timer-btn i,
        .save-btn i,
        .home-btn i {
            margin-right: 8px;
        }

        .start-timer-btn:hover,
        .save-btn:hover {
            background: linear-gradient(45deg, #ff6b9e, #ff4d88);
            transform: scale(1.05);
        }

        .start-timer-btn:active,
        .save-btn:active,
        .home-btn:active {
            transform: scale(0.95);
        }

        .timer-display,
        .counter-display {
            font-size: 16px;
            color: #666;
            background: linear-gradient(135deg, #ffffff, #f0f0f0);
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: fadeIn 1s ease;
        }

        .container {
            display: flex;
            flex: 1;
            gap: 20px;
        }

        .students-container {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 20px;
            padding: 20px;
            position: relative;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
            animation: fadeInLeft 1s ease;
            border: 3px dashed #ff9eb5;
        }

        /* æ³¡æ³¡æ ·å¼ */
        .student-ball {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle at 50% 120%, #ffd6e0, #ff9eb5 80%, #ff6b9e 100%);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1), 0 0 20px rgba(255, 107, 158, 0.5);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            animation: float 3s ease-in-out infinite;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .student-ball::before {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        /* åœ†è§’çŸ©å½¢æ ·å¼ */
        .student-rect {
            width: 100px;
            height: 60px;
            background: linear-gradient(45deg, #ffd6e0, #ff9eb5);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            position: relative;
            animation: bounce 3s ease-in-out infinite;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            padding: 10px;
            text-align: center;
        }

        .student-ball.completed,
        .student-rect.completed {
            background: radial-gradient(circle at 50% 120%, #b8e1ff, #73a6ff 80%, #4a90e2 100%);
            color: white;
        }

        .student-ball:hover,
        .student-rect:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1), 0 0 30px rgba(255, 107, 158, 0.8);
        }

        .student-ball:active,
        .student-rect:active {
            transform: scale(0.95);
        }

        .student-ball.completed::after,
        .student-rect.completed::after {
            content: "âœ“";
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background-color: #4a90e2;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            animation: bounceIn 0.5s ease;
        }

        .student-name {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            line-height: 1.2;
        }

		.student-name {
			font-size: 20px;
			font-weight: bold;
			text-align: center;
			line-height: 1.2;
			color: #000000;   /* â† æ–°å¢ï¼šé»˜è®¤ç™½è‰²ï¼Œæƒ³æ¢è‰²å†™ä½ è‡ªå·±çš„è‰²å€¼ */
		}

        .student-note {
            font-size: 9.6px;
            opacity: 0.8;
            text-align: center;
            margin-top: 4px;
            line-height: 1.1;
        }

        .leaderboard {
            width: 360px; /* åŸ300pxåŠ å®½20% */
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            animation: fadeInRight 1s ease;
            border: 3px dashed #73a6ff;
        }

        .leaderboard h2 {
            color: #ff6b9e;
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .leaderboard h2 i {
            margin-right: 10px;
        }

        .leaderboard-list {
            list-style-type: none;
            padding: 0;
            flex: 1;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            color: #666;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
            border-radius: 10px;
        }

        .leaderboard-item:first-child {
            color: #ff6b9e;
            font-weight: bold;
            background: rgba(255, 214, 224, 0.7);
        }

        .leaderboard-item:nth-child(2) {
            color: #ff9eb5;
            background: rgba(255, 214, 224, 0.5);
        }

        .leaderboard-item:nth-child(3) {
            color: #ffc0cb;
            background: rgba(255, 214, 224, 0.3);
        }

        .leaderboard-item:hover {
            background-color: rgba(255, 214, 224, 0.5);
            transform: scale(1.02);
        }

        .time-taken {
            font-weight: bold;
            color: inherit;
        }

        .pending-list {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #ff9eb5;
        }

        .pending-list h3 {
            color: #ff6b9e;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 20px;
            display: flex;
            align-items: center;
        }

        .pending-list h3 i {
            margin-right: 10px;
        }

        .pending-list-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pending-item {
            background: linear-gradient(45deg, #ffd6e0, #ff9eb5);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            color: white;
            animation: fadeInUp 0.5s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .show-pending-btn {
            background: linear-gradient(45deg, #ff6b9e, #ff4d88);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
            align-self: center;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .export-btn {
            background: linear-gradient(45deg, #4a90e2, #73a6ff);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
            align-self: center;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .export-btn:hover {
            background: linear-gradient(45deg, #73a6ff, #4a90e2);
            transform: scale(1.05);
        }

        .export-btn:active {
            transform: scale(0.95);
        }

        .style-selector {
            padding: 10px 15px;
            border-radius: 20px;
            border: none;
            background: linear-gradient(135deg, #ffffff, #f0f0f0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-family: inherit;
            cursor: pointer;
        }

        .leaderboard-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        /* æ•°æ®ç®¡ç†æ§ä»¶ */
        .data-btn {
            background: linear-gradient(45deg, #4a90e2, #73a6ff);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .data-btn i {
            margin-right: 5px;
        }

        .data-btn:hover {
            background: linear-gradient(45deg, #73a6ff, #4a90e2);
            transform: scale(1.05);
        }

        .data-btn:active {
            transform: scale(0.95);
        }

        .font-size-slider {
            width: 100px;
        }

        .text-color-picker {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .size-slider {
            width: 100px;
        }

        /* æ–°å¢æ ·å¼ */
        .task-record-item {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .task-record-item:hover {
            background: #edf2f7;
            transform: translateX(5px);
        }

        .record-header {
            font-weight: bold;
            color: #5a67d8;
            margin-bottom: 8px;
        }

        .record-details {
            font-size: 0.9em;
            color: #718096;
            margin: 4px 0;
        }

        .delete-record {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .task-record-item:hover .delete-record {
            display: block;
        }

        .sync-points-btn {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .sync-points-btn:hover {
            transform: scale(1.05);
        }

        .task-name-input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            margin-right: 10px;
        }

        .task-points-input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            width: 80px;
            margin-right: 10px;
        }

        /* è®°å½•é€‰æ‹©å™¨æ ·å¼ */
        .record-selector {
            margin: 15px 0;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .record-selector h4 {
            color: #5a67d8;
            margin-bottom: 10px;
        }

        .record-option {
            display: flex;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .record-option:hover {
            background: #edf2f7;
        }

        .record-option input[type="radio"] {
            margin-right: 10px;
        }

        .record-option label {
            cursor: pointer;
            flex: 1;
        }

        .record-stats {
            font-size: 0.8em;
            color: #718096;
            margin-left: auto;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
            100% {
                transform: translateY(0);
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes bounceIn {
            from,
            20%,
            40%,
            60%,
            80%,
            to {
                animation-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
            }

            0% {
                opacity: 0;
                transform: scale3d(0.3, 0.3, 0.3);
            }

            20% {
                transform: scale3d(1.1, 1.1, 1.1);
            }

            40% {
                transform: scale3d(0.9, 0.9, 0.9);
            }

            60% {
                opacity: 1;
                transform: scale3d(1.03, 1.03, 1.03);
            }

            80% {
                transform: scale3d(0.97, 0.97, 0.97);
            }

            to {
                opacity: 1;
                transform: scale3d(1, 1, 1);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            border-radius: 50%;
            animation: confetti-fall 1s linear forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100px) rotate(360deg);
                opacity: 0;
            }
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 100px;
            color: gold;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            animation: zoomIn 0.5s ease-out;
            opacity: 0;
        }

        @keyframes zoomIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .save-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(45deg, #4a90e2, #73a6ff);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: fadeInUp 0.5s ease;
            z-index: 1000;
            display: none;
        }
		
		.btn-load,.btn-detail,.btn-del{
			  padding:4px 8px;font-size:12px;border:none;border-radius:4px;color:#fff;cursor:pointer;
		}
		.btn-load{background:linear-gradient(135deg, #4a86e8 0%, #5b6abf 100%);}
		.btn-detail{background:linear-gradient(135deg, #4a86e8 0%, #5b6abf 100%);}
		.btn-del{background:linear-gradient(135deg, #4a86e8 0%, #5b6abf 100%);}
    </style>
</head>

<body>
    <div class="header">
        <div class="title" id="pageTitle">
            <i class="fas fa-clipboard-check title-icon"></i>
            <span id="titleText">ä»»åŠ¡æ‰“å¡</span>
            <input type="text" class="title-edit" id="titleEdit">
        </div>
        
        <div class="controls-container">
            <!-- ä¸»è¦åŠŸèƒ½æŒ‰é’® -->
            <div class="control-group">
					<button class="home-btn" id="newTaskBtn" title="å¼€å§‹å…¨æ–°ä»»åŠ¡">
					  <i class="fas fa-plus"></i> å¼€å§‹æ–°ä»»åŠ¡
					</button>
                <button class="start-timer-btn" id="startTaskBtn">
                    <i class="fas fa-play"></i>
                    å¼€å§‹ä»»åŠ¡
                </button>
                <div class="timer-display" id="timerDisplay">00:00:00</div>
                <div class="counter-display" id="counterDisplay">0/0</div>
            </div>
            
            <!-- æ ·å¼è°ƒæ•´æ§ä»¶ -->
            <div class="control-group">
                <label for="fontSizeSlider">å­—å·:</label>
                <input type="range" id="fontSizeSlider" class="font-size-slider" min="10" max="36" value="16">
                <label for="textColorPicker">é¢œè‰²:</label>
                <input type="color" id="textColorPicker" class="text-color-picker" value="#ffffff">
                <label for="sizeSlider">å¤§å°:</label>
                <input type="range" id="sizeSlider" class="size-slider" min="80" max="150" value="100">
            </div>
            
            <!-- æ•°æ®ç®¡ç†æ§ä»¶ -->
            <div class="control-group">
                <button class="data-btn" id="saveDataBtn" title="ä¿å­˜å½“å‰æ•°æ®">
                    <i class="fas fa-save"></i>
                    ç”Ÿæˆè®°å½•
                </button>

                <button class="sync-points-btn" id="syncPointsBtn" title="åŒæ­¥ç§¯åˆ†åˆ°ä¸»ç³»ç»Ÿ">
                    <i class="fas fa-sync"></i>
                    åŒæ­¥ç§¯åˆ†
                </button>
                <button class="home-btn" id="homeBtn" title="è¿”å›ä¸»é¡µ">
				<script>
				  document.getElementById('homeBtn').addEventListener('click', () => {
					if (confirm('ç¡®å®šè¦è¿”å›ä¸»é¡µå—ï¼Ÿ')) {
					  window.location.href = 'points.html';
					}
				  });
				</script>
                    <i class="fas fa-home"></i>
                    è¿”å›ä¸»é¡µ
                </button>
            </div>
            
            <!-- æ ·å¼é€‰æ‹© -->
            <div class="control-group">
                <select class="style-selector" id="styleSelector">
                    <option value="ball">æ³¡æ³¡æ ·å¼</option>
                    <option value="rect">åœ†è§’çŸ©å½¢</option>
                </select>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="students-container" id="studentsContainer">
            <!-- å­¦ç”Ÿåœ†çƒå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="leaderboard">
            <h2>
                <i class="fas fa-trophy"></i>
                å·²å®ŒæˆåŒå­¦
            </h2>
            <ul class="leaderboard-list" id="leaderboardList">
                <!-- æ’è¡Œæ¦œæ¡ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </ul>
            <div class="pending-list" id="pendingList" style="display: none;">
                <h3><i class="fas fa-list"></i> æœªå®ŒæˆåŒå­¦</h3>
                <div class="pending-list-items" id="pendingItems"></div>
            </div>
            <div class="leaderboard-buttons">
                <button class="show-pending-btn" id="showPendingBtn">
                    <i class="fas fa-eye"></i>
                    æ˜¾ç¤ºæœªå®ŒæˆåŒå­¦
                </button>
                <button class="export-btn" id="exportBtn">
                    <i class="fas fa-file-excel"></i>
                    å¯¼å‡ºç»“æœ
                </button>
            </div>
            
            <!-- ä»»åŠ¡è®°å½•åŒºåŸŸ -->
<!-- ä»»åŠ¡è®°å½•åŒºåŸŸ -->
<div style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed #ff9eb5;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3><i class="fas fa-history"></i> ä»»åŠ¡è®°å½•</h3>
        <button class="btn-del" id="clearRecordsBtn" title="æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡è®°å½•" style="padding: 6px 12px;">
            <i class="fas fa-trash-alt"></i> æ¸…ç©ºè®°å½•
        </button>
    </div>
    <div id="taskRecordsList" style="max-height: 200px; overflow-y: auto;">
        <!-- ä»»åŠ¡è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>
</div>
        </div>
    </div>

<!-- åŒæ­¥ç§¯åˆ†è®¾ç½®æ¨¡æ€æ¡† -->
<div id="syncPointsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
        <h3 style="color: #ff6b9e; margin-bottom: 20px; text-align: center;">âš™ï¸ åŒæ­¥ç§¯åˆ†è®¾ç½®</h3>
        
        <!-- è®°å½•é€‰æ‹©å™¨ -->
        <div class="record-selector" id="recordSelector" style="flex: 1; overflow-y: auto; margin-bottom: 20px;">
            <h4>é€‰æ‹©è¦åŒæ­¥çš„è®°å½•</h4>
            <div id="recordOptions">
                <!-- è®°å½•é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px;">ç§¯åˆ†å€¼:</label>
            <input type="number" id="taskPointsValue" class="task-points-input" placeholder="ç§¯åˆ†" value="5">
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: inline-flex; align-items: center;">
                <input type="checkbox" id="syncToMainSystem" checked style="margin-right: 5px;">
                åŒæ­¥åˆ°ä¸»ç³»ç»Ÿ
            </label>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center; flex-shrink: 0;">
            <button class="btn btn-primary" id="confirmSyncBtn" style="padding: 10px 20px; background: #4a90e2; color: white; border: none; border-radius: 5px; cursor: pointer;">ç¡®è®¤åŒæ­¥</button>
            <button class="btn btn-secondary" id="cancelSyncBtn" style="padding: 10px 20px; background: #718096; color: white; border: none; border-radius: 5px; cursor: pointer;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

    <!-- åº†ç¥æ•ˆæœå®¹å™¨ -->
    <div class="celebration" id="celebration"></div>
    
    <!-- ä¿å­˜æ¶ˆæ¯ -->
    <div class="save-message" id="saveMessage">
        <i class="fas fa-check-circle"></i> æ•°æ®å·²ä¿å­˜ï¼
    </div>

    <script>
        // å…¨å±€å˜é‡
        let startTime = null;
        let timerInterval = null;
        let isTimerRunning = false;
        let totalStudents = 0;
        let completedStudents = 0;
        let currentStyle = 'ball';
        let studentsData = [];
        let taskRecords = null; // åˆå§‹åŒ–ä¸ºnullï¼Œåœ¨loadDataFromLocalStorageä¸­åˆå§‹åŒ–
        let currentTaskName = '';
        let processedStudents = new Set(); // è®°å½•å·²åŒæ­¥ç§¯åˆ†çš„å­¦ç”Ÿ
        
        // DOMå…ƒç´ 
        const titleText = document.getElementById('titleText');
        const titleEdit = document.getElementById('titleEdit');
        const timerDisplay = document.getElementById('timerDisplay');
        const counterDisplay = document.getElementById('counterDisplay');
        const pendingList = document.getElementById('pendingList');
        const pendingItems = document.getElementById('pendingItems');
        const showPendingBtn = document.getElementById('showPendingBtn');
        const exportBtn = document.getElementById('exportBtn');
        const celebration = document.getElementById('celebration');
        const styleSelector = document.getElementById('styleSelector');
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const textColorPicker = document.getElementById('textColorPicker');
        const sizeSlider = document.getElementById('sizeSlider');
        const saveDataBtn = document.getElementById('saveDataBtn');
        const saveMessage = document.getElementById('saveMessage');
        const syncPointsBtn = document.getElementById('syncPointsBtn');
        const homeBtn = document.getElementById('homeBtn');
        
        // æ·»åŠ æ³¡æ³¡éŸ³æ•ˆ
        const popSound = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
        popSound.volume = 0.6;

        // ä»URLå‚æ•°è·å–å­¦ç”Ÿæ•°æ®
        function getStudentsFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const studentsParam = urlParams.get('students');
            const classNameParam = urlParams.get('className');
            
            if (studentsParam) {
                try {
                    const students = JSON.parse(decodeURIComponent(studentsParam));
                    studentsData = students.map((student, index) => ({
                        name: student.name,
                        note: '',
                        completed: false,
                        time: null,
                        avatar: student.avatar || 'ğŸ¥š'
                    }));
                    totalStudents = studentsData.length;
                    
                    if (classNameParam) {
                        document.getElementById('titleText').textContent = `${decodeURIComponent(classNameParam)} - ä»»åŠ¡æ‰“å¡`;
                        document.title = `${decodeURIComponent(classNameParam)} - ä»»åŠ¡æ‰“å¡`;
                    }
                    
                    return true;
                } catch (e) {
                    console.error('è§£æå­¦ç”Ÿæ•°æ®å¤±è´¥:', e);
                    return false;
                }
            }
            return false;
        }

        // æ ·å¼é€‰æ‹©å™¨
        styleSelector.addEventListener('change', function () {
            currentStyle = this.value;
            updateStudentStyles();
            saveDataToLocalStorage();
        });

        // æ›´æ–°å­¦ç”Ÿæ ·å¼
        function updateStudentStyles() {
            const students = document.querySelectorAll('.student-ball, .student-rect');
            students.forEach(student => {
                student.classList.remove('student-ball', 'student-rect');
                
                switch (currentStyle) {
                    case 'ball':
                        student.classList.add('student-ball');
                        break;
                    case 'rect':
                        student.classList.add('student-rect');
                        break;
                }
            });
        }

        // åˆå§‹åŒ–å­¦ç”Ÿæ•°æ®
        function initializeStudents() {
            if (!getStudentsFromURL()) {
                // å¦‚æœæ²¡æœ‰URLå‚æ•°ï¼Œä½¿ç”¨ç¤ºä¾‹æ•°æ®
                const sampleData = `å¼ ä¸‰|ç­é•¿\næå››|å‰¯ç­é•¿\nç‹äº”|å­¦ä¹ å§”å‘˜\nèµµå…­|ä½“è‚²å§”å‘˜\né’±ä¸ƒ|æ–‡è‰ºå§”å‘˜\nå­™å…«|ç”Ÿæ´»å§”å‘˜\nå‘¨ä¹|çºªå¾‹å§”å‘˜\nå´å|ç»„é•¿`;
                processStudentList(sampleData);
            } else {
                renderStudents();
                updateCounter();
                updatePendingList();
            }
        }

        // å¤„ç†å­¦ç”Ÿåå•
        function processStudentList(content) {
            const studentsContainer = document.getElementById('studentsContainer');
            const leaderboardList = document.getElementById('leaderboardList');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            studentsContainer.innerHTML = '';
            leaderboardList.innerHTML = '';
            pendingItems.innerHTML = '';
            pendingList.style.display = 'none';
            
            // é‡ç½®è®¡æ•°å™¨
            totalStudents = 0;
            completedStudents = 0;
            updateCounter();
            
            // è§£æåå•å†…å®¹
            const lines = content.split('\n');
            studentsData = [];
            
            lines.forEach(line => {
                line = line.trim();
                if (line) {
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«å¤‡æ³¨ï¼ˆä½¿ç”¨|åˆ†éš”ï¼‰
                    const parts = line.split('|');
                    const name = parts[0].trim();
                    const note = parts[1] ? parts[1].trim() : '';
                    
                    studentsData.push({ name, note, completed: false, time: null });
                    totalStudents++;
                }
            });
            
            // æ¸²æŸ“å­¦ç”Ÿå…ƒç´ 
            renderStudents();
        }

        // æ¸²æŸ“å­¦ç”Ÿå…ƒç´ 
        function renderStudents() {
            const studentsContainer = document.getElementById('studentsContainer');
            const leaderboardList = document.getElementById('leaderboardList');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            studentsContainer.innerHTML = '';
            leaderboardList.innerHTML = '';
            
            // é‡ç½®è®¡æ•°å™¨
            totalStudents = studentsData.length;
            completedStudents = 0;
            
            studentsData.forEach((student, index) => {
                if (student.completed) completedStudents++;
                
                const studentElement = document.createElement('div');
                
                // æ ¹æ®å½“å‰æ ·å¼è®¾ç½®ç±»å
                switch (currentStyle) {
                    case 'ball':
                        studentElement.classList.add('student-ball');
                        break;
                    case 'rect':
                        studentElement.classList.add('student-rect');
                        break;
                }
                
                // åº”ç”¨å½“å‰å­—å·å’Œé¢œè‰²
                studentElement.style.fontSize = fontSizeSlider.value + 'px';
                studentElement.style.color = textColorPicker.value;
                
                // è®¾ç½®å­¦ç”Ÿå§“åå’Œå¤‡æ³¨
                const mainFontSize = parseInt(fontSizeSlider.value);
                const noteFontSize = mainFontSize * 0.6;
                
                studentElement.innerHTML = `
                    <div class="student-name" style="font-size: ${mainFontSize}px">${student.name}</div>
                    ${student.note ? `<div class="student-note" style="font-size: ${noteFontSize}px">${student.note}</div>` : ''}
                `;
                
                studentElement.dataset.name = student.name;
                studentElement.dataset.index = index;
                
                // å¦‚æœå·²å®Œæˆï¼Œæ·»åŠ å®Œæˆæ ·å¼
                if (student.completed) {
                    studentElement.classList.add('completed');
                    
                    // æ·»åŠ åˆ°æ’è¡Œæ¦œ
                    const listItem = document.createElement('li');
                    listItem.classList.add('leaderboard-item');
                    listItem.dataset.name = student.name;
                    listItem.innerHTML = `
                        <span>${student.name}</span>
                        <span class="time-taken">${student.time ? formatTime(new Date() - new Date(student.time)) : 'æœªçŸ¥'}</span>
                    `;
                    leaderboardList.appendChild(listItem);
                }
                
                studentElement.addEventListener('click', function () {
                    // æ£€æŸ¥æ˜¯å¦å·²å¼€å§‹è®¡æ—¶
                    if (!isTimerRunning) {
                        showCelebration('è¯·å…ˆå¼€å§‹ä»»åŠ¡å“¦ï¼', 'â°');
                        return;
                    }
                    
                    const index = parseInt(this.dataset.index);
                    const student = studentsData[index];
                    
                    if (!student.completed) {
                        // æ ‡è®°ä¸ºå®Œæˆ
                        student.completed = true;
                        student.time = new Date();
                        completedStudents++;
                        
                        // æ·»åŠ å®Œæˆæ ·å¼
                        this.classList.add('completed');
                        
                        // æ›´æ–°è®¡æ•°å™¨
                        updateCounter();
                        
                        // æ’­æ”¾éŸ³æ•ˆ
                        popSound.play();
                        
                        // æ·»åŠ åˆ°æ’è¡Œæ¦œ
                        addToLeaderboard(student);
                        
                        // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
                        if (completedStudents === totalStudents) {
                            celebrateCompletion();
                        }
                        
                        // æ›´æ–°æœªç­¾åˆ°åˆ—è¡¨
                        updatePendingList();
                        
                        // ä¿å­˜æ•°æ®
                        saveDataToLocalStorage();
                    } else {
                        // æ’¤å›å®ŒæˆçŠ¶æ€
                        student.completed = false;
                        student.time = null;
                        completedStudents--;
                        
                        // ç§»é™¤å®Œæˆæ ·å¼
                        this.classList.remove('completed');
                        
                        // æ›´æ–°è®¡æ•°å™¨
                        updateCounter();
                        
                        // ä»æ’è¡Œæ¦œç§»é™¤
                        removeFromLeaderboard(student.name);
                        
                        // æ›´æ–°æœªç­¾åˆ°åˆ—è¡¨
                        updatePendingList();
                        
                        // ä¿å­˜æ•°æ®
                        saveDataToLocalStorage();
                    }
                });
                
                studentsContainer.appendChild(studentElement);
            });
            
            // æ›´æ–°è®¡æ•°å™¨
            updateCounter();
            
            // æ›´æ–°æœªç­¾åˆ°åˆ—è¡¨
            updatePendingList();
        }

        // æ›´æ–°è®¡æ•°å™¨
        function updateCounter() {
            counterDisplay.textContent = `${completedStudents}/${totalStudents}`;
        }

        // æ·»åŠ åˆ°æ’è¡Œæ¦œ
        function addToLeaderboard(student) {
            const leaderboardList = document.getElementById('leaderboardList');
            const listItem = document.createElement('li');
            listItem.classList.add('leaderboard-item');
            listItem.dataset.name = student.name;
            
            // è®¡ç®—ç”¨æ—¶ï¼ˆä»è®¡æ—¶å¼€å§‹åˆ°ç‚¹å‡»çš„æ—¶é—´ï¼‰
            let timeTaken = 'æœªçŸ¥';
            if (startTime) {
                const timeDiff = student.time - startTime;
                timeTaken = formatTime(timeDiff);
            }
            
            listItem.innerHTML = `
                <span>${student.name}</span>
                <span class="time-taken">${timeTaken}</span>
            `;
            
            leaderboardList.appendChild(listItem);
        }

        // ä»æ’è¡Œæ¦œç§»é™¤
        function removeFromLeaderboard(name) {
            const leaderboardList = document.getElementById('leaderboardList');
            const items = leaderboardList.querySelectorAll('.leaderboard-item');
            
            items.forEach(item => {
                if (item.dataset.name === name) {
                    item.remove();
                }
            });
        }

        // æ›´æ–°æœªç­¾åˆ°åˆ—è¡¨
        function updatePendingList() {
            const pendingStudents = studentsData.filter(student => !student.completed).map(student => student.name);
            
            pendingItems.innerHTML = '';
            
            if (pendingStudents.length > 0) {
                pendingStudents.forEach(name => {
                    const pendingItem = document.createElement('div');
                    pendingItem.classList.add('pending-item');
                    pendingItem.textContent = name;
                    pendingItems.appendChild(pendingItem);
                });
            }
        }

        // æ˜¾ç¤º/éšè—æœªç­¾åˆ°åˆ—è¡¨
        showPendingBtn.addEventListener('click', function () {
            if (pendingList.style.display === 'none') {
                pendingList.style.display = 'block';
                this.innerHTML = '<i class="fas fa-eye-slash"></i> éšè—æœªå®ŒæˆåŒå­¦';
            } else {
                pendingList.style.display = 'none';
                this.innerHTML = '<i class="fas fa-eye"></i> æ˜¾ç¤ºæœªå®ŒæˆåŒå­¦';
            }
        });

        // å¯¼å‡ºç»“æœ
        exportBtn.addEventListener('click', function () {
            const leaderboardItems = document.querySelectorAll('.leaderboard-item');
            let csvContent = "å§“å,ç”¨æ—¶\n";
            
            leaderboardItems.forEach(item => {
                const name = item.querySelector('span:first-child').textContent;
                const time = item.querySelector('.time-taken').textContent;
                csvContent += `${name},${time}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "ä»»åŠ¡å®Œæˆç»“æœ.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // å¼€å§‹ä»»åŠ¡
document.getElementById('startTaskBtn').addEventListener('click', function () {
  if (!isTimerRunning) {
    startTime = startTime || new Date(); // ç»§ç»­ç”¨æ—§æ—¶é—´
    timerInterval = setInterval(updateTimer, 1000);
    isTimerRunning = true;
    this.innerHTML = '<i class="fas fa-pause"></i> æš‚åœä»»åŠ¡';
  } else {
    clearInterval(timerInterval);
    isTimerRunning = false;
    this.innerHTML = '<i class="fas fa-play"></i> ç»§ç»­ä»»åŠ¡';
  }
  saveDataToLocalStorage();
});

        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            const now = new Date();
            const timeDiff = now - startTime;
            timerDisplay.textContent = formatTime(timeDiff);
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // åº†ç¥å®Œæˆ
        function celebrateCompletion() {
            // æ˜¾ç¤ºåº†ç¥æ–‡å­—
            celebration.textContent = 'ğŸ‰ å…¨éƒ¨å®Œæˆï¼ ğŸ‰';
            celebration.style.opacity = '1';
            
            // åˆ›å»ºå½©è‰²çº¸å±‘
            for (let i = 0; i < 100; i++) {
                createConfetti();
            }
            
            // 3ç§’åéšè—åº†ç¥æ–‡å­—
            setTimeout(() => {
                celebration.style.opacity = '0';
            }, 3000);
        }

        // åˆ›å»ºå½©è‰²çº¸å±‘
        function createConfetti() {
            const confetti = document.createElement('div');
            confetti.classList.add('confetti');
            
            // éšæœºé¢œè‰²
            const colors = ['#ff6b9e', '#4a90e2', '#aed581', '#ff8a65', '#4fc3f7', '#ffd700'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.backgroundColor = color;
            
            // éšæœºä½ç½®
            const startX = Math.random() * window.innerWidth;
            confetti.style.left = `${startX}px`;
            confetti.style.top = '0';
            
            // éšæœºåŠ¨ç”»å»¶è¿Ÿå’ŒæŒç»­æ—¶é—´
            const delay = Math.random() * 2;
            const duration = 1 + Math.random() * 2;
            confetti.style.animationDelay = `${delay}s`;
            confetti.style.animationDuration = `${duration}s`;
            
            document.body.appendChild(confetti);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                confetti.remove();
            }, (delay + duration) * 1000);
        }

        // æ˜¾ç¤ºåº†ç¥æ¶ˆæ¯
        function showCelebration(message, emoji) {
            celebration.textContent = `${emoji} ${message} ${emoji}`;
            celebration.style.opacity = 1;
            celebration.style.animation = 'none';
            void celebration.offsetHeight; // è§¦å‘é‡ç»˜
            celebration.style.animation = 'zoomIn 0.5s ease-out';
            
            setTimeout(() => {
                celebration.style.opacity = 0;
            }, 2000);
        }

        // æ ‡é¢˜ç¼–è¾‘åŠŸèƒ½
        titleText.addEventListener('click', function (e) {
            titleEdit.value = titleText.textContent;
            titleEdit.style.display = 'block';
            titleEdit.focus();
            e.stopPropagation();
        });

		titleEdit.addEventListener('blur', function () {
			titleText.textContent = this.value || 'ä»»åŠ¡æ‰“å¡';
			// è®¾ç½®æ ‡é¢˜å­—å·ä¸.titleæ ·å¼ä¸€è‡´
			titleText.style.fontSize = '24px'; // è¿™é‡Œæ”¹æˆä½ æƒ³è¦çš„å­—å·
			// æ ‡é¢˜å˜äº† â†’ æ–°ä»»åŠ¡ â†’ æ¸…ç©ºå·²åŒæ­¥é›†åˆï¼Œå…è®¸å…¨éƒ¨é‡æ–°åŠ ç§¯åˆ†
			processedStudents.clear();
			currentTaskName = titleText.textContent;
			document.title = titleText.textContent;
			this.style.display = 'none';
			saveDataToLocalStorage();
		});

        titleEdit.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') this.blur();
        });

        // å­—å·è°ƒæ•´åŠŸèƒ½
        fontSizeSlider.addEventListener('input', function() {
            const mainFontSize = this.value;
            const noteFontSize = mainFontSize * 0.6;
            
            const studentNames = document.querySelectorAll('.student-name');
            studentNames.forEach(name => {
                name.style.fontSize = mainFontSize + 'px';
            });
            
            const studentNotes = document.querySelectorAll('.student-note');
            studentNotes.forEach(note => {
                note.style.fontSize = noteFontSize + 'px';
            });
            
            saveDataToLocalStorage();
        });

        // é¢œè‰²è°ƒæ•´åŠŸèƒ½
        textColorPicker.addEventListener('input', function() {
            const color = this.value;
            const studentNames = document.querySelectorAll('.student-name, .student-note');
            studentNames.forEach(name => {
                name.style.color = color;
            });
            
            saveDataToLocalStorage();
        });

        // æ³¡æ³¡å¤§å°è°ƒæ•´åŠŸèƒ½
        sizeSlider.addEventListener('input', function() {
            const size = this.value;
            
            const studentBalls = document.querySelectorAll('.student-ball');
            studentBalls.forEach(ball => {
                ball.style.width = size + 'px';
                ball.style.height = size + 'px';
            });
            
            const studentRects = document.querySelectorAll('.student-rect');
            studentRects.forEach(rect => {
                rect.style.width = size + 'px';
                // ä¿æŒçŸ©å½¢æ¯”ä¾‹
                rect.style.height = (size * 0.6) + 'px';
            });
            
            saveDataToLocalStorage();
        });

        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function hasDesktopStorageApi() {
            return window.pywebview
                && window.pywebview.api
                && typeof window.pywebview.api.get_task_checkin_data === 'function';
        }

        async function readTaskCheckinData() {
            if (hasDesktopStorageApi()) {
                try {
                    return await window.pywebview.api.get_task_checkin_data();
                } catch (e) {
                    console.error('Read task checkin data failed:', e);
                    return null;
                }
            }
            return localStorage.getItem('taskCheckinData');
        }

        async function writeTaskCheckinData(payload) {
            if (hasDesktopStorageApi()) {
                try {
                    return await window.pywebview.api.save_task_checkin_data(payload);
                } catch (e) {
                    console.error('Save task checkin data failed:', e);
                    return false;
                }
            }
            try {
                localStorage.setItem('taskCheckinData', payload);
                return true;
            } catch (e) {
                console.error('Save task checkin data failed:', e);
                return false;
            }
        }

        async function removeTaskCheckinData() {
            if (hasDesktopStorageApi()) {
                try {
                    return await window.pywebview.api.clear_task_checkin_data();
                } catch (e) {
                    console.error('Clear task checkin data failed:', e);
                    return false;
                }
            }
            localStorage.removeItem('taskCheckinData');
            return true;
        }

        function saveDataToLocalStorage() {
            const data = {
                students: studentsData,
                timerState: {
                    isTimerRunning,
                    startTime: startTime ? startTime.toISOString() : null,
                    elapsedTime: timerDisplay.textContent
                },
                totalStudents,
                completedStudents,
                currentStyle,
                title: titleText.textContent,
                fontSize: fontSizeSlider.value,
                textColor: textColorPicker.value,
                size: sizeSlider.value,
                taskRecords: taskRecords,
                currentTaskName: currentTaskName,
                processedStudents: Array.from(processedStudents),
                timestamp: new Date().toISOString()
            };
            
            const payload = JSON.stringify(data);
            void writeTaskCheckinData(payload);
            
            // æ˜¾ç¤ºä¿å­˜æˆåŠŸçš„æ¶ˆæ¯
            showSaveMessage();
        }

        // æ˜¾ç¤ºä¿å­˜æ¶ˆæ¯
        function showSaveMessage() {
            saveMessage.style.display = 'block';
            setTimeout(() => {
                saveMessage.style.display = 'none';
            }, 2000);
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        async function loadDataFromLocalStorage() {
            const savedData = await readTaskCheckinData();
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    // æ¢å¤ä»»åŠ¡è®°å½•ï¼ˆæ— è®ºæ˜¯å¦æœ‰å­¦ç”Ÿæ•°æ®éƒ½è¦æ¢å¤ï¼‰
                    if (data.taskRecords) {
                        taskRecords = data.taskRecords;
                    } else {
                        // å¦‚æœæ²¡æœ‰ä»»åŠ¡è®°å½•æ•°æ®ï¼Œåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„
                        taskRecords = [];
                    }
                    
                    // æ¢å¤å·²å¤„ç†å­¦ç”Ÿåˆ—è¡¨
                    if (data.processedStudents) {
                        processedStudents = new Set(data.processedStudents);
                    }
                    
                    // æ¢å¤å­¦ç”Ÿæ•°æ®ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    if (data.students && data.students.length > 0) {
                        studentsData = data.students;
                        totalStudents = data.totalStudents || studentsData.length;
                        completedStudents = data.completedStudents || 0;
                        
                        // æ¢å¤è®¡æ—¶å™¨çŠ¶æ€
                        if (data.timerState && data.timerState.isTimerRunning && data.timerState.startTime) {
                            startTime = new Date(data.timerState.startTime);
                            timerInterval = setInterval(updateTimer, 1000);
                            isTimerRunning = true;
                            document.getElementById('startTaskBtn').innerHTML = '<i class="fas fa-pause"></i> æš‚åœä»»åŠ¡';
                        }
                        timerDisplay.textContent = data.timerState?.elapsedTime || '00:00:00';
                        
                        // æ¢å¤æ ·å¼è®¾ç½®
                        if (data.currentStyle) {
                            currentStyle = data.currentStyle;
                            styleSelector.value = currentStyle;
                        }
                        
                        if (data.title && data.title !== 'ä»»åŠ¡æ‰“å¡') {
                            titleText.textContent = data.title;
                            document.title = data.title;
                        }
                        
                        if (data.fontSize) {
                            fontSizeSlider.value = data.fontSize;
                        }
                        
                        if (data.textColor) {
                            textColorPicker.value = data.textColor;
                        }
                        
                        if (data.size) {
                            sizeSlider.value = data.size;
                        }
                        
                        if (data.currentTaskName) {
                            currentTaskName = data.currentTaskName;
                        }
                        
                        // é¡µé¢æ ‡é¢˜åŒæ­¥æ›´æ–°ï¼šå¦‚æœæœ‰ä»»åŠ¡è®°å½•ï¼Œä½¿ç”¨æœ€æ–°ä»»åŠ¡è®°å½•çš„åç§°æ›´æ–°é¡µé¢æ ‡é¢˜
                        if (taskRecords && taskRecords.length > 0) {
                            const latestRecord = taskRecords[taskRecords.length - 1];
                            if (latestRecord.taskName && latestRecord.taskName.trim() !== '') {
                                const pageTitle = `${latestRecord.taskName} - ä»»åŠ¡æ‰“å¡`;
                                document.title = pageTitle;
                                titleText.textContent = latestRecord.taskName;
                            }
                        }
                        
                        renderStudents();
                        renderTaskRecords();
                        showCelebration('å·²æ¢å¤ä¸Šæ¬¡çš„æ•°æ®ï¼', 'ğŸ“‚');
                    } else {
                        // å¦‚æœæ²¡æœ‰å­¦ç”Ÿæ•°æ®ï¼Œæ¢å¤å…¶ä»–çŠ¶æ€å¹¶åªæ¢å¤ä»»åŠ¡è®°å½•
                        // æ¢å¤å…¶ä»–çŠ¶æ€è®¾ç½®
                        if (data.timerState) {
                            timerDisplay.textContent = data.timerState?.elapsedTime || '00:00:00';
                        }
                        
                        if (data.currentStyle) {
                            currentStyle = data.currentStyle;
                            styleSelector.value = currentStyle;
                        }
                        
                        if (data.title && data.title !== 'ä»»åŠ¡æ‰“å¡') {
                            titleText.textContent = data.title;
                            document.title = data.title;
                        }
                        
                        if (data.fontSize) {
                            fontSizeSlider.value = data.fontSize;
                        }
                        
                        if (data.textColor) {
                            textColorPicker.value = data.textColor;
                        }
                        
                        if (data.size) {
                            sizeSlider.value = data.size;
                        }
                        
                        if (data.currentTaskName) {
                            currentTaskName = data.currentTaskName;
                        }
                        
                        // å…³é”®ä¿®å¤ï¼šå³ä½¿æ²¡æœ‰å­¦ç”Ÿæ•°æ®ï¼Œä¹Ÿè¦ç¡®ä¿studentsDataä¸ä¸ºç©ºæ•°ç»„
                        // é¿å…è§¦å‘initializeStudents()å¯¼è‡´ä»»åŠ¡è®°å½•ä¸¢å¤±
                        if (data.students && data.students.length === 0) {
                            studentsData = []; // æ˜ç¡®è®¾ç½®ä¸ºç©ºæ•°ç»„
                        }
                        
                        // é¡µé¢æ ‡é¢˜åŒæ­¥æ›´æ–°ï¼šå¦‚æœæœ‰ä»»åŠ¡è®°å½•ï¼Œä½¿ç”¨æœ€æ–°ä»»åŠ¡è®°å½•çš„åç§°æ›´æ–°é¡µé¢æ ‡é¢˜
                        if (taskRecords && taskRecords.length > 0) {
                            const latestRecord = taskRecords[taskRecords.length - 1];
                            if (latestRecord.taskName && latestRecord.taskName.trim() !== '') {
                                const pageTitle = `${latestRecord.taskName} - ä»»åŠ¡æ‰“å¡`;
                                document.title = pageTitle;
                                titleText.textContent = latestRecord.taskName;
                            }
                        }
                        
                        // åªæ¢å¤ä»»åŠ¡è®°å½•
                        renderTaskRecords();
                        if (taskRecords.length > 0) {
                            showCelebration('ä»»åŠ¡è®°å½•å·²æ¢å¤ï¼', 'ğŸ“‚');
                        }
                    }
                } catch (e) {
                    console.error('åŠ è½½ä¿å­˜çš„æ•°æ®æ—¶å‡ºé”™:', e);
                }
            }
            return savedData;
        }

// ========== ä»»åŠ¡è®°å½•ç›¸å…³ ==========

function renderTaskRecords() {
  const container = document.getElementById('taskRecordsList');
  if (!container) return;
  container.innerHTML = '';

  if (!taskRecords || taskRecords.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:#718096;padding:20px;">æš‚æ— ä»»åŠ¡è®°å½•</div>';
    return;
  }

  // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„åŸå§‹ç´¢å¼•ï¼Œè€Œä¸æ˜¯åå‘åçš„ç´¢å¼•
  taskRecords.slice().reverse().forEach((rec, displayIndex) => {
    // è®¡ç®—åŸå§‹æ•°ç»„ä¸­çš„æ­£ç¡®ç´¢å¼•
    const originalIndex = taskRecords.length - 1 - displayIndex;
    const div = document.createElement('div');
    div.className = 'task-record-item';
    div.dataset.index = originalIndex;
    div.innerHTML = `
      <div class="record-header">${rec.taskName || 'æœªå‘½åä»»åŠ¡'}</div>
      <div class="record-details">ğŸ“… ${rec.date}</div>
      <div class="record-details">â±ï¸ ${rec.duration}</div>
      <div class="record-details">âœ… ${rec.completedStudents.length}äººå®Œæˆ</div>
      <div class="record-details">â³ ${rec.pendingStudents.length}äººæœªå®Œæˆ</div>
      <div style="margin-top:6px;display:flex;gap:6px;">
        <button class="btn-load" onclick="loadThisRecord(${originalIndex})">åŠ è½½</button>
        <button class="btn-detail" onclick="showDetail(${originalIndex})">è¯¦æƒ…</button>
        <button class="btn-del" onclick="deleteThisRecord(${originalIndex})">åˆ é™¤</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function loadThisRecord(idx) {
  if (!confirm('åŠ è½½åä¼šæ›¿æ¢å½“å‰è¿›åº¦ï¼Œç¡®å®šç»§ç»­ï¼Ÿ')) return;
  const rec = taskRecords[idx];
  studentsData = rec.students.map(s => ({...s}));
  totalStudents = studentsData.length;
  completedStudents = studentsData.filter(s => s.completed).length;
  
  // å…³é”®ä¿®å¤ï¼šæ­£ç¡®æ›´æ–°å½“å‰ä»»åŠ¡åç§°å’Œé¡µé¢æ ‡é¢˜
  currentTaskName = rec.taskName || 'æœªå‘½åä»»åŠ¡';
  const pageTitle = `${currentTaskName} - ä»»åŠ¡æ‰“å¡`;
  document.title = pageTitle;
  titleText.textContent = currentTaskName; // ä¿®å¤ï¼šåªæ˜¾ç¤ºä»»åŠ¡åç§°ï¼Œä¸åŒ…å«" - ä»»åŠ¡æ‰“å¡"
  
  if (isTimerRunning) { clearInterval(timerInterval); isTimerRunning = false; }
  startTime = null; timerDisplay.textContent = '00:00:00';
  document.getElementById('startTaskBtn').innerHTML = '<i class="fas fa-play"></i> å¼€å§‹ä»»åŠ¡';
  renderStudents(); renderTaskRecords(); saveDataToLocalStorage();
}

function showDetail(idx) {
  const rec = taskRecords[idx];
  document.getElementById('detailTitle').textContent = rec.taskName || 'æœªå‘½åä»»åŠ¡';
  document.getElementById('doneCount').textContent = rec.completedStudents.length;
  document.getElementById('undoneCount').textContent = rec.pendingStudents.length;
  document.getElementById('doneList').innerHTML = rec.completedStudents.map(n => `<li>${n}</li>`).join('');
  document.getElementById('undoneList').innerHTML = rec.pendingStudents.map(n => `<li>${n}</li>`).join('');
  document.getElementById('detailModal').style.display = 'flex';
}

function closeDetail() {
  document.getElementById('detailModal').style.display = 'none';
}

function deleteThisRecord(idx) {
  if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')) return;
  // ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„ç´¢å¼•åˆ é™¤è®°å½•
  taskRecords.splice(idx, 1);
  saveDataToLocalStorage();
  renderTaskRecords();
}

        // è¿”å›ä¸»é¡µæŒ‰é’®äº‹ä»¶
        homeBtn.addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦è¿”å›ä¸»é¡µå—ï¼Ÿå½“å‰ä»»åŠ¡è¿›åº¦å°†ä¼šæ¸…é™¤ï¼Œä½†ä»»åŠ¡è®°å½•ä¼šä¿ç•™ã€‚')) {
                // åœæ­¢è®¡æ—¶å™¨
                if (isTimerRunning) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    document.getElementById('startTaskBtn').innerHTML = '<i class="fas fa-play"></i> å¼€å§‹ä»»åŠ¡';
                }
                
                // ä¿å­˜å½“å‰ä»»åŠ¡è®°å½•ï¼ˆç¡®ä¿ä¸ä¼šä¸¢å¤±ï¼‰
                const currentTaskRecords = [...taskRecords];
                const currentProcessedStudents = new Set(processedStudents);
                
                // é‡ç½®æ•°æ®ï¼ˆä»…æ¸…é™¤å½“å‰æ˜¾ç¤ºçš„åå­—å¡ç‰‡æ•°æ®ï¼Œä¿ç•™ä»»åŠ¡è®°å½•ï¼‰
                studentsData = [];
                totalStudents = 0;
                completedStudents = 0;
                startTime = null;
                timerDisplay.textContent = '00:00:00';
                counterDisplay.textContent = '0/0';
                
                // æ¢å¤ä»»åŠ¡è®°å½•å’Œå·²å¤„ç†å­¦ç”Ÿåˆ—è¡¨
                taskRecords = currentTaskRecords;
                processedStudents = currentProcessedStudents;
                
                // æ¸…ç©ºæ˜¾ç¤º
                document.getElementById('studentsContainer').innerHTML = '';
                document.getElementById('leaderboardList').innerHTML = '';
                document.getElementById('pendingItems').innerHTML = '';
                
                // ä¿å­˜æ•°æ®ï¼ˆåŒ…å«å®Œæ•´çš„ä»»åŠ¡è®°å½•ï¼‰
                saveDataToLocalStorage();
                
                // è·³è½¬åˆ°ä¸»é¡µ
                window.location.href = 'points.html';
            }
        });

        // åŒæ­¥ç§¯åˆ†æŒ‰é’®äº‹ä»¶
        syncPointsBtn.addEventListener('click', function() {
            try {
                if (taskRecords.length === 0) {
                    showCelebration('æ²¡æœ‰ä»»åŠ¡è®°å½•ï¼', 'âš ï¸');
                    return;
                }
                
                // æ¸²æŸ“è®°å½•é€‰æ‹©å™¨
                renderRecordSelector();
                
                // æ˜¾ç¤ºåŒæ­¥ç§¯åˆ†è®¾ç½®æ¨¡æ€æ¡†
                document.getElementById('syncPointsModal').style.display = 'flex';
            } catch (error) {
                console.error('æ‰“å¼€ç§¯åˆ†åŒæ­¥æ¨¡æ€æ¡†æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showCelebration('æ‰“å¼€ç§¯åˆ†åŒæ­¥å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'âŒ');
            }
        });

        // æ¸²æŸ“è®°å½•é€‰æ‹©å™¨
        function renderRecordSelector() {
            const recordOptions = document.getElementById('recordOptions');
            recordOptions.innerHTML = '';
            
            if (taskRecords.length === 0) {
                recordOptions.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">æš‚æ— ä»»åŠ¡è®°å½•</div>';
                return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ˜¾ç¤ºè®°å½•
            const sortedRecords = [...taskRecords].reverse();
            
            sortedRecords.forEach((record, index) => {
                const originalIndex = taskRecords.length - 1 - index;
                const completedCount = record.completedStudents.length;
                const pendingCount = record.pendingStudents.length;
                
                const optionDiv = document.createElement('div');
                optionDiv.className = 'record-option';
                
                optionDiv.innerHTML = `
                    <input type="radio" id="record-${originalIndex}" name="selectedRecord" value="${originalIndex}" ${index === 0 ? 'checked' : ''}>
                    <label for="record-${originalIndex}">
                        <div style="font-weight: 600;">${record.taskName || 'æœªå‘½åä»»åŠ¡'}</div>
                        <div style="font-size: 0.9em; color: #718096;">${record.date}</div>
                    </label>
                    <div class="record-stats">
                        âœ… ${completedCount}äºº | â³ ${pendingCount}äºº
                    </div>
                `;
                
                recordOptions.appendChild(optionDiv);
            });
        }

        // ç¡®è®¤åŒæ­¥ç§¯åˆ†
        document.getElementById('confirmSyncBtn').addEventListener('click', function() {
            const selectedRecordIndex = document.querySelector('input[name="selectedRecord"]:checked');
            if (!selectedRecordIndex) {
                alert('è¯·é€‰æ‹©è¦åŒæ­¥çš„è®°å½•ï¼');
                return;
            }
            
            const recordIndex = parseInt(selectedRecordIndex.value);
            const record = taskRecords[recordIndex];
            const pointsValue = parseInt(document.getElementById('taskPointsValue').value);
            const syncToMain = document.getElementById('syncToMainSystem').checked;
            
            if (isNaN(pointsValue) || pointsValue === 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†å€¼ï¼');
                return;
            }
            
            if (!record || !record.completedStudents || record.completedStudents.length === 0) {
                alert('è¯¥è®°å½•æ²¡æœ‰å·²å®Œæˆä»»åŠ¡çš„åŒå­¦ï¼');
                return;
            }
            
            // ç§¯åˆ†åŒæ­¥åˆ¤å®šé€»è¾‘ä¼˜åŒ–ï¼šåŸºäºä»»åŠ¡åç§°å»ºç«‹å…³è”
            // æ£€æŸ¥è¯¥ä»»åŠ¡æ˜¯å¦å·²ç»åŒæ­¥è¿‡ç§¯åˆ†
            const taskSyncHistory = JSON.parse(localStorage.getItem('taskSyncHistory') || '{}');
            // å…³é”®ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨currentTaskNameå˜é‡ï¼Œç¡®ä¿åœ¨loadThisRecordä¸­å·²æ­£ç¡®æ›´æ–°
            const taskKey = record.taskName || 'æœªå‘½åä»»åŠ¡';
            
            // å…³é”®ä¿®å¤ï¼šåŸºäºå½“å‰ä»»åŠ¡åç§°è¿›è¡Œç­›é€‰ï¼Œé¿å…é”™è¯¯è·³è¿‡æ—§ä»»åŠ¡ä¸­å·²å®ŒæˆåŒå­¦
            // åªæœ‰å½“è®°å½•çš„ä»»åŠ¡åç§°ä¸å½“å‰ä»»åŠ¡åç§°ç›¸åŒæ—¶ï¼Œæ‰æ£€æŸ¥ä»»åŠ¡åŒæ­¥å†å²
            const alreadyProcessed = record.completedStudents.filter(name => {
                // å¦‚æœä»»åŠ¡åç§°ä¸åŒï¼Œè¯´æ˜æ˜¯ä¸åŒä»»åŠ¡ï¼Œä¸æ£€æŸ¥åŒæ­¥å†å²
                if (taskKey !== currentTaskName) {
                    return false; // ä¸åŒä»»åŠ¡ï¼Œä¸è·³è¿‡ä»»ä½•åŒå­¦
                }
                
                // ç›¸åŒä»»åŠ¡ï¼šæ£€æŸ¥è¯¥å­¦ç”Ÿæ˜¯å¦åœ¨è¯¥ä»»åŠ¡ä¸­å·²åŒæ­¥
                if (taskSyncHistory[taskKey] && taskSyncHistory[taskKey].includes(name)) {
                    return true;
                }
                
                // å…³é”®ä¿®å¤ï¼šç§»é™¤å…¨å±€å·²å¤„ç†å­¦ç”Ÿé›†åˆæ£€æŸ¥
                // åªæ£€æŸ¥å½“å‰ä»»åŠ¡çš„åŒæ­¥å†å²ï¼Œé¿å…è·¨ä»»åŠ¡æ±¡æŸ“
                return false;
            });
            
            const availableStudents = record.completedStudents.filter(name => !alreadyProcessed.includes(name));
            
            if (availableStudents.length === 0) {
                alert('è¯¥è®°å½•ä¸­æ‰€æœ‰å·²å®Œæˆçš„åŒå­¦éƒ½å·²ç»åŒæ­¥è¿‡ç§¯åˆ†ï¼Œä¸èƒ½é‡å¤æ·»åŠ ï¼');
                return;
            }
            
            let confirmMessage = `ç¡®å®šè¦ä¸º${availableStudents.length}åå®Œæˆä»»åŠ¡çš„åŒå­¦æ¯äººå¢åŠ ${pointsValue}ç§¯åˆ†å—ï¼Ÿ`;
            if (alreadyProcessed.length > 0) {
                confirmMessage += `\n\næ³¨æ„ï¼š${alreadyProcessed.length}ååŒå­¦å·²ç»åŒæ­¥è¿‡ç§¯åˆ†ï¼Œå°†è·³è¿‡è¿™äº›äººã€‚`;
            }
            
            if (confirm(confirmMessage)) {
                // åˆ›å»ºä¸´æ—¶è§„åˆ™æ•°æ®
                const tempRuleData = {
                    taskName: record.taskName || 'ä»»åŠ¡æ‰“å¡',
                    points: pointsValue,
                    completedStudents: availableStudents,
                    timestamp: new Date().toISOString(),
                    recordIndex: recordIndex
                };
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('tempTaskRule', JSON.stringify(tempRuleData));
                
                // å°†å¤„ç†è¿‡çš„å­¦ç”ŸåŠ å…¥ä»»åŠ¡åŒæ­¥å†å²è®°å½•
                availableStudents.forEach(name => {
                    // å…³é”®ä¿®å¤ï¼šä¸å†æ·»åŠ åˆ°å…¨å±€å·²å¤„ç†å­¦ç”Ÿé›†åˆ
                    // åªæ›´æ–°å½“å‰ä»»åŠ¡çš„åŒæ­¥å†å²ï¼Œé¿å…è·¨ä»»åŠ¡æ±¡æŸ“
                    if (!taskSyncHistory[taskKey]) {
                        taskSyncHistory[taskKey] = [];
                    }
                    if (!taskSyncHistory[taskKey].includes(name)) {
                        taskSyncHistory[taskKey].push(name);
                    }
                });
                
                // ä¿å­˜ä»»åŠ¡åŒæ­¥å†å²è®°å½•
                localStorage.setItem('taskSyncHistory', JSON.stringify(taskSyncHistory));
                
                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('syncPointsModal').style.display = 'none';
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showCelebration(`ç§¯åˆ†è§„åˆ™å·²ç”Ÿæˆï¼ä¸º${availableStudents}ååŒå­¦å¢åŠ ${pointsValue}ç§¯åˆ†`, 'âœ…');
                
                // ä¿å­˜æ•°æ®
                saveDataToLocalStorage();
            }
        });

        // å–æ¶ˆåŒæ­¥
        document.getElementById('cancelSyncBtn').addEventListener('click', function() {
            document.getElementById('syncPointsModal').style.display = 'none';
        });

        // ç”Ÿæˆè®°å½•æŒ‰é’®äº‹ä»¶
        saveDataBtn.addEventListener('click', function() {
            try {
                if (studentsData.length === 0) {
                    showCelebration('å½“å‰æ²¡æœ‰ä»»åŠ¡æ•°æ®ï¼', 'âš ï¸');
                    return;
                }
                
                // è·å–ä»»åŠ¡åç§°
                const taskName = titleText.textContent.replace(' - ä»»åŠ¡æ‰“å¡', '') || 'æœªå‘½åä»»åŠ¡';
                const duration = timerDisplay.textContent;
                const completedStudentsList = studentsData.filter(student => student.completed);
                const pendingStudentsList = studentsData.filter(student => !student.completed);
                
                // å…³é”®ä¿®å¤ï¼šæ¯æ¬¡ç”Ÿæˆè®°å½•æ—¶ï¼Œå¦‚æœä»»åŠ¡åç§°ä¸ç°æœ‰è®°å½•ä¸åŒï¼Œåˆ™è§†ä¸ºæ–°ä»»åŠ¡
                // åŒæ—¶æ›´æ–°currentTaskNameå˜é‡ï¼Œç¡®ä¿ç§¯åˆ†åŒæ­¥é€»è¾‘ä½¿ç”¨æ­£ç¡®çš„ä»»åŠ¡åç§°
                const isNewTask = !taskRecords.some(rec => rec.taskName === taskName);
                currentTaskName = taskName; // ç¡®ä¿å½“å‰ä»»åŠ¡åç§°æ­£ç¡®æ›´æ–°
                
                // åˆ›å»ºä»»åŠ¡è®°å½•
                const record = {
                    taskName: taskName,
                    date: new Date().toLocaleString('zh-CN'),
                    duration: duration,
                    students: studentsData.map(student => ({
                        name: student.name,
                        note: student.note,
                        completed: student.completed,
                        time: student.time
                    })),
                    completedStudents: completedStudentsList.map(s => s.name),
                    pendingStudents: pendingStudentsList.map(s => s.name),
                    totalStudents: totalStudents,
                    completedCount: completedStudents,
                    isNewTask: isNewTask, // æ ‡è®°æ˜¯å¦ä¸ºæ–°ä»»åŠ¡
                    recordId: Date.now() + Math.random().toString(36).substr(2, 9) // å”¯ä¸€æ ‡è¯†ç¬¦
                };
                
                // æ·»åŠ åˆ°ä»»åŠ¡è®°å½•
                taskRecords.push(record);
                
                // é™åˆ¶è®°å½•æ•°é‡ï¼ˆæœ€å¤šä¿ç•™20æ¡ï¼‰
                if (taskRecords.length > 20) {
                    taskRecords.shift();
                }
                
                // ä¿å­˜æ•°æ®
                saveDataToLocalStorage();
                
                // é‡æ–°æ¸²æŸ“ä»»åŠ¡è®°å½•
				
                renderTaskRecords();
                
                // æ ¹æ®æ˜¯å¦ä¸ºæ–°ä»»åŠ¡æ˜¾ç¤ºä¸åŒçš„æç¤ºä¿¡æ¯
                if (isNewTask) {
                    showCelebration('æ–°ä»»åŠ¡è®°å½•å·²ç”Ÿæˆï¼', 'ğŸ†•');
                } else {
                    showCelebration('ä»»åŠ¡è®°å½•å·²æ›´æ–°ï¼', 'ğŸ“');
                }
            } catch (error) {
                console.error('ç”Ÿæˆè®°å½•æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showCelebration('ç”Ÿæˆè®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'âŒ');
            }
        });



        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async function() {
            // æ£€æŸ¥URLå‚æ•°ï¼Œåªæœ‰æ˜¾å¼è¦æ±‚å…¨æ–°ä»»åŠ¡æ—¶æ‰æ¸…ç©ºæ•°æ®
            const urlParams = new URLSearchParams(window.location.search);
            const newTask = urlParams.get('newTask') === '1';
            
            if (newTask) {
                // å…¨æ–°ä»»åŠ¡ï¼šæ¸…é™¤æœ¬åœ°å­˜å‚¨æ•°æ®ï¼Œé‡æ–°åˆå§‹åŒ–
                await removeTaskCheckinData();
                showCelebration('å¼€å§‹å…¨æ–°ä»»åŠ¡ï¼', 'ğŸ†•');
                
                // åˆå§‹åŒ–ä»»åŠ¡è®°å½•ä¸ºç©ºæ•°ç»„ï¼ˆå…¨æ–°ä»»åŠ¡ï¼‰
                taskRecords = [];
                
                // åˆå§‹åŒ–å­¦ç”Ÿæ•°æ®ï¼ˆå…¨æ–°ä»»åŠ¡ï¼‰
                initializeStudents();
            } else {
                // éå…¨æ–°ä»»åŠ¡ï¼šåŠ è½½ç°æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬ä»»åŠ¡è®°å½•ï¼‰
                const savedData = await loadDataFromLocalStorage();
                
                // ç¡®ä¿taskRecordsè¢«æ­£ç¡®åˆå§‹åŒ–ï¼ˆå¦‚æœloadDataFromLocalStorageæ²¡æœ‰åˆå§‹åŒ–ï¼‰
                if (taskRecords === null) {
                    taskRecords = [];
                }
                
                // ä¿®å¤ï¼šåªæœ‰åœ¨å®Œå…¨æ²¡æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®æ—¶æ‰åˆå§‹åŒ–å­¦ç”Ÿæ•°æ®
                // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦æœ‰æ•°æ®
                if (!savedData && studentsData.length === 0) {
                    // å®Œå…¨æ²¡æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®ä¸”æ²¡æœ‰å­¦ç”Ÿæ•°æ®ï¼Œæ‰åˆå§‹åŒ–
                    initializeStudents();
                } else if (savedData && studentsData.length === 0) {
                    // æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®ä½†å­¦ç”Ÿæ•°æ®ä¸ºç©ºï¼Œè¯´æ˜æ˜¯åªæ¢å¤ä»»åŠ¡è®°å½•çš„æƒ…å†µ
                    // ä¸éœ€è¦åˆå§‹åŒ–å­¦ç”Ÿæ•°æ®ï¼Œé¿å…ä»»åŠ¡è®°å½•ä¸¢å¤±
                    console.log('ä»…æ¢å¤ä»»åŠ¡è®°å½•ï¼Œä¸åˆå§‹åŒ–å­¦ç”Ÿæ•°æ®');
                }
            }
            
            // æ·»åŠ è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨ï¼ˆæ¯30ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ï¼‰
            setInterval(saveDataToLocalStorage, 30000);
        });
		
		function showDetail(idx){
  const rec  = taskRecords[idx];
  if(!rec) return;
  document.getElementById('detailTitle').textContent = rec.taskName || 'æœªå‘½åä»»åŠ¡';
  document.getElementById('doneCount').textContent   = rec.completedStudents.length;
  document.getElementById('undoneCount').textContent = rec.pendingStudents.length;

  document.getElementById('doneList').innerHTML   = rec.completedStudents.map(n=>`<li>${n}</li>`).join('');
  document.getElementById('undoneList').innerHTML = rec.pendingStudents.map(n=>`<li>${n}</li>`).join('');

  document.getElementById('detailModal').style.display = 'flex';
}
function closeDetail(){
  document.getElementById('detailModal').style.display = 'none';
}
function deleteThisRecord(idx){
  if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ')){
    taskRecords.splice(idx,1);
    saveDataToLocalStorage();
    renderTaskRecords();
  }
}

function loadThisRecord(idx){
  if(confirm('åŠ è½½åä¼šæ›¿æ¢å½“å‰è¿›åº¦ï¼Œç¡®å®šç»§ç»­ï¼Ÿ')){
    const rec = taskRecords[idx];
    // æ¢å¤æ•°æ®
    studentsData = rec.students.map(s=> ({...s}));
    totalStudents = studentsData.length;
    completedStudents = studentsData.filter(s=>s.completed).length;
    currentTaskName = rec.taskName || 'æœªå‘½åä»»åŠ¡';
    
    // å…³é”®ä¿®å¤ï¼šæ›´æ–°é¡µé¢æ ‡é¢˜å…ƒç´ ï¼Œç¡®ä¿ä»»åŠ¡åç§°åŒæ­¥æ˜¾ç¤º
    const pageTitle = currentTaskName + ' - ä»»åŠ¡æ‰“å¡';
    document.title = pageTitle;
    titleText.textContent = currentTaskName; // åªæ˜¾ç¤ºä»»åŠ¡åç§°ï¼Œä¸å«åç¼€
    
    // é‡ç½®è®¡æ—¶
    if(isTimerRunning){clearInterval(timerInterval);isTimerRunning=false;}
    startTime = null;
    timerDisplay.textContent = '00:00:00';
    document.getElementById('startTaskBtn').innerHTML = '<i class="fas fa-play"></i> å¼€å§‹ä»»åŠ¡';
    // é‡æ–°æ¸²æŸ“
    renderStudents(); renderTaskRecords();
    saveDataToLocalStorage();
  }
}

document.getElementById('newTaskBtn').addEventListener('click', function(){
  if(confirm('å¼€å§‹æ–°ä»»åŠ¡å°†æ¸…ç©ºå½“å‰è¿›åº¦å¹¶é‡æ–°è¯»å–ç­çº§æ•°æ®ï¼Œä½†ä¼šä¿ç•™ä»»åŠ¡è®°å½•ï¼Œç¡®å®šï¼Ÿ')){
    // ä¿å­˜å½“å‰ä»»åŠ¡è®°å½•ï¼ˆç¡®ä¿ä¸ä¼šä¸¢å¤±ï¼‰
    const currentTaskRecords = [...taskRecords];
    const currentProcessedStudents = new Set(processedStudents);
    
    // é‡ç½®å½“å‰ä»»åŠ¡æ•°æ®ï¼ˆä¸æ¸…é™¤localStorageï¼Œåªé‡ç½®å†…å­˜ä¸­çš„æ•°æ®ï¼‰
    studentsData.forEach(s=>{s.completed=false;s.time=null;});
    completedStudents=0;
    if(isTimerRunning){clearInterval(timerInterval);isTimerRunning=false;}
    startTime=null; timerDisplay.textContent='00:00:00';
    document.getElementById('startTaskBtn').innerHTML='<i class="fas fa-play"></i> å¼€å§‹ä»»åŠ¡';
    
    // æ¢å¤ä»»åŠ¡è®°å½•å’Œå·²å¤„ç†å­¦ç”Ÿåˆ—è¡¨
    taskRecords = currentTaskRecords;
    processedStudents = currentProcessedStudents;
    
    // ğŸ†• æ–°å¢ï¼šé‡æ–°è¯»å–ç­çº§æ•°æ®
    initializeStudents();
    
    renderStudents(); renderTaskRecords();
    saveDataToLocalStorage();
  }
});

// æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡è®°å½•æŒ‰é’®äº‹ä»¶
document.getElementById('clearRecordsBtn').addEventListener('click', function() {
    if (taskRecords.length === 0) {
        showCelebration('æ²¡æœ‰ä»»åŠ¡è®°å½•å¯æ¸…ç©ºï¼', 'â„¹ï¸');
        return;
    }
    
    if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰${taskRecords.length}æ¡ä»»åŠ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
        // æ¸…ç©ºä»»åŠ¡è®°å½•æ•°ç»„
        taskRecords = [];
        
        // æ¸…ç©ºå·²å¤„ç†å­¦ç”Ÿé›†åˆ
        processedStudents.clear();
        
        // ä¿å­˜æ•°æ®
        saveDataToLocalStorage();
        
        // é‡æ–°æ¸²æŸ“ä»»åŠ¡è®°å½•
        renderTaskRecords();
        
        showCelebration('æ‰€æœ‰ä»»åŠ¡è®°å½•å·²æ¸…ç©ºï¼', 'ğŸ—‘ï¸');
    }
});
    </script>
	
	<!-- æŸ¥çœ‹è¯¦æƒ…å¼¹çª— -->
<div id="detailModal" style="display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.4);">
  <div style="background:#fff;margin:10% auto;padding:20px;border-radius:10px;width:320px;max-height:60vh;overflow-y:auto;">
    <h3 id="detailTitle" style="margin-top:0;"></h3>
    <p><strong>âœ… å·²å®Œæˆï¼ˆ<span id="doneCount"></span>äººï¼‰ï¼š</strong></p>
    <ul id="doneList" style="margin:0 0 15px 0;padding-left:20px;"></ul>
    <p><strong>â³ æœªå®Œæˆï¼ˆ<span id="undoneCount"></span>äººï¼‰ï¼š</strong></p>
    <ul id="undoneList" style="margin:0;padding-left:20px;"></ul>
    <div style="text-align:right;margin-top:15px;">
      <button onclick="closeDetail()" style="padding:6px 12px;border:none;border-radius:4px;background:#718096;color:#fff;cursor:pointer;">å…³é—­</button>
    </div>
  </div>
</div>
</body>
</html>
