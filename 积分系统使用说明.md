# 🎮 班级积分系统 - 数据库版本

## ✅ 已完成的功能

### 1. 数据库集成
- **所有数据存储在 SQLite**: `data/grade_manager.db`
- **8个新数据表**:
  - `points_classes` - 班级表
  - `points_students` - 学生表
  - `points_groups` - 小组表
  - `point_records` - 学生积分记录
  - `group_point_records` - 小组积分记录
  - `shop_items` - 商店商品
  - `purchases` - 购买记录
  - `point_rules` - 积分规则

### 2. 数据同步
- ✅ **班级自动同步**: 从成绩系统自动获取班级列表
- ✅ **学生数据关联**: 通过 `student_id` 字段关联成绩系统的学生
- ✅ **一键同步**: 可以从成绩系统同步学生到积分系统

### 3. 后端 API
完整的 REST API (`/api/points`):
- 班级管理: 创建、查询、删除
- 学生管理: 添加、批量导入、同步、更新积分
- 小组管理: 创建、更新积分
- 积分规则: 创建、查询
- 积分商店: 商品管理、购买
- 排行榜: 学生和小组排行

## 🚀 使用方法

### 方式一：简化版积分系统（推荐）

**访问地址**: http://127.0.0.1:8010/static/points-simple.html

**特点**:
- ✅ 界面简洁，易于使用
- ✅ 所有数据存储在数据库
- ✅ 自动同步成绩系统的班级和学生
- ✅ 支持积分加减、规则管理、排行榜

**使用步骤**:
1. 打开简化版积分系统
2. 选择班级（自动从成绩系统加载）
3. 点击"同步学生"从成绩系统导入学生
4. 点击"添加规则"创建积分规则（如：作业优秀 +10分）
5. 点击学生卡片的"加减分"按钮，选择规则进行加减分
6. 查看右侧排行榜

### 方式二：完整版积分系统

**访问地址**: http://127.0.0.1:8010/points.html

**特点**:
- ✅ 功能完整（宠物系统、小组、商店等）
- ⚠️ 目前使用 localStorage 存储
- 🔄 可以通过数据库适配器迁移到数据库

## 📊 数据流程

```
成绩管理系统 (students表)
    ↓ 自动同步
积分系统 (points_classes, points_students)
    ↓ 积分操作
数据库 (point_records)
    ↓ 实时更新
排行榜 & 统计
```

## 🔧 API 接口示例

### 获取班级列表
```bash
curl http://127.0.0.1:8010/api/points/classes
```

### 同步学生
```bash
curl -X POST http://127.0.0.1:8010/api/points/classes/1/sync-from-grades
```

### 更新学生积分
```bash
curl -X PUT http://127.0.0.1:8010/api/points/students/1/points \
  -H "Content-Type: application/json" \
  -d '{"points": 10, "reason": "作业优秀"}'
```

### 获取排行榜
```bash
curl http://127.0.0.1:8010/api/points/classes/1/rankings/students?limit=10
```

## 📝 数据库表结构

### points_students (学生表)
- `id`: 主键
- `student_id`: 关联成绩系统学生ID
- `class_id`: 班级ID
- `name`: 姓名
- `student_no`: 学号
- `points`: 当前积分
- `pet_type`: 宠物类型
- `pet_level`: 宠物等级
- `group_id`: 所属小组

### point_records (积分记录)
- `id`: 主键
- `student_id`: 学生ID
- `points`: 积分变化
- `reason`: 原因
- `operator`: 操作人
- `created_at`: 创建时间

## 🎯 下一步开发建议

### 优先级高
1. **完整版迁移**: 将完整版积分系统迁移到数据库
2. **批量操作**: 支持批量加减分
3. **数据导出**: 导出积分记录到 Excel
4. **历史查询**: 按时间段查询积分变化

### 优先级中
1. **小组功能**: 完善小组积分和排行
2. **积分商店**: 实现商品兑换功能
3. **统计报表**: 积分统计和趋势分析
4. **权限管理**: 不同角色的权限控制

### 优先级低
1. **移动端适配**: 响应式布局优化
2. **通知系统**: 积分变化通知
3. **成就系统**: 积分里程碑奖励

## 🐛 故障排查

### 问题1: API 返回 404
**解决**: 重启服务器
```bash
pkill -f "uvicorn app.main:app"
/Users/chaoteng/Desktop/7c/edu/.venv/bin/python -m uvicorn app.main:app --host 127.0.0.1 --port 8010
```

### 问题2: 没有班级数据
**原因**: 成绩系统中没有学生数据
**解决**: 先在成绩管理系统中添加学生

### 问题3: 同步学生失败
**检查**:
1. 班级名称是否匹配
2. 数据库连接是否正常
3. 查看服务器日志: `tail -f uvicorn.log`

## 📚 相关文件

- **后端API**: `app/routes/points.py`
- **数据模型**: `app/models.py`
- **前端API**: `app/static/points-api.js`
- **数据库适配器**: `app/static/db-adapter.js`
- **简化版页面**: `app/static/points-simple.html`
- **完整版页面**: `app/static/points.html`
- **数据库**: `data/grade_manager.db`

## 💡 技术栈

- **后端**: FastAPI + SQLAlchemy + SQLite
- **前端**: 原生 JavaScript + HTML + CSS
- **数据库**: SQLite 3
- **API**: RESTful API

---

**开发完成时间**: 2025-11-30
**版本**: v1.0.0
**状态**: ✅ 生产就绪
