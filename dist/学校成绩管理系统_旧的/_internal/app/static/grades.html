<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>成绩管理控制台</title>
    <script src="/static/chart.min.js"></script>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f4f6fb;
        --card-bg: #ffffff;
        --primary: #2563eb;
        --text: #1f2937;
        --subtext: #6b7280;
        --border: #e5e7eb;
        --danger: #ef4444;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "PingFang SC", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: var(--bg);
        color: var(--text);
      }
      header.top-nav {
        position: sticky;
        top: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 40px;
        background: var(--card-bg);
        box-shadow: 0 2px 30px rgba(15, 23, 42, 0.08);
        z-index: 100;
      }
      .brand {
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      nav ul {
        list-style: none;
        display: flex;
        gap: 8px;
        margin: 0;
        padding: 0;
      }
      nav button {
        border: none;
        background: transparent;
        padding: 10px 18px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        color: var(--subtext);
        transition: background 0.2s ease, color 0.2s ease;
      }
      nav button.active {
        background: rgba(37, 99, 235, 0.12);
        color: var(--primary);
      }
      nav .has-submenu {
        position: relative;
      }
      nav .has-submenu > button {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      nav .submenu {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(15, 23, 42, 0.15);
        min-width: 180px;
        padding: 8px;
        list-style: none;
        z-index: 1000;
      }
      nav .has-submenu:hover .submenu {
        display: block;
      }
      nav .submenu li {
        margin: 0;
      }
      nav .submenu a {
        display: block;
        padding: 10px 14px;
        color: var(--text);
        text-decoration: none;
        border-radius: 8px;
        transition: background 0.2s ease;
        font-weight: 500;
      }
      nav .submenu a:hover {
        background: rgba(37, 99, 235, 0.08);
        color: var(--primary);
      }
      .app-shell {
        max-width: 1400px;
        margin: 0 auto;
        padding: 32px 12px 80px;
      }
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
      }
      .page-header h1 {
        margin: 0;
        font-size: 28px;
      }
      .page-header p {
        margin: 4px 0 0;
        color: var(--subtext);
      }
      .actions {
        display: flex;
        gap: 12px;
      }
      button,
      input,
      select,
      textarea {
        font: inherit;
      }
      .btn {
        border: none;
        border-radius: 10px;
        padding: 10px 18px;
        cursor: pointer;
        color: #fff;
        background: var(--primary);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.2);
      }
      .btn.secondary {
        background: #e5e7eb;
        color: #111827;
      }
      .compact-btn {
        padding: 8px 14px;
      }
      .btn.danger {
        background: var(--danger);
      }
      main[data-section] {
        display: none;
      }
      main[data-section].active {
        display: block;
      }
      .stats-grid {
        margin-top: 24px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }
      .stat-card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 15px 40px rgba(15, 23, 42, 0.05);
      }
      .stat-card h3 {
        margin: 0;
        font-size: 14px;
        color: var(--subtext);
      }
      .stat-card .value {
        font-size: 32px;
        margin-top: 12px;
        font-weight: 700;
      }
      .chip {
        display: inline-flex;
        margin-top: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        background: #ecfccb;
        color: #365314;
      }
      .filters {
        margin-top: 28px;
        background: var(--card-bg);
        border-radius: 16px;
        padding: 16px;
        border: 1px solid var(--border);
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .subject-tabs {
        margin-top: 20px;
        background: var(--card-bg);
        border-radius: 16px;
        border: 1px solid var(--border);
        padding: 18px 16px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .subject-tab {
        border: none;
        border-radius: 999px;
        padding: 10px 18px;
        background: #edf2ff;
        color: #475569;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .subject-tab.active {
        background: var(--primary);
        color: #fff;
      }
      .filters input,
      .filters select {
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 10px 12px;
        min-width: 180px;
      }
      .table-wrapper {
        margin-top: 18px;
        background: var(--card-bg);
        border-radius: 22px;
        border: 1px solid var(--border);
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: #f8fafc;
      }
      th,
      td {
        padding: 14px 16px;
        border-bottom: 1px solid #f1f5f9;
        text-align: left;
        font-size: 14px;
        vertical-align: top;
      }
      tbody tr:hover {
        background: #f9fbff;
      }
      .highlight-cell {
        background: rgba(37, 99, 235, 0.08);
        color: var(--primary);
        font-weight: 600;
      }
      .empty-tip {
        text-align: center;
        padding: 60px 20px;
        color: var(--subtext);
      }
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .modal-backdrop.active {
        display: flex;
      }
      .modal {
        background: var(--card-bg);
        width: min(640px, 92vw);
        max-height: 90vh;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 30px 80px rgba(15, 23, 42, 0.25);
        position: relative;
        overflow-y: auto;
      }
      .modal.modal-wide {
        width: min(900px, 92vw);
      }
      .modal h2 {
        margin-top: 0;
        font-size: 20px;
      }
      .modal form {
        display: grid;
        gap: 12px;
      }
      .field-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .field-group label {
        flex: 1;
      }
      label span {
        display: block;
        font-size: 12px;
        margin-bottom: 2px;
        color: var(--subtext);
      }
      label input,
      label textarea,
      label select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      label textarea {
        min-height: 64px;
        resize: vertical;
      }
      .scores-list {
        border-radius: 12px;
        border: 1px solid var(--border);
        padding: 12px;
        background: #f8fafc;
      }
      .score-row {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }
      .score-row input {
        flex: 1;
      }
      .score-row button {
        border: none;
        background: transparent;
        color: var(--danger);
        cursor: pointer;
      }
      .range-config-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 12px;
      }
      .range-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }
      .range-row .range-label {
        font-weight: 600;
        min-width: 64px;
      }
      .range-row input {
        width: 90px;
        border-radius: 8px;
        border: 1px solid var(--border);
        padding: 6px 8px;
      }
      .config-tip {
        margin: 4px 0 0;
        color: var(--subtext);
        font-size: 13px;
      }
      .config-note {
        margin: 8px 0 0;
        font-size: 12px;
        color: var(--subtext);
      }
      .modal-footer {
        margin-top: 12px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }
      .grade-manager {
        display: grid;
        gap: 20px;
        margin-top: 20px;
      }
      .grade-card {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border);
        padding: 24px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
      }
      .grade-card h2 {
        margin-top: 0;
      }
      .collapsible-section {
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid var(--border);
        padding: 0;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
        overflow: hidden;
      }
      .collapsible-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
      }
      .collapsible-header:hover {
        background: #f8fafc;
      }
      .collapsible-header h2 {
        margin: 0;
        font-size: 18px;
      }
      .collapsible-toggle {
        font-size: 20px;
        color: var(--primary);
        transition: transform 0.3s ease;
      }
      .collapsible-toggle.expanded {
        transform: rotate(180deg);
      }
      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      .collapsible-content.expanded {
        max-height: 1000px;
      }
      .collapsible-body {
        padding: 0 24px 24px 24px;
      }
      .inline-form {
        display: grid;
        gap: 16px;
      }
      .inline-form label {
        display: flex;
        flex-direction: column;
        font-size: 14px;
        color: var(--subtext);
      }
      .inline-form input,
      .inline-form select {
        margin-top: 4px;
        border-radius: 10px;
        border: 1px solid var(--border);
        padding: 8px 10px;
      }
      .inline-form-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .inline-form-row label {
        flex: 1;
      }
      .import-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .hint-text {
        font-size: 13px;
        color: var(--subtext);
        margin-top: 8px;
      }
      .notification {
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: #111827;
        color: #fff;
        padding: 12px 18px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      .notification.show {
        opacity: 1;
        transform: translateY(0);
      }
      .detail-tab {
        border: none;
        background: transparent;
        padding: 10px 20px;
        font-weight: 600;
        cursor: pointer;
        color: var(--subtext);
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
      }
      .detail-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .detail-tab-content {
        padding: 20px 0;
      }
      .info-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-top: 16px;
      }
      @media (max-width: 900px) {
        .info-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      @media (max-width: 600px) {
        .info-grid {
          grid-template-columns: 1fr;
        }
      }
      .info-item {
        padding: 12px;
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid var(--border);
      }
      .info-item label {
        display: block;
        font-size: 12px;
        color: var(--subtext);
        margin-bottom: 4px;
      }
      .info-item .value {
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
      }
      .overview-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
      }
      .overview-stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px;
        border-radius: 12px;
        text-align: center;
      }
      .overview-stat-card:nth-child(2) {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      .overview-stat-card:nth-child(3) {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      .overview-stat-card:nth-child(4) {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      }
      .overview-stat-card label {
        display: block;
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 4px;
      }
      .overview-stat-card .value {
        font-size: 24px;
        font-weight: 700;
      }
      #radarChart {
        max-width: 500px;
        margin: 0 auto;
      }
      .top-student-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        padding: 16px 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: box-shadow 0.2s ease;
      }
      .top-student-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
      .top-student-card .rank-badge {
        flex-shrink: 0;
        background: #f3f4f6;
        color: #111827;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
      }
      .top-student-card:nth-child(1) .rank-badge {
        background: #fef3c7;
        color: #92400e;
      }
      .top-student-card:nth-child(2) .rank-badge {
        background: #e0e7ff;
        color: #3730a3;
      }
      .top-student-card:nth-child(3) .rank-badge {
        background: #dbeafe;
        color: #1e40af;
      }
      .top-student-card .student-info-group {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 24px;
      }
      .top-student-card .student-name {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        min-width: 80px;
      }
      .top-student-card .student-detail {
        font-size: 14px;
        color: #6b7280;
      }
      .top-student-card .student-detail span {
        margin-right: 16px;
      }
      .top-student-card .score-display {
        flex-shrink: 0;
        text-align: right;
      }
      .top-student-card .avg-score {
        font-size: 24px;
        font-weight: 700;
        color: #111827;
      }
      .top-student-card .score-label {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 2px;
      }
      .tabs {
        display: flex;
        gap: 8px;
        border-bottom: 2px solid var(--border);
      }
      .tab-button {
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        color: var(--subtext);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: -2px;
        font-size: 14px;
      }
      .tab-button:hover {
        color: var(--text);
        background: rgba(0, 0, 0, 0.02);
      }
      .tab-button.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      @media (max-width: 720px) {
        header.top-nav {
          flex-direction: column;
          align-items: flex-start;
          gap: 16px;
        }
        .filters {
          flex-direction: column;
        }
        .actions {
          width: 100%;
        }
        .btn {
          flex: 1;
          justify-content: center;
        }
        .tab-button {
          padding: 10px 16px;
          font-size: 13px;
        }
      }
      /* 单科统计卡片样式 */
      .subject-stats-item {
        display: grid;
        grid-template-columns: 90px 1fr 90px 110px 85px;
        align-items: center;
        gap: 16px;
        padding: 16px 20px;
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
      }
      .subject-stats-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-color: #d1d5db;
      }
      .subject-name {
        font-size: 15px;
        font-weight: 600;
        color: #111827;
      }
      .subject-score {
        font-size: 28px;
        font-weight: 700;
        color: #2563eb;
        text-align: left;
      }
      .subject-rank {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
      }
      .subject-rank.rank-1 {
        background: #fef3c7;
        color: #92400e;
      }
      .subject-rank.rank-2 {
        background: #e5e7eb;
        color: #374151;
      }
      .subject-rank.rank-other {
        background: #f3f4f6;
        color: #6b7280;
      }
      .subject-diff {
        font-size: 18px;
        font-weight: 700;
        text-align: center;
      }
      .subject-diff.positive {
        color: #10b981;
      }
      .subject-diff.negative {
        color: #ef4444;
      }
      .subject-grade {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
      }
      .subject-grade.excellent {
        background: #dcfce7;
        color: #166534;
      }
      .subject-grade.good {
        background: #dbeafe;
        color: #1e40af;
      }
      .subject-grade.pass {
        background: #fed7aa;
        color: #9a3412;
      }
      .subject-stats-header {
        display: grid;
        grid-template-columns: 90px 1fr 90px 110px 85px;
        align-items: center;
        gap: 16px;
        padding: 12px 20px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 8px;
      }
      .subject-stats-header > div {
        font-size: 13px;
        font-weight: 600;
        color: #6b7280;
      }
      @media (max-width: 768px) {
        .subject-stats-header {
          display: none;
        }
        .subject-stats-item {
          grid-template-columns: 1fr;
          gap: 12px;
          padding: 14px 16px;
        }
        .subject-score {
          font-size: 24px;
        }
        .subject-diff {
          font-size: 16px;
        }
      }
    </style>
    <script src="/static/auth-guard.js"></script>
  </head>
  <body>
    <header class="top-nav">
      <div class="brand">📊 成绩管理</div>
      <nav>
        <ul>
          <li><button class="active" data-target="dashboard">仪表盘</button></li>
          <li><button data-target="grade">成绩管理</button></li>
          <li><button data-target="data">数据管理</button></li>
          <li id="systemMenuBtn" class="has-submenu" style="display: none;">
            <button>⚙️ 系统管理</button>
            <ul class="submenu">
              <li><a href="/static/admin-codes.html">🔑 激活码管理</a></li>
              <li><a href="/static/users.html">👥 用户管理</a></li>
            </ul>
          </li>
          <li><a href="points.html" style="text-decoration: none;"><button>🎮 积分系统</button></a></li>
        </ul>
      </nav>
    </header>

    <div class="app-shell">
      <main data-section="dashboard" class="active">
        <div class="page-header">
          <div>
            <h1>数据看板</h1>
            <p>成绩统计概览</p>
          </div>
          <div class="actions" style="gap: 12px; flex-wrap: wrap;">
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
              <button class="btn secondary" id="filterClassBtn" style="display: flex; align-items: center; gap: 6px;">
                <span>📚</span>
                <span id="filterClassText">选择班级</span>
                <span style="font-size: 12px; opacity: 0.7;" id="classCount"></span>
              </button>
              <button class="btn secondary" id="filterExamBtn" style="display: flex; align-items: center; gap: 6px;">
                <span>📝</span>
                <span id="filterExamText">选择考试</span>
                <span style="font-size: 12px; opacity: 0.7;" id="examCount"></span>
              </button>
              <button class="btn secondary" id="refreshBtn" style="display: flex; align-items: center; gap: 6px;">
                <span>🔄</span>
                <span>刷新数据</span>
              </button>
            </div>
          </div>
        </div>

        <section class="subject-tabs" id="subjectTabs"></section>

        <!-- 数据仪表盘 -->
        <section class="grade-card" style="margin-top: 20px;">
          <h2 style="margin-bottom: 20px;">数据统计概览</h2>
          <div id="gradeDashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;"></div>
        </section>

        <!-- 新增统计图表 -->
        <section style="margin-top: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">
          <!-- 分数分布 -->
          <div class="grade-card">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
              <span style="font-size: 20px;">📊</span>
              <h2 style="margin: 0;">分数分布</h2>
            </div>
            <p style="color: #718096; font-size: 14px; margin-bottom: 20px;">总分分段统计</p>
            <div style="height: 300px; position: relative;">
              <canvas id="scoreDistributionChart"></canvas>
            </div>
          </div>

          <!-- 科目雷达图 -->
          <div class="grade-card">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 20px;">👤</span>
                <h2 style="margin: 0;">科目雷达图</h2>
              </div>
              <button class="btn secondary" id="radarSettingsBtn" style="padding: 6px 12px; font-size: 14px;">⚙️ 设置科目</button>
            </div>
            <p style="color: #718096; font-size: 14px; margin-bottom: 20px;">各科平均分对比分析</p>
            <div style="height: 300px; position: relative;">
              <canvas id="subjectRadarChart"></canvas>
            </div>
          </div>

          <!-- 等级分布 -->
          <div class="grade-card">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
              <span style="font-size: 20px;">📈</span>
              <h2 style="margin: 0;">等级分布</h2>
            </div>
            <p style="color: #718096; font-size: 14px; margin-bottom: 20px;">优秀/良好/及格/不及格占比</p>
            <div style="height: 300px; position: relative;">
              <canvas id="gradeLevelChart"></canvas>
            </div>
          </div>
        </section>

        <section class="grade-card" style="margin-top: 24px;">
          <div style="margin-bottom: 16px;">
            <h2 style="margin-bottom: 12px;">考试成绩走势</h2>
            <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 14px; color: #718096;">按场次:</span>
                <div class="subject-tabs" style="margin: 0;">
                  <button class="subject-tab active" data-trend-count="3">近3场</button>
                  <button class="subject-tab" data-trend-count="5">近5场</button>
                  <button class="subject-tab" data-trend-count="10">近10场</button>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 14px; color: #718096;">按时间:</span>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="date" id="trendStartDate" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white;">
                  <span style="color: #718096;">至</span>
                  <input type="date" id="trendEndDate" style="padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white;">
                  <button id="applyTrendDateRange" class="subject-tab" style="padding: 6px 16px;">应用</button>
                </div>
              </div>
            </div>
          </div>
          <div style="padding: 20px; height: 350px; position: relative;">
            <canvas id="dashboardTrendChart"></canvas>
          </div>
          <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
              <div>
                <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #059669;">🏆 排名前5学生</h3>
                <div id="topStudentsGrid" style="display: flex; flex-direction: column; gap: 12px;"></div>
              </div>
              <div>
                <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #dc2626;">📉 排名后5学生</h3>
                <div id="bottomStudentsGrid" style="display: flex; flex-direction: column; gap: 12px;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- 学生个人成绩走势 -->
        <section class="grade-card" style="margin-top: 24px;">
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h2 style="margin: 0;">学生成绩对比走势</h2>
              <div style="display: flex; gap: 12px;">
                <button class="btn secondary compact-btn" id="selectStudentsBtn">📋 选择学生</button>
                <button class="btn secondary compact-btn" id="selectSubjectsBtn">⚙️ 选择科目</button>
              </div>
            </div>
            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
              <span style="font-size: 14px; color: #718096;">已选择学生 (<span id="selectedStudentCount">0</span>/5)</span>
              <span style="font-size: 14px; color: #718096;">|</span>
              <span style="font-size: 14px; color: #718096;">显示科目 (<span id="selectedSubjectCount">1</span>)</span>
            </div>
            <div id="selectedStudentsList" style="min-height: 44px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #f9fafb; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
              <span style="color: #9ca3af; font-size: 14px;">点击"选择学生"按钮添加学生</span>
            </div>
          </div>
          <div id="studentTrendChartContainer" style="display: none;">
            <div style="padding: 20px; height: 350px; position: relative;">
              <canvas id="studentTrendChart"></canvas>
            </div>
            <div style="margin-top: 24px; padding: 20px; background: #f7fafc; border-radius: 12px;">
              <h3 style="margin: 0 0 16px 0; font-size: 16px;">成绩统计</h3>
              <div id="studentTrendStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;"></div>
            </div>
          </div>
          <div id="studentTrendPlaceholder" style="padding: 60px 20px; text-align: center; color: #a0aec0;">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px;">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <p style="font-size: 16px; margin: 0;">请选择学生查看成绩对比走势（最多5人）</p>
          </div>
        </section>

        <!-- 进步与退步学生分析 -->
        <section style="margin-top: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="margin: 0; font-size: 20px;">📊 进步与退步学生分析</h2>
            <button class="btn secondary compact-btn" id="progressSettingsBtn" style="padding: 6px 12px; font-size: 14px;">⚙️ 设置</button>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 24px;">
          <!-- 进步最大前十名 -->
          <div class="grade-card">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
              <span style="font-size: 20px;">📈</span>
              <h2 style="margin: 0;" id="progressTitle">进步最大前10名</h2>
            </div>
            <p style="color: #718096; font-size: 14px; margin-bottom: 20px;" id="progressSubtitle">基于最近3场考试综合对比</p>
            <div style="height: 400px; position: relative;">
              <canvas id="progressChart"></canvas>
            </div>
            <div id="progressStudentsList" style="margin-top: 16px; padding: 12px; background: #f0fdf4; border-radius: 8px; max-height: 200px; overflow-y: auto;">
              <p style="margin: 0; color: #6b7280; text-align: center;">暂无数据</p>
            </div>
          </div>

          <!-- 退步最大前十名 -->
          <div class="grade-card">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
              <span style="font-size: 20px;">📉</span>
              <h2 style="margin: 0;" id="regressionTitle">退步最大前10名</h2>
            </div>
            <p style="color: #718096; font-size: 14px; margin-bottom: 20px;" id="regressionSubtitle">基于最近3场考试综合对比</p>
            <div style="height: 400px; position: relative;">
              <canvas id="regressionChart"></canvas>
            </div>
            <div id="regressionStudentsList" style="margin-top: 16px; padding: 12px; background: #fef2f2; border-radius: 8px; max-height: 200px; overflow-y: auto;">
              <p style="margin: 0; color: #6b7280; text-align: center;">暂无数据</p>
            </div>
          </div>
          </div>
        </section>

        <!-- 班级对比分析 -->
        <section class="grade-card" style="margin-top: 24px;" id="classComparisonSection">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <h2 style="margin: 0; font-size: 20px;">📊 班级对比分析</h2>
              <p style="color: #718096; font-size: 14px; margin: 4px 0 0 0;">选择班级进行多维度对比分析</p>
            </div>
            <button class="btn primary" id="selectClassesBtn" style="padding: 8px 16px;">
              <span>📋</span>
              <span>选择班级</span>
            </button>
          </div>

          <!-- 已选择班级标签 -->
          <div id="selectedClassesTags" style="min-height: 40px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: #f9fafb; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 20px;">
            <span style="color: #6b7280; font-size: 14px;">请选择班级进行对比（至少选择2个班级）</span>
          </div>

          <!-- 对比内容容器 -->
          <div id="classComparisonContent" style="display: none;">

            <!-- 1. 班级平均分对比 -->
            <div style="margin-bottom: 32px;">
              <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #111827;">
                <span style="margin-right: 8px;">📈</span>总分平均分对比
              </h3>
              <div style="height: 350px; position: relative; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                <canvas id="classAvgComparisonChart"></canvas>
              </div>
            </div>

            <!-- 2. 各班详细数据对比表格 -->
            <div style="margin-bottom: 32px;">
              <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #111827;">
                <span style="margin-right: 8px;">📋</span>各班详细数据
              </h3>
              <div style="overflow-x: auto; background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f9fafb;">
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">排名</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">班级</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">人数</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">平均分</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">最高分</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">及格率</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">良好率</th>
                      <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: #111827; border-bottom: 2px solid #e5e7eb;">优秀率</th>
                    </tr>
                  </thead>
                  <tbody id="classDetailTableBody">
                    <tr>
                      <td colspan="8" style="padding: 20px; text-align: center; color: #6b7280;">暂无数据</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 3. 各科平均分对比 -->
            <div style="margin-bottom: 32px;">
              <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #111827;">
                <span style="margin-right: 8px;">📊</span>各科平均分对比
              </h3>
              <div style="height: 400px; position: relative; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                <canvas id="subjectComparisonChart"></canvas>
              </div>
            </div>

            <!-- 4. 三率统计对比 -->
            <div>
              <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #111827;">
                <span style="margin-right: 8px;">📈</span>及格率·良好率·优秀率对比
              </h3>
              <div style="height: 350px; position: relative; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                <canvas id="ratesComparisonChart"></canvas>
              </div>
            </div>

          </div>
        </section>
      </main>

      <main data-section="grade">
        <div class="page-header">
          <div>
            <h1>成绩管理</h1>
            <p>查看和管理学生成绩</p>
          </div>
          <div class="actions">
            <button class="btn secondary" id="unifiedQueryBtn" style="background: #6366f1; color: white;">
              <span>🔍</span>
              <span>统一查询入口</span>
            </button>
            <button class="btn" id="addStudentBtn">+ 添加学生</button>
          </div>
        </div>

        <section class="filters">
          <input type="search" id="searchInput" placeholder="按姓名/学号搜索" />
          <select id="classFilter"><option value="">全部班级</option></select>
          <select id="examFilter"><option value="">全部考试</option></select>
          <button class="btn secondary compact-btn" id="columnSettingsBtn">⚙️ 列设置</button>
        </section>

        <section class="table-wrapper">
          <table class="ranking-table">
            <thead>
              <tr id="tableHeader">
                <th data-column="name">姓名</th>
                <th data-column="student_no">学号</th>
                <th data-column="class_rank">班级排名</th>
                <th data-column="grade_rank">年级排名</th>
                <th data-column="total_score">总分</th>
                <th data-column="rating">评分</th>
                <th data-column="语文">语文</th>
                <th data-column="数学">数学</th>
                <th data-column="英语">英语</th>
                <th data-column="物理">物理</th>
                <th data-column="化学">化学</th>
                <th data-column="生物">生物</th>
                <th data-column="历史">历史</th>
                <th data-column="政治">政治</th>
                <th data-column="地理">地理</th>
                <th data-column="actions">操作</th>
              </tr>
            </thead>
            <tbody id="studentBody">
              <tr><td colspan="16" class="empty-tip">数据加载中...</td></tr>
            </tbody>
          </table>
        </section>
      </main>

      <main data-section="data">
        <div class="page-header">
          <div>
            <h1>数据管理</h1>
            <p>批量导入导出成绩、设置科目区间。</p>
          </div>
        </div>
        <div class="grade-manager">
          <section class="grade-card">
            <h2>班级管理列表</h2>
            <p class="hint-text">查看所有班级的统计信息，包括人数、性别比例、平均分及各项率。</p>
            <div class="table-wrapper" style="margin-top:16px;">
              <table>
                <thead>
                  <tr>
                    <th>班级名称</th>
                    <th>年级</th>
                    <th>人数</th>
                    <th>考试场数</th>
                    <th>男生</th>
                    <th>女生</th>
                    <th>性别比例(男:女)</th>
                    <th>班级平均分</th>
                    <th>及格率</th>
                    <th>良好率</th>
                    <th>优秀率</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="classStatsBody">
                  <tr><td colspan="12" class="empty-tip">数据加载中...</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- 四个模块：两行两列布局 -->
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
            <!-- 第一行左：成绩区间设置 -->
            <section class="collapsible-section" style="margin: 0;">
              <div class="collapsible-header" data-target="rangeSection">
                <h2>成绩区间设置</h2>
                <span class="collapsible-toggle">▼</span>
              </div>
              <div class="collapsible-content" id="rangeSection">
                <div class="collapsible-body">
                  <p class="hint-text">为每个科目定义不及格/及格/良好/优秀的分数范围。</p>
                  <div class="inline-form-row">
                    <label>
                      科目
                      <select id="rangeSubjectSelect"></select>
                    </label>
                  </div>
                  <form id="rangeForm">
                    <div class="range-config-list" id="rangeRows"></div>
                    <div class="import-actions">
                      <button class="btn" type="submit">保存配置</button>
                    </div>
                  </form>
                </div>
              </div>
            </section>

            <!-- 第一行右：批量导入成绩 -->
            <section class="collapsible-section" style="margin: 0;">
              <div class="collapsible-header" data-target="importSection">
                <h2>批量导入成绩</h2>
                <span class="collapsible-toggle">▼</span>
              </div>
              <div class="collapsible-content" id="importSection">
                <div class="collapsible-body">
                  <p class="hint-text">先下载模板并录入成绩，再上传 Excel。</p>
                  <div class="import-actions">
                    <button class="btn secondary" id="downloadTemplate">下载导入模板</button>
                  </div>
                  <form class="inline-form" id="importForm">
                    <div class="inline-form-row" style="flex-wrap: wrap;">
                      <label style="flex: 1; min-width: 120px;">年级
                        <input type="text" id="importGrade" list="gradeList" placeholder="选择或输入" />
                        <datalist id="gradeList"></datalist>
                      </label>
                      <label style="flex: 1; min-width: 120px;">班级
                        <input type="text" id="importClass" list="classList" placeholder="选择或输入" />
                        <datalist id="classList"></datalist>
                      </label>
                      <label style="flex: 1; min-width: 120px;">考试名称
                        <input type="text" id="importExam" placeholder="例：期中考试" required />
                      </label>
                      <label style="flex: 1; min-width: 120px;">Excel 文件
                        <input type="file" id="importFile" accept=".xlsx,.xls" required />
                      </label>
                    </div>
                    <div class="import-actions">
                      <button class="btn" type="submit">上传并导入</button>
                    </div>
                  </form>
                </div>
              </div>
            </section>

            <!-- 第二行左：导入年级排名 -->
            <section class="collapsible-section" style="margin: 0;">
              <div class="collapsible-header" data-target="rankImportSection">
                <h2>导入年级排名（可选）</h2>
                <span class="collapsible-toggle">▼</span>
              </div>
              <div class="collapsible-content" id="rankImportSection">
                <div class="collapsible-body">
                  <p class="hint-text">导入年级排名数据，或系统自动计算。</p>
                  <div class="import-actions">
                    <button class="btn secondary" id="downloadRankTemplate">下载排名模板</button>
                    <button class="btn" id="autoCalculateRanksBtn">自动计算排名</button>
                  </div>
                  <form class="inline-form" id="rankImportForm">
                    <label>
                      <span>选择排名文件 (Excel)</span>
                      <input type="file" id="rankImportFile" accept=".xlsx,.xls" required />
                    </label>
                    <div class="import-actions">
                      <button class="btn" type="submit">上传并导入排名</button>
                    </div>
                  </form>
                </div>
              </div>
            </section>

            <!-- 第二行右：数据备份与恢复 -->
            <section class="collapsible-section" style="margin: 0;">
              <div class="collapsible-header" data-target="backupSection">
                <h2>数据备份与恢复</h2>
                <span class="collapsible-toggle">▼</span>
              </div>
              <div class="collapsible-content" id="backupSection">
                <div class="collapsible-body">
                  <p class="hint-text">备份数据到文件，或从备份恢复。</p>
                  <div class="import-actions" style="gap: 12px;">
                    <button class="btn secondary" id="backupDataBtn">导出数据备份</button>
                  </div>
                  <form class="inline-form" id="restoreForm" style="margin-top: 16px;">
                    <label>
                      <span>选择备份文件恢复数据</span>
                      <input type="file" id="restoreFile" accept=".json" />
                    </label>
                    <div class="import-actions">
                      <button class="btn" type="submit">恢复数据</button>
                    </div>
                  </form>
                  <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <p class="hint-text" style="color: var(--danger); font-weight: 500;">危险操作</p>
                    <div class="import-actions" style="margin-top: 8px;">
                      <button class="btn" id="clearDataBtn" style="background: var(--danger); border-color: var(--danger);">清空所有数据</button>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </main>
    </div>

    <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
      <div class="modal modal-wide">
        <h2 id="modalTitle">添加学生</h2>
        <form id="studentForm">
          <div class="field-group">
            <label>
              <span>姓名 *</span>
              <input type="text" name="name" required />
            </label>
            <label>
              <span>学号 *</span>
              <input type="text" name="student_no" required />
            </label>
            <label>
              <span>性别</span>
              <select name="gender">
                <option value="">请选择</option>
                <option value="男">男</option>
                <option value="女">女</option>
              </select>
            </label>
          </div>
          <div class="field-group">
            <label>
              <span>班级</span>
              <input type="text" name="class_name" placeholder="例：高一(3)班" />
            </label>
            <label>
              <span>年级</span>
              <input type="text" name="grade_name" placeholder="例：高一" />
            </label>
            <label>
              <span>考试名称</span>
              <input type="text" name="exam_name" placeholder="例：期中考试" />
            </label>
          </div>
          <div class="field-group">
            <label>
              <span>班级排名</span>
              <input type="number" name="class_rank" min="1" placeholder="例：5" />
            </label>
            <label>
              <span>年级排名</span>
              <input type="number" name="grade_rank" min="1" placeholder="例：20" />
            </label>
          </div>
          <label>
            <span>备注</span>
            <textarea name="notes" rows="2" placeholder="可写辅导建议、异常情况等"></textarea>
          </label>
          <div>
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <span style="font-weight:600;">各科成绩</span>
              <button class="btn secondary compact-btn" type="button" id="addScoreRow">+ 添加科目</button>
            </div>
            <div class="scores-list" id="scoreList"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn secondary" id="cancelModal">取消</button>
            <button type="submit" class="btn">保存</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal-backdrop" id="columnSettingsModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>列设置</h2>
        <p class="hint-text">选择要在表格中显示的列</p>
        <div id="columnCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin: 16px 0; max-height: 60vh; overflow-y: auto;"></div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelColumnSettings">取消</button>
          <button type="button" class="btn" id="saveColumnSettings">保存</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="studentDetailModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 900px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 id="detailStudentName" style="margin: 0;">学生成绩报告</h2>
          <div style="display: flex; gap: 8px; font-size: 13px; color: #6b7280;">
            <span id="detailStudentNo"></span>
            <span id="detailClassName"></span>
            <span id="detailExamInfo"></span>
          </div>
        </div>

        <!-- 选项卡导航 -->
        <div class="tabs" style="margin-bottom: 20px;">
          <button class="tab-button active" data-detail-tab="overview">成绩概览</button>
          <button class="tab-button" data-detail-tab="analysis">学科分析</button>
          <button class="tab-button" data-detail-tab="trend">趋势分析</button>
          <button class="tab-button" data-detail-tab="points">积分表现</button>
          <button class="tab-button" data-detail-tab="info">学生信息</button>
        </div>

        <!-- 成绩概览标签页 -->
        <div class="tab-content active" id="overviewTab" style="max-height: 60vh; overflow-y: auto;">
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">总分</div>
              <div style="font-size: 32px; font-weight: 700; color: #111827;" id="overviewTotalScore">0</div>
            </div>
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">班级排名</div>
              <div style="font-size: 32px; font-weight: 700; color: #111827;" id="overviewClassRank">-</div>
            </div>
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; text-align: center;">
              <div style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">平均分</div>
              <div style="font-size: 32px; font-weight: 700; color: #111827;" id="overviewAvgScore">0</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
            <div style="background: #ecfdf5; padding: 16px; border-radius: 10px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #059669;" id="overviewLevel">良好</div>
              <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">等级评定</div>
            </div>
            <div style="background: #fef3c7; padding: 16px; border-radius: 10px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #d97706;" id="overviewBestSubject">化学</div>
              <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">最强科目</div>
            </div>
            <div style="background: #fee2e2; padding: 16px; border-radius: 10px; text-align: center;">
              <div style="font-size: 24px; font-weight: 700; color: #dc2626;" id="overviewWeakSubject">物理</div>
              <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">待提高科目</div>
            </div>
          </div>

          <h3 style="margin: 24px 0 16px; font-size: 16px;">各科成绩对比</h3>
          <div style="height: 300px; position: relative; margin-bottom: 20px;">
            <canvas id="overviewRadarChart"></canvas>
          </div>

          <!-- 单科统计 -->
          <h3 style="margin: 24px 0 16px; font-size: 16px;">📊 各科成绩详情</h3>
          <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
            <!-- 表头 -->
            <div style="display: grid; grid-template-columns: 80px 80px 100px 120px 80px; gap: 16px; padding: 12px 20px; background: #f9fafb; border-bottom: 2px solid #e5e7eb; font-weight: 600; font-size: 13px; color: #6b7280;">
              <div>科目</div>
              <div style="text-align: center;">分数</div>
              <div style="text-align: center;">班级排名</div>
              <div style="text-align: center;">与班级均分差值</div>
              <div style="text-align: center;">等级</div>
            </div>
            <!-- 数据行 -->
            <div id="overviewSubjectStatsContainer">
              <div style="padding: 20px; text-align: center; color: #6b7280;">加载中...</div>
            </div>
          </div>
        </div>

        <!-- 趋势分析标签页 -->
        <div class="tab-content" id="trendTab" style="max-height: 60vh; overflow-y: auto;">
          <div style="height: 300px; position: relative; margin-bottom: 20px;">
            <canvas id="trendScoreChart"></canvas>
          </div>
          <div style="height: 300px; position: relative;">
            <canvas id="trendSubjectChart"></canvas>
          </div>
        </div>

        <!-- 积分表现标签页 -->
        <div class="tab-content" id="pointsTab" style="max-height: 60vh; overflow-y: auto;">
          <div id="pointsHeader" style="text-align: center; margin-bottom: 20px;">
            <!-- 标题和学生信息 -->
          </div>
          <div id="pointsRecordsList">
            <!-- 积分记录列表 -->
          </div>
        </div>

        <!-- 详细分析标签页 -->
        <div class="tab-content" id="analysisTab" style="max-height: 60vh; overflow-y: auto;">
          <h3 style="margin: 0 0 16px; font-size: 16px;">详细分析报告</h3>
          <div id="subjectAnalysisList" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
            <!-- 动态生成各科目详细分析 -->
          </div>

          <h3 style="margin: 24px 0 16px; font-size: 16px;">知识点与弱项分析</h3>
          <div id="weaknessAnalysis" style="background: #f9fafb; padding: 20px; border-radius: 12px;">
            <!-- 动态生成弱项分析 -->
          </div>
        </div>

        <!-- 学生信息标签页 -->
        <div class="tab-content" id="infoTab" style="max-height: 60vh; overflow-y: auto;">
          <form id="studentDetailForm">
            <div class="info-grid" id="studentInfoGrid"></div>
          </form>
        </div>

        <div class="modal-footer" style="margin-top: 20px;">
          <button type="button" class="btn secondary" id="closeDetailModal">关闭</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="classEditModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>编辑班级</h2>
        <form id="classEditForm">
          <div class="field-group">
            <label>
              <span>班级名称 *</span>
              <input type="text" name="class_name" id="editClassName" required />
            </label>
            <label>
              <span>年级</span>
              <input type="text" name="grade_name" id="editGradeName" placeholder="例：高一" />
            </label>
          </div>
          <p class="hint-text">修改班级名称或年级将更新该班级所有学生的记录。</p>
          <div class="modal-footer">
            <button type="button" class="btn secondary" id="cancelClassEdit">取消</button>
            <button type="submit" class="btn">保存</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal-backdrop" id="radarSettingsModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>科目雷达图设置</h2>
        <p class="hint-text">选择要在雷达图中显示的科目（至少选择3个科目）</p>
        <div style="margin-top: 24px;">
          <div id="radarSubjectCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;"></div>
        </div>
        <div class="modal-footer" style="margin-top: 24px;">
          <button type="button" class="btn secondary" id="cancelRadarSettings">取消</button>
          <button type="button" class="btn" id="saveRadarSettings">保存</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="progressSettingsModal" role="dialog" aria-modal="true">
      <div class="modal">
        <h2>📊 进步退步分析设置</h2>
        <p class="hint-text">选择对比方式和显示人数，系统将自动计算学生的进步或退步情况</p>

        <div style="margin-top: 24px;">
          <label style="display: block; margin-bottom: 12px; font-weight: 600;">对比方式</label>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="compareMode" value="2" style="width: 18px; height: 18px; cursor: pointer;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">最近2场对比</div>
                <div style="font-size: 13px; color: #718096; margin-top: 4px;">对比最新1场 vs 前1场（灵敏，适合短期激励）</div>
              </div>
            </label>
            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid #3b82f6; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: rgba(59, 130, 246, 0.05);">
              <input type="radio" name="compareMode" value="3" checked style="width: 18px; height: 18px; cursor: pointer;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">最近3场综合对比 ⭐ 推荐</div>
                <div style="font-size: 13px; color: #718096; margin-top: 4px;">对比最新1场 vs 前2场平均（稳定，过滤偶然波动）</div>
              </div>
            </label>
            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="compareMode" value="5" style="width: 18px; height: 18px; cursor: pointer;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">最近5场趋势对比</div>
                <div style="font-size: 13px; color: #718096; margin-top: 4px;">对比最近2场平均 vs 前3场平均（长期趋势）</div>
              </div>
            </label>
            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="compareMode" value="custom" style="width: 18px; height: 18px; cursor: pointer;">
              <div style="flex: 1;">
                <div style="font-weight: 600;">自定义场次</div>
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                  <span style="font-size: 13px; color: #718096;">对比最近</span>
                  <input type="number" id="customExamCount" min="2" max="50" value="10"
                    style="width: 70px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; text-align: center;"
                    onclick="event.stopPropagation(); document.querySelector('input[value=custom]').checked = true; document.querySelector('input[value=custom]').dispatchEvent(new Event('change'));">
                  <span style="font-size: 13px; color: #718096;">场考试（灵活设置）</span>
                </div>
                <div style="font-size: 12px; color: #f59e0b; margin-top: 6px;">💡 计算方式：最新1场 vs 前N-1场平均</div>
              </div>
            </label>
          </div>
        </div>

        <div style="margin-top: 24px;">
          <label style="display: block; margin-bottom: 12px; font-weight: 600;">显示人数</label>
          <select id="progressTopCount" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px;">
            <option value="5">前5名</option>
            <option value="10" selected>前10名</option>
            <option value="15">前15名</option>
            <option value="20">前20名</option>
          </select>
        </div>

        <div class="modal-footer" style="margin-top: 24px;">
          <button type="button" class="btn secondary" id="cancelProgressSettings">取消</button>
          <button type="button" class="btn" id="saveProgressSettings">保存</button>
        </div>
      </div>
    </div>

    <!-- 学生选择弹窗 -->
    <div class="modal-backdrop" id="studentSelectModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 600px;">
        <h2>选择学生（最多5人）</h2>
        <p class="hint-text">选择要对比的学生，不同学生将用不同颜色的曲线显示</p>
        <div style="margin: 20px 0;">
          <input type="search" id="studentSearchInput" placeholder="搜索学生姓名或学号..." style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 16px;" />
          <div id="studentCheckboxList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
            <!-- 动态填充学生复选框 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelStudentSelect">取消</button>
          <button type="button" class="btn" id="confirmStudentSelect">确定</button>
        </div>
      </div>
    </div>

    <!-- 科目选择弹窗 -->
    <div class="modal-backdrop" id="subjectSelectModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 500px;">
        <h2>选择显示科目</h2>
        <p class="hint-text">选择要在走势图中显示的科目</p>
        <div id="subjectCheckboxList" style="margin: 20px 0; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
          <!-- 动态填充科目复选框 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelSubjectSelect">取消</button>
          <button type="button" class="btn" id="confirmSubjectSelect">确定</button>
        </div>
      </div>
    </div>

    <!-- 班级筛选弹窗 -->
    <div class="modal-backdrop" id="classFilterModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 600px;">
        <h2>📚 筛选班级</h2>
        <p class="hint-text">可以选择一个或多个班级进行数据统计</p>
        <div style="margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: 600; font-size: 14px;">已选择 <span id="selectedClassCount">0</span> 个班级</span>
            <div style="display: flex; gap: 8px;">
              <button type="button" class="btn secondary" id="selectAllClasses" style="padding: 6px 12px; font-size: 13px;">全选</button>
              <button type="button" class="btn secondary" id="clearAllClasses" style="padding: 6px 12px; font-size: 13px;">清空</button>
            </div>
          </div>
          <div id="classCheckboxList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <!-- 动态填充班级复选框 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelClassFilter">取消</button>
          <button type="button" class="btn" id="confirmClassFilter">应用筛选</button>
        </div>
      </div>
    </div>

    <!-- 考试筛选弹窗 -->
    <div class="modal-backdrop" id="examFilterModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 600px;">
        <h2>📝 筛选考试</h2>
        <p class="hint-text">可以选择一个或多个考试进行数据统计</p>
        <div style="margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: 600; font-size: 14px;">已选择 <span id="selectedExamCount">0</span> 个考试</span>
            <div style="display: flex; gap: 8px;">
              <button type="button" class="btn secondary" id="selectAllExams" style="padding: 6px 12px; font-size: 13px;">全选</button>
              <button type="button" class="btn secondary" id="clearAllExams" style="padding: 6px 12px; font-size: 13px;">清空</button>
            </div>
          </div>
          <div id="examCheckboxList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <!-- 动态填充考试复选框 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelExamFilter">取消</button>
          <button type="button" class="btn" id="confirmExamFilter">应用筛选</button>
        </div>
      </div>
    </div>

    <!-- 班级选择模态框 -->
    <div class="modal-backdrop" id="classSelectionModal" role="dialog" aria-modal="true">
      <div class="modal" style="max-width: 700px;">
        <h2>📋 选择对比班级</h2>
        <p class="hint-text">请选择至少2个班级进行对比分析（最多选择6个）</p>

        <!-- 考试筛选 -->
        <div style="margin: 16px 0;">
          <label style="font-weight: 600; font-size: 14px; color: #111827; margin-bottom: 8px; display: block;">筛选考试</label>
          <select id="classComparisonExamFilter" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
            <option value="">全部考试</option>
          </select>
        </div>

        <div style="margin: 20px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: 600; font-size: 14px;">已选择 <span id="selectedClassCount">0</span> 个班级</span>
            <div style="display: flex; gap: 8px;">
              <button type="button" class="btn secondary" id="selectAllClasses" style="padding: 6px 12px; font-size: 13px;">全选</button>
              <button type="button" class="btn secondary" id="clearAllClasses" style="padding: 6px 12px; font-size: 13px;">清空</button>
            </div>
          </div>
          <div id="classCheckboxList" style="max-height: 350px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            <!-- 动态填充班级复选框 -->
            <p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 20px;">加载班级列表中...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn secondary" id="cancelClassSelection">取消</button>
          <button type="button" class="btn" id="confirmClassSelection">开始对比</button>
        </div>
      </div>
    </div>

    <div class="notification" id="notify"></div>

    <script>
      // 初始化认证守卫
      authGuard.init({
        required: true,
        onAuth: (user) => {
          // 如果是管理员（VIP3），显示系统管理菜单
          if (user.vip_level >= 3) {
            document.getElementById('systemMenuBtn').style.display = 'block';
          }
        }
      });

      const API_BASE = "/api/students";
      const studentBody = document.getElementById("studentBody");
      const subjectTabsEl = document.getElementById("subjectTabs");
      const modalBackdrop = document.getElementById("modalBackdrop");
      const studentForm = document.getElementById("studentForm");
      const modalTitle = document.getElementById("modalTitle");
      const addStudentBtn = document.getElementById("addStudentBtn");
      const addStudentBtn2 = document.getElementById("addStudentBtn2");
      const cancelModal = document.getElementById("cancelModal");
      const addScoreRowBtn = document.getElementById("addScoreRow");
      const scoreList = document.getElementById("scoreList");
      const notify = document.getElementById("notify");
      const classFilter = document.getElementById("classFilter");
      const examFilter = document.getElementById("examFilter");
      const searchInput = document.getElementById("searchInput");
      const refreshBtn = document.getElementById("refreshBtn");
      const downloadTemplateBtn = document.getElementById("downloadTemplate");
      const importForm = document.getElementById("importForm");
      const importFileInput = document.getElementById("importFile");
      const importClassInput = document.getElementById("importClass");
      const importGradeInput = document.getElementById("importGrade");
      const importExamInput = document.getElementById("importExam");
      const rangeSubjectSelect = document.getElementById("rangeSubjectSelect");
      const rangeForm = document.getElementById("rangeForm");
      const rangeRows = document.getElementById("rangeRows");
      const autoCalculateRanksBtn = document.getElementById("autoCalculateRanksBtn");
      const backupDataBtn = document.getElementById("backupDataBtn");
      const restoreForm = document.getElementById("restoreForm");
      const restoreFile = document.getElementById("restoreFile");
      const clearDataBtn = document.getElementById("clearDataBtn");
      const columnSettingsBtn = document.getElementById("columnSettingsBtn");
      const columnSettingsModal = document.getElementById("columnSettingsModal");
      const columnCheckboxes = document.getElementById("columnCheckboxes");
      const cancelColumnSettings = document.getElementById("cancelColumnSettings");
      const saveColumnSettings = document.getElementById("saveColumnSettings");
      const studentDetailModal = document.getElementById("studentDetailModal");
      const detailStudentName = document.getElementById("detailStudentName");
      const studentInfoGrid = document.getElementById("studentInfoGrid");
      const closeDetailModal = document.getElementById("closeDetailModal");
      const studentDetailForm = document.getElementById("studentDetailForm");
      const classStatsBody = document.getElementById("classStatsBody");
      const classEditModal = document.getElementById("classEditModal");
      const classEditForm = document.getElementById("classEditForm");
      const editClassName = document.getElementById("editClassName");
      const editGradeName = document.getElementById("editGradeName");
      const cancelClassEdit = document.getElementById("cancelClassEdit");

      // 筛选器相关元素
      const filterClassBtn = document.getElementById("filterClassBtn");
      const filterExamBtn = document.getElementById("filterExamBtn");
      const filterClassText = document.getElementById("filterClassText");
      const filterExamText = document.getElementById("filterExamText");
      const classCount = document.getElementById("classCount");
      const examCount = document.getElementById("examCount");
      const classFilterModal = document.getElementById("classFilterModal");
      const examFilterModal = document.getElementById("examFilterModal");
      const classCheckboxList = document.getElementById("classCheckboxList");
      const examCheckboxList = document.getElementById("examCheckboxList");
      const selectedClassCount = document.getElementById("selectedClassCount");
      const selectedExamCount = document.getElementById("selectedExamCount");
      const selectAllClasses = document.getElementById("selectAllClasses");
      const clearAllClasses = document.getElementById("clearAllClasses");
      const selectAllExams = document.getElementById("selectAllExams");
      const clearAllExams = document.getElementById("clearAllExams");
      const cancelClassFilter = document.getElementById("cancelClassFilter");
      const confirmClassFilter = document.getElementById("confirmClassFilter");
      const cancelExamFilter = document.getElementById("cancelExamFilter");
      const confirmExamFilter = document.getElementById("confirmExamFilter");

      // 筛选器状态
      let selectedClasses = [];
      let selectedExams = [];
      let allClassList = [];
      let allExamList = [];
      const selectStudentsBtn = document.getElementById("selectStudentsBtn");
      const selectSubjectsBtn = document.getElementById("selectSubjectsBtn");
      const studentSelectModal = document.getElementById("studentSelectModal");
      const subjectSelectModal = document.getElementById("subjectSelectModal");
      const studentCheckboxList = document.getElementById("studentCheckboxList");
      const subjectCheckboxList = document.getElementById("subjectCheckboxList");
      const studentSearchInput = document.getElementById("studentSearchInput");
      const cancelStudentSelect = document.getElementById("cancelStudentSelect");
      const confirmStudentSelect = document.getElementById("confirmStudentSelect");
      const cancelSubjectSelect = document.getElementById("cancelSubjectSelect");
      const confirmSubjectSelect = document.getElementById("confirmSubjectSelect");
      const selectedStudentsList = document.getElementById("selectedStudentsList");
      const selectedStudentCount = document.getElementById("selectedStudentCount");
      const selectedSubjectCount = document.getElementById("selectedSubjectCount");
      const studentTrendChartContainer = document.getElementById("studentTrendChartContainer");
      const studentTrendPlaceholder = document.getElementById("studentTrendPlaceholder");
      const studentTrendStats = document.getElementById("studentTrendStats");

      let students = [];
      let editingClassName = null;
      let summary = null;
      let editingId = null;
      let currentDetailStudent = null;
      let isEditingDetail = false;
      let classStats = [];
      let trendExamCount = 3; // 按场次：默认显示近3场
      let trendDateRange = null; // 按时间：{startDate, endDate} 或 null
      let selectedStudentNos = []; // 学生走势对比：选中的学生学号列表（最多5个）
      let selectedTrendSubjects = ["总分"]; // 学生走势对比：选中的科目列表
      let studentTrendChart = null; // 学生走势对比图表实例
      let allAvailableTrendSubjects = ["总分", "语文", "数学", "英语", "物理", "化学", "生物", "历史", "政治", "地理"]; // 所有可用科目

      // 5个学生对应的颜色
      const studentColors = [
        { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },   // 紫色
        { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },   // 蓝色
        { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },   // 绿色
        { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },   // 橙色
        { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' }    // 粉色
      ];

      const scoreSubjects = ["语文", "数学", "英语", "物理", "化学", "生物", "历史", "政治", "地理"];
      const allColumns = [
        { key: "name", label: "姓名", fixed: true },
        { key: "student_no", label: "学号", fixed: true },
        { key: "class_rank", label: "班级排名", fixed: false },
        { key: "grade_rank", label: "年级排名", fixed: false },
        { key: "total_score", label: "总分", fixed: false },
        { key: "rating", label: "评分", fixed: false },
        ...scoreSubjects.map(s => ({ key: s, label: s, fixed: false })),
        { key: "actions", label: "操作", fixed: true }
      ];
      let visibleColumns = allColumns.map(c => c.key);
      const subjectTabsList = ["总分", ...scoreSubjects];
      const rangeSubjects = ["总分", ...scoreSubjects];
      const subjectsPreset = [...scoreSubjects];
      const DEFAULT_RANGE_TEMPLATE = [
        { key: "fail", name: "不及格", min: 0, max: 60 },
        { key: "pass", name: "及格", min: 60, max: 80 },
        { key: "good", name: "良好", min: 80, max: 90 },
        { key: "excellent", name: "优秀", min: 90, max: 100 },
      ];
      let gradeRanges = {};
      let availableClasses = [];
      let availableExams = [];
      let selectedSubject = "总分";
      let currentRangeSubject = "总分";

      function createDefaultRanges() {
        return DEFAULT_RANGE_TEMPLATE.map((range) => ({ ...range }));
      }
      function getSubjectRanges(subject) {
        if (gradeRanges && gradeRanges[subject]) {
          return gradeRanges[subject];
        }
        return createDefaultRanges();
      }
      async function loadGradeConfig() {
        try {
          const res = await fetch(`${API_BASE}/ranges`);
          if (!res.ok) throw new Error("无法获取区间配置");
          gradeRanges = await res.json();
        } catch (error) {
          gradeRanges = {};
          showToast(error.message, true);
        }
        renderRangeSubjectOptions();
        renderRangeRows();
      }
      function renderRangeSubjectOptions() {
        if (!rangeSubjectSelect) return;
        rangeSubjectSelect.innerHTML = rangeSubjects
          .map((subject) => `<option value="${subject}">${subject}</option>`)
          .join("");
        rangeSubjectSelect.value = currentRangeSubject;
      }
      function renderRangeRows() {
        if (!rangeRows) return;
        const ranges = getSubjectRanges(currentRangeSubject);
        rangeRows.innerHTML = ranges
          .map(
            (range) => `
            <div class="range-row" data-key="${range.key}">
              <div class="range-label">${range.name}</div>
              <input type="number" data-field="min" step="0.1" value="${range.min}" placeholder="最低分" required />
              <span>至</span>
              <input type="number" data-field="max" step="0.1" value="${range.max ?? ""}" placeholder="最高分（可空）" />
            </div>
          `,
          )
          .join("");
      }

      renderSubjectTabs();

      document.querySelectorAll("nav button").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll("nav button").forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const target = btn.dataset.target;
          document.querySelectorAll("main[data-section]").forEach((section) => {
            section.classList.toggle("active", section.dataset.section === target);
          });
        });
      });

      function showToast(message, isError = false) {
        notify.textContent = message;
        notify.style.background = isError ? "#b91c1c" : "#111827";
        notify.classList.add("show");
        setTimeout(() => notify.classList.remove("show"), 2600);
      }

      function openModal(student) {
        editingId = student ? student.id : null;
        modalTitle.textContent = student ? "编辑学生" : "添加学生";
        studentForm.reset();
        scoreList.innerHTML = "";
        const scores = student?.scores?.length ? student.scores : subjectsPreset.map((s) => ({ subject: s, score: "" }));
        scores.forEach((row) => addScoreRow(row.subject, row.score));
        ["name", "student_no", "class_name", "grade_name", "exam_name", "notes", "class_rank", "grade_rank"].forEach((field) => {
          studentForm.elements[field].value = student?.[field] ?? "";
        });
        modalBackdrop.classList.add("active");
      }
      function closeModal() {
        modalBackdrop.classList.remove("active");
      }

      function addScoreRow(subject = "", score = "") {
        const wrapper = document.createElement("div");
        wrapper.className = "score-row";
        wrapper.innerHTML = `
          <input type="text" placeholder="科目" value="${subject}" />
          <input type="number" placeholder="分数" value="${score}" min="0" max="150" step="0.5" />
          <button type="button" title="删除这行">×</button>
        `;
        wrapper.querySelector("button").addEventListener("click", () => wrapper.remove());
        scoreList.appendChild(wrapper);
      }

      function getScoresFromForm() {
        const rows = [...scoreList.querySelectorAll(".score-row")];
        const scores = [];
        rows.forEach((row) => {
          const [subjectInput, scoreInput] = row.querySelectorAll("input");
          const subject = subjectInput.value.trim();
          const scoreValue = scoreInput.value.trim();
          if (!subject && !scoreValue) return;
          const score = Number(scoreValue);
          if (!subject || Number.isNaN(score)) return;
          scores.push({ subject, score });
        });
        return scores;
      }

      async function saveStudent(event) {
        event.preventDefault();
        const form = new FormData(studentForm);
        const payload = Object.fromEntries(form.entries());
        payload.scores = getScoresFromForm();
        if (payload.scores.length === 0) {
          showToast("请至少录入一个科目成绩", true);
          return;
        }

        // 转换数字字段，空值转为 null
        if (payload.class_rank) {
          payload.class_rank = parseInt(payload.class_rank);
        } else {
          delete payload.class_rank;
        }

        if (payload.grade_rank) {
          payload.grade_rank = parseInt(payload.grade_rank);
        } else {
          delete payload.grade_rank;
        }

        // 清理空字符串字段
        Object.keys(payload).forEach(key => {
          if (payload[key] === '') {
            delete payload[key];
          }
        });

        const method = editingId ? "PUT" : "POST";
        const url = editingId ? `${API_BASE}/${editingId}` : API_BASE;
        try {
          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "保存失败");
          }
          showToast("保存成功");
          closeModal();
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function deleteStudent(id) {
        if (!confirm("确认删除该学生记录？")) return;
        try {
          const res = await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
          if (!res.ok) throw new Error("删除失败");
          showToast("已删除");
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }


      function renderSubjectTabs() {
        if (!subjectTabsEl) return;
        subjectTabsEl.innerHTML = subjectTabsList
          .map(
            (subject) => `
            <button class="subject-tab ${selectedSubject === subject ? "active" : ""}" data-subject="${subject}">
              ${subject}
            </button>
          `,
          )
          .join("");
      }

      function renderFilters() {
        const classes = new Set();
        const grades = new Set();
        const exams = new Set();
        students.forEach((student) => {
          if (student.class_name) classes.add(student.class_name);
          if (student.grade_name) grades.add(student.grade_name);
          if (student.exam_name) exams.add(student.exam_name);
        });
        availableClasses = [...classes];
        availableExams = [...exams];
        const availableGrades = [...grades];

        populateSelect(classFilter, availableClasses, "全部班级", true);
        populateSelect(examFilter, availableExams, "全部考试", true);
        populateDatalist('gradeList', availableGrades);
        populateDatalist('classList', availableClasses);
        renderSubjectTabs();
      }

      function populateSelect(selectEl, values, placeholder, includeEmpty) {
        if (!selectEl) return;
        const options = includeEmpty ? `<option value="">${placeholder}</option>` : "";
        selectEl.innerHTML = options + values.map((value) => `<option value="${value}">${value}</option>`).join("");
      }

      function populateDatalist(datalistId, values) {
        const datalist = document.getElementById(datalistId);
        if (!datalist) return;
        datalist.innerHTML = values.map((value) => `<option value="${value}">`).join("");
      }

      function loadColumnSettings() {
        const saved = localStorage.getItem("visibleColumns");
        if (saved) {
          try {
            visibleColumns = JSON.parse(saved);
          } catch (e) {
            visibleColumns = allColumns.map(c => c.key);
          }
        }
      }

      function saveColumnSettingsToStorage() {
        localStorage.setItem("visibleColumns", JSON.stringify(visibleColumns));
      }

      function openColumnSettings() {
        columnCheckboxes.innerHTML = allColumns.map(col => `
          <label style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 8px; background: #f8fafc; cursor: ${col.fixed ? 'not-allowed' : 'pointer'}; white-space: nowrap;">
            <input type="checkbox" value="${col.key}" ${visibleColumns.includes(col.key) ? 'checked' : ''} ${col.fixed ? 'disabled' : ''} style="cursor: ${col.fixed ? 'not-allowed' : 'pointer'};">
            <span style="color: ${col.fixed ? '#9ca3af' : 'inherit'}; font-size: 14px;">${col.label}${col.fixed ? ' (必需)' : ''}</span>
          </label>
        `).join('');
        columnSettingsModal.classList.add("active");
      }

      function closeColumnSettings() {
        columnSettingsModal.classList.remove("active");
      }

      function applyColumnSettings() {
        const checkboxes = columnCheckboxes.querySelectorAll('input[type="checkbox"]');
        visibleColumns = Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);
        saveColumnSettingsToStorage();
        updateTableColumns();
        closeColumnSettings();
        renderTable();
      }

      function updateTableColumns() {
        const headers = document.querySelectorAll('#tableHeader th');
        headers.forEach(th => {
          const column = th.getAttribute('data-column');
          th.style.display = visibleColumns.includes(column) ? '' : 'none';
        });
      }

      // 详情弹窗的图表对象
      let detailRadarChart = null;
      let detailTrendScoreChart = null;
      let detailTrendSubjectChart = null;

      async function openStudentDetail(studentId) {
        const student = students.find(s => s.id === studentId);
        if (!student) return;

        currentDetailStudent = student;
        isEditingDetail = false;

        // 更新标题信息
        detailStudentName.textContent = student.name;
        document.getElementById('detailStudentNo').textContent = `学号: ${student.student_no}`;
        document.getElementById('detailClassName').textContent = student.class_name ? `班级: ${student.class_name}` : '';
        document.getElementById('detailExamInfo').textContent = student.exam_name ? `考试: ${student.exam_name}` : '';

        // 重置到成绩概览标签页
        document.querySelectorAll('[data-detail-tab]').forEach(btn => btn.classList.remove('active'));
        document.querySelector('[data-detail-tab="overview"]').classList.add('active');
        document.querySelectorAll('#studentDetailModal .tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById('overviewTab').classList.add('active');

        // 渲染成绩概览
        renderOverviewTab(student);

        // 渲染学生信息（第四个标签页）
        renderStudentInfo(student, false);

        studentDetailModal.classList.add("active");
      }

      // 渲染成绩概览标签页
      function renderOverviewTab(student) {
        const totalScore = student.total_score || 0;
        const avgScore = student.average_score || 0;

        // 计算班级排名：同班级、同考试的学生按总分排序
        let classRank = '-';
        if (student.class_name && student.exam_name && totalScore > 0) {
          const classmates = students.filter(s =>
            s.class_name === student.class_name &&
            s.exam_name === student.exam_name &&
            s.total_score > 0
          ).sort((a, b) => (b.total_score || 0) - (a.total_score || 0));

          const rankIndex = classmates.findIndex(s => s.id === student.id);
          if (rankIndex !== -1) {
            classRank = rankIndex + 1;
          }
        }

        document.getElementById('overviewTotalScore').textContent = totalScore.toFixed(1);
        document.getElementById('overviewAvgScore').textContent = avgScore.toFixed(1);
        document.getElementById('overviewClassRank').textContent = classRank;

        // 计算等级
        let level = '待提高';
        let levelColor = '#dc2626';
        let levelBg = '#fee2e2';
        if (avgScore >= 90) {
          level = '优秀';
          levelColor = '#059669';
          levelBg = '#ecfdf5';
        } else if (avgScore >= 80) {
          level = '良好';
          levelColor = '#d97706';
          levelBg = '#fef3c7';
        } else if (avgScore >= 60) {
          level = '及格';
          levelColor = '#2563eb';
          levelBg = '#dbeafe';
        }

        const levelEl = document.getElementById('overviewLevel');
        levelEl.textContent = level;
        levelEl.style.color = levelColor;
        levelEl.parentElement.style.background = levelBg;

        // 找出最强和最弱科目
        const scores = student.scores || [];
        if (scores.length > 0) {
          const sortedScores = [...scores].sort((a, b) => b.score - a.score);
          document.getElementById('overviewBestSubject').textContent = sortedScores[0].subject;
          document.getElementById('overviewWeakSubject').textContent = sortedScores[sortedScores.length - 1].subject;
        }

        // 渲染雷达图
        renderDetailRadarChart(student);

        // 加载单科统计数据
        loadDetailSubjectStats(student);
      }

      // 渲染雷达图
      async function renderDetailRadarChart(student) {
        const ctx = document.getElementById('overviewRadarChart');
        if (!ctx) return;

        const scores = student.scores || [];
        const subjects = scores.map(s => s.subject);
        const values = scores.map(s => s.score);

        // 获取班级平均分（从API获取真实数据）
        let classAvg = values.map(v => v * 0.95); // 默认值
        try {
          const response = await fetch(`${API_BASE}/class-subject-stats?class_name=${encodeURIComponent(student.class_name)}&exam_name=${encodeURIComponent(student.exam_name)}`);
          if (response.ok) {
            const classStats = await response.json();
            const statsMap = {};
            classStats.subject_stats.forEach(stat => {
              statsMap[stat.subject] = stat.average;
            });
            classAvg = subjects.map(subject => statsMap[subject] || 0);
          }
        } catch (error) {
          console.error('获取班级统计数据失败:', error);
        }

        if (detailRadarChart) {
          detailRadarChart.destroy();
        }

        detailRadarChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: subjects,
            datasets: [
              {
                label: '本人成绩',
                data: values,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.2)',
                pointBackgroundColor: '#2563eb',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#2563eb'
              },
              {
                label: '班级平均',
                data: classAvg,
                borderColor: '#dc2626',
                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                pointBackgroundColor: '#dc2626',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#dc2626'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 20
                }
              }
            },
            plugins: {
              legend: {
                position: 'top'
              }
            }
          }
        });
      }

      // 加载单科统计数据（显示该学生的单科成绩及排名）
      async function loadDetailSubjectStats(student) {
        const container = document.getElementById('overviewSubjectStatsContainer');

        if (!student || !student.scores || student.scores.length === 0) {
          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">暂无成绩信息</div>';
          return;
        }

        // 显示加载中
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">加载中...</div>';

        try {
          // 获取该考试该班级的所有学生成绩用于排名计算
          const params = new URLSearchParams();
          params.append('exam_name', student.exam_name);
          if (student.class_name) {
            params.append('class_name', student.class_name);
          }

          console.log('正在加载单科统计:', student.exam_name, student.class_name);

          const res = await fetch(`${API_BASE}/?${params.toString()}`);
          if (!res.ok) {
            throw new Error('获取统计数据失败');
          }

          const allStudents = await res.json();
          console.log('获取到学生数据:', allStudents.length, '人');

          // 按科目计算排名和平均分
          const subjectData = {};

          allStudents.forEach(s => {
            if (!s.scores || !Array.isArray(s.scores)) return;

            s.scores.forEach(score => {
              const subject = score.subject;
              const scoreValue = parseFloat(score.score);

              if (isNaN(scoreValue)) return;

              if (!subjectData[subject]) {
                subjectData[subject] = [];
              }

              subjectData[subject].push({
                studentNo: s.student_no,
                score: scoreValue
              });
            });
          });

          // 计算每个科目的排名和平均分
          const subjectStats = {};
          Object.keys(subjectData).forEach(subject => {
            const scores = subjectData[subject];
            // 按分数降序排序
            scores.sort((a, b) => b.score - a.score);

            // 计算平均分
            const average = scores.reduce((sum, item) => sum + item.score, 0) / scores.length;

            // 找到该学生在这个科目的排名
            const rankIndex = scores.findIndex(item => item.studentNo === student.student_no);

            subjectStats[subject] = {
              average: average,
              rank: rankIndex + 1,
              totalCount: scores.length
            };
          });

          console.log('单科统计结果:', subjectStats);

          // 生成卡片列表
          const cardsHtml = student.scores.map(score => {
            const subject = score.subject;
            const scoreValue = parseFloat(score.score);
            const stat = subjectStats[subject];

            if (!stat) return '';

            // 计算与班级均分的差值
            const diff = scoreValue - stat.average;
            const diffText = diff >= 0 ? `+${diff.toFixed(1)}` : diff.toFixed(1);
            const diffClass = diff >= 0 ? 'positive' : 'negative';

            // 判断排名样式
            let rankClass = 'rank-other';
            let rankText = `第${stat.rank}名`;
            if (stat.rank === 1) {
              rankClass = 'rank-1';
              rankText = '第1名';
            } else if (stat.rank === 2) {
              rankClass = 'rank-2';
              rankText = '第2名';
            }

            // 判断等级
            let gradeClass = '';
            let gradeText = '';
            if (scoreValue >= 90) {
              gradeClass = 'excellent';
              gradeText = '优秀';
            } else if (scoreValue >= 75) {
              gradeClass = 'good';
              gradeText = '良好';
            } else if (scoreValue >= 60) {
              gradeClass = 'pass';
              gradeText = '及格';
            } else {
              gradeClass = 'pass';
              gradeText = '待提高';
            }

            // 排名徽章样式
            let rankBadgeStyle = 'background: #f3f4f6; color: #6b7280;';
            if (stat.rank === 1) {
              rankBadgeStyle = 'background: #fef3c7; color: #92400e;';
            } else if (stat.rank === 2) {
              rankBadgeStyle = 'background: #e5e7eb; color: #374151;';
            }

            // 差值颜色
            const diffColor = diff >= 0 ? '#10b981' : '#ef4444';

            // 等级徽章样式
            let gradeBadgeStyle = '';
            if (scoreValue >= 90) {
              gradeBadgeStyle = 'background: #3b82f6; color: white;';
            } else if (scoreValue >= 75) {
              gradeBadgeStyle = 'background: #10b981; color: white;';
            } else if (scoreValue >= 60) {
              gradeBadgeStyle = 'background: #f59e0b; color: white;';
            } else {
              gradeBadgeStyle = 'background: #ef4444; color: white;';
            }

            return `
              <div style="display: grid; grid-template-columns: 80px 80px 100px 120px 80px; gap: 16px; padding: 14px 20px; border-bottom: 1px solid #f3f4f6; align-items: center; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                <div style="font-weight: 500; color: #111827; font-size: 14px;">${subject}</div>
                <div style="text-align: center; font-size: 18px; font-weight: 700; color: #2563eb;">${scoreValue}</div>
                <div style="text-align: center;">
                  <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600; ${rankBadgeStyle}">${rankText}</span>
                </div>
                <div style="text-align: center; font-size: 16px; font-weight: 700; color: ${diffColor};">${diffText}</div>
                <div style="text-align: center;">
                  <span style="display: inline-block; padding: 6px 14px; border-radius: 16px; font-size: 13px; font-weight: 600; ${gradeBadgeStyle}">${gradeText}</span>
                </div>
              </div>
            `;
          }).join('');

          container.innerHTML = cardsHtml || '<div style="padding: 20px; text-align: center; color: #6b7280;">暂无科目数据</div>';

        } catch (error) {
          console.error('加载单科统计失败:', error);
          container.innerHTML = `<div style="padding: 20px; text-align: center; color: #dc2626;">加载失败: ${error.message}</div>`;
        }
      }

      // 渲染趋势分析标签页
      async function renderTrendTab(student) {
        try {
          const res = await fetch(`${API_BASE}/student-trend/${student.student_no}`);
          if (!res.ok) throw new Error('无法加载趋势数据');

          const trendData = await res.json();
          const exams = trendData.exams || [];

          if (exams.length === 0) {
            document.getElementById('trendTab').innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 60px;">暂无历史成绩数据</p>';
            return;
          }

          const examNames = exams.map(e => e.exam_name);
          const totalScores = exams.map(e => e.total_score);
          const avgScores = exams.map(e => e.average_score);

          // 总分与平均分走势图
          const trendScoreCtx = document.getElementById('trendScoreChart');
          if (detailTrendScoreChart) {
            detailTrendScoreChart.destroy();
          }

          detailTrendScoreChart = new Chart(trendScoreCtx, {
            type: 'line',
            data: {
              labels: examNames,
              datasets: [
                {
                  label: '总分',
                  data: totalScores,
                  borderColor: '#2563eb',
                  backgroundColor: 'rgba(37, 99, 235, 0.1)',
                  tension: 0.3,
                  fill: true
                },
                {
                  label: '平均分',
                  data: avgScores,
                  borderColor: '#059669',
                  backgroundColor: 'rgba(5, 150, 105, 0.1)',
                  tension: 0.3,
                  fill: true
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top'
                },
                title: {
                  display: true,
                  text: '总分与平均分走势'
                }
              },
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });

          // 各科目成绩走势图
          const allSubjects = new Set();
          exams.forEach(exam => {
            Object.keys(exam.subject_scores).forEach(subject => allSubjects.add(subject));
          });

          const subjectArray = Array.from(allSubjects);
          const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0'
          ];

          const subjectDatasets = subjectArray.map((subject, index) => {
            return {
              label: subject,
              data: exams.map(exam => exam.subject_scores[subject] || null),
              borderColor: colors[index % colors.length],
              backgroundColor: colors[index % colors.length] + '33',
              tension: 0.3,
              fill: false
            };
          });

          const trendSubjectCtx = document.getElementById('trendSubjectChart');
          if (detailTrendSubjectChart) {
            detailTrendSubjectChart.destroy();
          }

          detailTrendSubjectChart = new Chart(trendSubjectCtx, {
            type: 'line',
            data: {
              labels: examNames,
              datasets: subjectDatasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'top'
                },
                title: {
                  display: true,
                  text: '各科目成绩走势'
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100
                }
              }
            }
          });

        } catch (error) {
          console.error('加载趋势数据失败:', error);
          document.getElementById('trendTab').innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 60px;">暂无历史成绩数据</p>';
        }
      }

      // 渲染详细分析标签页
      async function renderAnalysisTab(student) {
        const scores = student.scores || [];
        const avgScore = student.average_score || 0;

        // 获取班级科目统计数据（班级平均分、排名等）
        let classStats = null;
        let classStudents = [];
        try {
          // 获取班级统计数据
          const statsResponse = await fetch(`${API_BASE}/class-subject-stats?class_name=${encodeURIComponent(student.class_name)}&exam_name=${encodeURIComponent(student.exam_name)}`);
          if (statsResponse.ok) {
            classStats = await statsResponse.json();
          }

          // 获取同班同学数据用于计算排名
          const studentsResponse = await fetch(`${API_BASE}/?class_name=${encodeURIComponent(student.class_name)}&exam_name=${encodeURIComponent(student.exam_name)}`);
          if (studentsResponse.ok) {
            classStudents = await studentsResponse.json();
          }
        } catch (error) {
          console.error('获取班级数据失败:', error);
        }

        // 创建班级平均分映射
        const classAvgMap = {};
        if (classStats) {
          classStats.subject_stats.forEach(stat => {
            classAvgMap[stat.subject] = stat.average;
          });
        }

        // 生成各科目详细分析
        const subjectAnalysisList = document.getElementById('subjectAnalysisList');
        subjectAnalysisList.innerHTML = scores.map(scoreItem => {
          const score = scoreItem.score;
          const subject = scoreItem.subject;

          // 计算得分率
          const rate = score;

          // 计算班级排名（基于真实数据）
          let rank = 1;
          if (classStudents.length > 0) {
            classStudents.forEach(s => {
              const subjectScore = (s.scores || []).find(sc => sc.subject === subject);
              if (subjectScore && subjectScore.score > score) {
                rank++;
              }
            });
          } else {
            rank = '-';
          }

          // 与班级平均分差距（使用真实班级平均）
          const classAvg = classAvgMap[subject] || avgScore;
          const diff = (score - classAvg).toFixed(1);
          const diffText = diff > 0 ? `+${diff}` : diff;
          const diffColor = diff >= 0 ? '#059669' : '#dc2626';

          return `
            <div style="background: #f9fafb; padding: 16px; border-radius: 10px; border-left: 4px solid ${score >= 90 ? '#059669' : score >= 60 ? '#d97706' : '#dc2626'};">
              <h4 style="margin: 0 0 12px; font-size: 15px; font-weight: 600;">${subject}详细分析</h4>
              <div style="font-size: 13px; color: #6b7280; line-height: 1.8;">
                <div>得分率: <strong style="color: #111827;">${rate.toFixed(1)}%</strong></div>
                <div>班级排名: <strong style="color: #111827;">${rank}</strong></div>
                <div>与班级平均差距: <strong style="color: ${diffColor};">${diffText}分</strong></div>
                <div style="margin-top: 8px; color: ${score >= 80 ? '#059669' : score >= 60 ? '#d97706' : '#dc2626'};">
                  ${score >= 90 ? '✓ 优秀，继续保持' : score >= 80 ? '○ 良好，需要继续努力' : score >= 60 ? '△ 及格，属于及格线' : '✗ 低于及格线，需重点关注'}
                </div>
              </div>
            </div>
          `;
        }).join('');

        // 生成弱项分析（使用班级平均分）
        const weaknessAnalysis = document.getElementById('weaknessAnalysis');
        const weakSubjects = scores.map(s => {
          const classAvg = classAvgMap[s.subject] || avgScore;
          return {
            ...s,
            belowAvg: s.score < classAvg,
            diff: classAvg - s.score
          };
        }).filter(s => s.belowAvg).sort((a, b) => b.diff - a.diff);

        if (weakSubjects.length > 0) {
          weaknessAnalysis.innerHTML = `
            <ul style="margin: 0; padding-left: 20px; color: #374151; line-height: 2;">
              ${weakSubjects.map(s => `
                <li><strong>${s.subject}</strong>科目低于班级平均水平${s.diff.toFixed(1)}分，需要加强学习。</li>
              `).join('')}
              ${weakSubjects.length > 2 ? `<li>建议重点关注<strong>${weakSubjects[0].subject}</strong>和<strong>${weakSubjects[1].subject}</strong>，这两科与班级平均差距较大。</li>` : ''}
              <li>建议加强弱项训练，多做练习。</li>
            </ul>
          `;
        } else {
          weaknessAnalysis.innerHTML = '<p style="margin: 0; color: #059669;">所有科目均达到或超过班级平均分，继续保持！</p>';
        }
      }

      // 渲染积分表现标签页
      async function renderPointsTab(student) {
        const headerEl = document.getElementById('pointsHeader');
        const recordsList = document.getElementById('pointsRecordsList');

        // 显示加载中
        headerEl.innerHTML = '<p style="color: #9ca3af; padding: 20px;">加载中...</p>';
        recordsList.innerHTML = '';

        try {
          const res = await fetch(`${API_BASE}/${student.id}/point-records`);
          if (!res.ok) throw new Error('无法加载积分记录');

          const data = await res.json();

          if (!data.has_points_account) {
            headerEl.innerHTML = `
              <div style="font-size: 20px; margin-bottom: 8px;">📊 学生积分历史</div>
              <p style="color: #6b7280; font-size: 14px;">该学生暂未加入积分系统</p>
            `;
            recordsList.innerHTML = `
              <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                <a href="/static/points.html" style="color: var(--primary); text-decoration: none;">前往积分系统创建账户</a>
              </div>
            `;
            return;
          }

          // 渲染标题和学生信息
          headerEl.innerHTML = `
            <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">📊 学生积分历史</div>
            <p style="color: #6b7280; font-size: 15px;">学生: ${student.name} (${data.total_points}积分)</p>
          `;

          // 渲染积分记录列表
          if (data.records.length === 0) {
            recordsList.innerHTML = `
              <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                <p style="margin: 0;">暂无积分记录</p>
              </div>
            `;
            return;
          }

          recordsList.innerHTML = data.records.map((record) => {
            const isPositive = record.points > 0;
            const pointsColor = isPositive ? '#3b82f6' : '#ef4444';
            const pointsSign = isPositive ? '+' : '';
            const date = new Date(record.created_at);
            const dateStr = date.toLocaleString('zh-CN', {
              year: 'numeric',
              month: 'numeric',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });

            return `
              <div style="padding: 16px 0; border-bottom: 1px solid #e5e7eb; text-align: center;">
                <div style="font-size: 13px; color: #9ca3af; margin-bottom: 6px;">${dateStr}</div>
                <div style="font-size: 18px; font-weight: 600; color: ${pointsColor};">
                  ${record.reason} ${pointsSign}${record.points}积分
                </div>
              </div>
            `;
          }).join('');

        } catch (error) {
          console.error('加载积分记录失败:', error);
          headerEl.innerHTML = `
            <div style="font-size: 20px; margin-bottom: 8px;">📊 学生积分历史</div>
            <p style="color: #dc2626;">加载失败: ${error.message}</p>
          `;
          recordsList.innerHTML = '';
        }
      }

      // 详情弹窗选项卡切换（使用事件委托）
      studentDetailModal?.addEventListener('click', async (e) => {
        const button = e.target.closest('[data-detail-tab]');
        if (!button) return;

        const targetTab = button.getAttribute('data-detail-tab');

        // 更新按钮状态
        document.querySelectorAll('#studentDetailModal [data-detail-tab]').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        // 更新内容显示
        document.querySelectorAll('#studentDetailModal .tab-content').forEach(content => content.classList.remove('active'));
        const targetContent = document.getElementById(targetTab + 'Tab');
        if (targetContent) {
          targetContent.classList.add('active');
        }

        // 懒加载数据
        if (targetTab === 'trend' && currentDetailStudent) {
          await renderTrendTab(currentDetailStudent);
        } else if (targetTab === 'analysis' && currentDetailStudent) {
          renderAnalysisTab(currentDetailStudent);
        } else if (targetTab === 'points' && currentDetailStudent) {
          await renderPointsTab(currentDetailStudent);
        }
      });

      function closeStudentDetail() {
        studentDetailModal.classList.remove("active");
        currentDetailStudent = null;
        isEditingDetail = false;
      }

      function renderStudentInfo(student, isEditing) {
        const fields = [
          { key: 'name', label: '姓名', type: 'text', required: true },
          { key: 'student_no', label: '学号', type: 'text', required: true },
          { key: 'gender', label: '性别', type: 'text' },
          { key: 'class_name', label: '班级', type: 'text' },
          { key: 'grade_name', label: '年级', type: 'text' },
          { key: 'exam_name', label: '考试名称', type: 'text' },
          { key: 'class_rank', label: '班级排名', type: 'number' },
          { key: 'grade_rank', label: '年级排名', type: 'number' },
          { key: 'notes', label: '备注', type: 'textarea', fullWidth: true }
        ];

        if (isEditing) {
          studentInfoGrid.innerHTML = fields.map(field => {
            const value = student[field.key] || '';
            if (field.type === 'textarea') {
              return `
                <div class="info-item" style="${field.fullWidth ? 'grid-column: 1 / -1;' : ''}">
                  <label>${field.label}${field.required ? ' *' : ''}</label>
                  <textarea name="${field.key}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); min-height: 80px;" ${field.required ? 'required' : ''}>${value}</textarea>
                </div>
              `;
            }
            return `
              <div class="info-item" style="${field.fullWidth ? 'grid-column: 1 / -1;' : ''}">
                <label>${field.label}${field.required ? ' *' : ''}</label>
                <input type="${field.type}" name="${field.key}" value="${value}" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border);" ${field.required ? 'required' : ''} />
              </div>
            `;
          }).join('');
        } else {
          studentInfoGrid.innerHTML = fields.map(field => {
            const value = student[field.key] || '-';
            return `
              <div class="info-item" style="${field.fullWidth ? 'grid-column: 1 / -1;' : ''}">
                <label>${field.label}</label>
                <div class="value">${value}</div>
              </div>
            `;
          }).join('');
        }
      }

      async function saveDetailEdit(event) {
        event.preventDefault();
        if (!currentDetailStudent) return;

        const formData = new FormData(studentDetailForm);
        const payload = Object.fromEntries(formData.entries());

        // 转换数字字段
        if (payload.class_rank) {
          payload.class_rank = parseInt(payload.class_rank);
        } else {
          delete payload.class_rank;
        }

        if (payload.grade_rank) {
          payload.grade_rank = parseInt(payload.grade_rank);
        } else {
          delete payload.grade_rank;
        }

        // 清理空字符串字段
        Object.keys(payload).forEach(key => {
          if (payload[key] === '') {
            delete payload[key];
          }
        });

        // 保留原有的成绩数据
        payload.scores = currentDetailStudent.scores;

        try {
          const res = await fetch(`${API_BASE}/${currentDetailStudent.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || '保存失败');
          }

          showToast('保存成功');
          await loadStudents();
          await loadClassStats();

          // 更新当前学生数据并切换回查看模式
          const updatedStudent = students.find(s => s.id === currentDetailStudent.id);
          if (updatedStudent) {
            currentDetailStudent = updatedStudent;
            detailStudentName.textContent = `${updatedStudent.name} - 学生信息`;
            renderStudentInfo(updatedStudent, false);
            isEditingDetail = false;
          }
        } catch (error) {
          showToast(error.message, true);
        }
      }

      function applyFilters(student) {
        const keyword = searchInput.value.trim().toLowerCase();
        if (keyword) {
          const hit = student.name.toLowerCase().includes(keyword) || student.student_no.toLowerCase().includes(keyword);
          if (!hit) return false;
        }
        if (classFilter.value && student.class_name !== classFilter.value) return false;
        if (examFilter.value && student.exam_name !== examFilter.value) return false;
        if (selectedSubject !== "总分") {
          const hasScore = student.scores.some((item) => item.subject === selectedSubject);
          if (!hasScore) return false;
        }
        return true;
      }

      function renderTable() {
        updateTableColumns();
        if (!students.length) {
          studentBody.innerHTML = `<tr><td colspan="${visibleColumns.length}" class="empty-tip">暂未录入任何学生数据，点击"添加学生"开始吧。</td></tr>`;
          return;
        }
        const filtered = students.filter(applyFilters);
        const rows = filtered
          .sort((a, b) => {
            const scoreA = getSubjectScore(a, selectedSubject);
            const scoreB = getSubjectScore(b, selectedSubject);
            return scoreB - scoreA;
          })
          .map((student, index) => {
            const scoreMap = Object.fromEntries(student.scores.map((item) => [item.subject, item.score]));
            const rating = getPerformanceLabel(getSubjectScore(student, "总分"), "总分");

            const cellData = {
              name: student.name,
              student_no: student.student_no,
              class_rank: student.class_rank ?? "-",
              grade_rank: student.grade_rank ?? "-",
              total_score: Number(student.total_score || 0).toFixed(1),
              rating: rating,
              ...Object.fromEntries(scoreSubjects.map(key => [
                key,
                scoreMap[key] ?? "-"
              ])),
              actions: `
                <button class="btn secondary compact-btn" type="button" data-view="${student.id}">查看</button>
                <button class="btn secondary compact-btn" type="button" data-edit="${student.id}" style="margin-left:4px;">编辑</button>
                <button class="btn danger compact-btn" type="button" data-delete="${student.id}" style="margin-left:4px;">删除</button>
              `
            };

            const cells = visibleColumns.map(col => {
              const value = cellData[col];
              const cls = selectedSubject === col ? "highlight-cell" : "";
              return `<td class="${cls}" data-column="${col}" style="${visibleColumns.includes(col) ? '' : 'display:none;'}">${value}</td>`;
            }).join("");

            return `<tr>${cells}</tr>`;
          })
          .join("");
        studentBody.innerHTML = rows || `<tr><td colspan="${visibleColumns.length}" class="empty-tip">没有符合筛选条件的数据。</td></tr>`;
      }

      function getPerformanceLabel(value, subject) {
        const ranges = getSubjectRanges(subject);
        if (!ranges) return "-";
        if (inRange(ranges.find((r) => r.key === "excellent"), value)) return "优秀";
        if (inRange(ranges.find((r) => r.key === "good"), value)) return "良好";
        if (inRange(ranges.find((r) => r.key === "pass"), value)) return "及格";
        return "不及格";
      }


      function enrichStudent(student) {
        const scores = Array.isArray(student.scores) ? student.scores : [];
        const totalFromScores = scores.reduce((sum, item) => sum + Number(item.score || 0), 0);
        const totalScore = typeof student.total_score === "number" ? student.total_score : totalFromScores;
        const averageScore =
          typeof student.average_score === "number"
            ? student.average_score
            : scores.length
              ? totalScore / scores.length
              : 0;
        return {
          ...student,
          scores,
          total_score: Number(totalScore.toFixed(2)),
          average_score: Number(averageScore.toFixed(2)),
        };
      }

      function getSubjectScore(student, subject) {
        if (subject === "总分") return Number(student.total_score || 0);
        const score = student.scores.find((item) => item.subject === subject);
        return score ? Number(score.score || 0) : 0;
      }

      async function loadStudents() {
        try {
          const res = await fetch(API_BASE);
          const data = await res.json();

          // 验证数据格式
          if (!Array.isArray(data)) {
            console.error('API 返回的数据不是数组:', data);
            students = [];
            renderTable();
            return;
          }

          let allStudents = data.map(enrichStudent);

          // 应用班级筛选
          if (selectedClasses.length > 0) {
            allStudents = allStudents.filter(s => selectedClasses.includes(s.class_name));
          }

          // 应用考试筛选
          if (selectedExams.length > 0) {
            allStudents = allStudents.filter(s => selectedExams.includes(s.exam_name));
          }

          students = allStudents;
          renderFilters();
          renderTable();
          updateSummary();
          await loadClassStats();
          renderProgressRegressionCharts();
        } catch (error) {
          studentBody.innerHTML = `<tr><td colspan="14" class="empty-tip">加载失败：${error.message}</td></tr>`;
        }
      }

      async function loadClassStats() {
        try {
          const res = await fetch(`${API_BASE}/class-stats`);
          if (!res.ok) throw new Error("加载班级统计失败");
          classStats = await res.json();
          renderClassStats();
        } catch (error) {
          if (classStatsBody) {
            classStatsBody.innerHTML = `<tr><td colspan="11" class="empty-tip">加载失败：${error.message}</td></tr>`;
          }
        }
      }

      function renderClassStats() {
        if (!classStatsBody) return;
        if (!classStats || classStats.length === 0) {
          classStatsBody.innerHTML = '<tr><td colspan="12" class="empty-tip">暂无班级数据</td></tr>';
          return;
        }

        const rows = classStats.map(cls => {
          const genderRatio = `${cls.male_ratio}% : ${cls.female_ratio}%`;
          return `
            <tr>
              <td>${cls.class_name}</td>
              <td>${cls.grade_name || '-'}</td>
              <td>${cls.total_students}</td>
              <td>${cls.exam_count}</td>
              <td>${cls.male_count}</td>
              <td>${cls.female_count}</td>
              <td>${genderRatio}</td>
              <td>${cls.average_score.toFixed(2)}</td>
              <td>${cls.pass_rate}%</td>
              <td>${cls.good_rate}%</td>
              <td>${cls.excellent_rate}%</td>
              <td>
                <button class="btn secondary compact-btn" type="button" data-edit-class="${cls.class_name}">编辑</button>
                <button class="btn danger compact-btn" type="button" data-delete-class="${cls.class_name}" style="margin-left:4px;">删除</button>
              </td>
            </tr>
          `;
        }).join('');

        classStatsBody.innerHTML = rows;
      }

      function openClassEditModal(className) {
        const classData = classStats.find(c => c.class_name === className);
        if (!classData) return;

        editingClassName = className;
        editClassName.value = className;
        editGradeName.value = classData.grade_name || '';
        classEditModal.classList.add('active');
      }

      function closeClassEditModal() {
        classEditModal.classList.remove('active');
        editingClassName = null;
      }

      async function saveClassEdit(event) {
        event.preventDefault();
        if (!editingClassName) return;

        const newClassName = editClassName.value.trim();
        const newGradeName = editGradeName.value.trim();

        if (!newClassName) {
          showToast('班级名称不能为空', true);
          return;
        }

        try {
          const params = new URLSearchParams();
          params.append('new_class_name', newClassName);
          if (newGradeName) {
            params.append('new_grade_name', newGradeName);
          }

          const res = await fetch(`${API_BASE}/class/${encodeURIComponent(editingClassName)}/rename?${params.toString()}`, {
            method: 'PUT'
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || '更新失败');
          }

          const result = await res.json();
          showToast(`已更新 ${result.updated_count} 条记录`);
          closeClassEditModal();
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function deleteClass(className) {
        if (!confirm(`确认删除班级"${className}"及其所有学生记录？此操作不可恢复！`)) return;

        try {
          const res = await fetch(`${API_BASE}/class/${encodeURIComponent(className)}`, {
            method: 'DELETE'
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || '删除失败');
          }

          const result = await res.json();
          showToast(`已删除班级及 ${result.deleted_count} 条学生记录`);
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      function inRange(range, value) {
        if (!range) return false;
        const minOk = value >= Number(range.min ?? Number.NEGATIVE_INFINITY);
        const maxOk = range.max == null ? true : value <= Number(range.max);
        return minOk && maxOk;
      }

      function computeSummaryFromStudents(list, subject = "总分") {
        if (!list.length) {
          return {
            total_students: 0,
            average_total: 0,
            highest_total: null,
            highest_student: null,
            pass_rate: 0,
            good_rate: 0,
            excellent_rate: 0,
          };
        }
        const ranges = getSubjectRanges(subject);
        const passRange = ranges.find((item) => item.key === "pass");
        const goodRange = ranges.find((item) => item.key === "good");
        const excellentRange = ranges.find((item) => item.key === "excellent");
        let totalScores = 0;
        let highestTotal = -Infinity;
        let highestName = null;
        let passCount = 0;
        let goodCount = 0;
        let excellentCount = 0;
        list.forEach((student) => {
          // 对于总分，使用总分；对于单科，使用单科分数
          const value = subject === "总分" ? Number(student.total_score || 0) : getSubjectScore(student, subject);
          totalScores += value;
          if (value > highestTotal) {
            highestTotal = value;
            highestName = student.name;
          }

          // 判断等级时：总分使用平均分，单科使用单科分数
          const scoreForRate = subject === "总分" ? Number(student.average_score || 0) : value;

          // 按优先级检查：优秀 > 良好 > 及格
          // 优秀的学生也算良好和及格，良好的学生也算及格
          if (inRange(excellentRange, scoreForRate)) {
            excellentCount++;
            goodCount++; // 优秀的学生也算良好
            passCount++; // 优秀的学生也算及格
          } else if (inRange(goodRange, scoreForRate)) {
            goodCount++;
            passCount++; // 良好的学生也算及格
          } else if (inRange(passRange, scoreForRate)) {
            passCount++;
          }
        });
        const totalStudents = list.length;
        return {
          total_students: totalStudents,
          average_total: Number((totalScores / totalStudents).toFixed(2)),
            highest_total: highestTotal === -Infinity ? null : Number(highestTotal.toFixed(2)),
            highest_student: highestName,
            pass_rate: Number(((passCount / totalStudents) * 100).toFixed(2)),
            good_rate: Number(((goodCount / totalStudents) * 100).toFixed(2)),
            excellent_rate: Number(((excellentCount / totalStudents) * 100).toFixed(2)),
        };
      }

      function updateSummary() {
        // 应用筛选条件，确保统计数据与表格数据一致
        const filtered = students.filter(applyFilters);
        summary = computeSummaryFromStudents(filtered, selectedSubject);
        renderGradeDashboard();
        renderStatisticsCharts();
        renderProgressRegressionCharts();
        renderDashboardTrendChart();
        renderTopStudents();
        updateSelectedSubjectCount(); // 初始化科目数量显示
      }

      // 考试成绩走势图（使用Chart.js）
      let trendChart = null;

      function renderDashboardTrendChart() {
        const canvas = document.getElementById('dashboardTrendChart');
        if (!canvas) return;

        // 销毁旧图表
        if (trendChart) {
          trendChart.destroy();
        }

        if (students.length === 0) {
          return;
        }

        // 按考试名称分组
        const examGroups = {};
        students.forEach(student => {
          const examName = student.exam_name || '未知考试';
          if (!examGroups[examName]) {
            examGroups[examName] = {
              name: examName,
              date: student.exam_date ? new Date(student.exam_date) : null,
              students: []
            };
          }
          examGroups[examName].students.push(student);
        });

        // 转换为数组并按日期排序
        let exams = Object.values(examGroups).sort((a, b) => {
          if (!a.date || !b.date) return 0;
          return a.date - b.date;
        });

        // 根据筛选模式过滤考试
        if (trendDateRange !== null) {
          // 按时间模式：筛选指定日期范围内的考试
          const startDate = new Date(trendDateRange.startDate);
          const endDate = new Date(trendDateRange.endDate);
          endDate.setHours(23, 59, 59, 999); // 包含结束日期的全天
          exams = exams.filter(exam => exam.date && exam.date >= startDate && exam.date <= endDate);
        } else if (trendExamCount !== null) {
          // 按场次模式：取最近N场考试
          exams = exams.slice(-trendExamCount);
        }

        // 如果没有考试数据，显示空图表
        if (exams.length === 0) {
          return;
        }

        // 计算每场考试的统计数据
        const examStats = exams.map(exam => {
          const stats = computeSummaryFromStudents(exam.students, "总分");
          return {
            name: exam.name,
            date: exam.date,
            avgScore: stats.average_total,
            excellentRate: stats.excellent_rate,
            goodRate: stats.good_rate,
            passRate: stats.pass_rate
          };
        });

        // 准备图表数据
        const labels = examStats.map(e => {
          // 如果有日期，显示日期；否则显示考试名称
          if (e.date) {
            const month = (e.date.getMonth() + 1).toString().padStart(2, '0');
            const day = e.date.getDate().toString().padStart(2, '0');
            return `${month}-${day}`;
          }
          return e.name.length > 10 ? e.name.substring(0, 10) + '...' : e.name;
        });
        const avgScores = examStats.map(e => e.avgScore);
        const excellentRates = examStats.map(e => e.excellentRate);
        const goodRates = examStats.map(e => e.goodRate);

        const ctx = canvas.getContext('2d');
        trendChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: '平均分',
                data: avgScores,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: '#3b82f6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.3,
                yAxisID: 'y'
              },
              {
                label: '优秀率',
                data: excellentRates,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 2.5,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#10b981',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.3,
                yAxisID: 'y1'
              },
              {
                label: '良好率',
                data: goodRates,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                borderWidth: 2.5,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#f59e0b',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.3,
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false
            },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: { size: 13 },
                  padding: 15,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: { size: 14 },
                bodyFont: { size: 13 },
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      if (context.datasetIndex === 0) {
                        label += context.parsed.y.toFixed(1) + '分';
                      } else {
                        label += context.parsed.y.toFixed(1) + '%';
                      }
                    }
                    return label;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: { size: 12 },
                  color: '#374151'
                }
              },
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: '平均分',
                  color: '#3b82f6',
                  font: { size: 12, weight: 'bold' }
                },
                ticks: {
                  font: { size: 12 },
                  color: '#3b82f6'
                },
                grid: {
                  color: '#e5e7eb'
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: '百分比(%)',
                  color: '#10b981',
                  font: { size: 12, weight: 'bold' }
                },
                min: 0,
                max: 100,
                ticks: {
                  font: { size: 12 },
                  color: '#10b981',
                  callback: function(value) {
                    return value + '%';
                  }
                },
                grid: {
                  drawOnChartArea: false
                }
              }
            }
          }
        });
      }

      function renderTopStudents() {
        const topStudentsGrid = document.getElementById('topStudentsGrid');
        const bottomStudentsGrid = document.getElementById('bottomStudentsGrid');
        if (!topStudentsGrid) return;

        // 获取所有考试名称
        const examNames = new Set();
        students.forEach(student => {
          if (student.exam_name) examNames.add(student.exam_name);
        });

        // 取最近N场考试
        const recentExams = Array.from(examNames).slice(-trendExamCount);

        if (recentExams.length === 0) {
          topStudentsGrid.innerHTML = '<p style="color: #6b7280; text-align: center;">暂无考试数据</p>';
          if (bottomStudentsGrid) {
            bottomStudentsGrid.innerHTML = '<p style="color: #6b7280; text-align: center;">暂无考试数据</p>';
          }
          return;
        }

        // 计算每个学生在这些考试中的平均分
        const studentScores = new Map();

        students.forEach(student => {
          if (!student.exam_name || !recentExams.includes(student.exam_name)) return;
          if (!student.total_score) return;

          const key = student.student_no;
          if (!studentScores.has(key)) {
            studentScores.set(key, {
              name: student.name,
              student_no: student.student_no,
              class_name: student.class_name,
              scores: [],
              ranks: []
            });
          }

          const data = studentScores.get(key);
          data.scores.push(Number(student.total_score));
          if (student.grade_rank) {
            data.ranks.push(student.grade_rank);
          }
        });

        // 计算平均分并按平均分排序
        const allStudents = Array.from(studentScores.values())
          .map(student => ({
            ...student,
            examCount: student.scores.length,
            avgScore: student.scores.reduce((sum, score) => sum + score, 0) / student.scores.length,
            avgRank: student.ranks.length > 0
              ? student.ranks.reduce((sum, rank) => sum + rank, 0) / student.ranks.length
              : null
          }))
          .filter(student => student.examCount >= Math.min(1, recentExams.length)) // 至少参加1场考试
          .sort((a, b) => b.avgScore - a.avgScore); // 按平均分降序排序

        if (allStudents.length === 0) {
          topStudentsGrid.innerHTML = '<p style="color: #6b7280; text-align: center;">暂无学生数据</p>';
          if (bottomStudentsGrid) {
            bottomStudentsGrid.innerHTML = '<p style="color: #6b7280; text-align: center;">暂无学生数据</p>';
          }
          return;
        }

        // 前5名学生
        const topStudents = allStudents.slice(0, 5);

        // 后5名学生
        const bottomStudents = allStudents.slice(-5).reverse();

        // 渲染前5名学生卡片
        topStudentsGrid.innerHTML = topStudents.map((student, index) => `
          <div class="top-student-card">
            <div class="rank-badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">${index + 1}</div>
            <div class="student-info-group">
              <div class="student-name">${student.name}</div>
              <div class="student-detail">
                <span>学号: ${student.student_no}</span>
                <span>${student.class_name || '-'}</span>
                <span>参加: ${student.examCount} 场考试</span>
                ${student.avgRank !== null ? `<span>平均排名: ${student.avgRank.toFixed(1)}</span>` : ''}
              </div>
            </div>
            <div class="score-display">
              <div class="avg-score" style="color: #059669;">${student.avgScore.toFixed(1)}</div>
              <div class="score-label">平均总分</div>
            </div>
          </div>
        `).join('');

        // 渲染后5名学生卡片
        if (bottomStudentsGrid) {
          bottomStudentsGrid.innerHTML = bottomStudents.map((student, index) => {
            const actualRank = allStudents.length - bottomStudents.length + index + 1;
            return `
              <div class="top-student-card">
                <div class="rank-badge" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">${actualRank}</div>
                <div class="student-info-group">
                  <div class="student-name">${student.name}</div>
                  <div class="student-detail">
                    <span>学号: ${student.student_no}</span>
                    <span>${student.class_name || '-'}</span>
                    <span>参加: ${student.examCount} 场考试</span>
                    ${student.avgRank !== null ? `<span>平均排名: ${student.avgRank.toFixed(1)}</span>` : ''}
                  </div>
                </div>
                <div class="score-display">
                  <div class="avg-score" style="color: #dc2626;">${student.avgScore.toFixed(1)}</div>
                  <div class="score-label">平均总分</div>
                </div>
              </div>
            `;
          }).join('');
        }
      }

      // 填充学生复选框列表
      function populateStudentCheckboxList(searchTerm = '') {
        if (!studentCheckboxList) return;

        // 获取所有唯一的学生（按学号去重）
        const uniqueStudents = new Map();
        students.forEach(student => {
          if (!uniqueStudents.has(student.student_no)) {
            uniqueStudents.set(student.student_no, {
              name: student.name,
              student_no: student.student_no,
              class_name: student.class_name
            });
          }
        });

        // 按姓名排序并筛选
        let sortedStudents = Array.from(uniqueStudents.values()).sort((a, b) =>
          a.name.localeCompare(b.name, 'zh-CN')
        );

        if (searchTerm) {
          sortedStudents = sortedStudents.filter(s =>
            s.name.includes(searchTerm) || s.student_no.includes(searchTerm)
          );
        }

        studentCheckboxList.innerHTML = sortedStudents.map(s => {
          const isChecked = selectedStudentNos.includes(s.student_no);
          const colorIndex = selectedStudentNos.indexOf(s.student_no);
          const colorIndicator = colorIndex >= 0 ?
            `<span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${studentColors[colorIndex].border}; margin-left: 8px;"></span>` : '';

          return `
            <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; ${isChecked ? 'background: #f0f9ff; border-color: #3b82f6;' : ''}">
              <input type="checkbox" value="${s.student_no}" ${isChecked ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
              <span style="flex: 1;">${s.name} (${s.student_no})</span>
              <span style="font-size: 12px; color: #6b7280;">${s.class_name || '无班级'}</span>
              ${colorIndicator}
            </label>
          `;
        }).join('') || '<p style="text-align: center; color: #9ca3af; padding: 20px;">没有找到匹配的学生</p>';
      }

      // 填充科目复选框列表
      function populateSubjectCheckboxList() {
        if (!subjectCheckboxList) return;

        subjectCheckboxList.innerHTML = allAvailableTrendSubjects.map(subject => {
          const isChecked = selectedTrendSubjects.includes(subject);
          return `
            <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; ${isChecked ? 'background: #f0fdf4; border-color: #10b981;' : ''}">
              <input type="checkbox" value="${subject}" ${isChecked ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
              <span>${subject}</span>
            </label>
          `;
        }).join('');
      }

      // 更新已选择学生列表显示
      function updateSelectedStudentsList() {
        if (!selectedStudentsList || !selectedStudentCount) return;

        selectedStudentCount.textContent = selectedStudentNos.length;

        if (selectedStudentNos.length === 0) {
          selectedStudentsList.innerHTML = '<span style="color: #9ca3af; font-size: 14px;">点击"选择学生"按钮添加学生</span>';
        } else {
          const uniqueStudents = new Map();
          students.forEach(student => {
            if (!uniqueStudents.has(student.student_no)) {
              uniqueStudents.set(student.student_no, student.name);
            }
          });

          selectedStudentsList.innerHTML = selectedStudentNos.map((studentNo, index) => {
            const name = uniqueStudents.get(studentNo) || '未知';
            const color = studentColors[index].border;
            return `
              <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: ${studentColors[index].bg}; border: 1px solid ${color}; border-radius: 6px; font-size: 14px; color: ${color}; font-weight: 500;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: ${color};"></span>
                ${name}
                <button onclick="removeSelectedStudent('${studentNo}')" style="background: none; border: none; color: ${color}; cursor: pointer; padding: 0; margin-left: 4px; font-size: 16px; line-height: 1;">&times;</button>
              </span>
            `;
          }).join('');
        }
      }

      // 移除选中的学生
      window.removeSelectedStudent = function(studentNo) {
        selectedStudentNos = selectedStudentNos.filter(no => no !== studentNo);
        updateSelectedStudentsList();
        renderStudentTrendChart();
      };

      // 更新选中科目数量显示
      function updateSelectedSubjectCount() {
        if (selectedSubjectCount) {
          selectedSubjectCount.textContent = selectedTrendSubjects.length;
        }
      }

      // 渲染学生成绩对比走势图
      function renderStudentTrendChart() {
        if (selectedStudentNos.length === 0 || selectedTrendSubjects.length === 0) {
          studentTrendChartContainer.style.display = 'none';
          studentTrendPlaceholder.style.display = 'block';
          return;
        }

        studentTrendChartContainer.style.display = 'block';
        studentTrendPlaceholder.style.display = 'none';

        // 销毁旧图表
        if (studentTrendChart) {
          studentTrendChart.destroy();
        }

        // 获取所有考试，按日期排序
        const examGroups = {};
        students.forEach(student => {
          const examName = student.exam_name || '未知考试';
          if (!examGroups[examName]) {
            examGroups[examName] = {
              name: examName,
              date: student.exam_date ? new Date(student.exam_date) : null
            };
          }
        });

        const exams = Object.values(examGroups).sort((a, b) => {
          if (a.date && b.date) return a.date - b.date;
          return 0;
        });

        // X轴标签
        const labels = exams.map(e => {
          if (e.date) {
            const month = (e.date.getMonth() + 1).toString().padStart(2, '0');
            const day = e.date.getDate().toString().padStart(2, '0');
            return `${month}-${day}`;
          }
          return e.name.length > 8 ? e.name.substring(0, 8) + '...' : e.name;
        });

        // 为每个学生的每个科目创建一条曲线
        const datasets = [];
        selectedStudentNos.forEach((studentNo, studentIndex) => {
          const studentName = students.find(s => s.student_no === studentNo)?.name || '未知';
          const color = studentColors[studentIndex];

          selectedTrendSubjects.forEach((subject) => {
            // 获取该学生在各场考试中该科目的成绩
            const scores = exams.map(exam => {
              const record = students.find(s =>
                s.student_no === studentNo && s.exam_name === exam.name
              );
              if (!record) return null;

              if (subject === "总分") {
                return record.total_score || null;
              } else {
                const scoreItem = record.scores?.find(s => s.subject === subject);
                return scoreItem ? Number(scoreItem.score) : null;
              }
            });

            datasets.push({
              label: `${studentName} - ${subject}`,
              data: scores,
              borderColor: color.border,
              backgroundColor: color.bg,
              borderWidth: 2.5,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: color.border,
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              tension: 0.3,
              spanGaps: true // 允许跳过null值连接线
            });
          });
        });

        const canvas = document.getElementById('studentTrendChart');
        const ctx = canvas.getContext('2d');

        studentTrendChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: { size: 12 },
                  padding: 12,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: { size: 14 },
                bodyFont: { size: 13 }
              }
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: { size: 11 },
                  color: '#374151',
                  maxRotation: 45,
                  minRotation: 0
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: '#e5e7eb'
                },
                ticks: {
                  font: { size: 11 },
                  color: '#374151'
                },
                title: {
                  display: true,
                  text: '分数',
                  font: { size: 12, weight: 'bold' }
                }
              }
            }
          }
        });

        // 隐藏统计信息（因为是多学生对比，统计不太合适）
        if (studentTrendStats) {
          studentTrendStats.parentElement.style.display = 'none';
        }
      }


      async function saveTextDesktop(filename, content) {
        try {
          const res = await fetch('/api/desktop/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename, content, encoding: 'utf-8' })
          });
          if (!res.ok) return null;
          const result = await res.json();
          if (result && result.saved) return result;
        } catch (error) {
          console.error('Desktop export failed:', error);
        }
        return null;
      }

      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      async function downloadTemplate(event) {
        event?.preventDefault();
        try {
          const res = await fetch(`${API_BASE}/template`);
          if (!res.ok) throw new Error("模板下载失败");
          const blob = await res.blob();
          downloadBlob(blob, "成绩导入模板.xlsx");
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function downloadRankTemplate(event) {
        event?.preventDefault();
        try {
          const res = await fetch(`${API_BASE}/rank-template`);
          if (!res.ok) throw new Error("排名模板下载失败");
          const blob = await res.blob();
          downloadBlob(blob, "排名导入模板.xlsx");
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleImport(event) {
        event.preventDefault();
        if (!importFileInput?.files.length) {
          showToast("请先选择 Excel 文件", true);
          return;
        }
        const formData = new FormData();
        formData.append("file", importFileInput.files[0]);
        if (importClassInput?.value) formData.append("class_name", importClassInput.value);
        if (importGradeInput?.value) formData.append("grade_name", importGradeInput.value);
        if (importExamInput?.value) formData.append("exam_name", importExamInput.value);
        try {
          const res = await fetch(`${API_BASE}/import`, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "导入失败");
          }
          const summary = await res.json();
          showToast(`导入完成：新增 ${summary.imported} 条，更新 ${summary.updated} 条`);
          importForm?.reset();
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleRankImport(event) {
        event.preventDefault();
        const rankFileInput = document.getElementById('rankImportFile');
        if (!rankFileInput?.files.length) {
          showToast("请先选择 Excel 文件", true);
          return;
        }
        const formData = new FormData();
        formData.append("file", rankFileInput.files[0]);
        try {
          const res = await fetch(`${API_BASE}/import-ranks`, {
            method: "POST",
            body: formData,
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "导入排名失败");
          }
          const summary = await res.json();
          let message = `导入完成：更新 ${summary.updated} 条记录`;
          if (summary.not_found > 0) {
            message += `，未找到 ${summary.not_found} 条记录`;
          }
          if (summary.errors && summary.errors.length > 0) {
            message += `\n前${summary.errors.length}个错误：\n${summary.errors.join('\n')}`;
          }
          showToast(message);
          document.getElementById('rankImportForm')?.reset();
          await loadStudents();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleAutoCalculateRanks() {
        if (!confirm('确认要自动计算所有考试的年级排名和班级排名吗？\n\n此操作将根据总分重新计算排名，已有的排名数据将被覆盖。')) {
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/calculate-ranks`, {
            method: "POST"
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "计算排名失败");
          }
          const summary = await res.json();
          showToast(`排名计算完成：更新了 ${summary.updated || 0} 条记录`);
          await loadStudents();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleBackupData() {
        try {
          const res = await fetch(`${API_BASE}/backup`);
          if (!res.ok) throw new Error("Backup failed");
          const data = await res.json();
          const content = JSON.stringify(data, null, 2);
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
          const filename = `grades_backup_${timestamp}.json`;
          const saved = await saveTextDesktop(filename, content);
          if (!saved) {
            const blob = new Blob([content], { type: 'application/json' });
            downloadBlob(blob, filename);
            showToast('Backup saved');
          } else if (saved.path) {
            showToast(`Saved to: ${saved.path}`);
          } else {
            showToast('Backup saved');
          }
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleRestoreData(event) {
        event.preventDefault();
        if (!restoreFile?.files.length) {
          showToast("请先选择备份文件", true);
          return;
        }

        if (!confirm('确认要恢复数据吗？\n\n此操作将覆盖当前所有数据，建议先进行备份！')) {
          return;
        }

        try {
          const file = restoreFile.files[0];
          const text = await file.text();
          const data = JSON.parse(text);

          const res = await fetch(`${API_BASE}/restore`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "恢复数据失败");
          }

          const summary = await res.json();
          showToast(`数据恢复完成：恢复了 ${summary.restored || 0} 条记录`);
          restoreForm?.reset();
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleClearData() {
        if (!confirm('⚠️ 危险操作警告 ⚠️\n\n确认要清空所有成绩数据吗？\n\n此操作不可恢复，建议先进行数据备份！')) {
          return;
        }

        if (!confirm('⚠️ 最后确认 ⚠️\n\n真的要删除所有数据吗？删除后无法恢复！')) {
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/clear-all`, {
            method: "DELETE"
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "清空数据失败");
          }

          const summary = await res.json();
          showToast(`已清空 ${summary.deleted || 0} 条记录`);
          await loadStudents();
          await loadClassStats();
        } catch (error) {
          showToast(error.message, true);
        }
      }

      async function handleRangeSave(event) {
        event.preventDefault();
        if (!rangeRows) return;
        const current = gradeRanges[currentRangeSubject] || createDefaultRanges();
        let hasError = false;
        const updated = current.map((range) => {
          const row = rangeRows.querySelector(`.range-row[data-key="${range.key}"]`);
          if (!row) return range;
          const minInput = row.querySelector('[data-field="min"]');
          const maxInput = row.querySelector('[data-field="max"]');
          const minVal = parseFloat(minInput.value);
          const maxRaw = maxInput.value.trim();
          const maxVal = maxRaw === "" ? null : parseFloat(maxRaw);
          if (Number.isNaN(minVal)) {
            showToast(`请填写${range.name}的最小值`, true);
            hasError = true;
            return range;
          }
          if (maxRaw !== "" && Number.isNaN(maxVal)) {
            showToast(`请填写${range.name}的最大值`, true);
            hasError = true;
            return range;
          }
          if (maxVal !== null && maxVal <= minVal) {
            showToast(`${range.name}的最大值需大于最小值`, true);
            hasError = true;
            return range;
          }
          return { ...range, min: minVal, max: maxVal };
        });
        if (hasError) return;
        try {
          const res = await fetch(`${API_BASE}/ranges/${encodeURIComponent(currentRangeSubject)}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updated),
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || "保存失败");
          }
          const saved = await res.json();
          gradeRanges[currentRangeSubject] = saved;
          renderRangeRows();
          updateSummary();
          showToast("区间配置已保存");
        } catch (error) {
          showToast(error.message, true);
        }
      }

      // ========== 筛选器功能 ==========

      // 加载班级和考试列表
      async function loadFilterOptions() {
        try {
          const res = await fetch(`${API_BASE}/`);
          if (!res.ok) throw new Error("加载数据失败");
          const students = await res.json();

          // 提取唯一的班级和考试
          const classSet = new Set();
          const examSet = new Set();

          students.forEach(student => {
            if (student.class_name) classSet.add(student.class_name);
            if (student.exam_name) examSet.add(student.exam_name);
          });

          allClassList = Array.from(classSet).sort();
          allExamList = Array.from(examSet).sort();

          // 渲染班级复选框
          renderClassCheckboxes();
          // 渲染考试复选框
          renderExamCheckboxes();
        } catch (error) {
          console.error("加载筛选选项失败:", error);
        }
      }

      // 渲染班级复选框列表
      function renderClassCheckboxes() {
        classCheckboxList.innerHTML = allClassList.map(className => `
          <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s;"
                 onmouseover="this.style.background='#f3f4f6'"
                 onmouseout="this.style.background='transparent'">
            <input type="checkbox" value="${className}" ${selectedClasses.includes(className) ? 'checked' : ''}
                   style="width: 16px; height: 16px; cursor: pointer;">
            <span style="font-size: 14px;">${className}</span>
          </label>
        `).join('');

        updateSelectedClassCount();
      }

      // 渲染考试复选框列表
      function renderExamCheckboxes() {
        examCheckboxList.innerHTML = allExamList.map(examName => `
          <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s;"
                 onmouseover="this.style.background='#f3f4f6'"
                 onmouseout="this.style.background='transparent'">
            <input type="checkbox" value="${examName}" ${selectedExams.includes(examName) ? 'checked' : ''}
                   style="width: 16px; height: 16px; cursor: pointer;">
            <span style="font-size: 14px;">${examName}</span>
          </label>
        `).join('');

        updateSelectedExamCount();
      }

      // 更新已选择班级数量
      function updateSelectedClassCount() {
        const checkboxes = classCheckboxList.querySelectorAll('input[type="checkbox"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        selectedClassCount.textContent = checked.length;
      }

      // 更新已选择考试数量
      function updateSelectedExamCount() {
        const checkboxes = examCheckboxList.querySelectorAll('input[type="checkbox"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        selectedExamCount.textContent = checked.length;
      }

      // 更新筛选器按钮文本
      function updateFilterButtonText() {
        if (selectedClasses.length === 0) {
          filterClassText.textContent = "全部班级";
          classCount.textContent = "";
        } else if (selectedClasses.length === 1) {
          filterClassText.textContent = selectedClasses[0];
          classCount.textContent = "";
        } else {
          filterClassText.textContent = "多个班级";
          classCount.textContent = `(${selectedClasses.length})`;
        }

        if (selectedExams.length === 0) {
          filterExamText.textContent = "全部考试";
          examCount.textContent = "";
        } else if (selectedExams.length === 1) {
          filterExamText.textContent = selectedExams[0];
          examCount.textContent = "";
        } else {
          filterExamText.textContent = "多个考试";
          examCount.textContent = `(${selectedExams.length})`;
        }
      }

      // 打开班级筛选弹窗
      filterClassBtn?.addEventListener("click", () => {
        renderClassCheckboxes();
        classFilterModal.classList.add("active");
      });

      // 打开考试筛选弹窗
      filterExamBtn?.addEventListener("click", () => {
        renderExamCheckboxes();
        examFilterModal.classList.add("active");
      });

      // 班级复选框change事件
      classCheckboxList?.addEventListener("change", updateSelectedClassCount);

      // 考试复选框change事件
      examCheckboxList?.addEventListener("change", updateSelectedExamCount);

      // 全选班级
      selectAllClasses?.addEventListener("click", () => {
        classCheckboxList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        updateSelectedClassCount();
      });

      // 清空班级选择
      clearAllClasses?.addEventListener("click", () => {
        classCheckboxList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateSelectedClassCount();
      });

      // 全选考试
      selectAllExams?.addEventListener("click", () => {
        examCheckboxList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        updateSelectedExamCount();
      });

      // 清空考试选择
      clearAllExams?.addEventListener("click", () => {
        examCheckboxList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateSelectedExamCount();
      });

      // 取消班级筛选
      cancelClassFilter?.addEventListener("click", () => {
        classFilterModal.classList.remove("active");
      });

      // 确认班级筛选
      confirmClassFilter?.addEventListener("click", () => {
        const checkboxes = classCheckboxList.querySelectorAll('input[type="checkbox"]:checked');
        selectedClasses = Array.from(checkboxes).map(cb => cb.value);
        updateFilterButtonText();
        classFilterModal.classList.remove("active");

        // 刷新仪表盘数据
        loadStudents();
        showToast(`已应用班级筛选 (${selectedClasses.length || '全部'})`);
      });

      // 取消考试筛选
      cancelExamFilter?.addEventListener("click", () => {
        examFilterModal.classList.remove("active");
      });

      // 确认考试筛选
      confirmExamFilter?.addEventListener("click", () => {
        const checkboxes = examCheckboxList.querySelectorAll('input[type="checkbox"]:checked');
        selectedExams = Array.from(checkboxes).map(cb => cb.value);
        updateFilterButtonText();
        examFilterModal.classList.remove("active");

        // 刷新仪表盘数据
        loadStudents();
        showToast(`已应用考试筛选 (${selectedExams.length || '全部'})`);
      });

      // 点击弹窗外部关闭
      classFilterModal?.addEventListener("click", (e) => {
        if (e.target === classFilterModal) {
          classFilterModal.classList.remove("active");
        }
      });

      examFilterModal?.addEventListener("click", (e) => {
        if (e.target === examFilterModal) {
          examFilterModal.classList.remove("active");
        }
      });

      // ========== 结束筛选器功能 ==========

      refreshBtn.addEventListener("click", () => {
        loadStudents();
      });
      subjectTabsEl?.addEventListener("click", async (event) => {
        const target = event.target.closest("button[data-subject]");
        if (!target) return;
        const subject = target.dataset.subject;
        if (subject && subject !== selectedSubject) {
          selectedSubject = subject;
          renderSubjectTabs();
          renderTable();
          updateSummary();
        }
      });

      // 走势图选项卡切换 - 按场次
      document.addEventListener("click", (event) => {
        const countTarget = event.target.closest("button[data-trend-count]");
        if (countTarget) {
          const count = parseInt(countTarget.dataset.trendCount);
          if (count && count !== trendExamCount) {
            trendExamCount = count;
            trendDateRange = null; // 禁用按时间模式

            // 更新按场次选项卡样式
            document.querySelectorAll("button[data-trend-count]").forEach(btn => {
              btn.classList.remove("active");
            });
            countTarget.classList.add("active");

            // 重新绘制图表和排名
            renderDashboardTrendChart();
            renderTopStudents();
          }
          return;
        }
      });

      // 应用自定义日期范围
      document.getElementById("applyTrendDateRange")?.addEventListener("click", () => {
        const startDate = document.getElementById("trendStartDate").value;
        const endDate = document.getElementById("trendEndDate").value;

        if (!startDate || !endDate) {
          alert("请选择开始日期和结束日期");
          return;
        }

        if (new Date(startDate) > new Date(endDate)) {
          alert("开始日期不能晚于结束日期");
          return;
        }

        trendDateRange = { startDate, endDate };
        trendExamCount = null; // 禁用按场次模式

        // 清除按场次选项卡样式
        document.querySelectorAll("button[data-trend-count]").forEach(btn => {
          btn.classList.remove("active");
        });

        // 重新绘制图表和排名
        renderDashboardTrendChart();
        renderTopStudents();
      });
      downloadTemplateBtn?.addEventListener("click", downloadTemplate);
      document.getElementById('downloadRankTemplate')?.addEventListener("click", downloadRankTemplate);
      document.getElementById('rankImportForm')?.addEventListener("submit", handleRankImport);
      autoCalculateRanksBtn?.addEventListener("click", handleAutoCalculateRanks);
      backupDataBtn?.addEventListener("click", handleBackupData);
      restoreForm?.addEventListener("submit", handleRestoreData);
      clearDataBtn?.addEventListener("click", handleClearData);

      // 统一查询入口按钮 - 复制链接
      const unifiedQueryBtn = document.getElementById("unifiedQueryBtn");
      unifiedQueryBtn?.addEventListener("click", async () => {
        const url = window.location.origin + "/static/unified-query.html";
        try {
          await navigator.clipboard.writeText(url);
          const originalText = unifiedQueryBtn.innerHTML;
          unifiedQueryBtn.innerHTML = '<span>✅</span><span>已复制链接</span>';
          setTimeout(() => {
            unifiedQueryBtn.innerHTML = originalText;
          }, 2000);
        } catch (err) {
          // 降级方案
          const textArea = document.createElement("textarea");
          textArea.value = url;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand("copy");
          document.body.removeChild(textArea);
          alert("链接已复制: " + url);
        }
      });

      addStudentBtn?.addEventListener("click", () => openModal());
      cancelModal.addEventListener("click", closeModal);
      modalBackdrop.addEventListener("click", (event) => {
        if (event.target === modalBackdrop) closeModal();
      });
      addScoreRowBtn.addEventListener("click", () => addScoreRow());
      studentForm.addEventListener("submit", saveStudent);
      rangeSubjectSelect?.addEventListener("change", () => {
        currentRangeSubject = rangeSubjectSelect.value;
        renderRangeRows();
      });
      importForm?.addEventListener("submit", handleImport);
      rangeForm?.addEventListener("submit", handleRangeSave);
      searchInput.addEventListener("input", renderTable);
      classFilter.addEventListener("change", renderTable);
      examFilter.addEventListener("change", renderTable);

      columnSettingsBtn?.addEventListener("click", openColumnSettings);
      cancelColumnSettings?.addEventListener("click", closeColumnSettings);
      saveColumnSettings?.addEventListener("click", applyColumnSettings);
      columnSettingsModal?.addEventListener("click", (event) => {
        if (event.target === columnSettingsModal) closeColumnSettings();
      });

      closeDetailModal?.addEventListener("click", closeStudentDetail);
      studentDetailForm?.addEventListener("submit", saveDetailEdit);
      studentDetailModal?.addEventListener("click", (event) => {
        if (event.target === studentDetailModal) closeStudentDetail();
      });

      cancelClassEdit?.addEventListener("click", closeClassEditModal);
      classEditForm?.addEventListener("submit", saveClassEdit);
      classEditModal?.addEventListener("click", (event) => {
        if (event.target === classEditModal) closeClassEditModal();
      });

      classStatsBody?.addEventListener("click", (event) => {
        const editClassName = event.target.getAttribute("data-edit-class");
        const deleteClassName = event.target.getAttribute("data-delete-class");

        if (editClassName) {
          openClassEditModal(editClassName);
        }
        if (deleteClassName) {
          deleteClass(deleteClassName);
        }
      });

      // 学生成绩对比走势图事件监听

      // 打开学生选择弹窗
      selectStudentsBtn?.addEventListener("click", () => {
        populateStudentCheckboxList();
        studentSelectModal?.classList.add("active");
      });

      // 打开科目选择弹窗
      selectSubjectsBtn?.addEventListener("click", () => {
        populateSubjectCheckboxList();
        subjectSelectModal?.classList.add("active");
      });

      // 学生搜索
      studentSearchInput?.addEventListener("input", (e) => {
        populateStudentCheckboxList(e.target.value);
      });

      // 取消学生选择
      cancelStudentSelect?.addEventListener("click", () => {
        studentSelectModal?.classList.remove("active");
      });

      // 确认学生选择
      confirmStudentSelect?.addEventListener("click", () => {
        const checkboxes = studentCheckboxList.querySelectorAll('input[type="checkbox"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);

        if (selected.length > 5) {
          alert('最多只能选择5个学生');
          return;
        }

        selectedStudentNos = selected;
        updateSelectedStudentsList();
        studentSelectModal?.classList.remove("active");
        renderStudentTrendChart();
      });

      // 取消科目选择
      cancelSubjectSelect?.addEventListener("click", () => {
        subjectSelectModal?.classList.remove("active");
      });

      // 确认科目选择
      confirmSubjectSelect?.addEventListener("click", () => {
        const checkboxes = subjectCheckboxList.querySelectorAll('input[type="checkbox"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);

        if (selected.length === 0) {
          alert('请至少选择一个科目');
          return;
        }

        selectedTrendSubjects = selected;
        updateSelectedSubjectCount();
        subjectSelectModal?.classList.remove("active");
        renderStudentTrendChart();
      });

      // 点击弹窗背景关闭
      studentSelectModal?.addEventListener("click", (event) => {
        if (event.target === studentSelectModal) {
          studentSelectModal.classList.remove("active");
        }
      });

      subjectSelectModal?.addEventListener("click", (event) => {
        if (event.target === subjectSelectModal) {
          subjectSelectModal.classList.remove("active");
        }
      });

      studentBody.addEventListener("click", (event) => {
        const viewId = event.target.getAttribute("data-view");
        const editId = event.target.getAttribute("data-edit");
        const deleteId = event.target.getAttribute("data-delete");

        if (viewId) {
          openStudentDetail(Number(viewId));
        }
        if (editId) {
          const student = students.find((item) => item.id === Number(editId));
          if (student) openModal(student);
        }
        if (deleteId) {
          deleteStudent(Number(deleteId));
        }
      });

      function initCollapsibleSections() {
        document.querySelectorAll('.collapsible-header').forEach(header => {
          header.addEventListener('click', () => {
            const targetId = header.getAttribute('data-target');
            const content = document.getElementById(targetId);
            const toggle = header.querySelector('.collapsible-toggle');

            if (content && toggle) {
              const isExpanded = content.classList.contains('expanded');

              if (isExpanded) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
              } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
              }
            }
          });
        });
      }

      // 渲染成绩仪表盘（使用Chart.js）
      let dashboardCharts = [];

      function renderGradeDashboard() {
        const container = document.getElementById('gradeDashboard');
        if (!container) return;

        // 销毁旧图表
        dashboardCharts.forEach(chart => chart.destroy());
        dashboardCharts = [];

        // 使用现有的computeSummaryFromStudents函数计算统计数据
        const summaryData = computeSummaryFromStudents(students, "总分");

        // 计算班级数和考试场次
        const classCount = new Set(students.map(s => s.class_name).filter(Boolean)).size;
        const examCount = new Set(students.map(s => s.exam_name).filter(Boolean)).size;

        // 提取统计数据
        const totalStudents = summaryData.total_students;
        const avgScore = summaryData.average_total;
        const maxScore = summaryData.highest_total || 0;
        const topStudentName = summaryData.highest_student || '';
        const passRate = Math.round(summaryData.pass_rate);
        const goodRate = Math.round(summaryData.good_rate);
        const excellentRate = Math.round(summaryData.excellent_rate);

        // 计算总分满分（假设每科150分，共5科=750分）
        const maxPossibleTotal = 750;

        // 定义统计卡片数据
        const dashboardStats = [
          { label: '学生总数', value: totalStudents, percentage: Math.min(100, (totalStudents / 50) * 100), color: '#9f7aea', trend: null },
          { label: '班级数', value: classCount, percentage: Math.min(100, (classCount / 10) * 100), color: '#4299e1', trend: null },
          { label: '考试场次', value: examCount, percentage: Math.min(100, (examCount / 20) * 100), color: '#38b2ac', trend: null },
          { label: '平均总分', value: avgScore, percentage: Math.min(100, (avgScore / maxPossibleTotal) * 100), color: '#ed8936', trend: null },
          { label: '最高总分', value: maxScore, percentage: Math.min(100, (maxScore / maxPossibleTotal) * 100), color: '#48bb78', trend: topStudentName },
          { label: '及格率', value: passRate + '%', percentage: passRate, color: '#ecc94b', trend: null },
          { label: '良好率', value: goodRate + '%', percentage: goodRate, color: '#ed64a6', trend: null },
          { label: '优秀率', value: excellentRate + '%', percentage: excellentRate, color: '#f56565', trend: null }
        ];

        // 清空容器
        container.innerHTML = '';

        // 创建卡片
        dashboardStats.forEach((stat, index) => {
          const card = document.createElement('div');
          card.style.cssText = `
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
          `;
          card.onmouseenter = () => {
            card.style.transform = 'translateY(-5px)';
            card.style.boxShadow = '0 4px 16px rgba(0, 0, 0, 0.15)';
          };
          card.onmouseleave = () => {
            card.style.transform = '';
            card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
          };

          // 左侧内容
          const content = document.createElement('div');
          content.style.cssText = 'flex: 1;';
          content.innerHTML = `
            <div style="font-size: 14px; color: #718096; margin-bottom: 8px; font-weight: 500;">${stat.label}</div>
            <div style="font-size: 32px; font-weight: bold; color: #2d3748; line-height: 1;">${stat.value}</div>
            ${stat.trend ? `<div style="font-size: 12px; margin-top: 8px; color: #48bb78;">↑ ${stat.trend}</div>` : ''}
          `;

          // 右侧圆环图
          const chartContainer = document.createElement('div');
          chartContainer.style.cssText = 'width: 80px; height: 80px; position: relative;';

          const canvas = document.createElement('canvas');
          canvas.id = `dashboardChart${index}`;
          chartContainer.appendChild(canvas);

          card.appendChild(content);
          card.appendChild(chartContainer);
          container.appendChild(card);

          // 创建Chart.js圆环图
          const ctx = canvas.getContext('2d');
          const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              datasets: [{
                data: [stat.percentage, 100 - stat.percentage],
                backgroundColor: [stat.color, '#edf2f7'],
                borderWidth: 0
              }]
            },
            options: {
              cutout: '70%',
              responsive: true,
              maintainAspectRatio: true,
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
              }
            }
          });
          dashboardCharts.push(chart);

          // 添加装饰圆圈
          const decoration = document.createElement('div');
          decoration.style.cssText = `
            position: absolute;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: ${stat.color};
            opacity: 0.05;
            right: -50px;
            top: -50px;
            pointer-events: none;
          `;
          card.appendChild(decoration);
        });
      }

      // 新增统计图表
      let scoreDistChart = null;
      let radarChart = null;
      let levelChart = null;

      function renderStatisticsCharts() {
        renderScoreDistribution();
        renderSubjectRadar();
        renderGradeLevel();
      }

      // 1. 分数分布柱状图
      function renderScoreDistribution() {
        const canvas = document.getElementById('scoreDistributionChart');
        if (!canvas) return;

        // 销毁旧图表
        if (scoreDistChart) {
          scoreDistChart.destroy();
        }

        // 获取所有学生的总分
        const scores = students
          .filter(s => s.total_score != null && s.total_score > 0)
          .map(s => Number(s.total_score));

        if (scores.length === 0) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.font = '14px PingFang SC';
          ctx.fillStyle = '#6b7280';
          ctx.textAlign = 'center';
          ctx.fillText('暂无分数数据', canvas.width / 2, canvas.height / 2);
          return;
        }

        // 计算分数范围
        const minScore = Math.floor(Math.min(...scores) / 50) * 50; // 向下取整到50的倍数
        const maxScore = Math.ceil(Math.max(...scores) / 50) * 50; // 向上取整到50的倍数
        const interval = 50; // 每个区间50分

        // 动态生成分数段
        const ranges = [];
        for (let i = minScore; i < maxScore; i += interval) {
          ranges.push({
            label: `${i}-${i + interval - 1}`,
            min: i,
            max: i + interval - 1
          });
        }

        const distribution = ranges.map(range => {
          return students.filter(s => {
            const total = s.total_score || 0;
            return total >= range.min && total <= range.max;
          }).length;
        });

        const ctx = canvas.getContext('2d');
        scoreDistChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ranges.map(r => r.label),
            datasets: [{
              label: '人数',
              data: distribution,
              backgroundColor: '#3b82f6',
              borderRadius: 4,
              barPercentage: 0.6,
              categoryPercentage: 0.8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: { size: 14 },
                bodyFont: { size: 13 }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  font: { size: 12 }
                },
                grid: {
                  color: '#e5e7eb'
                }
              },
              x: {
                ticks: {
                  font: { size: 12 }
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }

      // 2. 科目雷达图
      let selectedRadarSubjects = []; // 用户选择的科目
      let allAvailableSubjects = []; // 所有可用科目

      // 从数据库提取所有科目
      function extractAvailableSubjects() {
        const subjectsSet = new Set();
        students.forEach(student => {
          if (student.scores && Array.isArray(student.scores)) {
            student.scores.forEach(score => {
              if (score.subject) {
                subjectsSet.add(score.subject);
              }
            });
          }
        });
        allAvailableSubjects = Array.from(subjectsSet).sort();

        // 初始化选择的科目（默认全选所有科目）
        if (selectedRadarSubjects.length === 0) {
          selectedRadarSubjects = [...allAvailableSubjects];
        }

        return allAvailableSubjects;
      }

      function renderSubjectRadar() {
        const canvas = document.getElementById('subjectRadarChart');
        if (!canvas) return;

        // 销毁旧图表
        if (radarChart) {
          radarChart.destroy();
        }

        // 提取可用科目
        extractAvailableSubjects();

        // 使用用户选择的科目（默认全部）
        const subjects = selectedRadarSubjects.length > 0 ? selectedRadarSubjects : allAvailableSubjects;
        const subjectAvgs = subjects.map(subject => {
          let total = 0;
          let count = 0;
          students.forEach(student => {
            const score = student.scores?.find(s => s.subject === subject);
            if (score) {
              total += Number(score.score || 0);
              count++;
            }
          });
          return count > 0 ? (total / count).toFixed(1) : 0;
        });

        const ctx = canvas.getContext('2d');
        radarChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: subjects,
            datasets: [{
              label: '平均分',
              data: subjectAvgs,
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              borderColor: '#3b82f6',
              borderWidth: 2,
              pointBackgroundColor: '#3b82f6',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  font: { size: 12 },
                  padding: 15
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + context.parsed.r + '分';
                  }
                }
              }
            },
            scales: {
              r: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 20,
                  font: { size: 11 }
                },
                grid: {
                  color: '#e5e7eb'
                },
                angleLines: {
                  color: '#e5e7eb'
                },
                pointLabels: {
                  font: { size: 13, weight: 'bold' },
                  color: '#2d3748'
                }
              }
            }
          }
        });
      }

      // 3. 等级分布饼图
      function renderGradeLevel() {
        const canvas = document.getElementById('gradeLevelChart');
        if (!canvas) return;

        // 销毁旧图表
        if (levelChart) {
          levelChart.destroy();
        }

        // 计算等级分布
        const summaryData = computeSummaryFromStudents(students, "总分");
        const total = summaryData.total_students;

        // 计算各等级人数
        const excellentCount = Math.round(total * summaryData.excellent_rate / 100);
        const goodCount = Math.round(total * summaryData.good_rate / 100) - excellentCount;
        const passCount = Math.round(total * summaryData.pass_rate / 100) - goodCount - excellentCount;
        const failCount = total - excellentCount - goodCount - passCount;

        const ctx = canvas.getContext('2d');
        levelChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['不及格', '及格', '良好', '优秀'],
            datasets: [{
              data: [failCount, passCount, goodCount, excellentCount],
              backgroundColor: ['#3b82f6', '#f59e0b', '#10b981', '#ef4444'],
              borderWidth: 0,
              spacing: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: {
                display: true,
                position: 'right',
                labels: {
                  font: { size: 13 },
                  padding: 15,
                  generateLabels: function(chart) {
                    const data = chart.data;
                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                    return data.labels.map((label, i) => {
                      const value = data.datasets[0].data[i];
                      const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                      return {
                        text: `${label}: ${value}人 (${percentage}%)`,
                        fillStyle: data.datasets[0].backgroundColor[i],
                        hidden: false,
                        index: i
                      };
                    });
                  }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value}人 (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }

      // 科目雷达图设置弹窗
      const radarSettingsModal = document.getElementById('radarSettingsModal');
      const radarSettingsBtn = document.getElementById('radarSettingsBtn');
      const cancelRadarSettings = document.getElementById('cancelRadarSettings');
      const saveRadarSettings = document.getElementById('saveRadarSettings');
      const radarSubjectCheckboxes = document.getElementById('radarSubjectCheckboxes');

      // 打开设置弹窗
      radarSettingsBtn?.addEventListener('click', () => {
        // 提取可用科目
        extractAvailableSubjects();

        // 渲染复选框
        radarSubjectCheckboxes.innerHTML = allAvailableSubjects.map(subject => `
          <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
            <input type="checkbox" value="${subject}" ${selectedRadarSubjects.includes(subject) ? 'checked' : ''}
              style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-size: 14px;">${subject}</span>
          </label>
        `).join('');

        radarSettingsModal?.classList.add('active');
      });

      // 关闭弹窗
      cancelRadarSettings?.addEventListener('click', () => {
        radarSettingsModal?.classList.remove('active');
      });

      // 点击背景关闭
      radarSettingsModal?.addEventListener('click', (e) => {
        if (e.target === radarSettingsModal) {
          radarSettingsModal.classList.remove('active');
        }
      });

      // 保存设置
      saveRadarSettings?.addEventListener('click', () => {
        const checkboxes = radarSubjectCheckboxes.querySelectorAll('input[type="checkbox"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);

        if (selected.length < 3) {
          alert('请至少选择3个科目');
          return;
        }

        selectedRadarSubjects = selected;
        radarSettingsModal?.classList.remove('active');

        // 重新渲染雷达图
        renderSubjectRadar();
      });

      // 进步与退步学生分析
      let progressChart = null;
      let regressionChart = null;

      // 默认设置：对比场次3，显示人数10，自定义场次10
      let progressSettings = {
        compareMode: 3,
        topCount: 10,
        customCount: 10
      };

      // 从localStorage加载设置
      function loadProgressSettings() {
        const saved = localStorage.getItem('progressSettings');
        if (saved) {
          try {
            progressSettings = JSON.parse(saved);
          } catch (e) {
            console.error('Failed to load progress settings', e);
          }
        }
      }

      // 保存设置到localStorage
      function saveProgressSettings() {
        localStorage.setItem('progressSettings', JSON.stringify(progressSettings));
      }

      // 更新标题显示
      function updateProgressTitles() {
        const count = progressSettings.topCount;
        const mode = progressSettings.compareMode;

        document.getElementById('progressTitle').textContent = `进步最大前${count}名`;
        document.getElementById('regressionTitle').textContent = `退步最大前${count}名`;

        let subtitle = '';
        if (mode === 2) {
          subtitle = '基于最近2场考试对比';
        } else if (mode === 3) {
          subtitle = '基于最近3场考试综合对比';
        } else if (mode === 5) {
          subtitle = '基于最近5场考试趋势对比';
        } else if (mode === 'custom') {
          const customCount = progressSettings.customCount || 10;
          subtitle = `基于最近${customCount}场考试综合对比`;
        }

        document.getElementById('progressSubtitle').textContent = subtitle;
        document.getElementById('regressionSubtitle').textContent = subtitle;
      }

      function renderProgressRegressionCharts() {
        // 获取所有学生的成绩数据
        if (!students || students.length === 0) {
          document.getElementById('progressStudentsList').innerHTML = '<p style="margin: 0; color: #6b7280; text-align: center;">暂无数据</p>';
          document.getElementById('regressionStudentsList').innerHTML = '<p style="margin: 0; color: #6b7280; text-align: center;">暂无数据</p>';
          return;
        }

        // 更新标题
        updateProgressTitles();

        const mode = progressSettings.compareMode;
        const topCount = progressSettings.topCount;

        // 获取每个学生的所有考试记录，按日期排序
        const studentProgressData = [];

        students.forEach(student => {
          if (!student.exam_id) return;

          // 找到该学生的所有考试记录
          const studentExams = students.filter(s => s.name === student.name && s.total_score != null);

          // 确定需要的最少考试场次
          let requiredExams;
          if (mode === 'custom') {
            requiredExams = progressSettings.customCount || 10;
          } else {
            requiredExams = mode;
          }

          if (studentExams.length >= requiredExams) {
            // 按日期排序
            studentExams.sort((a, b) => {
              const dateA = new Date(a.exam_date || 0);
              const dateB = new Date(b.exam_date || 0);
              return dateA - dateB;
            });

            let latestScore, previousScore, change;

            if (mode === 2) {
              // 最近2场对比：最新1场 vs 前1场
              const latest = studentExams[studentExams.length - 1];
              const previous = studentExams[studentExams.length - 2];
              latestScore = latest.total_score;
              previousScore = previous.total_score;
              change = latestScore - previousScore;
            } else if (mode === 3) {
              // 最近3场综合对比：最新1场 vs 前2场平均
              const latest = studentExams[studentExams.length - 1];
              const prev1 = studentExams[studentExams.length - 2];
              const prev2 = studentExams[studentExams.length - 3];
              latestScore = latest.total_score;
              previousScore = (prev1.total_score + prev2.total_score) / 2;
              change = latestScore - previousScore;
            } else if (mode === 5) {
              // 最近5场趋势对比：最近2场平均 vs 前3场平均
              const recent2Avg = (studentExams[studentExams.length - 1].total_score + studentExams[studentExams.length - 2].total_score) / 2;
              const prev3Avg = (studentExams[studentExams.length - 3].total_score + studentExams[studentExams.length - 4].total_score + studentExams[studentExams.length - 5].total_score) / 3;
              latestScore = recent2Avg;
              previousScore = prev3Avg;
              change = latestScore - previousScore;
            } else if (mode === 'custom') {
              // 自定义场次对比：最新1场 vs 前N-1场平均
              const customCount = progressSettings.customCount || 10;
              const latest = studentExams[studentExams.length - 1];
              latestScore = latest.total_score;

              // 计算前N-1场的平均分
              let sum = 0;
              for (let i = studentExams.length - 2; i >= studentExams.length - customCount; i--) {
                sum += studentExams[i].total_score;
              }
              previousScore = sum / (customCount - 1);
              change = latestScore - previousScore;
            }

            studentProgressData.push({
              name: student.name,
              previous: previousScore.toFixed(1),
              latest: latestScore.toFixed(1),
              change: change.toFixed(1),
              changePercent: ((change / previousScore) * 100).toFixed(1)
            });
          }
        });

        // 去重（同一个学生只保留一条记录）
        const uniqueStudents = [];
        const seenNames = new Set();
        studentProgressData.forEach(item => {
          if (!seenNames.has(item.name)) {
            seenNames.add(item.name);
            uniqueStudents.push(item);
          }
        });

        // 进步最大的前N名（正数，从大到小）
        const topProgress = uniqueStudents
          .filter(s => parseFloat(s.change) > 0)
          .sort((a, b) => parseFloat(b.change) - parseFloat(a.change))
          .slice(0, topCount);

        // 退步最大的前N名（负数，从小到大）
        const topRegression = uniqueStudents
          .filter(s => parseFloat(s.change) < 0)
          .sort((a, b) => parseFloat(a.change) - parseFloat(b.change))
          .slice(0, topCount);

        // 渲染进步榜
        renderProgressChart(topProgress);
        renderProgressList(topProgress);

        // 渲染退步榜
        renderRegressionChart(topRegression);
        renderRegressionList(topRegression);
      }

      function renderProgressChart(data) {
        const canvas = document.getElementById('progressChart');
        if (!canvas) return;

        if (progressChart) {
          progressChart.destroy();
        }

        if (data.length === 0) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.font = '14px sans-serif';
          ctx.fillStyle = '#9ca3af';
          ctx.textAlign = 'center';
          ctx.fillText('暂无进步数据', canvas.width / 2, canvas.height / 2);
          return;
        }

        const ctx = canvas.getContext('2d');
        progressChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.map(s => s.name),
            datasets: [{
              label: '进步分数',
              data: data.map(s => s.change),
              backgroundColor: '#10b981',
              borderRadius: 8,
              barThickness: 30
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                  label: function(context) {
                    const student = data[context.dataIndex];
                    return [
                      `进步: +${student.change}分`,
                      `前次: ${student.previous}分`,
                      `本次: ${student.latest}分`,
                      `提升: ${student.changePercent}%`
                    ];
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: { font: { size: 11 } },
                grid: { color: '#e5e7eb' }
              },
              y: {
                ticks: { font: { size: 12 } },
                grid: { display: false }
              }
            }
          }
        });
      }

      function renderRegressionChart(data) {
        const canvas = document.getElementById('regressionChart');
        if (!canvas) return;

        if (regressionChart) {
          regressionChart.destroy();
        }

        if (data.length === 0) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.font = '14px sans-serif';
          ctx.fillStyle = '#9ca3af';
          ctx.textAlign = 'center';
          ctx.fillText('暂无退步数据', canvas.width / 2, canvas.height / 2);
          return;
        }

        const ctx = canvas.getContext('2d');
        regressionChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.map(s => s.name),
            datasets: [{
              label: '退步分数',
              data: data.map(s => Math.abs(s.change)),
              backgroundColor: '#ef4444',
              borderRadius: 8,
              barThickness: 30
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                  label: function(context) {
                    const student = data[context.dataIndex];
                    return [
                      `退步: ${student.change}分`,
                      `前次: ${student.previous}分`,
                      `本次: ${student.latest}分`,
                      `下降: ${student.changePercent}%`
                    ];
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: { font: { size: 11 } },
                grid: { color: '#e5e7eb' }
              },
              y: {
                ticks: { font: { size: 12 } },
                grid: { display: false }
              }
            }
          }
        });
      }

      function renderProgressList(data) {
        const container = document.getElementById('progressStudentsList');
        if (!container) return;

        if (data.length === 0) {
          container.innerHTML = '<p style="margin: 0; color: #6b7280; text-align: center;">暂无数据</p>';
          return;
        }

        container.innerHTML = data.map((student, index) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-weight: 600; color: #10b981; font-size: 16px;">${index + 1}</span>
              <span style="font-weight: 500;">${student.name}</span>
            </div>
            <div style="text-align: right;">
              <span style="color: #10b981; font-weight: 600; font-size: 15px;">+${student.change}分</span>
              <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">(${student.previous}→${student.latest})</span>
            </div>
          </div>
        `).join('');
      }

      function renderRegressionList(data) {
        const container = document.getElementById('regressionStudentsList');
        if (!container) return;

        if (data.length === 0) {
          container.innerHTML = '<p style="margin: 0; color: #6b7280; text-align: center;">暂无数据</p>';
          return;
        }

        container.innerHTML = data.map((student, index) => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-weight: 600; color: #ef4444; font-size: 16px;">${index + 1}</span>
              <span style="font-weight: 500;">${student.name}</span>
            </div>
            <div style="text-align: right;">
              <span style="color: #ef4444; font-weight: 600; font-size: 15px;">${student.change}分</span>
              <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">(${student.previous}→${student.latest})</span>
            </div>
          </div>
        `).join('');
      }

      // 进步退步设置模态框
      const progressSettingsModal = document.getElementById('progressSettingsModal');
      const progressSettingsBtn = document.getElementById('progressSettingsBtn');
      const cancelProgressSettings = document.getElementById('cancelProgressSettings');
      const saveProgressSettingsBtn = document.getElementById('saveProgressSettings');
      const progressTopCountSelect = document.getElementById('progressTopCount');
      const customExamCountInput = document.getElementById('customExamCount');

      // 打开设置弹窗
      progressSettingsBtn?.addEventListener('click', () => {
        // 恢复当前设置到UI
        document.querySelectorAll('input[name="compareMode"]').forEach(radio => {
          const isCustom = radio.value === 'custom' && progressSettings.compareMode === 'custom';
          const isNumeric = parseInt(radio.value) === progressSettings.compareMode;
          radio.checked = isCustom || isNumeric;

          // 更新样式
          const label = radio.closest('label');
          if (radio.checked) {
            label.style.borderColor = '#3b82f6';
            label.style.background = 'rgba(59, 130, 246, 0.05)';
          } else {
            label.style.borderColor = 'var(--border)';
            label.style.background = 'transparent';
          }
        });
        progressTopCountSelect.value = progressSettings.topCount;
        customExamCountInput.value = progressSettings.customCount || 10;
        progressSettingsModal?.classList.add('active');
      });

      // 单选按钮样式更新
      document.querySelectorAll('input[name="compareMode"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.querySelectorAll('input[name="compareMode"]').forEach(r => {
            const label = r.closest('label');
            if (r.checked) {
              label.style.borderColor = '#3b82f6';
              label.style.background = 'rgba(59, 130, 246, 0.05)';
            } else {
              label.style.borderColor = 'var(--border)';
              label.style.background = 'transparent';
            }
          });
        });
      });

      // 关闭弹窗
      cancelProgressSettings?.addEventListener('click', () => {
        progressSettingsModal?.classList.remove('active');
      });

      // 点击背景关闭
      progressSettingsModal?.addEventListener('click', (e) => {
        if (e.target === progressSettingsModal) {
          progressSettingsModal.classList.remove('active');
        }
      });

      // 保存设置
      saveProgressSettingsBtn?.addEventListener('click', () => {
        const selectedMode = document.querySelector('input[name="compareMode"]:checked');
        if (selectedMode) {
          if (selectedMode.value === 'custom') {
            // 自定义场次
            const customCount = parseInt(customExamCountInput.value);

            // 验证输入
            if (isNaN(customCount) || customCount < 2 || customCount > 50) {
              alert('请输入有效的场次数（2-50之间）');
              return;
            }

            progressSettings.compareMode = 'custom';
            progressSettings.customCount = customCount;
          } else {
            // 预设场次
            progressSettings.compareMode = parseInt(selectedMode.value);
          }
        }
        progressSettings.topCount = parseInt(progressTopCountSelect.value);

        // 保存到localStorage
        saveProgressSettings();

        // 关闭弹窗
        progressSettingsModal?.classList.remove('active');

        // 重新渲染图表
        renderProgressRegressionCharts();
      });

      // ============ 班级对比功能 ============
      let selectedComparisonClasses = [];
      let classComparisonCharts = {
        avgChart: null,
        subjectChart: null,
        ratesChart: null
      };

      // 打开班级选择模态框
      document.getElementById('selectClassesBtn')?.addEventListener('click', () => {
        openClassSelectionModal();
      });

      // 打开班级选择模态框
      async function openClassSelectionModal() {
        const modal = document.getElementById('classSelectionModal');
        const examFilter = document.getElementById('classComparisonExamFilter');
        const classList = document.getElementById('classCheckboxList');

        // 加载考试列表到筛选器
        const exams = [...new Set(students.map(s => s.exam_name).filter(Boolean))];
        examFilter.innerHTML = '<option value="">全部考试</option>' +
          exams.map(exam => `<option value="${exam}">${exam}</option>`).join('');

        // 加载班级列表
        await loadClassListForComparison();

        modal.classList.add('active');
      }

      // 加载班级列表
      async function loadClassListForComparison() {
        const classList = document.getElementById('classCheckboxList');
        const examFilter = document.getElementById('classComparisonExamFilter');
        const selectedExam = examFilter.value;

        try {
          // 从当前学生数据中提取班级
          let filteredStudents = students;
          if (selectedExam) {
            filteredStudents = students.filter(s => s.exam_name === selectedExam);
          }

          const classes = [...new Set(filteredStudents.map(s => s.class_name).filter(Boolean))];

          if (classes.length === 0) {
            classList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 20px;">暂无班级数据</p>';
            return;
          }

          // 渲染班级复选框
          classList.innerHTML = classes.map((className, index) => {
            const isChecked = selectedComparisonClasses.includes(className);
            const studentCount = filteredStudents.filter(s => s.class_name === className).length;

            return `
              <label style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid ${isChecked ? '#2563eb' : '#e5e7eb'}; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: ${isChecked ? '#eff6ff' : 'white'};">
                <input type="checkbox" value="${className}" ${isChecked ? 'checked' : ''}
                  onchange="toggleClassSelection('${className}')"
                  style="width: 18px; height: 18px; cursor: pointer;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 14px; color: #111827;">${className}</div>
                  <div style="font-size: 12px; color: #6b7280;">${studentCount} 名学生</div>
                </div>
              </label>
            `;
          }).join('');

          updateSelectedClassCount();
        } catch (error) {
          console.error('加载班级列表失败:', error);
          classList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #dc2626; padding: 20px;">加载失败</p>';
        }
      }

      // 切换班级选择
      function toggleClassSelection(className) {
        const index = selectedComparisonClasses.indexOf(className);
        if (index > -1) {
          selectedComparisonClasses.splice(index, 1);
        } else {
          if (selectedComparisonClasses.length >= 6) {
            alert('最多只能选择6个班级');
            event.target.checked = false;
            return;
          }
          selectedComparisonClasses.push(className);
        }
        updateSelectedClassCount();
        loadClassListForComparison(); // 重新渲染以更新样式
      }

      // 更新已选择班级数量
      function updateSelectedClassCount() {
        const countEl = document.getElementById('selectedClassCount');
        if (countEl) {
          countEl.textContent = selectedComparisonClasses.length;
        }
      }

      // 全选班级
      document.getElementById('selectAllClasses')?.addEventListener('click', () => {
        const checkboxes = document.querySelectorAll('#classCheckboxList input[type="checkbox"]');
        const classes = Array.from(checkboxes).map(cb => cb.value).slice(0, 6);
        selectedComparisonClasses = classes;
        loadClassListForComparison();
      });

      // 清空选择
      document.getElementById('clearAllClasses')?.addEventListener('click', () => {
        selectedComparisonClasses = [];
        loadClassListForComparison();
      });

      // 考试筛选变化
      document.getElementById('classComparisonExamFilter')?.addEventListener('change', () => {
        selectedComparisonClasses = []; // 重置选择
        loadClassListForComparison();
      });

      // 取消选择
      document.getElementById('cancelClassSelection')?.addEventListener('click', () => {
        document.getElementById('classSelectionModal').classList.remove('active');
      });

      // 确认选择并开始对比
      document.getElementById('confirmClassSelection')?.addEventListener('click', () => {
        if (selectedComparisonClasses.length < 2) {
          alert('请至少选择2个班级进行对比');
          return;
        }

        document.getElementById('classSelectionModal').classList.remove('active');
        renderClassComparison();
      });

      // 渲染班级对比
      async function renderClassComparison() {
        const examFilter = document.getElementById('classComparisonExamFilter').value;

        // 显示对比内容区域
        document.getElementById('classComparisonContent').style.display = 'block';

        // 更新已选择班级标签
        updateSelectedClassesTags();

        // 收集各班数据
        const classesData = await Promise.all(
          selectedComparisonClasses.map(className => getClassData(className, examFilter))
        );

        // 渲染各个图表
        renderClassAvgComparison(classesData);
        renderClassDetailTable(classesData);
        renderSubjectComparison(classesData);
        renderRatesComparison(classesData);

        // 滚动到对比区域
        document.getElementById('classComparisonSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // 更新已选择班级标签
      function updateSelectedClassesTags() {
        const container = document.getElementById('selectedClassesTags');
        if (selectedComparisonClasses.length === 0) {
          container.innerHTML = '<span style="color: #6b7280; font-size: 14px;">请选择班级进行对比（至少选择2个班级）</span>';
          return;
        }

        container.innerHTML = selectedComparisonClasses.map((className, index) => {
          const colors = ['#2563eb', '#059669', '#d97706', '#dc2626', '#7c3aed', '#0891b2'];
          const color = colors[index % colors.length];
          return `
            <span style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: ${color}; color: white; border-radius: 6px; font-size: 14px; font-weight: 500;">
              ${className}
              <button onclick="removeComparisonClass('${className}')" style="background: none; border: none; color: white; cursor: pointer; padding: 0; margin: 0; font-size: 16px; line-height: 1;">×</button>
            </span>
          `;
        }).join('');
      }

      // 移除对比班级
      function removeComparisonClass(className) {
        selectedComparisonClasses = selectedComparisonClasses.filter(c => c !== className);
        if (selectedComparisonClasses.length < 2) {
          document.getElementById('classComparisonContent').style.display = 'none';
        }
        updateSelectedClassesTags();
        if (selectedComparisonClasses.length >= 2) {
          renderClassComparison();
        }
      }

      // 获取班级数据
      async function getClassData(className, examName) {
        let classStudents = students.filter(s => s.class_name === className);
        if (examName) {
          classStudents = classStudents.filter(s => s.exam_name === examName);
        }

        if (classStudents.length === 0) {
          return {
            className,
            studentCount: 0,
            avgScore: 0,
            maxScore: 0,
            passRate: 0,
            goodRate: 0,
            excellentRate: 0,
            subjectAvgs: {}
          };
        }

        const totalScores = classStudents.map(s => s.total_score || 0);
        const avgScores = classStudents.map(s => s.average_score || 0);

        const avgScore = avgScores.reduce((a, b) => a + b, 0) / avgScores.length;
        const maxScore = Math.max(...totalScores);

        // 计算三率
        const passCount = avgScores.filter(s => s >= 60).length;
        const goodCount = avgScores.filter(s => s >= 75).length;
        const excellentCount = avgScores.filter(s => s >= 90).length;

        // 计算各科平均分
        const subjectAvgs = {};
        classStudents.forEach(student => {
          if (student.scores && Array.isArray(student.scores)) {
            student.scores.forEach(score => {
              if (!subjectAvgs[score.subject]) {
                subjectAvgs[score.subject] = [];
              }
              subjectAvgs[score.subject].push(parseFloat(score.score));
            });
          }
        });

        // 计算平均值
        Object.keys(subjectAvgs).forEach(subject => {
          const scores = subjectAvgs[subject];
          subjectAvgs[subject] = scores.reduce((a, b) => a + b, 0) / scores.length;
        });

        return {
          className,
          studentCount: classStudents.length,
          avgScore: avgScore.toFixed(1),
          maxScore: maxScore.toFixed(1),
          passRate: ((passCount / classStudents.length) * 100).toFixed(1),
          goodRate: ((goodCount / classStudents.length) * 100).toFixed(1),
          excellentRate: ((excellentCount / classStudents.length) * 100).toFixed(1),
          subjectAvgs
        };
      }

      // 1. 渲染班级平均分对比柱状图
      function renderClassAvgComparison(classesData) {
        const ctx = document.getElementById('classAvgComparisonChart');
        if (!ctx) return;

        if (classComparisonCharts.avgChart) {
          classComparisonCharts.avgChart.destroy();
        }

        const colors = ['#2563eb', '#059669', '#d97706', '#dc2626', '#7c3aed', '#0891b2'];

        classComparisonCharts.avgChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: classesData.map(d => d.className),
            datasets: [{
              label: '平均分',
              data: classesData.map(d => parseFloat(d.avgScore)),
              backgroundColor: classesData.map((_, i) => colors[i % colors.length]),
              borderColor: classesData.map((_, i) => colors[i % colors.length]),
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: (context) => `平均分: ${context.parsed.y.toFixed(1)}分`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 10
                },
                title: {
                  display: true,
                  text: '平均分'
                }
              }
            }
          }
        });
      }

      // 2. 渲染各班详细数据表格
      function renderClassDetailTable(classesData) {
        const tbody = document.getElementById('classDetailTableBody');
        if (!tbody) return;

        // 按平均分排序
        const sortedData = [...classesData].sort((a, b) => parseFloat(b.avgScore) - parseFloat(a.avgScore));

        tbody.innerHTML = sortedData.map((data, index) => {
          const rankColors = ['#f59e0b', '#94a3b8', '#cd7f32'];
          const rankColor = index < 3 ? rankColors[index] : '#6b7280';

          return `
            <tr style="border-bottom: 1px solid #f3f4f6;">
              <td style="padding: 12px 16px;">
                <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: ${rankColor}; color: white; font-weight: 700; font-size: 14px;">
                  ${index + 1}
                </span>
              </td>
              <td style="padding: 12px 16px; font-weight: 600; color: #111827;">${data.className}</td>
              <td style="padding: 12px 16px; color: #111827;">${data.studentCount}</td>
              <td style="padding: 12px 16px;"><span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 4px; font-weight: 600;">${data.avgScore}</span></td>
              <td style="padding: 12px 16px; color: #111827;">${data.maxScore}</td>
              <td style="padding: 12px 16px; color: #111827;">${data.passRate}%</td>
              <td style="padding: 12px 16px; color: #111827;">${data.goodRate}%</td>
              <td style="padding: 12px 16px; color: #111827;">${data.excellentRate}%</td>
            </tr>
          `;
        }).join('');
      }

      // 3. 渲染各科平均分对比
      function renderSubjectComparison(classesData) {
        const ctx = document.getElementById('subjectComparisonChart');
        if (!ctx) return;

        if (classComparisonCharts.subjectChart) {
          classComparisonCharts.subjectChart.destroy();
        }

        // 提取所有科目
        const allSubjects = new Set();
        classesData.forEach(data => {
          Object.keys(data.subjectAvgs).forEach(subject => allSubjects.add(subject));
        });
        const subjects = Array.from(allSubjects);

        if (subjects.length === 0) {
          return;
        }

        const colors = ['#2563eb', '#059669', '#d97706', '#dc2626', '#7c3aed', '#0891b2'];

        const datasets = classesData.map((data, index) => ({
          label: data.className,
          data: subjects.map(subject => data.subjectAvgs[subject] || 0),
          backgroundColor: colors[index % colors.length],
          borderColor: colors[index % colors.length],
          borderWidth: 2,
          borderRadius: 6
        }));

        classComparisonCharts.subjectChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: subjects,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(1)}分`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 10
                },
                title: {
                  display: true,
                  text: '平均分'
                }
              }
            }
          }
        });
      }

      // 4. 渲染三率对比
      function renderRatesComparison(classesData) {
        const ctx = document.getElementById('ratesComparisonChart');
        if (!ctx) return;

        if (classComparisonCharts.ratesChart) {
          classComparisonCharts.ratesChart.destroy();
        }

        const colors = ['#2563eb', '#059669', '#d97706', '#dc2626', '#7c3aed', '#0891b2'];

        classComparisonCharts.ratesChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: classesData.map(d => d.className),
            datasets: [
              {
                label: '及格率',
                data: classesData.map(d => parseFloat(d.passRate)),
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              },
              {
                label: '良好率',
                data: classesData.map(d => parseFloat(d.goodRate)),
                borderColor: '#d97706',
                backgroundColor: 'rgba(217, 119, 6, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              },
              {
                label: '优秀率',
                data: classesData.map(d => parseFloat(d.excellentRate)),
                borderColor: '#059669',
                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  stepSize: 10,
                  callback: (value) => value + '%'
                },
                title: {
                  display: true,
                  text: '百分比'
                }
              }
            }
          }
        });
      }

      // ============ 班级对比功能结束 ============

      async function bootstrap() {
        loadColumnSettings();
        loadProgressSettings();
        renderRangeSubjectOptions();
        await loadGradeConfig();
        await loadFilterOptions(); // 加载筛选选项
        await loadStudents();
        addScoreRow();
        initCollapsibleSections();
        renderGradeDashboard();
        renderStatisticsCharts();
        renderProgressRegressionCharts();
      }
      bootstrap();
    </script>
  </body>
</html>
